<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Admin Chat Portal</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the dark sidebar and clean layout */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #1e293b; color: #e2e8f0; height: 100vh; }
        .chat-entry { cursor: pointer; transition: background-color 0.15s; }
        .chat-entry:hover { background-color: #334155; }
        .active-chat { background-color: #0d9488; color: white; }
        .message-bubble.admin { background-color: #d1fae5; align-self: flex-end; }
        .message-bubble.user { background-color: #e0f2fe; align-self: flex-start; }
        .chat-container { height: calc(100vh - 4rem); overflow-y: auto; scroll-behavior: smooth; }
        .chat-input-area { background-color: #f9fafb; border-top: 1px solid #e5e7eb; }
        .error-message { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body class="flex">

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing.");
            document.getElementById('auth-status').innerText = "ERROR: Firebase Config is missing.";
            return;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Expose necessary variables globally for HTML/JS access
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;

        let userId = null;
        let isAuthReady = false;

        // 1. Authentication and Initialization
        async function initAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Auth successful.");
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                document.getElementById('auth-status').innerText = `Auth Failed: ${error.message}`;
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                console.log("User signed in:", userId);
                document.getElementById('auth-status').innerText = `User ID: ${userId}`;
                window.userId = userId; // Expose userId globally
                startChatListener();
            } else {
                // If not signed in (e.g., custom token failed), sign in anonymously as fallback
                if (!isAuthReady) { // Prevent loop if anonymous sign-in also fails/changes state
                    initAuth();
                }
            }
        });

        // 2. Start Real-Time Chat Listener (Anti-Duplication Logic Here)
        function startChatListener() {
            if (!isAuthReady) return;

            // Public path for shared chat data
            const chatsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
            
            // Query: Get all chats, ordered by lastMessageTime (newest first)
            // Note: We use in-memory sorting later to avoid Firestore index issues on orderBy
            const q = query(chatsCollectionRef); 

            console.log("Starting onSnapshot listener for chats...");
            
            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const chatsMap = {}; // Use Map/Object for guaranteed uniqueness by ID
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Ensure the document ID is the chat ID
                    chatsMap[doc.id] = { 
                        telegramId: doc.id,
                        name: data.name || 'Unknown User',
                        lastMessage: data.lastMessage || 'No recent message',
                        // Convert Firestore Timestamp to JS Date for proper sorting/display
                        lastMessageTime: data.lastMessageTime ? data.lastMessageTime.toDate() : new Date(0), 
                        avatar: data.avatar || (data.name ? data.name[0].toUpperCase() : 'U'),
                        // Include other data fields like unread count if available
                    };
                });

                // Convert map values to array
                let updatedChats = Object.values(chatsMap);

                // **DUPLICATION FIX & SORTING:** // Since Firestore only returns one document per ID, we only need to sort the result.
                // The 'chatsMap' approach guarantees no duplication.
                updatedChats.sort((a, b) => b.lastMessageTime - a.lastMessageTime);

                // Update the global state
                window.activeChats = updatedChats; 
                console.log(`Chat List updated. Total unique chats: ${updatedChats.length}`);

                // Re-render the UI
                window.renderChatList();

            }, (error) => {
                console.error("Error listening to chats:", error);
                document.getElementById('auth-status').innerText = `Chat Error: ${error.message}`;
            });
        }
        
        // Start the initial auth process
        initAuth();

    </script>
    
    <!-- 1. Sidebar / Navigation -->
    <div class="sidebar w-64 flex-shrink-0 p-4">
        <h1 class="text-xl font-bold mb-8">Admin Portal</h1>
        <p id="auth-status" class="text-xs text-gray-400 mb-4">Initializing Auth...</p>
        <nav>
            <a href="#" class="block py-2.5 px-4 rounded-lg hover:bg-gray-700" onclick="showView('dashboard')">Dashboard</a>
            <a href="#" class="block py-2.5 px-4 rounded-lg bg-emerald-600 text-white" onclick="showView('chat')">Chat (Real-Time)</a>
            <a href="#" class="block py-2.5 px-4 rounded-lg hover:bg-gray-700" onclick="showView('broadcast')">Broadcast</a>
        </nav>
    </div>

    <!-- 2. Main Content Area -->
    <div class="flex-grow flex flex-col">
        <!-- Header -->
        <header class="h-16 bg-white shadow-md flex items-center px-6">
            <h2 class="text-2xl font-semibold">အသုံးပြုသူ စာရင်း</h2>
        </header>

        <!-- Main Workspace -->
        <main class="flex-grow flex overflow-hidden">
            <!-- Chat List Sidebar -->
            <div id="chat-list-view" class="w-80 border-r border-gray-200 bg-white overflow-y-auto flex-shrink-0" style="display: block;">
                <p class="p-4 text-gray-500 text-center">Loading chats...</p>
            </div>

            <!-- Message View (Hidden by default) -->
            <div id="message-view" class="flex-grow flex flex-col bg-white" style="display: none;">
                <!-- Current Chat Header -->
                <div id="current-chat-header" class="h-16 border-b border-gray-200 p-4 flex items-center justify-between shadow-sm">
                    <p class="text-gray-400">စကားပြောရန် Chat တစ်ခုကို ရွေးချယ်ပါ</p>
                </div>
                
                <!-- Messages Container -->
                <div id="messages-container" class="chat-container p-4 flex flex-col space-y-3">
                    <p class="text-center text-gray-500 mt-10">စကားပြောမှုမှတ်တမ်း (Firestore မှ ရယူပါမည်)</p>
                </div>

                <!-- Input Area -->
                <div class="chat-input-area p-4">
                    <div class="flex items-center space-x-3">
                        <textarea id="message-input" class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-emerald-500 focus:border-emerald-500 resize-none h-12" placeholder="Admin အနေဖြင့် စာပြန်ရန်..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        <button onclick="sendMessage()" class="bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-full shadow-lg transition duration-150">
                            <!-- Send Icon (SVG) -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global State (populated by the module script)
        window.activeChats = [];
        let currentChatId = null;
        let messages = {}; // Store messages locally for the currently selected chat

        // Helper to format date for display
        function formatDisplayTime(date) {
            if (!(date instanceof Date)) return 'N/A';
            const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleString('en-US', options).replace(',', '');
        }

        // ၁။ Chat List ကို Render လုပ်ခြင်း
        window.renderChatList = function() {
            const chatListContainer = document.getElementById('chat-list-view');
            if (window.activeChats.length === 0) {
                 chatListContainer.innerHTML = '<p class="p-4 text-gray-500 text-center">No active chats found.</p>';
                 return;
            }
            
            let html = '';

            window.activeChats.forEach(chat => {
                // Mock unread count for display, since real tracking requires another collection
                const unreadCount = chat.unreadCount || 0; 
                const isActive = chat.telegramId === currentChatId ? 'active-chat' : '';
                const displayTime = formatDisplayTime(chat.lastMessageTime);
                
                html += `
                    <div class="chat-entry flex items-center p-4 border-b border-gray-100 ${isActive}" 
                         onclick="openChat('${chat.telegramId}', '${chat.name}', '${chat.avatar}')">
                        
                        <!-- Avatar -->
                        <div class="flex-shrink-0 w-12 h-12 bg-gray-500 text-white flex items-center justify-center rounded-full font-semibold mr-3">
                            ${chat.avatar}
                        </div>
                        
                        <!-- Chat Info -->
                        <div class="flex-grow min-w-0">
                            <div class="font-semibold text-sm truncate">${chat.name}</div>
                            <div class="text-xs text-gray-500">${displayTime}</div>
                            <div class="text-sm text-gray-700 truncate">${chat.lastMessage}</div>
                        </div>

                        <!-- Unread Count -->
                        ${unreadCount > 0 ? `
                            <div class="flex-shrink-0 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center ml-2">
                                ${unreadCount}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            chatListContainer.innerHTML = html;
        }

        // ၂။ Message View ကို ဖွင့်ခြင်း
        window.openChat = function(id, name, avatar) {
            currentChatId = id;
            
            // 1. Header ကို ပြင်ဆင်ခြင်း
            document.getElementById('current-chat-header').innerHTML = `
                <div class="text-lg font-bold">${name}</div>
                <div class="text-sm text-gray-500">Chat ID: ${id}</div>
            `;
            
            // 2. Message များကို Real-Time Listen လုပ်ခြင်း
            listenToMessages(id);

            // 3. Message View ကို ပြသပြီး Chat List ထဲမှ Active Class ကို ပြန်ဆွဲခြင်း
            document.getElementById('message-view').style.display = 'flex';
            window.renderChatList(); 
        }

        // ၃။ Message Collection ကို Listen လုပ်ခြင်း
        function listenToMessages(chatId) {
            const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
            
            // Query: Messages ကို အချိန်အလိုက် အစီအစဉ်အတိုင်းယူခြင်း
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc')); 

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const chatMessages = [];
                snapshot.docs.forEach(doc => {
                    chatMessages.push({ id: doc.id, ...doc.data() });
                });
                
                messages[chatId] = chatMessages; // Update local message cache
                renderMessages(chatId);
            }, (error) => {
                console.error("Error listening to messages:", error);
                document.getElementById('messages-container').innerHTML = '<p class="text-center error-message">Failed to load messages.</p>';
            });
        }


        // ၄။ Message များကို Render လုပ်ခြင်း
        function renderMessages(chatId) {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = ''; 
            
            const chatMessages = messages[chatId] || [];

            if (chatMessages.length === 0) {
                messagesContainer.innerHTML = '<p class="text-center text-gray-500 mt-10">စကားစပြောရန် စောင့်ဆိုင်းနေပါသည်...</p>';
                return;
            }

            let html = '';
            chatMessages.forEach(msg => {
                // Check sender field (assuming 'user' or 'admin' or similar)
                const isUser = msg.sender !== 'admin'; 
                const bubbleClass = isUser ? 'user mr-auto' : 'admin ml-auto';
                const alignment = isUser ? 'items-start' : 'items-end';

                // Format timestamp
                const displayTime = msg.timestamp && msg.timestamp.toDate ? 
                                    msg.timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 
                                    'N/A';

                html += `
                    <div class="flex w-full ${alignment}">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${bubbleClass} flex flex-col">
                            <span class="text-sm">${msg.content || '...'}</span>
                            <span class="text-xs text-gray-400 mt-1 self-end">${displayTime}</span>
                        </div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = html;
            // Message များကို အောက်ဆုံးသို့ ရွှေ့ခြင်း
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ၅။ Message အသစ် ပို့ခြင်း (Admin to User)
        window.sendMessage = async function() {
            const inputElement = document.getElementById('message-input');
            const content = inputElement.value.trim();
            const chatId = currentChatId;
            const userId = window.userId;

            if (!content || !chatId || !userId) {
                console.error("Cannot send message: content, chat ID, or user ID missing.");
                return;
            }

            try {
                // 1. Message Collection ထဲကို Message အသစ်ထည့်ခြင်း
                const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
                await addDoc(messagesRef, {
                    sender: 'admin',
                    content: content,
                    timestamp: serverTimestamp(),
                    senderId: userId
                });
                
                // 2. Chat Document ကို Update လုပ်ပြီး Chat List ကို အပေါ်ဆုံးသို့ ရွှေ့ခြင်း
                const chatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
                await updateDoc(chatDocRef, {
                    lastMessage: content,
                    lastMessageTime: serverTimestamp()
                    // unreadCount update logic would go here if implemented
                });

                // 3. Input ကို ရှင်းလင်းခြင်း
                inputElement.value = '';

            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        // ၆။ View ပြောင်းလဲခြင်း
        window.showView = function(view) {
            // ... (implement view switching logic if more views are added)
        }
        
        // ၇။ Testing function: User Message အသစ် ဝင်လာပုံကို Firestore ဖြင့် စမ်းသပ်ခြင်း
        // Console မှာ ဒီ function ကို ခေါ်ပြီး Chat List ရဲ့ Duplication Fix အလုပ်လုပ်ပုံကို စမ်းသပ်နိုင်ပါတယ်။
        window.simulateNewIncomingMessage = async function(chatId, name, newMessage) {
            const userId = window.userId;
             if (!userId) {
                 console.error("Auth not ready. Cannot simulate message.");
                 return;
             }
             
             try {
                // 1. Chat Document ကို Update လုပ်ပြီး Chat List ကို အပေါ်ဆုံးသို့ ရွှေ့ခြင်း
                const chatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
                
                // Firestore.setDoc() with merge:true is used here.
                // If the chat doesn't exist, it creates it. If it exists, it updates it.
                await setDoc(chatDocRef, {
                    name: name,
                    lastMessage: newMessage,
                    lastMessageTime: serverTimestamp(),
                    avatar: name[0].toUpperCase(),
                    // Increment unread count if desired (requires transaction)
                }, { merge: true });
                
                // 2. Message Collection ထဲကို Message အသစ်ထည့်ခြင်း
                const messagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
                await addDoc(messagesRef, {
                    sender: 'user', // Simulate user sending
                    content: newMessage,
                    timestamp: serverTimestamp(),
                    senderId: 'mock-user-id-' + chatId
                });

                console.log(`Simulated incoming message for ${name} (${chatId}). Check the list for sorting.`);

            } catch (error) {
                console.error("Error simulating message:", error);
            }
        }

    </script>
</body>
</html>
