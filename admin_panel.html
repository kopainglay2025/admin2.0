<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Messenger Panel - Redesign V2</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap');
        body { font-family: 'Padauk', sans-serif; }
        
        /* Messenger Style */
        .user-message {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            color: #1a202c; /* Gray-900 */
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .admin-message {
            background-color: #10b981; /* Emerald-500 */
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            color: white;
            max-width: 80%;
            align-self: flex-end;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        /* Custom scrollbar for chat window */
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; } /* Gray-400 */
        #chat-window::-webkit-scrollbar-track { background-color: #f3f4f6; } /* Gray-100 */

        /* Custom active state for navigation */
        .nav-item {
            border-radius: 0.5rem; /* rounded-lg */
            margin: 0.25rem 0.5rem; /* mx-2 my-0.5 */
        }
        .nav-item.active {
            background-color: #059669; /* Emerald-600 */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .nav-item:hover:not(.active) {
            background-color: #1e293b; /* Slate-800 */
            color: white;
        }

        /* Custom active state for chat list */
        .chat-list-item.active {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .chat-list-item:hover:not(.active) {
            background-color: #334155; /* Slate-700 */
        }

        /* Badge for Unread Count */
        .unread-badge {
            background-color: #ef4444; /* Red-500 */
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px; /* Full rounded */
            margin-left: 0.5rem;
            min-width: 1.5rem;
            text-align: center;
        }
        
        /* Image Preview Style */
        .message-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            object-fit: contain;
        }

        /* Lightbox modal animation */
        #image-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex antialiased p-6">

    <!-- Main Container -->
    <div class="flex flex-row w-full h-full shadow-2xl rounded-2xl overflow-hidden bg-white">

        <!-- ---------------------------------------------------- -->
        <!-- LEFT SECTION (Menu Navigation & Chat List) -->
        <!-- ---------------------------------------------------- -->
        <div id="left-panel" class="w-1/3 flex flex-row overflow-hidden border-r border-slate-700 transition-all duration-300">
            
            <!-- COLUMN 1: Menu Navigation -->
            <div id="menu-nav-col" class="w-40 flex flex-col bg-slate-950 shadow-xl z-30">
                
                <!-- App Header -->
                <div class="p-4 border-b border-slate-700 bg-slate-950 text-emerald-400 font-extrabold text-lg sticky top-0 z-20">
                    Admin Portal
                </div>

                <!-- Menu Navigation -->
                <nav id="main-nav" class="flex flex-col py-3">
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="dashboard">
                        Dashboard
                    </a>
                    <a href="#" class="nav-item active p-3 px-4 text-white transition duration-200" data-view="chat">
                        Chat
                    </a>
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="broadcast">
                        Broadcast
                    </a>
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="settings">
                        Settings
                    </a>
                </nav>
            </div>
            
            <!-- COLUMN 2: Chat List Panel -->
            <div id="chat-list-panel" class="flex-grow flex flex-col bg-slate-800" data-for-view="chat">
                
                <!-- Chat List Header -->
                <div id="chat-list-header" class="p-4 bg-slate-700 text-white font-bold text-xl sticky top-0 z-10 shadow-lg">
                    á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸
                </div>
                
                <!-- Chat List Container -->
                <div id="user-list-container" class="overflow-y-auto flex-grow">
                    <!-- Placeholder for loading -->
                    <div class="p-4 text-center text-slate-400" id="loading-chats">á€…á€¬á€›á€„á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€šá€°á€”á€±á€á€Šá€º...</div>
                </div>
            </div>
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- RIGHT SECTION (Dynamic Content Area) -->
        <!-- ---------------------------------------------------- -->
        <div id="right-panel" class="w-2/3 flex flex-col">
            
            <!-- View: Dashboard -->
            <div id="view-dashboard" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard</h1>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg">
                    <p class="font-bold">á€á€á€­á€•á€±á€¸á€á€»á€€á€º:</p>
                    <p>á€¤á€á€Šá€ºá€™á€¾á€¬ Dashboard á€§á€›á€­á€šá€¬á€–á€¼á€…á€ºá€á€Šá€ºá‹ Chat á€…á€”á€…á€ºá á€…á€¬á€›á€„á€ºá€¸á€¡á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬- á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°áŠ á€á€…á€ºá€›á€€á€ºá€á€¬ message á€¡á€›á€±á€¡á€á€½á€€á€º) á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€¼á€á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
            </div>

            <!-- View: Chat (Default View) -->
            <div id="view-chat" class="view-content flex flex-col h-full">
                <!-- Chat Header (Clean White with subtle shadow) -->
                <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-lg sticky top-0 z-10">
                    <p id="current-chat-title" class="font-bold text-xl text-gray-800">
                        á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€›á€”á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«
                    </p>
                    <p id="current-chat-subtitle" class="text-sm text-gray-500"></p>
                </div>

                <!-- Chat Messages Window -->
                <div id="chat-window" class="flex-grow p-6 space-y-4 overflow-y-auto flex flex-col bg-gray-50">
                    <!-- Messages will be dynamically inserted here -->
                    <div class="flex justify-center items-center h-full text-gray-400 text-lg" id="no-chat-selected">
                        á€˜á€šá€ºá€˜á€€á€ºá€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€á€…á€ºá€¦á€¸á€¦á€¸á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ á€…á€á€„á€ºá€•á€¼á€±á€¬á€†á€­á€¯á€•á€«á‹
                    </div>
                </div>

                <!-- Message Input (Sleek design) -->
                <div id="message-input-area" class="p-4 border-t border-gray-200 bg-white shadow-inner">
                    <!-- File Preview Area -->
                    <div id="file-preview-area" class="flex items-center p-2 mb-2 border border-gray-300 rounded-lg hidden bg-gray-100">
                        <span id="file-name" class="text-sm text-gray-700 truncate flex-grow"></span>
                        <button type="button" onclick="clearFileSelection()" class="ml-3 text-red-500 hover:text-red-700">
                            <!-- SVG Close Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <form id="reply-form" class="flex" onsubmit="handleReply(event)">
                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="previewFile(event)">
                        
                        <!-- Attach Button -->
                        <button type="button" onclick="document.getElementById('file-input').click()"
                                class="bg-gray-200 text-gray-600 p-3 rounded-l-xl hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 transition duration-150 shadow-md"
                                id="attach-button" disabled>
                            <!-- SVG Paperclip Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.574 6.574A2 2 0 1011 16.586l6.574-6.574a4 4 0 10-5.656-5.656L5 14.5" />
                            </svg>
                        </button>

                        <input type="text" id="reply-text" placeholder="Admin á€¡á€”á€±á€–á€¼á€„á€·á€º á€•á€¼á€”á€ºá€œá€Šá€ºá€–á€¼á€±á€€á€¼á€¬á€¸á€›á€”á€º á€…á€¬á€›á€­á€¯á€€á€ºá€•á€«..."
                               class="flex-grow p-3 border-t border-b border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-gray-100"
                               disabled required>
                        <button type="submit" id="send-button"
                                class="bg-emerald-600 text-white p-3 rounded-r-xl hover:bg-emerald-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-150 shadow-md hover:shadow-lg"
                                disabled>
                            <!-- SVG Send Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- View: Broadcast -->
            <div id="view-broadcast" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Broadcast Message</h1>
                <div class="bg-teal-100 border-l-4 border-teal-500 text-teal-700 p-4 rounded-lg mb-6">
                    <p class="font-bold">á€¡á€á€»á€€á€ºá€¡á€œá€€á€º:</p>
                    <p>á€¤á€”á€±á€›á€¬á€™á€¾ Telegram á€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€¬á€¸á€œá€¯á€¶á€¸á€á€­á€¯á€· á€á€…á€ºá€•á€¼á€­á€¯á€„á€ºá€á€Šá€ºá€¸ á€…á€¬á€™á€»á€¬á€¸ á€•á€­á€¯á€·á€”á€­á€¯á€„á€ºá€›á€”á€º á€…á€®á€…á€‰á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
                <textarea class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="á€•á€­á€¯á€·á€œá€­á€¯á€á€±á€¬ á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«..."></textarea>
                <button class="mt-4 bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition duration-150 shadow-md">Broadcast á€…á€á€„á€ºá€•á€«</button>
            </div>

            <!-- View: Settings -->
            <div id="view-settings" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Settings</h1>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <p class="font-bold">á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸:</p>
                    <p>á€¤á€”á€±á€›á€¬á€á€½á€„á€º Admin Account á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Bot á á€¡á€á€¼á€±á€á€¶ á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€¯á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
            </div>

        </div>
    </div>
    
    <!-- ---------------------------------------------------- -->
    <!-- Image Modal/Lightbox Overlay - Click to view full image -->
    <!-- ---------------------------------------------------- -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden" onclick="closeImageModal()">
        <div class="relative max-w-6xl max-h-full mx-auto p-4" onclick="event.stopPropagation()">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-3xl font-bold hover:text-gray-300">
                &times;
            </button>
            <!-- Image content will be loaded here -->
            <img id="modal-image-content" class="max-w-full max-h-screen object-contain rounded-lg shadow-2xl" src="" alt="Full-size image">
            
            <!-- Download Button -->
            <a id="download-link" href="#" download class="absolute bottom-4 right-4 bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 transition shadow-lg">
                á€’á€±á€«á€„á€ºá€¸á€œá€¯á€á€ºá€†á€½á€²á€›á€”á€º
            </a>
        </div>
    </div>


    <script>
        const socket = io();
        const apiBaseUrl = window.location.origin;

        // Configuration
        const MESSAGE_LIMIT = 30; // á€á€…á€ºá€€á€¼á€­á€™á€ºá€œá€»á€¾á€„á€º á€™á€€á€ºá€†á€±á€·á€á€»á€º áƒá€ á€á€¬ á€á€„á€ºá€›á€”á€º
        
        let activeChats = [];
        let unreadCounts = {}; // á€™á€–á€á€ºá€›á€á€±á€¸á€á€±á€¬ á€…á€¬á€›á€±á€á€½á€€á€ºá€…á€”á€…á€º { chatId: count }
        let currentChatId = null;
        let currentChatOffset = 0; // Pagination á€¡á€á€½á€€á€º
        let allHistoryLoaded = false;
        let currentView = 'chat'; 

        const navItems = document.querySelectorAll('.nav-item');
        const viewContents = document.querySelectorAll('.view-content');
        
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        const menuNavCol = document.getElementById('menu-nav-col');

        const chatListPanel = document.getElementById('chat-list-panel');
        const chatListHeader = document.getElementById('chat-list-header');
        const userListContainer = document.getElementById('user-list-container');
        
        const chatWindow = document.getElementById('chat-window');
        const chatHeaderTitle = document.getElementById('current-chat-title');
        const chatHeaderSubtitle = document.getElementById('current-chat-subtitle');
        const replyText = document.getElementById('reply-text');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const fileInput = document.getElementById('file-input');
        const filePreviewArea = document.getElementById('file-preview-area');
        const fileNameSpan = document.getElementById('file-name');
        const noChatSelected = document.getElementById('no-chat-selected');
        
        // Image Modal Elements
        const imageModal = document.getElementById('image-modal');
        const modalImageContent = document.getElementById('modal-image-content');
        const downloadLink = document.getElementById('download-link');


        // Helper function to format time
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('my-MM', {
            hour: '2-digit', minute: '2-digit', hour12: true
        });

        // ------------------------------------
        // Menu Navigation Function
        // ------------------------------------

        const switchView = (viewId) => {
            currentView = viewId;
            const isChatView = viewId === 'chat';

            // áá‹ Navigation Item á€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            navItems.forEach(item => {
                item.classList.remove('active', 'text-white', 'text-slate-300', 'hover:bg-slate-800'); 
                
                if (item.getAttribute('data-view') === viewId) {
                    item.classList.add('active', 'text-white');
                } else {
                    item.classList.add('text-slate-300');
                }
            });

            // á‚á‹ Content View á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            viewContents.forEach(view => {
                if (view.id === `view-${viewId}`) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });

            // áƒá‹ LAYOUT: Chat View á€¡á€á€½á€€á€º Column Widths á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€á€¼á€„á€ºá€¸ (Dynamic Resizing)
            if (isChatView) {
                // Chat View: 3-column layout (Menu | Chat List | Content)
                leftPanel.classList.add('w-1/3');
                leftPanel.classList.remove('w-40');
                rightPanel.classList.add('w-2/3');
                rightPanel.classList.remove('flex-grow');
                
                chatListPanel.classList.remove('hidden');
                
                // Add border back to menu column
                menuNavCol.classList.add('border-r', 'border-slate-800');

                if (activeChats.length === 0) {
                    fetchChats();
                }
            } else {
                // Other Views: 2-column layout (Menu | Content)
                leftPanel.classList.remove('w-1/3');
                leftPanel.classList.add('w-40'); 
                rightPanel.classList.remove('w-2/3');
                rightPanel.classList.add('flex-grow'); 

                // Hide Chat List column completely
                chatListPanel.classList.add('hidden');
                
                // Remove right border of the menu column if it's the edge of the panel
                menuNavCol.classList.remove('border-r', 'border-slate-800');
            }
        };

        // Event listener for navigation
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.getAttribute('data-view'));
            });
        });

        // ------------------------------------
        // Image Modal Functions (Lightbox)
        // ------------------------------------
        
        const openImageModal = (event, src) => {
            event.stopPropagation(); // Message bubble á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€™á€­á€á€¼á€„á€ºá€¸á€™á€¾ á€€á€¬á€€á€½á€šá€ºá€›á€”á€º
            modalImageContent.src = src;
            downloadLink.href = src;
            
            // Base64 image á€™á€»á€¬á€¸á€€á€­á€¯ download á€œá€¯á€•á€ºá€›á€¬á€á€½á€„á€º filename á€•á€«á€›á€”á€º
            if (src.startsWith('data:')) {
                downloadLink.setAttribute('download', 'image.png');
            } else {
                downloadLink.removeAttribute('download');
            }

            imageModal.classList.remove('hidden');
        };

        const closeImageModal = () => {
            imageModal.classList.add('hidden');
            modalImageContent.src = ''; // Clear src
        };


        // ------------------------------------
        // UI Rendering Functions
        // ------------------------------------

        // áá‹ Chat Message á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderMessage = (message, prepend = false) => {
            const isUser = message.sender === 'user';
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 shadow-md text-sm ${isUser ? 'user-message' : 'admin-message'}`;
            
            let contentHTML = '';
            
            // á€“á€¬á€á€ºá€•á€¯á€¶á€•á€«á€›á€¾á€­á€œá€»á€¾á€„á€º á€•á€¼á€á€á€¼á€„á€ºá€¸ + Modal á€–á€½á€„á€·á€ºá€”á€­á€¯á€„á€ºá€›á€”á€º `onclick` á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸
            if (message.imageUrl) {
                // Base64 data (admin outgoing) á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º URL (user incoming)
                contentHTML += `
                    <img src="${message.imageUrl}" 
                         class="message-image cursor-pointer hover:opacity-90 transition duration-150" 
                         alt="Image attachment" loading="lazy"
                         onclick="openImageModal(event, '${message.imageUrl}')">
                `;
            }

            // á€…á€¬á€á€¬á€¸á€•á€«á€›á€¾á€­á€œá€»á€¾á€„á€º á€•á€¼á€á€á€¼á€„á€ºá€¸
            if (message.text && message.text.trim().length > 0) {
                 contentHTML += `<p class="whitespace-pre-wrap">${message.text}</p>`;
            } else if (!message.imageUrl) {
                 // á€“á€¬á€á€ºá€•á€¯á€¶á€™á€•á€«á€˜á€² á€…á€¬á€á€¬á€¸á€™á€›á€¾á€­á€•á€«á€€ placeholder á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
                 contentHTML += `<p class="italic opacity-80">${isUser ? 'á€•á€¯á€¶á€á€…á€ºá€•á€¯á€¶ á€•á€­á€¯á€·á€‘á€¬á€¸á€á€Šá€º' : 'Admin á€™á€¾ á€“á€¬á€á€ºá€•á€¯á€¶á€•á€­á€¯á€·á€‘á€¬á€¸á€á€Šá€º'}</p>`;
            }

            bubble.innerHTML = `
                ${contentHTML}
                <span class="block text-xs mt-1 opacity-75 text-right ${isUser ? 'text-gray-600' : 'text-emerald-200'}">${formatTime(message.timestamp)}</span>
            `;
            
            messageEl.appendChild(bubble);

            if (prepend) {
                // Load More á€¡á€á€½á€€á€º á€¡á€•á€±á€«á€ºá€™á€¾ á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
                chatWindow.insertBefore(messageEl, chatWindow.firstChild.nextSibling); // Load More á€á€œá€¯á€á€ºá€¡á€±á€¬á€€á€ºá€á€½á€„á€º á€‘á€Šá€·á€ºá€›á€”á€º
            } else {
                // á€™á€€á€ºá€†á€±á€·á€á€»á€ºá€¡á€á€…á€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€…á€á€„á€ºá€á€„á€ºá€á€Šá€·á€ºá€¡á€á€« á€¡á€±á€¬á€€á€ºá€™á€¾ á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
                chatWindow.appendChild(messageEl);
            }
        };

        // á‚á‹ Chat List á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderChatList = () => {
            userListContainer.innerHTML = ''; 
            const fragment = document.createDocumentFragment();

            activeChats.forEach(chat => {
                const chatId = chat.telegramId;
                const isActive = currentChatId === chatId;
                const unreadCount = unreadCounts[chatId] || 0;

                const chatItem = document.createElement('div');
                chatItem.dataset.chatId = chatId;

                chatItem.className = `chat-list-item p-4 border-b border-slate-700 text-white cursor-pointer transition duration-150 ${isActive ? 'active' : ''}`;

                const lastMsgTime = chat.lastMessageTime ? new Date(chat.lastMessageTime) : new Date(chat.createdAt);
                const timeString = lastMsgTime.toLocaleDateString('my-MM', { month: 'short', day: 'numeric' }) + ' ' + lastMsgTime.toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });

                chatItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="text-base truncate ${isActive ? 'font-semibold' : ''} flex-grow">${chat.username}</p>
                        ${unreadCount > 0 ? `<span class="unread-badge ml-2">${unreadCount}</span>` : ''}
                    </div>
                    <p class="text-xs ${isActive ? 'text-emerald-200' : 'text-slate-400'} mt-1">${timeString}</p>
                `;

                chatItem.onclick = () => selectChat(chatId);
                fragment.appendChild(chatItem);
            });
            userListContainer.appendChild(fragment);
        };

        // áƒá‹ Chat á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸ Pagination á€–á€¼á€„á€·á€º á€…á€á€„á€º History á€á€„á€ºá€á€¼á€„á€ºá€¸
        const selectChat = async (chatId) => {
            if (currentChatId === chatId) return; 

            // Unread Count á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€á€¼á€„á€ºá€¸
            if (unreadCounts[chatId] > 0) {
                unreadCounts[chatId] = 0;
            }

            currentChatId = chatId;
            currentChatOffset = 0; 
            allHistoryLoaded = false;
            
            clearFileSelection();

            // UI á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            const user = activeChats.find(c => c.telegramId === chatId);
            chatHeaderTitle.textContent = user.username;
            chatHeaderSubtitle.textContent = `Telegram ID: ${chatId}`;
            noChatSelected.classList.add('hidden');
            replyText.disabled = false;
            sendButton.disabled = false;
            attachButton.disabled = false;
            
            chatWindow.innerHTML = '<div class="text-center text-gray-500 py-4" id="initial-loading">History á€€á€­á€¯ á€›á€šá€°á€”á€±á€á€Šá€º...</div>';
            
            // Chat List á€€á€­á€¯ á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€•á€¼á€®á€¸ badge á€€á€­á€¯ á€–á€»á€±á€¬á€€á€ºá€á€¼á€„á€ºá€¸
            renderChatList(); 

            await loadChatHistory(chatId, MESSAGE_LIMIT, currentChatOffset, true);
        };

        // á„á‹ Chat History á€€á€­á€¯ Limit/Offset á€–á€¼á€„á€·á€º á€›á€šá€°á€á€¼á€„á€ºá€¸ (Pagination)
        const loadChatHistory = async (chatId, limit, offset, isInitialLoad = false) => {
            if (allHistoryLoaded && !isInitialLoad) {
                document.getElementById('load-more-btn')?.remove();
                return;
            }

            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) loadMoreBtn.disabled = true;

            try {
                const response = await fetch(`${apiBaseUrl}/api/chats/${chatId}/history?limit=${limit}&offset=${offset}`);

                if (response.status === 401) throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                if (!response.ok) throw new Error('History á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');
                
                const history = await response.json();
                
                if (history.length < limit) {
                    allHistoryLoaded = true;
                }

                if (isInitialLoad) {
                    chatWindow.innerHTML = '';
                    history.forEach(msg => renderMessage(msg, false));
                    chatWindow.scrollTop = chatWindow.scrollHeight; 
                } else {
                    history.reverse().forEach(msg => renderMessage(msg, true));
                }

                const loadingEl = document.getElementById('initial-loading');
                if (loadingEl) loadingEl.remove();

                if (!allHistoryLoaded) {
                    const existingBtn = document.getElementById('load-more-btn');
                    if (!existingBtn) {
                        const btn = document.createElement('button');
                        btn.id = 'load-more-btn';
                        btn.textContent = 'á€šá€á€„á€ºá€…á€¬á€™á€»á€¬á€¸ á€‘á€•á€ºá€šá€°á€›á€”á€º...';
                        btn.className = 'w-full p-2 text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-lg transition duration-150 shadow-sm sticky top-0';
                        btn.onclick = () => loadChatHistory(chatId, MESSAGE_LIMIT, currentChatOffset);
                        chatWindow.insertBefore(btn, chatWindow.firstChild);
                    } else {
                        existingBtn.disabled = false;
                    }
                } else {
                    document.getElementById('load-more-btn')?.remove();
                    if(isInitialLoad) {
                         const endMsg = document.createElement('div');
                         endMsg.textContent = '--- á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€†á€­á€¯á€™á€¾á€¯ á€¡á€…á€™á€¾ á€¡á€†á€¯á€¶á€¸ ---';
                         endMsg.className = 'text-center text-xs text-gray-400 py-2';
                         chatWindow.insertBefore(endMsg, chatWindow.firstChild);
                    }
                }
                
                currentChatOffset += history.length;

                if (!isInitialLoad && history.length > 0) {
                     // Loading á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€”á€±á€¬á€€á€º Scrollbar á€€á€­á€¯ á€¡á€•á€±á€«á€ºá€á€­á€¯á€· á€Šá€½á€¾á€”á€ºá€•á€¼á€›á€”á€º
                     chatWindow.scrollTop = 10;
                }

            } catch (error) {
                console.error("Fetch history error:", error);
                if (isInitialLoad) {
                    chatWindow.innerHTML = `<div class="text-center text-red-500">Chat history á€€á€­á€¯ á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€á€Šá€º: ${error.message}</div>`;
                } else {
                    const errorBtn = document.getElementById('load-more-btn');
                    if (errorBtn) {
                        errorBtn.textContent = `ğŸš« Error: ${error.message}`;
                        setTimeout(() => {
                            errorBtn.textContent = 'á€šá€á€„á€ºá€…á€¬á€™á€»á€¬á€¸ á€‘á€•á€ºá€šá€°á€›á€”á€º...';
                            errorBtn.disabled = false;
                        }, 5000); 
                    }
                }
            }
        };


        // á…á‹ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ API á€™á€¾ á€›á€šá€°á€á€¼á€„á€ºá€¸
        const fetchChats = async () => {
            const loadingEl = document.getElementById('loading-chats');
            loadingEl.classList.remove('hidden');
            try {
                const response = await fetch(`${apiBaseUrl}/api/chats`);
                
                if (response.status === 401) throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                if (!response.ok) throw new Error('Chat list á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');

                activeChats = await response.json();
                renderChatList();
            } catch (error) {
                console.error("Fetch chats error:", error);
                userListContainer.innerHTML = `<div class="p-4 text-center text-red-500">á€…á€¬á€›á€„á€ºá€¸á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á‹ Server á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹ (${error.message})</div>`;
            } finally {
                loadingEl.classList.add('hidden');
            }
        };

        // ------------------------------------
        // Photo Handling Functions
        // ------------------------------------
        let selectedFileBase64 = null; 

        // á€“á€¬á€á€ºá€•á€¯á€¶á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸ Preview á€•á€¼á€á€¼á€„á€ºá€¸
        const previewFile = (event) => {
            const file = event.target.files[0];
            if (!file) {
                clearFileSelection();
                return;
            }

            if (!file.type.startsWith('image/')) {
                // Custom modal á€–á€¼á€„á€·á€º á€•á€¼á€á€›á€”á€º (alert() á€€á€­á€¯ á€›á€¾á€±á€¬á€„á€ºá€›á€”á€º)
                console.error('á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€“á€¬á€á€ºá€•á€¯á€¶á€–á€­á€¯á€„á€ºá€€á€­á€¯á€á€¬ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€±á€¸á€•á€«');
                clearFileSelection();
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileBase64 = e.target.result; 
                fileNameSpan.textContent = file.name;
                filePreviewArea.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        };

        // á€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€±á€¬ á€“á€¬á€á€ºá€•á€¯á€¶á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
        const clearFileSelection = () => {
            selectedFileBase64 = null;
            fileInput.value = ''; 
            filePreviewArea.classList.add('hidden');
            fileNameSpan.textContent = '';
        };

        // ------------------------------------
        // Event Handlers
        // ------------------------------------

        // Admin á€™á€¾ Message á€•á€¼á€”á€ºá€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
        const handleReply = (event) => {
            event.preventDefault();
            const text = replyText.value.trim();

            if (!text && !selectedFileBase64 || !currentChatId) {
                return;
            }

            // UI á€€á€­á€¯ á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€•á€­á€á€ºá€•á€¼á€®á€¸ Loading á€•á€¼á€›á€”á€º
            sendButton.disabled = true;
            replyText.disabled = true;
            attachButton.disabled = true;

            const messagePayload = {
                chatId: currentChatId,
                text: text,
                imageUrl: selectedFileBase64 
            };

            // Socket.io á€™á€¾á€á€…á€ºá€†á€„á€·á€º Server á€€á€­á€¯ message á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
            socket.emit('admin_reply', messagePayload, () => {
                // Post-send cleanup
                sendButton.disabled = false;
                replyText.disabled = false;
                attachButton.disabled = false;
            });

            // UI á€á€½á€„á€º á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€•á€¼á€á€á€¼á€„á€ºá€¸ (Local Echo)
            const tempMessage = {
                chatId: currentChatId,
                sender: 'admin',
                text: text,
                imageUrl: selectedFileBase64,
                timestamp: new Date().toISOString()
            };
            renderMessage(tempMessage);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Input á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€á€¼á€„á€ºá€¸
            replyText.value = '';
            clearFileSelection();
        };

        // ------------------------------------
        // Socket.io Real-time Handling
        // ------------------------------------
        
        // Telegram Bot á€™á€¾ message á€¡á€á€…á€º á€›á€±á€¬á€€á€ºá€œá€¬á€á€±á€¬á€¡á€á€«
        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // áá‹ Chat List á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            const existingIndex = activeChats.findIndex(c => c.telegramId === chatId);
            
            if (existingIndex > -1) {
                // á€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸ user á€–á€¼á€…á€ºá€•á€«á€€ á€…á€¬á€›á€„á€ºá€¸á€¡á€›á€¾á€±á€·á€†á€¯á€¶á€¸á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€á€¼á€„á€ºá€¸
                const updatedUser = activeChats.splice(existingIndex, 1)[0];
                updatedUser.lastMessageTime = new Date();
                activeChats.unshift(updatedUser); // á€¡á€›á€¾á€±á€·á€†á€¯á€¶á€¸á€á€­á€¯á€· á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
            } else {
                // user á€¡á€á€…á€ºá€–á€¼á€…á€ºá€•á€«á€€ á€…á€¬á€›á€„á€ºá€¸á€¡á€›á€¾á€±á€·á€†á€¯á€¶á€¸á€á€­á€¯á€· á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
                activeChats.unshift(user);
            }
            
            // á‚á‹ á€™á€–á€á€ºá€›á€á€±á€¸á€á€±á€¬ á€…á€¬á€›á€±á€á€½á€€á€ºá€…á€”á€…á€º (Unread Counts) á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            // User message á€–á€¼á€…á€ºá€•á€¼á€®á€¸ á€œá€€á€ºá€›á€¾á€­ chat á€™á€Ÿá€¯á€á€ºá€•á€«á€€ count á€á€­á€¯á€¸á€á€¼á€„á€ºá€¸
            if (message.sender === 'user' && chatId !== currentChatId) {
                unreadCounts[chatId] = (unreadCounts[chatId] || 0) + 1;
            } else if (chatId === currentChatId) {
                // á€œá€€á€ºá€›á€¾á€­ chat á€–á€¼á€…á€ºá€•á€«á€€ count á€€á€­á€¯ 0 á€•á€¼á€”á€ºá€‘á€¬á€¸á€á€¼á€„á€ºá€¸ (safety)
                unreadCounts[chatId] = 0;
            }


            if (currentView === 'chat') {
                renderChatList(); // Chat list á á€¡á€…á€‰á€ºá€œá€­á€¯á€€á€ºá€”á€¾á€„á€·á€º badge á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€•á€¼á€á€á€¼á€„á€ºá€¸
            }

            // áƒá‹ á€œá€€á€ºá€›á€¾á€­ chat window á€á€½á€„á€º á€›á€¾á€­á€”á€±á€•á€«á€€ message á€€á€­á€¯ á€•á€¼á€á€á€¼á€„á€ºá€¸
            if (chatId === currentChatId) {
                if (message.sender === 'user' || message.sender === 'admin') {
                    renderMessage(message);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        });

        // Server á€™á€¾ á€¡á€™á€¾á€¬á€¸á€¡á€šá€½á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬: Telegram á€•á€­á€¯á€·á€™á€›á€á€¼á€„á€ºá€¸)
        socket.on('error', (err) => {
            console.error("Socket Error:", err);
            // Custom notification á€•á€¼á€á€á€¼á€„á€ºá€¸
            const header = document.getElementById('chat-header');
            const errorDiv = document.createElement('div');
            errorDiv.className = "bg-red-500 text-white p-2 text-center text-sm sticky top-0 z-50";
            errorDiv.textContent = `ğŸš« Message á€•á€­á€¯á€·á€›á€”á€º á€¡á€†á€„á€ºá€™á€•á€¼á€±á€•á€«á‹ ${err.message}`;
            header.insertAdjacentElement('afterend', errorDiv);
            setTimeout(() => errorDiv.remove(), 5000); 
            
            // Input á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€–á€½á€„á€·á€ºá€•á€±á€¸á€›á€”á€º
            sendButton.disabled = false;
            replyText.disabled = false;
            attachButton.disabled = false;
        });

        // ------------------------------------
        // Initialization
        // ------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            switchView('chat'); 
        });

    </script>
</body>
</html>
