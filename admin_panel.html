<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Messenger Panel - Redesign V2</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap');
        body { font-family: 'Padauk', sans-serif; }
        
        /* Messenger Style */
        .user-message {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            color: #1a202c; /* Gray-900 */
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .admin-message {
            background-color: #10b981; /* Emerald-500 */
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            color: white;
            max-width: 80%;
            align-self: flex-end;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        /* Custom scrollbar for chat window */
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; } /* Gray-400 */
        #chat-window::-webkit-scrollbar-track { background-color: #f3f4f6; } /* Gray-100 */

        /* Custom active state for navigation */
        .nav-item {
            border-radius: 0.5rem; /* rounded-lg */
            margin: 0.25rem 0.5rem; /* mx-2 my-0.5 */
        }
        .nav-item.active {
            background-color: #059669; /* Emerald-600 */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .nav-item:hover:not(.active) {
            background-color: #1e293b; /* Slate-800 */
            color: white;
        }

        /* Custom active state for chat list */
        .chat-list-item.active {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .chat-list-item:hover:not(.active) {
            background-color: #334155; /* Slate-700 */
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex antialiased p-6">

    <!-- Main Container: Dynamically sized columns. Start in Chat View State (1/3 Left, 2/3 Right) -->
    <div class="flex flex-row w-full h-full shadow-2xl rounded-2xl overflow-hidden bg-white">

        <!-- ---------------------------------------------------- -->
        <!-- LEFT SECTION (Menu Navigation & Chat List) -->
        <!-- ---------------------------------------------------- -->
        <!-- Initial classes set for Chat View: w-1/3 and flex-row -->
        <div id="left-panel" class="w-1/3 flex flex-row overflow-hidden border-r border-slate-700 transition-all duration-300">
            
            <!-- COLUMN 1: Menu Navigation (Fixed Width - Darker Slate) -->
            <div id="menu-nav-col" class="w-40 flex flex-col bg-slate-950 shadow-xl z-30">
                
                <!-- App Header -->
                <div class="p-4 border-b border-slate-700 bg-slate-950 text-emerald-400 font-extrabold text-lg sticky top-0 z-20">
                    Admin Portal
                </div>

                <!-- Menu Navigation -->
                <nav id="main-nav" class="flex flex-col py-3">
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="dashboard">
                        Dashboard
                    </a>
                    <a href="#" class="nav-item active p-3 px-4 text-white transition duration-200" data-view="chat">
                        Chat
                    </a>
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="broadcast">
                        Broadcast
                    </a>
                    <a href="#" class="nav-item p-3 px-4 text-slate-300 transition duration-200" data-view="settings">
                        Settings
                    </a>
                </nav>
            </div>
            
            <!-- COLUMN 2: Chat List Panel (Flexible Width - Lighter Slate) -->
            <div id="chat-list-panel" class="flex-grow flex flex-col bg-slate-800" data-for-view="chat">
                
                <!-- Chat List Header -->
                <div id="chat-list-header" class="p-4 bg-slate-700 text-white font-bold text-xl sticky top-0 z-10 shadow-lg">
                    á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸
                </div>
                
                <!-- Chat List Container -->
                <div id="user-list-container" class="overflow-y-auto flex-grow">
                    <!-- Placeholder for loading -->
                    <div class="p-4 text-center text-slate-400" id="loading-chats">á€…á€¬á€›á€„á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€šá€°á€”á€±á€á€Šá€º...</div>
                </div>
            </div>
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- RIGHT SECTION (Dynamic Content Area) -->
        <!-- ---------------------------------------------------- -->
        <!-- Initial classes set for Chat View: w-2/3 -->
        <div id="right-panel" class="w-2/3 flex flex-col">
            
            <!-- View: Dashboard -->
            <div id="view-dashboard" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard</h1>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg">
                    <p class="font-bold">á€á€á€­á€•á€±á€¸á€á€»á€€á€º:</p>
                    <p>á€¤á€á€Šá€ºá€™á€¾á€¬ Dashboard á€§á€›á€­á€šá€¬á€–á€¼á€…á€ºá€á€Šá€ºá‹ Chat á€…á€”á€…á€ºá á€…á€¬á€›á€„á€ºá€¸á€¡á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬- á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°áŠ á€á€…á€ºá€›á€€á€ºá€á€¬ message á€¡á€›á€±á€¡á€á€½á€€á€º) á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€¼á€á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
            </div>

            <!-- View: Chat (Default View) -->
            <div id="view-chat" class="view-content flex flex-col h-full">
                <!-- Chat Header (Clean White with subtle shadow) -->
                <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-lg sticky top-0 z-10">
                    <p id="current-chat-title" class="font-bold text-xl text-gray-800">
                        á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€›á€”á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«
                    </p>
                    <p id="current-chat-subtitle" class="text-sm text-gray-500"></p>
                </div>

                <!-- Chat Messages Window -->
                <div id="chat-window" class="flex-grow p-6 space-y-4 overflow-y-auto flex flex-col bg-gray-50">
                    <!-- Messages will be dynamically inserted here -->
                    <div class="flex justify-center items-center h-full text-gray-400 text-lg" id="no-chat-selected">
                        á€˜á€šá€ºá€˜á€€á€ºá€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€á€…á€ºá€¦á€¸á€¦á€¸á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ á€…á€á€„á€ºá€•á€¼á€±á€¬á€†á€­á€¯á€•á€«á‹
                    </div>
                </div>

                <!-- Message Input (Sleek design) -->
                <div id="message-input-area" class="p-4 border-t border-gray-200 bg-white shadow-inner">
                    <form id="reply-form" class="flex" onsubmit="handleReply(event)">
                        <input type="text" id="reply-text" placeholder="Admin á€¡á€”á€±á€–á€¼á€„á€·á€º á€•á€¼á€”á€ºá€œá€Šá€ºá€–á€¼á€±á€€á€¼á€¬á€¸á€›á€”á€º á€…á€¬á€›á€­á€¯á€€á€ºá€•á€«..."
                               class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-gray-100"
                               disabled required>
                        <button type="submit" id="send-button"
                                class="bg-emerald-600 text-white p-3 rounded-r-xl hover:bg-emerald-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-150 shadow-md hover:shadow-lg"
                                disabled>
                            <!-- SVG Send Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- View: Broadcast -->
            <div id="view-broadcast" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Broadcast Message</h1>
                <div class="bg-teal-100 border-l-4 border-teal-500 text-teal-700 p-4 rounded-lg mb-6">
                    <p class="font-bold">á€¡á€á€»á€€á€ºá€¡á€œá€€á€º:</p>
                    <p>á€¤á€”á€±á€›á€¬á€™á€¾ Telegram á€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€¬á€¸á€œá€¯á€¶á€¸á€á€­á€¯á€· á€á€…á€ºá€•á€¼á€­á€¯á€„á€ºá€á€Šá€ºá€¸ á€…á€¬á€™á€»á€¬á€¸ á€•á€­á€¯á€·á€”á€­á€¯á€„á€ºá€›á€”á€º á€…á€®á€…á€‰á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
                <!-- ... Broadcast Form ... -->
                <textarea class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="á€•á€­á€¯á€·á€œá€­á€¯á€á€±á€¬ á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«..."></textarea>
                <button class="mt-4 bg-emerald-600 text-white p-3 rounded-lg hover:bg-emerald-700 transition duration-150 shadow-md">Broadcast á€…á€á€„á€ºá€•á€«</button>
            </div>

            <!-- View: Settings -->
            <div id="view-settings" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Settings</h1>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <p class="font-bold">á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸:</p>
                    <p>á€¤á€”á€±á€›á€¬á€á€½á€„á€º Admin Account á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Bot á á€¡á€á€¼á€±á€á€¶ á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€¯á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        const apiBaseUrl = window.location.origin;

        let activeChats = [];
        let currentChatId = null;
        let currentView = 'chat'; // Default view is 'chat'

        const navItems = document.querySelectorAll('.nav-item');
        const viewContents = document.querySelectorAll('.view-content');
        
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        const menuNavCol = document.getElementById('menu-nav-col');

        const chatListPanel = document.getElementById('chat-list-panel');
        const chatListHeader = document.getElementById('chat-list-header');
        const userListContainer = document.getElementById('user-list-container');
        
        const chatWindow = document.getElementById('chat-window');
        const chatHeaderTitle = document.getElementById('current-chat-title');
        const chatHeaderSubtitle = document.getElementById('current-chat-subtitle');
        const replyText = document.getElementById('reply-text');
        const sendButton = document.getElementById('send-button');
        const noChatSelected = document.getElementById('no-chat-selected');

        // Helper function to format time
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('my-MM', {
            hour: '2-digit', minute: '2-digit', hour12: true
        });

        // ------------------------------------
        // Menu Navigation Function
        // ------------------------------------

        const switchView = (viewId) => {
            currentView = viewId;
            const isChatView = viewId === 'chat';

            // áá‹ Navigation Item á€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            navItems.forEach(item => {
                // Clear all previous active/hover classes
                item.classList.remove('active', 'text-white', 'text-slate-300', 'hover:bg-slate-800'); 
                
                if (item.getAttribute('data-view') === viewId) {
                    item.classList.add('active', 'text-white');
                } else {
                    item.classList.add('text-slate-300', 'hover:bg-slate-800');
                }
            });

            // á‚á‹ Content View á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            viewContents.forEach(view => {
                if (view.id === `view-${viewId}`) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });

            // áƒá‹ LAYOUT: Chat View á€¡á€á€½á€€á€º Column Widths á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€á€¼á€„á€ºá€¸ (Dynamic Resizing)
            if (isChatView) {
                // Chat View: 3-column layout (Menu | Chat List | Content)
                leftPanel.classList.add('w-1/3');
                leftPanel.classList.remove('w-40');
                rightPanel.classList.add('w-2/3');
                rightPanel.classList.remove('flex-grow');
                
                chatListPanel.classList.remove('hidden');
                chatListHeader.classList.remove('hidden');
                userListContainer.classList.remove('hidden');
                
                // Add border back to menu column
                menuNavCol.classList.add('border-r', 'border-slate-800');

                if (activeChats.length === 0) {
                    fetchChats();
                }
            } else {
                // Other Views: 2-column layout (Menu | Content)
                leftPanel.classList.remove('w-1/3');
                leftPanel.classList.add('w-40'); // Left panel only takes w-40 (Menu width)
                rightPanel.classList.remove('w-2/3');
                rightPanel.classList.add('flex-grow'); // Right panel takes the rest

                // Hide Chat List column completely
                chatListPanel.classList.add('hidden');
                
                // Remove right border of the menu column if it's the edge of the panel
                menuNavCol.classList.remove('border-r', 'border-slate-800');
            }
        };

        // Event listener for navigation
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.getAttribute('data-view'));
            });
        });

        // ------------------------------------
        // UI Rendering Functions
        // ------------------------------------

        // áá‹ Chat Message á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderMessage = (message) => {
            const isUser = message.sender === 'user';
            const hasImage = !!message.imageUrl; // Check if imageUrl exists
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;

            const bubble = document.createElement('div');
            
            // Adjust bubble classes based on content (image or text)
            bubble.className = `p-3 shadow-md text-sm ${isUser ? 'user-message' : 'admin-message'} max-w-sm`; // Add max-width for image stability

            // Content preparation
            let contentHTML = '';

            if (hasImage) {
                // Use a placeholder image link and ensure it is responsive
                const imageUrl = message.imageUrl; 
                contentHTML += `
                    <div class="${message.text ? 'mb-2' : 'p-0'}">
                        <img src="${imageUrl}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/300x200/94a3b8/ffffff?text=Image+Loading+Error';"
                             alt="Sent Image" 
                             class="rounded-lg shadow-md w-full h-auto object-cover max-h-60"
                        >
                    </div>
                `;
            }
            
            if (message.text) {
                // Ensure text is rendered correctly, especially if it follows an image
                contentHTML += `<p class="whitespace-pre-wrap">${message.text}</p>`;
            } else if (!hasImage) {
                // Safety check for empty messages
                contentHTML += `<p>... (á€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€¡á€›á€¬ á€™á€›á€¾á€­á€•á€«)</p>`;
            }


            // Time stamp insertion
            contentHTML += `
                <span class="block text-xs mt-1 opacity-75 text-right ${isUser ? 'text-gray-600' : 'text-emerald-200'}">
                    ${formatTime(message.timestamp)}
                </span>
            `;

            bubble.innerHTML = contentHTML;
            messageEl.appendChild(bubble);
            chatWindow.appendChild(messageEl);
        };

        // á‚á‹ Chat List á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderChatList = () => {
            userListContainer.innerHTML = ''; // á€…á€¬á€›á€„á€ºá€¸á€Ÿá€±á€¬á€„á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
            const fragment = document.createDocumentFragment();

            activeChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.dataset.chatId = chat.telegramId;
                const isActive = currentChatId === chat.telegramId;

                // Chat List item style á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€Šá€¾á€­á€á€¼á€„á€ºá€¸
                chatItem.className = `chat-list-item p-4 border-b border-slate-700 text-white cursor-pointer transition duration-150 ${isActive ? 'active' : ''}`;

                // á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ Message á€¡á€á€»á€­á€”á€ºá€€á€­á€¯ á€á€½á€€á€ºá€á€»á€€á€ºá€á€¼á€„á€ºá€¸
                const lastMsgTime = chat.lastMessageTime ? new Date(chat.lastMessageTime) : new Date(chat.createdAt);
                const timeString = lastMsgTime.toLocaleDateString('my-MM', { month: 'short', day: 'numeric' }) + ' ' + lastMsgTime.toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });

                chatItem.innerHTML = `
                    <p class="text-base truncate ${isActive ? 'font-semibold' : ''}">${chat.username}</p>
                    <p class="text-xs ${isActive ? 'text-emerald-200' : 'text-slate-400'} mt-1">${timeString}</p>
                `;

                chatItem.onclick = () => selectChat(chat.telegramId);
                fragment.appendChild(chatItem);
            });
            userListContainer.appendChild(fragment);
        };

        // áƒá‹ Chat á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸ History á€€á€­á€¯ á€á€„á€ºá€á€¼á€„á€ºá€¸
        const selectChat = async (chatId) => {
            currentChatId = chatId;
            
            // UI á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            const user = activeChats.find(c => c.telegramId === chatId);
            chatHeaderTitle.textContent = user.username;
            chatHeaderSubtitle.textContent = `Telegram ID: ${chatId}`;
            noChatSelected.classList.add('hidden');
            replyText.disabled = false;
            sendButton.disabled = false;
            
            // Loading Spinner á€–á€¼á€„á€·á€º á€¡á€…á€¬á€¸á€‘á€­á€¯á€¸á€á€¼á€„á€ºá€¸ (Performance improvement)
            chatWindow.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full space-y-4">
                    <svg class="animate-spin h-8 w-8 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div class="text-gray-500 font-semibold">Chat History á€™á€»á€¬á€¸á€€á€­á€¯ á€œá€»á€„á€ºá€™á€¼á€”á€ºá€…á€½á€¬ á€á€„á€ºá€”á€±á€á€Šá€º...</div>
                </div>
            `;
            
            // Active chat á€€á€­á€¯ á€™á€®á€¸á€™á€±á€¬á€„á€ºá€¸á€‘á€­á€¯á€¸á€•á€¼á€›á€”á€º chat list á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€º render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            renderChatList();

            try {
                // HTTP Basic Auth Credentials á€€á€­á€¯ fetch request á€á€½á€„á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º
                const response = await fetch(`${apiBaseUrl}/api/chats/${chatId}/history`);

                if (response.status === 401) {
                    throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                }
                if (!response.ok) throw new Error('History á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');
                
                // const history = await response.json(); // Real data fetch

                // === MOCK DATA FOR IMAGE DEMO (á€”á€™á€°á€”á€¬á€¡á€á€½á€€á€ºá€á€¬ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€‘á€¬á€¸á€á€Šá€º) ===
                // In a real app, this should come from the API response
                const mockHistoryWithImage = [
                    { sender: 'user', text: 'á€•á€¯á€¶á€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€•á€«á€á€šá€º Admin, á€’á€®á€™á€¾á€¬á€€á€¼á€Šá€·á€ºá€•á€«', timestamp: new Date(Date.now() - 300000).toISOString(), imageUrl: 'https://placehold.co/300x180/10b981/ffffff?text=User+Image+Here' },
                    { sender: 'admin', text: 'á€•á€¯á€¶á€›á€•á€«á€•á€¼á€®á‹ á€¡á€á€±á€¸á€…á€­á€á€ºá€™á€»á€¬á€¸ á€†á€½á€±á€¸á€”á€½á€±á€¸á€”á€­á€¯á€„á€ºá€•á€«á€•á€¼á€®á‹', timestamp: new Date(Date.now() - 200000).toISOString() },
                    { sender: 'user', text: 'á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºá‹', timestamp: new Date(Date.now() - 100000).toISOString() },
                    { sender: 'admin', text: 'á€¡á€á€¼á€¬á€¸ á€•á€¯á€¶ á€á€…á€ºá€á€¯á€€á€­á€¯ á€‘á€•á€ºá€•á€­á€¯á€·á€•á€±á€¸á€œá€­á€¯á€€á€ºá€•á€«á€á€šá€ºá‹', timestamp: new Date(Date.now() - 50000).toISOString(), imageUrl: 'https://placehold.co/250x150/065f46/ffffff?text=Admin+Response+Image' },
                    { sender: 'user', text: 'âœ…', timestamp: new Date().toISOString() },
                ];
                const historyToRender = mockHistoryWithImage; // For demo, use mock data

                // ==================================================================

                chatWindow.innerHTML = ''; // loading á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
                historyToRender.forEach(renderMessage);
                chatWindow.scrollTop = chatWindow.scrollHeight; // á€¡á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€á€¼á€„á€ºá€¸
            } catch (error) {
                chatWindow.innerHTML = `<div class="text-center text-red-500">Chat history á€€á€­á€¯ á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€á€Šá€º: ${error.message}</div>`;
                console.error("Fetch history error:", error);
            }
        };

        // á„á‹ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ API á€™á€¾ á€›á€šá€°á€á€¼á€„á€ºá€¸
        const fetchChats = async () => {
            const loadingEl = document.getElementById('loading-chats');
            loadingEl.classList.remove('hidden');
            try {
                const response = await fetch(`${apiBaseUrl}/api/chats`);
                
                if (response.status === 401) {
                    throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                }
                if (!response.ok) throw new Error('Chat list á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');

                activeChats = await response.json();
                renderChatList();
            } catch (error) {
                console.error("Fetch chats error:", error);
                userListContainer.innerHTML = `<div class="p-4 text-center text-red-500">á€…á€¬á€›á€„á€ºá€¸á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á‹ Server á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹ (${error.message})</div>`;
            } finally {
                loadingEl.classList.add('hidden');
            }
        };

        // ------------------------------------
        // Event Handlers
        // ------------------------------------

        // Admin á€™á€¾ Message á€•á€¼á€”á€ºá€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
        const handleReply = (event) => {
            event.preventDefault();
            const text = replyText.value.trim();

            if (!text || !currentChatId) return;

            // Socket.io á€™á€¾á€á€…á€ºá€†á€„á€·á€º Server á€€á€­á€¯ message á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
            socket.emit('admin_reply', { chatId: currentChatId, text });

            // UI á€á€½á€„á€º á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€•á€¼á€á€á€¼á€„á€ºá€¸ (Local Echo)
            const tempMessage = {
                chatId: currentChatId,
                sender: 'admin',
                text: text,
                timestamp: new Date().toISOString()
            };
            renderMessage(tempMessage);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            replyText.value = '';
        };

        // ------------------------------------
        // Socket.io Real-time Handling
        // ------------------------------------
        
        // Telegram Bot á€™á€¾ message á€¡á€á€…á€º á€›á€±á€¬á€€á€ºá€œá€¬á€á€±á€¬á€¡á€á€«
        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // áá‹ Chat List á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            const existingIndex = activeChats.findIndex(c => c.telegramId === chatId);
            if (existingIndex > -1) {
                // á€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸ chat á€€á€­á€¯ á€¡á€•á€±á€«á€ºá€†á€¯á€¶á€¸á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€›á€”á€º
                const updatedUser = activeChats.splice(existingIndex, 1)[0];
                updatedUser.lastMessageTime = new Date();
                activeChats.unshift(updatedUser);
            } else {
                // chat á€¡á€á€…á€º á€–á€¼á€…á€ºá€•á€«á€€ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º
                activeChats.unshift(user);
            }
            // Chat view á€á€½á€„á€º á€›á€¾á€­á€”á€±á€™á€¾á€á€¬ render á€œá€¯á€•á€ºá€›á€”á€º
            if (currentView === 'chat') {
                renderChatList();
            }

            // á‚á‹ á€œá€€á€ºá€›á€¾á€­ chat window á€á€½á€„á€º á€›á€¾á€­á€”á€±á€•á€«á€€ message á€€á€­á€¯ á€•á€¼á€á€á€¼á€„á€ºá€¸
            if (chatId === currentChatId) {
                // Server á€€á€”á€± á€•á€¼á€”á€ºá€œá€¬á€á€²á€· admin reply message á€€á€­á€¯ (local echo á€™á€œá€¯á€•á€ºá€‘á€¬á€¸á€›á€„á€º) á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º user message á€€á€­á€¯ á€•á€¼á€á€á€¼á€„á€ºá€¸
                if (message.sender === 'user' || message.sender === 'admin') {
                    renderMessage(message);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        });

        // Server á€™á€¾ á€¡á€™á€¾á€¬á€¸á€¡á€šá€½á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬: Telegram á€•á€­á€¯á€·á€™á€›á€á€¼á€„á€ºá€¸)
        socket.on('error', (err) => {
            console.error("Socket Error:", err);
            // Custom notification á€•á€¼á€á€á€¼á€„á€ºá€¸
            const header = document.getElementById('chat-header');
            const errorDiv = document.createElement('div');
            errorDiv.className = "bg-red-500 text-white p-2 text-center text-sm sticky top-0 z-50";
            errorDiv.textContent = `ğŸš« Message á€•á€­á€¯á€·á€›á€”á€º á€¡á€†á€„á€ºá€™á€•á€¼á€±á€•á€«á‹ ${err.message}`;
            header.insertAdjacentElement('afterend', errorDiv);
            setTimeout(() => errorDiv.remove(), 5000); 
        });

        // ------------------------------------
        // Initialization
        // ------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Default á€¡á€”á€±á€–á€¼á€„á€·á€º 'chat' view á€€á€­á€¯ á€…á€á€„á€ºá€•á€¼á€á€•á€¼á€®á€¸ chat list á€€á€­á€¯ á€šá€°á€á€¼á€„á€ºá€¸
            switchView('chat'); 
        });

    </script>
</body>
</html>
