<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .chat-container {
            display: flex;
            height: calc(100vh - 4rem); /* Subtract header height */
        }
        .chat-history {
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .user-message {
            background-color: #e5e7eb; /* Gray-200 */
            align-self: flex-start;
        }
        .admin-message {
            background-color: #2563eb; /* Blue-600 */
            color: white;
            align-self: flex-end;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-gray-800">Telegram Live Chat Relay</h1>
        <div id="connection-status" class="flex items-center space-x-2 text-sm">
            <span class="w-3 h-3 rounded-full bg-red-500" id="status-indicator"></span>
            <span class="text-gray-600" id="status-text">Connecting...</span>
        </div>
    </header>

    <main class="chat-container">
        <!-- Chat List (Left Column) -->
        <div id="chat-list" class="w-full md:w-1/3 border-r bg-white overflow-y-auto">
            <div id="list-loading" class="p-4 text-center text-gray-500 hidden">
                Loading chats...
            </div>
            <div id="list-empty" class="p-4 text-center text-gray-500 hidden">
                No active chats found.
            </div>
        </div>

        <!-- Chat Window (Right Column) -->
        <div id="chat-window-container" class="w-full md:w-2/3 flex flex-col hidden bg-gray-100">
            <!-- Selected Chat Header -->
            <div class="p-4 border-b bg-white shadow-sm">
                <h2 class="text-xl font-semibold text-gray-800" id="current-chat-title">Select a Chat</h2>
                <p class="text-sm text-gray-500" id="current-chat-id"></p>
            </div>

            <!-- Chat History Area -->
            <div id="chat-history" class="chat-history flex-grow p-4 space-y-3">
                <!-- Messages will be injected here -->
            </div>

            <!-- Message Input Area -->
            <div class="p-4 bg-white border-t sticky bottom-0">
                <div id="file-preview-area" class="mb-2 hidden p-2 border border-gray-300 rounded-lg bg-gray-50 flex justify-between items-center">
                    <span id="file-name-display" class="text-sm text-gray-700 truncate"></span>
                    <button onclick="clearFileSelection()" class="text-red-500 hover:text-red-700 ml-4 font-semibold text-sm">Remove</button>
                </div>
                <div class="flex items-end space-x-2">
                    <textarea id="message-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" rows="1" placeholder="Type your reply..."></textarea>
                    
                    <label for="file-upload" class="p-3 bg-gray-200 text-gray-700 rounded-lg cursor-pointer hover:bg-gray-300 transition duration-150 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5" />
                        </svg>
                    </label>
                    <input type="file" id="file-upload" class="hidden" onchange="handleFileSelect(event)">
                    
                    <button id="send-button" onclick="sendMessage()" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-45 -mt-1 -mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Initial Placeholder Message -->
        <div id="chat-placeholder" class="w-full md:w-2/3 flex items-center justify-center p-8 text-gray-500 text-center">
            <p>Select a user from the left panel to view and start chatting.</p>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Global State ---
        const socket = io();
        let currentChatId = null;
        let selectedFile = null;

        // --- DOM Elements ---
        const chatListEl = document.getElementById('chat-list');
        const chatHistoryEl = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatWindowContainer = document.getElementById('chat-window-container');
        const chatPlaceholder = document.getElementById('chat-placeholder');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const filePreviewArea = document.getElementById('file-preview-area');
        const fileNameDisplay = document.getElementById('file-name-display');

        // --- Utility Functions ---

        /** Formats Firestore/Date timestamps into readable strings */
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            if (isNaN(date)) return '---';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + 
                   ' ' + 
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        /** Enables/Disables the send button based on input state */
        function updateSendButtonState() {
            const hasText = messageInput.value.trim().length > 0;
            const hasFile = selectedFile !== null;
            sendButton.disabled = !(hasText || hasFile || currentChatId === null);
        }

        // --- Message Rendering ---

        /** Renders a single message bubble into the chat history */
        function renderMessage(msg) {
            const isUser = msg.sender === 'user';
            const alignmentClass = isUser ? 'items-start' : 'items-end';
            const messageClasses = isUser ? 'user-message' : 'admin-message';
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex flex-col w-full ${alignmentClass}`;

            const contentBlock = document.createElement('div');
            contentBlock.className = `max-w-xl p-3 rounded-xl shadow-md break-words ${messageClasses}`;

            // Handle Media Content
            if (msg.mediaPath) {
                const mediaType = msg.mediaPath.startsWith('data:') ? (msg.mediaPath.includes('image') ? 'image' : 'file') : 'telegram-file';
                
                if (mediaType === 'image' || (mediaType === 'telegram-file' && msg.filename && msg.filename.match(/\.(jpeg|jpg|png|gif)$/i))) {
                    // Display image (either base64 for admin echo, or fetching via API for user messages)
                    const mediaEl = document.createElement('img');
                    mediaEl.className = 'max-w-full h-auto rounded-lg mb-2 cursor-pointer';
                    mediaEl.style.maxHeight = '300px';
                    mediaEl.src = mediaType === 'image' 
                        ? msg.mediaPath 
                        : `/api/get-media?file_id=${msg.mediaPath}`;
                    mediaEl.onerror = () => mediaEl.src = 'https://placehold.co/300x200/cccccc/333333?text=Image+Load+Error';
                    contentBlock.appendChild(mediaEl);

                } else if (mediaType === 'file' || mediaType === 'telegram-file') {
                    // Display document/file link
                    const filename = msg.filename || (mediaType === 'file' ? 'Admin File' : 'User Document');
                    const fileLink = document.createElement('a');
                    fileLink.className = 'text-sm font-medium underline';
                    fileLink.textContent = `⬇️ Download: ${filename}`;
                    fileLink.target = '_blank';
                    
                    if (mediaType === 'telegram-file') {
                         fileLink.href = `/api/get-media?file_id=${msg.mediaPath}`;
                    } else {
                        // For admin echo, base64 is saved, but we can't download it easily via link.
                        // For simplicity, we just display the filename or a link placeholder.
                        fileLink.removeAttribute('href');
                        fileLink.style.pointerEvents = 'none'; // Make it non-clickable
                    }
                    contentBlock.appendChild(fileLink);
                }
            }
            
            // Handle Text Content (including captions)
            if (msg.text) {
                const textEl = document.createElement('p');
                textEl.className = 'text-sm';
                textEl.textContent = msg.text;
                contentBlock.appendChild(textEl);
            }

            // Timestamp
            const timestampEl = document.createElement('span');
            timestampEl.className = `text-xs ${isUser ? 'text-gray-600 mr-2' : 'text-blue-200 ml-2'} mt-1`;
            timestampEl.textContent = formatTimestamp(msg.timestamp);
            contentBlock.appendChild(timestampEl);

            messageWrapper.appendChild(contentBlock);
            chatHistoryEl.appendChild(messageWrapper);
            
            // Scroll to bottom after adding new message
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        /** Renders a single chat item in the list */
        function renderChatItem(chat) {
            const item = document.createElement('div');
            item.id = `chat-item-${chat.telegramId}`;
            item.className = 'p-4 border-b cursor-pointer hover:bg-gray-50 transition duration-150';
            item.setAttribute('data-chat-id', chat.telegramId);
            item.onclick = () => selectChat(chat.telegramId, chat.username);

            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="font-semibold text-gray-800">${chat.username || 'User ' + chat.telegramId}</span>
                    <span class="text-xs text-gray-400" data-timestamp="${chat.telegramId}">${formatTimestamp(chat.lastMessageTime)}</span>
                </div>
                <p class="text-sm text-gray-500 truncate mt-1" data-last-message="${chat.telegramId}">
                    ${chat.lastMessageText || 'Start chat...'}
                </p>
            `;
            chatListEl.appendChild(item);
            return item;
        }

        // --- Core Application Logic ---

        /** Fetches and displays the list of active chats */
        async function fetchChats() {
            document.getElementById('list-loading').classList.remove('hidden');
            try {
                const response = await fetch('/api/chats');
                if (!response.ok) throw new Error('Failed to fetch chat list');
                const chats = await response.json();
                
                chatListEl.innerHTML = ''; // Clear existing list
                
                if (chats.length === 0) {
                    document.getElementById('list-empty').classList.remove('hidden');
                } else {
                    chats.forEach(renderChatItem);
                }

            } catch (error) {
                console.error('Error loading chats:', error);
                chatListEl.innerHTML = `<div class="p-4 text-red-500">Error: ${error.message}. Check Server Console.</div>`;
            } finally {
                document.getElementById('list-loading').classList.add('hidden');
            }
        }

        /** Selects a chat, updates the UI, and loads history */
        async function selectChat(chatId, username) {
            if (currentChatId === chatId) return;

            // Update state
            currentChatId = chatId;
            selectedFile = null;
            clearFileSelection();
            messageInput.value = '';
            updateSendButtonState();

            // UI changes
            chatHistoryEl.innerHTML = '<div class="text-center text-gray-400">Loading chat history...</div>';
            chatWindowContainer.classList.remove('hidden');
            chatPlaceholder.classList.add('hidden');
            document.getElementById('current-chat-title').textContent = username || `User ${chatId}`;
            document.getElementById('current-chat-id').textContent = `ID: ${chatId}`;

            // Highlight selected item
            document.querySelectorAll('#chat-list > div').forEach(el => {
                el.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
            });
            const selectedEl = document.getElementById(`chat-item-${chatId}`);
            if (selectedEl) {
                selectedEl.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500');
            }

            // Load History
            try {
                const response = await fetch(`/api/chats/${chatId}/history?limit=50`);
                if (!response.ok) throw new Error('Failed to load chat history');
                const history = await response.json();
                
                chatHistoryEl.innerHTML = ''; // Clear loading message
                history.forEach(renderMessage);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight; // Scroll to bottom
                
            } catch (error) {
                console.error(`Error loading history for ${chatId}:`, error);
                chatHistoryEl.innerHTML = `<div class="text-center text-red-500">Failed to load history.</div>`;
            }
        }

        /** Sends the message (text and/or media) via Socket.io */
        async function sendMessage() {
            const text = messageInput.value.trim();
            const chatId = currentChatId;

            if (!chatId || (!text && !selectedFile)) {
                return;
            }

            // Disable button and input during sending
            sendButton.disabled = true;
            messageInput.disabled = true;

            const dataToSend = {
                chatId: chatId,
                text: text,
                mediaPath: selectedFile ? selectedFile.base64 : null,
                mediaType: selectedFile ? selectedFile.type : null,
                filename: selectedFile ? selectedFile.name : null,
            };

            try {
                // Emit the reply over Socket.io
                socket.emit('admin_reply', dataToSend, (response) => {
                    if (response.success) {
                        // Success: Clear input fields, update UI immediately
                        messageInput.value = '';
                        clearFileSelection();
                        
                        // Local echo (The server handles saving to Firestore, but we echo instantly)
                        const now = new Date().toISOString();
                        renderMessage({
                            sender: 'admin',
                            text: dataToSend.text,
                            mediaPath: dataToSend.mediaPath, // Base64 for local echo
                            filename: dataToSend.filename,
                            timestamp: now
                        });

                        // Also update the chat list item's last message text and time
                        const chatItem = document.querySelector(`#chat-item-${chatId} [data-last-message="${chatId}"]`);
                        const timestampEl = document.querySelector(`#chat-item-${chatId} [data-timestamp="${chatId}"]`);
                        if (chatItem) chatItem.textContent = dataToSend.text || (dataToSend.filename ? `Sent: ${dataToSend.filename}` : 'Sent Media');
                        if (timestampEl) timestampEl.textContent = formatTimestamp(now);

                    } else {
                        console.error('Admin reply failed:', response.error);
                        alert(`Failed to send message: ${response.error}`);
                    }
                    // Re-enable input fields regardless of success
                    messageInput.disabled = false;
                    updateSendButtonState();
                });
            } catch (error) {
                console.error('Socket emission error:', error);
                alert('A critical error occurred while sending the message.');
                messageInput.disabled = false;
                updateSendButtonState();
            }
        }

        // --- File Handling ---

        /** Handles file selection from the input field */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert("File size exceeds 5MB limit.");
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onloadend = () => {
                const mimeType = file.type.startsWith('image/') ? 'photo' : 'document';
                
                selectedFile = {
                    name: file.name,
                    base64: reader.result, // Contains the data URL
                    type: mimeType
                };
                
                fileNameDisplay.textContent = `${selectedFile.type.toUpperCase()}: ${selectedFile.name}`;
                filePreviewArea.classList.remove('hidden');
                updateSendButtonState();
            };
            reader.readAsDataURL(file);
        }

        /** Clears the selected file */
        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('file-upload').value = '';
            filePreviewArea.classList.add('hidden');
            fileNameDisplay.textContent = '';
            updateSendButtonState();
        }

        // --- Socket.io Handlers ---

        socket.on('connect', () => {
            statusIndicator.classList.remove('bg-red-500', 'bg-yellow-500');
            statusIndicator.classList.add('bg-green-500');
            statusText.textContent = 'Connected';
            fetchChats(); // Refresh chat list on connect
        });

        socket.on('disconnect', () => {
            statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
            statusIndicator.classList.add('bg-red-500');
            statusText.textContent = 'Disconnected';
        });

        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            console.log('Received new message:', message);

            // 1. Update/Add chat item in the list
            let chatItem = document.getElementById(`chat-item-${chatId}`);
            if (!chatItem) {
                // If it's a new chat, refresh the whole list to maintain sorting
                fetchChats(); 
            } else {
                // Update existing item's text and time
                const lastMessageEl = document.querySelector(`#chat-item-${chatId} [data-last-message="${chatId}"]`);
                const timestampEl = document.querySelector(`#chat-item-${chatId} [data-timestamp="${chatId}"]`);
                if (lastMessageEl) lastMessageEl.textContent = message.text || (message.filename || 'Media Received');
                if (timestampEl) timestampEl.textContent = formatTimestamp(message.timestamp);

                // Re-order the item to the top (simple DOM manipulation)
                chatListEl.prepend(chatItem);
            }

            // 2. Render message if this chat is currently open
            if (currentChatId === chatId) {
                renderMessage(message);
            }
        });


        // --- Event Listeners and Initialization ---
        
        // Auto-resize textarea and enable send button check
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto'; // Reset height
            messageInput.style.height = messageInput.scrollHeight + 'px'; // Set to fit content
            updateSendButtonState();
        });

        // Send message on Enter key press (Shift+Enter for new line)
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.disabled) {
                    sendMessage();
                }
            }
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', fetchChats);

    </script>
</body>
</html>
