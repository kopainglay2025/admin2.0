<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB Page Messenger Admin Panel</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Socket.io Client -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Load Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --fb-blue: #0A66FF;
            --fb-light-blue: #E7F3FF;
            --sidebar-width: 280px;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .sidebar { width: var(--sidebar-width); transition: transform 0.3s ease; }
        .chat-area { min-height: 80vh; max-height: 80vh; overflow-y: auto; }
        .chat-input-area { border-top: 1px solid #e5e7eb; }
        .message-bubble.user { background-color: var(--fb-blue); color: white; border-bottom-right-radius: 0.5rem; }
        .message-bubble.admin { background-color: #fff; color: #1c1e21; border: 1px solid #e5e7eb; border-bottom-left-radius: 0.5rem; }
        .menu-item.active { background-color: var(--fb-light-blue); color: var(--fb-blue); font-weight: 600; border-right: 4px solid var(--fb-blue); }
        /* Scrollbar styling for modern look */
        .chat-area::-webkit-scrollbar, .chat-list-area::-webkit-scrollbar { width: 8px; }
        .chat-area::-webkit-scrollbar-thumb, .chat-list-area::-webkit-scrollbar-thumb { background-color: #c4c4c4; border-radius: 10px; }
        .chat-area::-webkit-scrollbar-track, .chat-list-area::-webkit-scrollbar-track { background-color: #f0f2f5; }

        /* Custom file input appearance */
        .file-input-label { cursor: pointer; }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                height: 100%;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar (Left Menu) -->
    <div id="sidebar" class="sidebar bg-white shadow-xl flex-shrink-0 flex flex-col justify-between overflow-y-auto z-50 md:static md:translate-x-0">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="ph-chats text-3xl mr-2 text-blue-600"></i>
                Page Manager
            </h1>
        </div>
        
        <!-- Menu Items -->
        <nav class="flex-grow p-4 space-y-2">
            <!-- Items are mapped to different views/functionality -->
            <button class="menu-item flex items-center w-full p-3 rounded-xl text-gray-600 hover:bg-gray-100" data-view="dashboard">
                <i class="ph-chart-bar text-xl mr-3"></i>
                Dashboard
            </button>
            <button class="menu-item active flex items-center w-full p-3 rounded-xl text-gray-800 hover:bg-gray-100" data-view="messenger">
                <i class="ph-messenger-logo text-xl mr-3"></i>
                FB Page Messager
            </button>
            <!-- NOTE: 'Chats' is the same view as Messenger for this demo, keeping the structure -->
            <button class="menu-item flex items-center w-full p-3 rounded-xl text-gray-600 hover:bg-gray-100" data-view="chats">
                <i class="ph-chats text-xl mr-3"></i>
                Chats
            </button>
            <button class="menu-item flex items-center w-full p-3 rounded-xl text-gray-600 hover:bg-gray-100" data-view="broadcast">
                <i class="ph-megaphone text-xl mr-3"></i>
                Broadcast
            </button>
            <button class="menu-item flex items-center w-full p-3 rounded-xl text-gray-600 hover:bg-gray-100" data-view="settings">
                <i class="ph-gear-six text-xl mr-3"></i>
                Settings
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 text-sm text-gray-500">
            <p>Admin ID: <span id="current-user-id" class="font-mono text-gray-700">Loading...</span></p>
            <p>&copy; 2024 Page Manager</p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col">
        <!-- Header (Only visible on Mobile) -->
        <header class="bg-white shadow-md p-4 flex items-center justify-between md:hidden">
            <h2 class="text-lg font-semibold text-gray-800">FB Page Messager</h2>
            <button id="menu-toggle" class="text-gray-700 hover:text-blue-600">
                <i class="ph-list text-2xl"></i>
            </button>
        </header>

        <!-- Dynamic Content Views -->
        <div id="content-container" class="flex-grow overflow-y-auto p-4 md:p-6">
            <!-- Messenger View (Default) -->
            <div id="view-messenger" class="h-full flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-6">

                <!-- 1. Chat List (Left Panel) -->
                <div class="bg-white rounded-xl shadow-lg w-full lg:w-96 flex-shrink-0 overflow-hidden h-full">
                    <div class="p-4 border-b">
                        <h3 class="font-semibold text-lg text-gray-800">Customer Chats</h3>
                        <input type="text" id="search-input" placeholder="Search chats..." class="mt-2 w-full p-2 text-sm border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="chat-list-area" class="chat-list-area overflow-y-auto max-h-[70vh] lg:max-h-[80vh]">
                        <!-- Chat items will be injected here -->
                        <div class="p-4 text-center text-gray-500">Chats loading...</div>
                    </div>
                </div>

                <!-- 2. Chat Window (Right Panel) -->
                <div class="bg-white rounded-xl shadow-lg flex-grow flex flex-col h-full">
                    <div id="chat-header" class="p-4 border-b flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 text-gray-500">
                            <i class="ph-user text-xl"></i>
                        </div>
                        <h3 id="current-chat-title" class="font-semibold text-gray-800">Select a Chat to start messaging</h3>
                    </div>
                    
                    <!-- Message Display Area -->
                    <div id="message-container" class="chat-area p-4 flex-grow flex flex-col space-y-4">
                        <!-- Messages will be injected here -->
                        <div id="initial-message" class="text-center text-gray-500 mt-24">
                            Your conversations with FB Users will appear here.
                        </div>
                    </div>

                    <!-- Message Input Area -->
                    <div id="chat-input-area" class="chat-input-area p-4" style="display:none;">
                        <div id="file-preview-area" class="mb-2 p-2 border border-gray-200 rounded-lg hidden">
                            <span id="file-preview-name" class="text-sm font-medium text-gray-700"></span>
                            <button id="clear-file-btn" class="ml-3 text-red-500 hover:text-red-700 text-sm">Clear</button>
                        </div>
                        
                        <div class="flex items-end">
                            <label for="file-upload" class="file-input-label text-gray-500 hover:text-fb-blue p-2 rounded-full transition duration-150">
                                <i class="ph-paperclip text-2xl"></i>
                                <input type="file" id="file-upload" class="hidden">
                            </label>

                            <textarea id="message-input" class="flex-grow resize-none border rounded-xl p-3 mr-3 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Type a message..." rows="1" oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'"></textarea>

                            <button id="send-button" class="bg-fb-blue text-white p-3 rounded-full shadow-md hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:opacity-50" disabled>
                                <i class="ph-paper-plane-tilt text-xl"></i>
                            </button>
                        </div>
                        <p id="error-message" class="text-red-500 text-xs mt-1 hidden">Error sending message.</p>
                    </div>
                </div>

            </div>
            
            <!-- Other Views (Placeholders) -->
            <div id="view-dashboard" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold">Dashboard</h2>
                    <p class="mt-4 text-gray-600">Overview of FB Page performance and messaging metrics will be shown here.</p>
                </div>
            </div>
            <div id="view-chats" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold">Chats (Combined)</h2>
                    <p class="mt-4 text-gray-600">This section could combine messages from Messenger, Instagram, or other sources.</p>
                </div>
            </div>
            <div id="view-broadcast" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold">Broadcast Messages</h2>
                    <p class="mt-4 text-gray-600">Send bulk messages or notifications to segments of your users (FB Messenger Rules Apply).</p>
                </div>
            </div>
            <div id="view-settings" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold">Settings</h2>
                    <p class="mt-4 text-gray-600">Configure Page API keys, auto-reply settings, and webhook details.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for showing error/info messages -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-semibold mb-2">Notice</h3>
            <p id="modal-content" class="text-gray-600 mb-4"></p>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="bg-fb-blue text-white px-4 py-2 rounded-lg float-right hover:bg-blue-700">Close</button>
        </div>
    </div>

    <script>
        // Global State
        let currentChatId = null;
        let socket = null;
        let authUserId = 'admin-user-1234'; // Mock admin ID for display
        let selectedFile = null;
        let isSending = false;
        
        // --- Utility Functions ---

        /** Shows a custom modal message. */
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            document.getElementById('modal').classList.remove('hidden');
        }

        /** Formats timestamps for display. */
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date)) return isoString;
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ' - ' +
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        /** Converts a File object to a Base64 Data URL. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- UI Rendering Functions ---

        /** Renders a single chat item in the left list. */
        function renderChatItem(chat) {
            const container = document.createElement('button');
            container.className = 'chat-item flex items-center w-full p-3 text-left border-b hover:bg-gray-50 transition duration-150';
            container.setAttribute('data-chat-id', chat.telegramId);
            container.onclick = () => selectChat(chat.telegramId);

            // Active/Unread Styling
            if (chat.telegramId === currentChatId) {
                container.classList.add('bg-fb-light-blue', 'border-l-4', 'border-fb-blue');
            } else if (chat.unreadCount > 0) {
                 container.classList.add('bg-yellow-50');
            }

            const avatar = `<div class="w-10 h-10 bg-fb-blue rounded-full flex items-center justify-center text-white text-sm font-bold mr-3 flex-shrink-0">
                ${chat.username ? chat.username[0].toUpperCase() : 'U'}
            </div>`;
            
            const unreadBadge = chat.unreadCount > 0 ? 
                `<span id="badge-${chat.telegramId}" class="bg-red-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full ml-2">${chat.unreadCount}</span>` : 
                `<span id="badge-${chat.telegramId}" class="hidden"></span>`;

            container.innerHTML = `
                ${avatar}
                <div class="flex-grow overflow-hidden">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800 truncate">${chat.username || 'User ' + chat.telegramId}</p>
                        ${unreadBadge}
                    </div>
                    <p class="text-xs text-gray-500 truncate">${chat.lastMessageText || 'Media received/sent'}</p>
                </div>
            `;
            return container;
        }
        
        /** Renders a single message bubble. */
        function renderMessage(message) {
            const isUser = message.sender === 'user';
            const alignmentClass = isUser ? 'justify-start' : 'justify-end';
            const bubbleClass = isUser ? 'message-bubble user' : 'message-bubble admin';
            const marginClass = isUser ? 'mr-auto' : 'ml-auto';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${alignmentClass} max-w-3/4 mb-2`;

            let contentHTML = '';

            if (message.mediaPath) {
                const mediaUrl = isUser 
                    ? `/api/get-media?file_id=${message.mediaPath}` // Telegram media endpoint
                    : message.mediaPath; // Admin sent base64 data

                const isImage = mediaUrl.startsWith('data:image') || message.mediaPath.match(/\.(jpg|jpeg|png|gif)$/i) || !message.filename;
                
                if (isImage) {
                    // Image display
                    contentHTML = `<img src="${mediaUrl}" alt="Media" class="max-w-xs md:max-w-sm rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/200x150/f0f2f5/a8a8a8?text=Cannot+Load+Media'">`;
                } else {
                    // Document/File display
                    const icon = message.filename.endsWith('.pdf') ? 'ph-file-pdf' : 'ph-file-text';
                    contentHTML = `
                        <a href="${mediaUrl}" target="_blank" class="flex items-center p-3 bg-white text-gray-800 rounded-lg border border-gray-300 hover:bg-gray-100 transition duration-150">
                            <i class="${icon} text-xl mr-2"></i>
                            <span class="truncate max-w-[200px]">${message.filename || 'File Download'}</span>
                        </a>
                    `;
                }
            }
            
            // Add text if present
            if (message.text) {
                const textContent = `<p class="${message.mediaPath ? 'mt-1' : ''}">${message.text}</p>`;
                if (message.mediaPath) {
                    contentHTML += textContent;
                } else {
                    contentHTML = textContent;
                }
            }

            const timestamp = formatTimestamp(message.timestamp);

            messageDiv.innerHTML = `
                <div class="${bubbleClass} ${marginClass} max-w-[75%] px-4 py-2 rounded-xl text-sm shadow-sm flex flex-col">
                    <div>${contentHTML}</div>
                    <span class="text-xs ${isUser ? 'text-blue-200' : 'text-gray-400'} self-end mt-1">${timestamp}</span>
                </div>
            `;
            return messageDiv;
        }


        // --- Core Logic ---

        /** Initializes Firebase Auth and displays the mock user ID. */
        function initAuth() {
             // In a real app, this would initialize Firebase auth and get the real user ID.
             // Mocking based on the server's expected behavior (assuming admin is authenticated via Basic Auth)
             document.getElementById('current-user-id').textContent = authUserId;
        }

        /** Sets up Socket.io connection and listeners. */
        function setupSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Socket.io connected.');
            });

            socket.on('new_message', (data) => {
                console.log('Real-time new message:', data);
                // 1. Update chat list (or refresh list)
                fetchChatList(); 
                
                // 2. If it's the currently selected chat, display the message
                if (data.chatId === currentChatId) {
                    displayMessage(data.message);
                    // Ensure unread count is reset visually, even if the user hasn't explicitly clicked 'read'
                    const badge = document.getElementById(`badge-${data.chatId}`);
                    if (badge) {
                        badge.classList.add('hidden');
                        badge.textContent = 0;
                    }
                }
            });

            socket.on('chat_read_status', (data) => {
                const badge = document.getElementById(`badge-${data.chatId}`);
                if (badge) {
                    badge.textContent = data.unreadCount;
                    if (data.unreadCount > 0) {
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });

            socket.on('error', (data) => {
                showModal('API Error', data.message || 'An unknown error occurred with the message sending process.');
            });
        }

        /** Fetches and displays the list of chats. */
        async function fetchChatList() {
            const chatListArea = document.getElementById('chat-list-area');
            chatListArea.innerHTML = '<div class="p-4 text-center text-gray-500"><i class="ph-spinner-gap animate-spin mr-2"></i>Loading chats...</div>';
            
            try {
                const response = await fetch('/api/chats');
                if (!response.ok) throw new Error('Failed to fetch chat list');
                const chats = await response.json();
                
                chatListArea.innerHTML = '';
                chats.forEach(chat => {
                    chatListArea.appendChild(renderChatItem(chat));
                });

            } catch (error) {
                console.error('Error fetching chat list:', error);
                chatListArea.innerHTML = '<div class="p-4 text-center text-red-500">Failed to load chats. Check server status.</div>';
            }
        }
        
        /** Selects a chat, loads history, and updates UI. */
        async function selectChat(chatId) {
            currentChatId = chatId;
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('bg-fb-light-blue', 'border-l-4', 'border-fb-blue', 'bg-yellow-50');
                if (item.getAttribute('data-chat-id') === chatId) {
                    item.classList.add('bg-fb-light-blue', 'border-l-4', 'border-fb-blue');
                }
            });

            const currentChatTitle = document.getElementById('current-chat-title');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageContainer = document.getElementById('message-container');
            const selectedChat = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            const chatName = selectedChat ? selectedChat.querySelector('.font-semibold').textContent : 'Unknown User';

            currentChatTitle.textContent = chatName;
            chatInputArea.style.display = 'block';
            messageContainer.innerHTML = '<div class="text-center text-gray-500 mt-24"><i class="ph-spinner-gap animate-spin mr-2"></i>Loading history...</div>';
            
            // Mark chat as read
            await fetch(`/api/chats/${chatId}/read`, { method: 'PUT' });
            socket.emit('chat_read_status', { chatId, unreadCount: 0 }); // Local echo for immediate badge clear
            
            try {
                const response = await fetch(`/api/chats/${chatId}/history?limit=50`);
                if (!response.ok) throw new Error('Failed to fetch chat history');
                const history = await response.json();

                messageContainer.innerHTML = '';
                history.forEach(message => displayMessage(message, false));
                
                // Scroll to bottom after loading
                messageContainer.scrollTop = messageContainer.scrollHeight;

            } catch (error) {
                console.error('Error fetching chat history:', error);
                messageContainer.innerHTML = `<div class="text-center text-red-500 mt-24">Failed to load chat history.</div>`;
            }
        }

        /** Appends a message to the message container and scrolls to the bottom. */
        function displayMessage(message, shouldScroll = true) {
            document.getElementById('initial-message')?.remove();
            const messageContainer = document.getElementById('message-container');
            messageContainer.appendChild(renderMessage(message));
            if (shouldScroll) {
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
        }

        /** Handles sending the message (text or media). */
        async function sendMessage() {
            if (isSending || !currentChatId) return;

            const input = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const text = input.value.trim();
            const media = selectedFile;

            if (!text && !media) return;

            isSending = true;
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="ph-spinner-gap animate-spin text-xl"></i>';
            document.getElementById('error-message').classList.add('hidden');

            try {
                let mediaPath = null;
                let mediaType = null;
                let filename = null;
                
                if (media) {
                    mediaPath = await fileToBase64(media);
                    mediaType = media.type.startsWith('image/') ? 'photo' : 'document';
                    filename = media.name;
                }
                
                const dataToSend = { 
                    chatId: currentChatId, 
                    text: text, 
                    mediaPath: mediaPath, 
                    mediaType: mediaType, 
                    filename: filename 
                };

                // Emit to Socket.io for server processing (Telegram sending)
                socket.emit('admin_reply', dataToSend, (response) => {
                    if (response.success) {
                        console.log('Message sent successfully via Socket.io.');
                        // Local echo (The server will save it, but we echo instantly for better UX)
                        const now = new Date().toISOString();
                        const localMessage = { 
                            sender: 'admin', 
                            text: text, 
                            mediaPath: mediaPath, 
                            filename: filename,
                            timestamp: now 
                        };
                        displayMessage(localMessage);
                        
                        // Clear input fields
                        input.value = '';
                        input.style.height='auto';
                        clearFileSelection();
                        
                    } else {
                        throw new Error(response.error || 'Server failed to process the message.');
                    }

                    isSending = false;
                    updateSendButtonState();
                    sendButton.innerHTML = '<i class="ph-paper-plane-tilt text-xl"></i>';
                });

            } catch (error) {
                console.error('Error in sendMessage:', error);
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error-message').classList.remove('hidden');
                isSending = false;
                updateSendButtonState();
                sendButton.innerHTML = '<i class="ph-paper-plane-tilt text-xl"></i>';
            }
        }
        
        /** Updates the send button state based on input. */
        function updateSendButtonState() {
            const input = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const text = input.value.trim();
            
            if (isSending) return;

            if (text || selectedFile) {
                sendButton.disabled = false;
            } else {
                sendButton.disabled = true;
            }
        }

        /** Clears the file selection state. */
        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview-area').classList.add('hidden');
            updateSendButtonState();
        }

        // --- View Switching ---
        function switchView(viewName) {
            // Update Menu Items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-view') === viewName) {
                    item.classList.add('active');
                }
            });

            // Update Content Views
            document.querySelectorAll('#content-container > div').forEach(view => {
                if (view.id === 'view-' + viewName) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });
            
            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }


        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            setupSocket();
            fetchChatList(); // Initial chat list load
            
            // Menu Item Click Handlers
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => switchView(item.getAttribute('data-view')));
            });

            // Mobile Menu Toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });


            // Message Input/Send Handlers
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('input', updateSendButtonState);
            document.getElementById('message-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // File Upload Handler
            document.getElementById('file-upload').addEventListener('change', (event) => {
                selectedFile = event.target.files[0];
                if (selectedFile) {
                    document.getElementById('file-preview-name').textContent = selectedFile.name;
                    document.getElementById('file-preview-area').classList.remove('hidden');
                } else {
                    clearFileSelection();
                }
                updateSendButtonState();
            });
            
            document.getElementById('clear-file-btn').addEventListener('click', clearFileSelection);

        });

    </script>
</body>
</html>
