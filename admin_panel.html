<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Admin Interface - 2026</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration for the futuristic dark theme */
        :root {
            --primary-neon: #00e0ff; /* Electric Cyan */
            --secondary-neon: #ff00ff; /* Fuchsia */
            --dark-bg: #0d0c1d; /* Very deep indigo/slate */
            --card-bg: #1a192b; /* Slightly lighter card background */
        }

        body { 
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
            background-color: var(--dark-bg);
            color: #E2E8F0; /* Light text */
        }
        
        /* --- General UI Styles (Admin Portal & Auth View) --- */
        
        /* Sidebar: Base for the dark, futuristic look */
        .sidebar {
            background-color: #121021; /* Slightly darker than body for depth */
            box-shadow: 6px 0 15px rgba(0, 0, 0, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Nav Item Styling */
        .nav-item {
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 14px; /* Aggressive rounding */
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--primary-neon);
            transform: scale(1.02);
        }

        /* Active Nav Item - Neon Glow Effect */
        .active-nav {
            background-color: var(--card-bg) !important;
            color: var(--primary-neon) !important;
            border: 1px solid var(--primary-neon);
            box-shadow: 0 0 10px rgba(0, 224, 255, 0.5); /* Subtle glow */
        }
        .active-nav svg {
            color: var(--primary-neon) !important;
        }

        /* --- Auth UI Specific Styles --- */

        /* Custom message box for non-alert messages */
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(-10px);
            z-index: 1000;
        }
        .message-show {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Input field focus glow for Auth forms */
        .auth-input:focus {
            outline: none;
            border-color: var(--primary-neon) !important;
            box-shadow: 0 0 0 3px rgba(0, 224, 255, 0.4);
        }

        /* Toggle Button Group style (Kept for UI consistency) */
        .toggle-group button {
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .toggle-group .active-toggle {
            background-color: var(--primary-neon);
            color: var(--dark-bg);
            font-weight: 700;
            box-shadow: 0 0 15px rgba(0, 224, 255, 0.7);
        }
        
        /* Hidden Forms for Sliding Transition */
        .auth-form {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            position: absolute;
            width: 100%;
            top: 0;
            padding: 0;
        }
        #signUpForm {
            opacity: 0;
            transform: translateX(100%);
        }
        #signInForm {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- Chat Specific Styles --- */
        .chat-item {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
            border-radius: 12px;
        }
        
        .chat-item:hover {
            background-color: rgba(26, 25, 43, 0.8);
            border-color: var(--primary-neon);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 224, 255, 0.1);
        }
        
        /* Active Chat Item - Secondary Neon Accent */
        .chat-item.active {
            background-color: #581c87; 
            color: white !important; 
            border: 2px solid var(--secondary-neon);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
        }
        .chat-item.active p, .chat-item.active span, .chat-item.active .avatar-placeholder {
            color: white !important; 
            opacity: 1;
        }
        .chat-item.active .avatar-placeholder {
             background-color: var(--primary-neon) !important; 
        }

        /* Message History container */
        .chat-messages {
            max-height: calc(100vh - 230px); 
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; 
            padding: 1rem;
        }

        /* Custom Scrollbar - Neon look */
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { 
            background-color: var(--primary-neon); 
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-track {
             background-color: var(--card-bg);
        }
        
        /* Unread Badge - Sharp and secondary neon */
        .badge-style {
            background-color: var(--secondary-neon); 
            color: var(--dark-bg); 
            font-weight: 900; 
            box-shadow: 0 0 8px var(--secondary-neon);
        }

        /* Message Bubbles */
        .admin-bubble {
            background-color: #312e81; 
            color: white;
            border-bottom-right-radius: 8px !important;
        }
        .user-bubble {
            background-color: #374151; 
            color: #F9FAFB; 
            border-bottom-left-radius: 8px !important;
        }
        
        /* Card Styles for Dashboard */
        .stat-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .stat-card:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px rgba(0, 224, 255, 0.3);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-neon), var(--secondary-neon));
        }

        /* Input/Textarea Focus Glow */
        input:not(.auth-input):focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(0, 224, 255, 0.4);
            border-color: var(--primary-neon) !important;
        }

        /* Send Button Glow */
        #sendButton {
            background-color: var(--primary-neon);
            color: var(--dark-bg);
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 224, 255, 0.6);
            transition: all 0.2s;
        }
        #sendButton:hover {
             box-shadow: 0 0 15px rgba(0, 224, 255, 0.8), 0 0 5px white;
             background-color: #00ffff;
        }
    </style>
</head>
<body class="bg-[var(--dark-bg)] h-screen overflow-hidden flex flex-col sm:flex-row">

    <!-- Custom Message Box UI -->
    <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl shadow-2xl transition duration-300 transform" 
         style="min-width: 300px; background-color: #2D3748; border-left: 5px solid var(--primary-neon);">
        <p id="message-text" class="text-sm font-medium"></p>
    </div>

    <!-- === Authentication View (Initial state) === -->
    <div id="auth-view" class="flex-grow flex items-center justify-center p-4">
        <!-- Auth Card -->
        <div class="w-full max-w-md bg-[var(--card-bg)] rounded-2xl shadow-2xl p-8 space-y-6 border border-gray-700/50">
            
            <!-- Header -->
            <h1 class="text-4xl font-extrabold text-center text-[var(--primary-neon)] tracking-wider">
                QUANTUM ACCESS
            </h1>
            <p id="auth-status" class="text-center text-sm text-gray-400">
                Initializing connection to Firebase Auth...
            </p>
            
            <!-- Toggle Button Group -->
            <div class="flex bg-gray-700/50 p-1 rounded-xl toggle-group">
                <!-- Removed inline onclick handlers -->
                <button id="signInTab" data-form-type="signin"
                        class="flex-1 py-2 rounded-lg text-sm active-toggle">
                    Sign In (Simulated)
                </button>
                <button id="signUpTab" data-form-type="signup"
                        class="flex-1 py-2 rounded-lg text-sm text-gray-400">
                    Sign Up (Simulated)
                </button>
            </div>

            <!-- Form Container (Relative positioning for absolute children) -->
            <div id="form-container" class="relative h-[250px] overflow-hidden">
                
                <!-- Sign In Form -->
                <!-- Removed inline onsubmit handler -->
                <form id="signInForm" class="auth-form space-y-4 pt-4">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium mb-2 text-gray-300">User ID (Username/Email)</label>
                        <!-- Pre-filled with user's specific credentials -->
                        <input type="text" id="signin-email" required value="admin"
                               class="auth-input w-full p-3 bg-gray-900 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 transition duration-300">
                    </div>
                    <div>
                        <label for="signin-password" class="block text-sm font-medium mb-2 text-gray-300">Password</label>
                        <!-- Pre-filled with user's specific credentials -->
                        <input type="password" id="signin-password" required value="Paing@123"
                               class="auth-input w-full p-3 bg-gray-900 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 transition duration-300">
                    </div>
                    
                    <button type="submit" id="signInBtn"
                            class="w-full py-3 mt-6 bg-[var(--primary-neon)] text-primary-bg font-bold rounded-xl shadow-lg transition duration-300 hover:opacity-90 transform hover:scale-[1.01] shadow-[0_0_15px_rgba(0,224,255,0.5)] flex items-center justify-center">
                        Attempt Canvas Token Access
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        Note: Authentication uses the secure Canvas token. Input fields are for UI demonstration.
                    </p>
                </form>

                <!-- Sign Up Form -->
                <!-- Removed inline onsubmit handler -->
                <form id="signUpForm" class="auth-form space-y-4 pt-4">
                    <div>
                        <label for="signup-username" class="block text-sm font-medium mb-2 text-gray-300">Username</label>
                        <input type="text" id="signup-username" required
                               class="auth-input w-full p-3 bg-gray-900 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 transition duration-300">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium mb-2 text-gray-300">User ID (Email)</label>
                        <input type="email" id="signup-email" required
                               class="auth-input w-full p-3 bg-gray-900 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 transition duration-300">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium mb-2 text-gray-300">Create Password</label>
                        <input type="password" id="signup-password" required
                               class="auth-input w-full p-3 bg-gray-900 border border-gray-700 rounded-xl text-gray-100 placeholder-gray-500 transition duration-300">
                    </div>
                    
                    <button type="submit" id="signUpBtn"
                            class="w-full py-3 mt-6 bg-gray-500 text-gray-900 font-bold rounded-xl shadow-lg transition duration-300 hover:opacity-90 transform hover:scale-[1.01]">
                        Register New Node (Not Functional)
                    </button>
                     <p class="text-xs text-center text-red-400 mt-2">
                        Sign Up is disabled. Only Sign In with Canvas Token is supported.
                    </p>
                </form>
                
            </div>
            
        </div>
    </div>

    <!-- === Admin Portal View (Hidden until authenticated) === -->
    <div id="admin-portal" class="hidden w-full h-full flex flex-col sm:flex-row">
        
        <!-- 1. Full Sidebar (w-64) -->
        <div class="w-64 sidebar text-white flex flex-col flex-shrink-0 z-20 transition-all duration-400">
            <!-- Logo/Title -->
            <div class="p-6 text-2xl font-black flex items-center h-20 border-b border-gray-700/30">
                <svg class="w-8 h-8 mr-3 text-[var(--secondary-neon)]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.5 8.9v.2c0 .28-.22.5-.5.5h-2.5v2.5c0 .28-.22.5-.5.5h-.2a.5.5 0 01-.5-.5v-2.5H8.3a.5.5 0 01-.5-.5v-.2c0-.28.22-.5.5-.5h2.5V8.3c0-.28.22-.5.5-.5h.2c.28 0 .5.22.5.5v2.5h2.5c.28 0 .5.22.5.5z"></path></svg>
                <span class="tracking-widest">QUANTUM</span>
            </div>

            <!-- Navigation Menu -->
            <nav id="mainNav" class="p-4 space-y-2 flex-grow">
                
                <a href="#" class="nav-item flex items-center p-3 transition-all duration-200 active-nav" data-section="dashboard">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="font-medium">Dashboard</span>
                </a>
                
                <a href="#" class="nav-item flex items-center p-3 transition-all duration-200 hover:text-[var(--primary-neon)]" data-section="chat">
                    <svg class="w-6 h-6 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.804A11.95 11.95 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    <span class="font-medium">Chats</span>
                </a>
                
                <a href="#" class="nav-item flex items-center p-3 transition-all duration-200 hover:text-[var(--primary-neon)]" data-section="broadcast">
                    <svg class="w-6 h-6 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.235.986l-4.14-2.887a1.76 1.76 0 010-2.813l4.14-2.887a1.76 1.76 0 013.235.986zM18.75 16.5V7.5M15 12h3.75M21 12h3.75"></path></svg>
                    <span class="font-medium">Broadcast</span>
                </a>
                
                <a href="#" class="nav-item flex items-center p-3 transition-all duration-200 hover:text-[var(--primary-neon)]" data-section="settings">
                    <svg class="w-6 h-6 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="font-medium">Settings</span>
                </a>
                
                <!-- Replaced inline onclick with programmatic listener -->
                <a href="#" id="logoutButton" class="nav-item flex items-center p-3 transition-all duration-200 hover:text-red-400 mt-auto">
                    <svg class="w-6 h-6 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-5a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="font-medium text-red-400">Logout</span>
                </a>
            </nav>
            
            <!-- User ID Display -->
            <div class="p-4 border-t border-gray-700/30 text-xs text-gray-500 break-words">
                <p>Authenticated User ID:</p>
                <p id="userIdDisplay" class="text-[var(--primary-neon)] font-mono text-sm mt-1 truncate">N/A</p>
            </div>
        </div>

        <!-- 2. Chat List Panel (w-80) -->
        <div id="chatListPanel" class="w-80 bg-[var(--card-bg)] border-r border-gray-700/30 flex-col flex-shrink-0 transition-colors duration-400 shadow-xl hidden">
            <!-- Chat List Header -->
            <div class="p-6 text-xl font-extrabold border-b border-gray-700/30 text-white h-20 flex items-center transition-colors duration-400">
                Conversations Log
            </div>

            <!-- Chat List Search Input -->
            <div class="p-4 border-b border-gray-700/30">
                <input type="text" id="chatListSearch" placeholder="Search Chat/User ID..."
                       onkeyup="filterChatList(this.value)"
                       class="w-full p-3 border border-gray-700 bg-gray-900 rounded-xl text-gray-200 focus:ring-[var(--primary-neon)] focus:border-[var(--primary-neon)] transition duration-200 text-sm">
            </div>

            <!-- Chat List Container -->
            <div id="chatList" class="flex-grow overflow-y-auto p-4 space-y-3">
                <div class="text-center p-4 text-gray-500 text-sm">Awaiting Firebase connection...</div>
            </div>
        </div>

        <!-- 3. Main Content Area (flex-grow) -->
        <div class="flex-grow flex flex-col bg-[var(--dark-bg)] transition-colors duration-400">
            
            <!-- === SECTION: Dashboard === -->
            <div id="section-dashboard" class="main-section flex-grow p-8">
                <h1 class="text-4xl font-extrabold mb-8 text-[var(--primary-neon)] tracking-wide">
                    üöÄ Dashboard | Nexus View
                </h1>
                <p class="text-gray-400 mb-10 border-b border-gray-700/50 pb-4">
                    Real-time metrics and system status reports.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Card 1 (Neon Blue Gradient) -->
                    <div class="stat-card p-8 bg-gradient-to-br from-blue-900 to-indigo-900 text-white cursor-pointer">
                        <div class="text-6xl font-black" id="totalUsersCount">0</div>
                        <div class="text-sm mt-3 opacity-90 tracking-wider">Total Chats / Entities</div>
                    </div>
                    <!-- Card 2 (Neon Green Gradient) -->
                    <div class="stat-card p-8 bg-gradient-to-br from-green-900 to-teal-900 text-white cursor-pointer">
                        <div class="text-6xl font-black">25</div>
                        <div class="text-sm mt-3 opacity-90 tracking-wider">Active Sessions (Simulated)</div>
                    </div>
                    <!-- Card 3 (Neon Magenta/Red Gradient) -->
                    <div class="stat-card p-8 bg-gradient-to-br from-fuchsia-900 to-red-900 text-white cursor-pointer">
                        <div class="text-6xl font-black" id="unreadMessagesCount">0</div>
                        <div class="text-sm mt-3 opacity-90 tracking-wider">Unread Messages</div>
                    </div>
                </div>
                
                <div class="mt-12 bg-[var(--card-bg)] p-8 rounded-2xl shadow-2xl transition-colors duration-300 border border-gray-700/50">
                    <h3 class="text-2xl font-bold mb-4 text-[var(--secondary-neon)]">System Load Visualization</h3>
                    <p class="text-gray-500">Resource utilization over the last 24 hours.</p>
                    <div class="h-64 bg-gray-900 rounded-lg mt-4 flex items-center justify-center text-gray-700 border border-gray-700/50">
                        [Holographic Data Display Placeholder]
                    </div>
                </div>
            </div>

            <!-- === SECTION: Chat === -->
            <div id="section-chat" class="main-section flex-grow flex-col hidden">
                <!-- Chat Header -->
                <header id="chatHeader" class="p-4 border-b border-gray-700/30 bg-[var(--card-bg)] flex items-center justify-between z-10 transition-colors duration-400 h-20 shadow-md">
                    <span class="text-xl font-semibold text-gray-300">Select a Chat</span>
                </header>
                
                <!-- Chat History Search Input -->
                <div id="chatHistorySearchArea" class="p-3 bg-[var(--card-bg)] border-b border-gray-700/30 hidden">
                    <input type="text" id="chatHistorySearch" placeholder="Search Messages in History (Client-Side)..."
                           onkeyup="filterChatHistory(this.value)"
                           class="w-full p-3 border border-gray-700 bg-gray-900 rounded-xl text-gray-200 focus:ring-[var(--primary-neon)] focus:border-[var(--primary-neon)] transition duration-200 text-sm">
                </div>

                <!-- Message History -->
                <div id="messageHistory" class="flex-grow chat-messages bg-[var(--dark-bg)] transition-colors duration-400">
                    <div class="text-center text-gray-600">No chat selected yet. Select an entity from the left.</div>
                </div>

                <!-- Message Input -->
                <div id="chatInputArea" class="p-4 bg-[var(--card-bg)] transition-colors duration-400 shadow-2xl hidden min-h-[100px] border-t border-gray-700/50">
                    
                    <!-- File/Image Preview Area (File sending is simulated/placeholder) -->
                    <div id="filePreview" class="hidden border border-gray-700/50 bg-gray-900/50 rounded-xl p-3 mb-2">
                         <div class="text-sm text-gray-400">File sending is a placeholder for this environment.</div>
                    </div>

                    <div class="flex space-x-2">
                        <!-- Hidden File Input (Disabled for simplicity) -->
                        <button disabled 
                                class="text-gray-600 p-4 rounded-xl flex items-center justify-center opacity-50 cursor-not-allowed">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        </button>
                        
                        <!-- Input field -->
                        <!-- The Enter key handler (onkeypress) remains inline as it calls the module-scoped sendReply, but we must ensure sendReply is hoisted or accessible. In a module, this is usually fine if sendReply is global, but in a type="module" script, it is not. However, since the error was on switchForm/handleAuth, and fixing those by programmatic linking is better, let's leave this one small onkeypress and see if it works, otherwise, it will also need programmatic binding. sendReply is not defined globally. I will attach it programmatically as well. -->
                        <input type="text" id="replyText" placeholder="Transmit data packet (Powered by Firestore)..."
                               class="flex-grow border border-gray-700 bg-gray-900 rounded-xl p-4 text-base text-gray-100 transition duration-200">
                               
                        <!-- Send button -->
                        <!-- Removed inline onclick and attached listener programmatically -->
                        <button id="sendButton" 
                                class="p-4 rounded-xl flex items-center justify-center transform hover:scale-[1.05]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- === SECTION: Broadcast / Settings (Placeholder) === -->
             <div id="section-broadcast" class="main-section flex-grow p-8 hidden">
                <h1 class="text-4xl font-extrabold mb-8 text-[var(--primary-neon)] tracking-wide">üì£ Global Broadcast Matrix</h1>
                <div class="bg-[var(--card-bg)] p-8 rounded-2xl shadow-xl border border-gray-700/50 transition-colors duration-300">
                    <p class="text-xl text-gray-300">This feature is pending integration with the Gemini API for bulk communication.</p>
                </div>
            </div>

            <div id="section-settings" class="main-section flex-grow p-8 hidden">
                <h1 class="text-4xl font-extrabold mb-8 text-[var(--primary-neon)] tracking-wide">‚öôÔ∏è System Configuration</h1>
                <div class="bg-[var(--card-bg)] p-8 rounded-2xl shadow-xl border border-gray-700/50 transition-colors duration-300">
                    <h3 class="text-2xl font-semibold mb-3 text-gray-200">Firebase Status</h3>
                    <p class="text-sm text-gray-400 mb-4">
                        Status: <span id="firebaseStatus" class="font-bold text-green-400">Connected</span>
                    </p>
                    <p class="text-sm text-gray-400">
                        App ID: <span class="font-mono text-[var(--primary-neon)]" id="appIdDisplay">N/A</span>
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- 4. Firebase and JavaScript Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // setLogLevel('debug'); // Uncomment to see Firebase logs

        // --- Client-side State Management ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quantum-admin';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = null;
        let isAuthReady = false; 
        
        let currentChatId = null;
        let unsubscribeChatHistory = null;
        let allChats = []; 
        let unreadCounts = {}; 

        // UI Elements
        const authView = document.getElementById('auth-view');
        const adminPortal = document.getElementById('admin-portal');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const chatListElement = document.getElementById('chatList');
        const historyContainer = document.getElementById('messageHistory');
        const totalUsersCount = document.getElementById('totalUsersCount');
        const unreadMessagesCount = document.getElementById('unreadMessagesCount');
        const signInForm = document.getElementById('signInForm');
        const signUpForm = document.getElementById('signUpForm');
        const formContainer = document.getElementById('form-container');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');


        // --- Firestore Paths ---
        // Public collection for shared chat data (all users can read/write)
        function getChatCollectionRef() {
            return collection(db, `/artifacts/${appId}/public/data/chats`);
        }
        
        function getMessageCollectionRef(chatId) {
            return collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
        }
        
        // --- Utility Functions (same as previous version, stripped of unused file logic) ---

        /**
         * Utility to display custom UI messages instead of alerts.
         */
        function showMessage(message, type = 'info') {
            const colors = {
                success: { background: '#15803d', border: '#4ade80' }, 
                error: { background: '#b91c1c', border: '#f87171' }, 
                info: { background: '#2D3748', border: getComputedStyle(document.documentElement).getPropertyValue('--primary-neon') } 
            };

            const style = colors[type] || colors.info;

            messageBox.style.backgroundColor = style.background;
            messageBox.style.borderLeftColor = style.border;
            messageText.textContent = message;
            
            messageBox.classList.add('message-show');
            
            setTimeout(() => {
                messageBox.classList.remove('message-show');
            }, 3000); 
        }

        function updateFormContainerHeight(formElement) {
            formElement.style.position = 'static';
            formElement.style.opacity = '1';
            formElement.style.transform = 'none';
            
            const height = formElement.offsetHeight + 40; 
            formContainer.style.height = `${height}px`;

            formElement.style.position = 'absolute';
            if (formElement.id === 'signInForm') {
                formElement.style.opacity = '1';
                formElement.style.transform = 'translateX(0)';
            } else {
                 formElement.style.opacity = '0';
                 formElement.style.transform = 'translateX(100%)';
            }
        }

        /**
         * FIX: This function is now called programmatically via event listeners.
         */
        function switchForm(type) {
            const signInTab = document.getElementById('signInTab');
            const signUpTab = document.getElementById('signUpTab');

            if (type === 'signin') {
                signInForm.style.transform = 'translateX(0)';
                signInForm.style.opacity = '1';
                signUpForm.style.transform = 'translateX(100%)';
                signUpForm.style.opacity = '0';
                
                signInTab.classList.add('active-toggle');
                signUpTab.classList.remove('active-toggle');
                signUpTab.classList.add('text-gray-400');
                signInTab.classList.remove('text-gray-400');
                
                updateFormContainerHeight(signInForm);
            } else if (type === 'signup') {
                signInForm.style.transform = 'translateX(-100%)';
                signInForm.style.opacity = '0';
                signUpForm.style.transform = 'translateX(0)';
                signUpForm.style.opacity = '1';

                signUpTab.classList.add('active-toggle');
                signInTab.classList.remove('active-toggle');
                signInTab.classList.add('text-gray-400');
                signUpTab.classList.remove('text-gray-400');

                updateFormContainerHeight(signUpForm);
            }
        }
        
        // --- Firebase/Auth Functions ---

        /**
         * Attempts to log in using the custom Canvas token or anonymously.
         * FIX: This function is now called programmatically via event listeners.
         */
        async function handleAuth(event, type) {
            event.preventDefault();
            
            if (type === 'signup') {
                showMessage("Sign Up is disabled. Please use the Canvas environment's authentication token.", 'error');
                return;
            }

            const button = document.getElementById('signInBtn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>';

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    // onAuthStateChanged listener handles the rest
                } else {
                    await signInAnonymously(auth);
                    // onAuthStateChanged listener handles the rest
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage(`Authentication failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        /**
         * Switches the view to the Admin Portal.
         */
        function login(user) {
            userId = user.uid;
            userIdDisplay.textContent = userId;
            
            authView.classList.add('hidden');
            adminPortal.classList.remove('hidden');
            showMessage(`[ACCESS GRANTED] Connected as ${user.isAnonymous ? 'Anonymous' : 'Authenticated'} user.`, 'success');
            
            // Start listening to the chat list once authenticated
            fetchChats();
            // Ensure first section is shown
            showSection('dashboard');
        }

        /**
         * Switches the view back to the Authentication Portal.
         */
        async function logout() {
            try {
                await signOut(auth);
                adminPortal.classList.add('hidden');
                authView.classList.remove('hidden');
                historyContainer.innerHTML = '<div class="text-center text-gray-600">No chat selected yet. Select an entity from the left.</div>';
                
                // Clear state
                userId = null;
                isAuthReady = false;
                userIdDisplay.textContent = 'N/A';
                allChats = [];
                unreadCounts = {};
                if (unsubscribeChatHistory) unsubscribeChatHistory();
                currentChatId = null;
                
                showMessage('[SESSION TERMINATED] Access revoked. Please sign in again.', 'info');
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage(`Logout failed: ${error.message}`, 'error');
            }
        }


        // --- Chat UI Helpers (Minimal Changes) ---

        function createChatListItem(chat) {
            const chatId = chat.id;
            const displayId = String(chatId).length > 10 ? String(chatId).substring(0, 10) + '...' : chatId;
            // Use 'name' or fallback to a shortened ID
            const username = chat.name || `Chat Entity ${displayId}`;
            const count = unreadCounts[chatId] || 0; 

            const chatElement = document.createElement('div');
            chatElement.id = `chat-${chatId}`;
            // Use data-name for filtering
            chatElement.className = 'chat-item flex items-start p-4 relative text-gray-200 shadow-lg hover:shadow-2xl cursor-pointer';
            chatElement.setAttribute('data-chat-id', chatId);
            chatElement.setAttribute('data-name', username.toLowerCase());

            const unreadBadge = count > 0 ? `<span class="badge-style absolute top-2 right-2 text-xs h-6 w-6 flex items-center justify-center p-1 rounded-full">${count > 99 ? '99+' : count}</span>` : '';

            const avatar = `
                <div class="avatar-placeholder flex items-center justify-center mr-3 flex-shrink-0 w-10 h-10 rounded-full bg-indigo-700/50 text-[var(--primary-neon)] border border-[var(--primary-neon)]/50">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </div>
            `;
            // Display only the last message text, not media info
            const lastMessageText = chat.lastMessage?.text || chat.lastMessage?.mediaType || '[No recent communication]';

            chatElement.innerHTML = `
                ${avatar}
                <div class="flex-grow min-w-0">
                    <p class="font-bold truncate text-base">${username}</p>
                    <p class="text-xs text-[var(--primary-neon)] opacity-70 mt-0.5">ID: ${displayId}</p>
                    <p class="text-sm text-gray-400 truncate mt-1">${lastMessageText}</p>
                </div>
                ${unreadBadge}
            `;

            chatElement.addEventListener('click', () => {
                selectChat(chatId, username);
            });

            return chatElement;
        }

        function createMessageBubble(msg) {
            // Note: In a real system, 'sender' would be checked against the logged-in user ID.
            // Here, we simulate 'user' (external) and 'admin' (this user) based on the 'senderId' field.
            const isUser = msg.senderId !== userId;
            const alignment = isUser ? 'justify-start' : 'justify-end';
            const bubbleClass = isUser ? 'user-bubble' : 'admin-bubble';
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble flex ${alignment} mb-3`;
            
            const timeString = new Date(msg.timestamp.toDate ? msg.timestamp.toDate() : msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let mediaContent = ''; // Placeholder for media

            messageElement.innerHTML = `
                <div class="message-content max-w-[80%] md:max-w-[60%] p-3 rounded-t-xl rounded-bl-xl rounded-br-xl shadow-xl ${bubbleClass}" data-text="${(msg.text || '').toLowerCase()}">
                    ${mediaContent}
                    <p class="${msg.text ? 'block' : 'hidden'} text-base leading-relaxed">${msg.text || ''}</p>
                    <span class="block text-[10px] opacity-70 mt-1 ${isUser ? 'text-gray-400' : 'text-indigo-200'} text-right">
                        ${timeString}
                    </span>
                </div>
            `;
            return messageElement;
        }

        // --- Navigation Functions ---
        function showSection(sectionId) {
            document.querySelectorAll('.main-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));

            const targetSection = document.getElementById(`section-${sectionId}`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            const activeNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active-nav');
            }

            const chatListPanel = document.getElementById('chatListPanel');
            if (sectionId === 'chat') {
                chatListPanel.classList.remove('hidden');
                targetSection.classList.add('flex-col');
                document.getElementById('chatHistorySearchArea').classList.remove('hidden'); 
            } else {
                chatListPanel.classList.add('hidden');
                // Ensure chat listeners are removed when leaving chat section
                if (unsubscribeChatHistory) {
                    unsubscribeChatHistory();
                    unsubscribeChatHistory = null;
                }
                currentChatId = null;
            }
            
            // Update Dashboard metrics if switching to dashboard
            if (sectionId === 'dashboard') {
                totalUsersCount.textContent = allChats.length;
                unreadMessagesCount.textContent = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
            }
        }

        // --- Firestore Chat Logic ---

        /**
         * Listens for real-time updates on the list of active chats/users.
         */
        function fetchChats() {
            if (!isAuthReady) return;

            const chatsRef = getChatCollectionRef();
            const q = query(chatsRef, limit(50)); // Limit to 50 active chats

            onSnapshot(q, (snapshot) => {
                const updatedChats = [];
                let newUnreadCounts = {};
                
                snapshot.docChanges().forEach(change => {
                    const chatData = { id: change.doc.id, ...change.doc.data() };

                    // Recalculate unread counts based on last admin read status
                    const lastReadTime = chatData.lastReadByAdmin?.toDate ? chatData.lastReadByAdmin.toDate().getTime() : 0;
                    const lastMessageTime = chatData.lastMessage?.timestamp?.toDate ? chatData.lastMessage.timestamp.toDate().getTime() : 0;
                    
                    // Simple heuristic: if last message time is after last read time, mark as potentially unread (1)
                    // In a production app, we would query the messages collection for a proper unread count.
                    const isUnread = lastMessageTime > lastReadTime;
                    newUnreadCounts[chatData.id] = isUnread ? 1 : 0; 

                    if (change.type === 'added' || change.type === 'modified') {
                         updatedChats.push(chatData);
                    } else if (change.type === 'removed') {
                        // Remove from list
                    }
                });

                allChats = updatedChats.sort((a, b) => {
                    const timeA = a.lastMessage?.timestamp?.toDate ? a.lastMessage.timestamp.toDate() : new Date(0);
                    const timeB = b.lastMessage?.timestamp?.toDate ? b.lastMessage.toDate() : new Date(0);
                    return timeB - timeA; // Sort by most recent message first
                });
                
                unreadCounts = newUnreadCounts;
                renderChatList();
            }, (error) => {
                console.error("Error fetching chats:", error);
                chatListElement.innerHTML = `<div class="text-center p-4 text-red-500 text-sm">Error fetching chats: ${error.message}</div>`;
            });
        }
        
        function renderChatList() {
            chatListElement.innerHTML = '';
             if (allChats.length === 0) {
                chatListElement.innerHTML = '<div class="text-center p-4 text-gray-600">No active communication threads detected.</div>';
                return;
            }
            
            filterChatList(document.getElementById('chatListSearch').value || '');

            // Update dashboard counts
            totalUsersCount.textContent = allChats.length;
            unreadMessagesCount.textContent = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
        }

        function filterChatList(query) {
            const lowerCaseQuery = query.toLowerCase().trim();
            chatListElement.innerHTML = ''; 

            const filteredChats = allChats.filter(chat => {
                const name = (chat.name || '').toLowerCase();
                const chatId = String(chat.id);
                return name.includes(lowerCaseQuery) || chatId.includes(lowerCaseQuery);
            });
            
            if (filteredChats.length > 0) {
                filteredChats.forEach(chat => {
                    chatListElement.appendChild(createChatListItem(chat));
                });
            } else {
                chatListElement.innerHTML = `<div class="text-center p-4 text-gray-600 text-sm">No entities match search query: "${query}"</div>`;
            }

            // Re-apply active class
            if (currentChatId) {
                const activeChatElement = document.getElementById(`chat-${currentChatId}`);
                if (activeChatElement) activeChatElement.classList.add('active');
            }
        }


        /**
         * Selects a chat, updates the UI, and sets up a new Firestore listener for messages.
         */
        function selectChat(chatId, username) {
            if (unsubscribeChatHistory) {
                unsubscribeChatHistory(); // Unsubscribe from the previous chat's history
            }
            currentChatId = chatId;

            document.getElementById('chatHeader').innerHTML = `
                <div class="flex flex-col">
                    <span class="text-xl font-semibold text-gray-300">${username}</span>
                    <span class="text-sm font-medium text-[var(--primary-neon)] opacity-80">ID: ${chatId} | Live Feed</span>
                </div>
            `;
            document.getElementById('chatInputArea').classList.remove('hidden');
            
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const activeChatElement = document.getElementById(`chat-${chatId}`);
            if (activeChatElement) {
                activeChatElement.classList.add('active');
                // Clear unread count locally and update Firestore status
                unreadCounts[chatId] = 0;
                const badge = activeChatElement.querySelector('.badge-style');
                if (badge) badge.remove();
                
                // Update Firestore document to mark as read
                const chatDocRef = doc(getChatCollectionRef(), chatId);
                updateDoc(chatDocRef, {
                    lastReadByAdmin: new Date(), 
                    unreadCount: 0 // Optional, if we tracked count
                }).catch(e => console.error("Error marking chat as read:", e));
            }
            
            historyContainer.innerHTML = '<div class="text-center text-gray-600">Establishing real-time data link...</div>';

            const messagesRef = getMessageCollectionRef(chatId);
            // Query messages: ordered by timestamp, last 50 messages
            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(50));
            
            // Set up new listener
            unsubscribeChatHistory = onSnapshot(q, (snapshot) => {
                historyContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    historyContainer.innerHTML = '<div class="text-center text-gray-600">No communication history found for this entity.</div>';
                    return;
                }
                
                // Use a document fragment for performance
                const fragment = document.createDocumentFragment();
                // Since we query by 'desc' (most recent first), we must append the items in reverse 
                // order to maintain the correct display order (oldest at top of view, newest at bottom).
                
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                messages.reverse().forEach(msg => { // Process from oldest to newest
                    fragment.appendChild(createMessageBubble(msg));
                });
                
                historyContainer.appendChild(fragment);
                historyContainer.scrollTop = 0; // Scroll to the top (most recent message)
                
            }, (error) => {
                console.error(`Error fetching chat history for ${chatId}:`, error);
                historyContainer.innerHTML = `<div class="text-center p-4 text-red-500">Error retrieving data packets: ${error.message}</div>`;
            });
        }


        /**
         * Sends a reply by adding a new message document to the Firestore subcollection.
         */
        async function sendReply() {
            if (!currentChatId || !userId) {
                showMessage("System not ready or no chat selected.", 'error');
                return;
            }

            const replyInput = document.getElementById('replyText');
            const text = replyInput.value.trim();

            if (!text) {
                showMessage("Transmission aborted: Empty data packet.", 'info');
                return;
            }

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>';

            try {
                const newMessage = {
                    senderId: userId, // The admin's user ID
                    text: text,
                    timestamp: new Date(),
                    read: false, // Mark for the external user to read
                    type: 'text'
                };
                
                const messagesRef = getMessageCollectionRef(currentChatId);
                await addDoc(messagesRef, newMessage);

                // Update the parent chat document with the last message summary
                const chatDocRef = doc(getChatCollectionRef(), currentChatId);
                await updateDoc(chatDocRef, {
                    lastMessage: {
                        text: text,
                        timestamp: newMessage.timestamp,
                        senderId: userId
                    },
                    lastReadByAdmin: newMessage.timestamp, // Mark as read by admin instantly
                });

                replyInput.value = '';
                showMessage("Data packet transmitted successfully.", 'success');

            } catch (error) {
                console.error("Error transmitting data packet:", error);
                showMessage(`Transmission failed: ${error.message}`, 'error');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>';
            }
        }


        // ------------------------------------------------------------------
        // Initialization
        // ------------------------------------------------------------------

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set session persistence (optional, but good practice)
                setPersistence(auth, browserSessionPersistence);

                // Listener for authentication state change
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        authStatus.textContent = 'Connection established.';
                        login(user);
                    } else {
                        // If auth failed or user logged out, display auth view
                        authView.classList.remove('hidden');
                        adminPortal.classList.add('hidden');
                        authStatus.textContent = 'Ready to establish connection.';
                    }
                });

                // Display App ID in settings
                document.getElementById('appIdDisplay').textContent = appId;
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                authStatus.textContent = `Error: ${error.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Hide the admin portal initially until auth confirms
            adminPortal.classList.add('hidden');
            authView.classList.remove('hidden');
            
            // --- FIX: Programmatically attach event listeners to replace inline handlers ---
            
            // 1. Auth form tab switching
            document.getElementById('signInTab').addEventListener('click', () => switchForm('signin'));
            document.getElementById('signUpTab').addEventListener('click', () => switchForm('signup'));

            // 2. Auth form submission
            document.getElementById('signInForm').addEventListener('submit', (event) => handleAuth(event, 'signin'));
            document.getElementById('signUpForm').addEventListener('submit', (event) => handleAuth(event, 'signup'));
            
            // 3. Chat input and send button
            const replyInput = document.getElementById('replyText');
            replyInput.addEventListener('keypress', (event) => {
                if(event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission if input was inside a form
                    sendReply();
                }
            });
            document.getElementById('sendButton').addEventListener('click', sendReply);
            
            // 4. Navigation and Logout button
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Check if it's the Logout button by ID
                    if (item.id === 'logoutButton') {
                        logout();
                    } else if (item.getAttribute('data-section')) {
                        showSection(item.getAttribute('data-section'));
                    }
                });
            });
            // --- END FIX ---


            initializeFirebase();
            
            // Set initial height for sign in form
            updateFormContainerHeight(signInForm);
        });

    </script>
</body>
</html>
