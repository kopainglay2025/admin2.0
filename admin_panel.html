<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Messenger Panel</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap');
        body { font-family: 'Padauk', sans-serif; }
        /* Messenger Style */
        .user-message {
            background-color: #e2e8f0; /* Gray-200 */
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            color: #1a202c; /* Gray-900 */
            max-width: 80%;
            align-self: flex-start;
        }
        .admin-message {
            background-color: #3b82f6; /* Blue-500 */
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            color: white;
            max-width: 80%;
            align-self: flex-end;
        }
        /* Custom scrollbar for chat window */
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-track { background-color: #f1f5f9; }

        /* Custom active state for navigation */
        .nav-item.active {
            background-color: #1d4ed8; /* Blue-700 */
            color: white;
            border-left: 4px solid #fcd34d; /* Amber-300 */
        }
        .nav-item:hover:not(.active) {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex antialiased">

    <!-- Main Container: Chat Layout -->
    <div class="flex flex-row w-full h-full shadow-2xl rounded-xl overflow-hidden m-4 bg-white">

        <!-- Left Panel: Menu Navigation & Chat List -->
        <div class="w-1/4 bg-gray-900 border-r border-gray-800 flex flex-col overflow-hidden">
            
            <!-- App Header -->
            <div class="p-4 border-b border-gray-700 bg-gray-950 text-white font-extrabold text-2xl sticky top-0 z-20">
                Admin Console
            </div>

            <!-- Menu Navigation -->
            <nav id="main-nav" class="flex flex-col py-2 border-b border-gray-700">
                <a href="#" class="nav-item p-3 px-6 text-gray-300 transition duration-150" data-view="dashboard">
                    Dashboard
                </a>
                <a href="#" class="nav-item active p-3 px-6 text-white transition duration-150" data-view="chat">
                    Chat
                </a>
                <a href="#" class="nav-item p-3 px-6 text-gray-300 transition duration-150" data-view="broadcast">
                    Broadcast
                </a>
                <a href="#" class="nav-item p-3 px-6 text-gray-300 transition duration-150" data-view="settings">
                    Settings
                </a>
            </nav>
            
            <!-- Chat List Header -->
            <div id="chat-list-header" class="p-3 bg-gray-800 text-gray-200 font-semibold text-lg sticky top-[210px] z-10 hidden" data-for-view="chat">
                á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸
            </div>
            
            <!-- Chat List Container -->
            <div id="user-list-container" class="overflow-y-auto flex-grow hidden" data-for-view="chat">
                <!-- Placeholder for loading -->
                <div class="p-4 text-center text-gray-400" id="loading-chats">á€…á€¬á€›á€„á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€šá€°á€”á€±á€á€Šá€º...</div>
            </div>
        </div>

        <!-- Right Panel: Dynamic Content Area -->
        <div id="content-area" class="w-3/4 flex flex-col">
            
            <!-- View: Dashboard -->
            <div id="view-dashboard" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard</h1>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg">
                    <p class="font-bold">á€á€á€­á€•á€±á€¸á€á€»á€€á€º:</p>
                    <p>á€¤á€á€Šá€ºá€™á€¾á€¬ Dashboard á€§á€›á€­á€šá€¬á€–á€¼á€…á€ºá€á€Šá€ºá‹ Chat á€…á€”á€…á€ºá á€…á€¬á€›á€„á€ºá€¸á€¡á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬- á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°áŠ á€á€…á€ºá€›á€€á€ºá€á€¬ message á€¡á€›á€±á€¡á€á€½á€€á€º) á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€•á€¼á€á€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
                <!-- ... Dashboard Widgets ... -->
            </div>

            <!-- View: Chat (Default View) -->
            <div id="view-chat" class="view-content flex flex-col h-full">
                <!-- Chat Header -->
                <div id="chat-header" class="p-4 border-b bg-white shadow-sm sticky top-0 z-10">
                    <p id="current-chat-title" class="font-bold text-xl text-gray-800">
                        á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€›á€”á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«
                    </p>
                    <p id="current-chat-subtitle" class="text-sm text-gray-500"></p>
                </div>

                <!-- Chat Messages Window -->
                <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col">
                    <!-- Messages will be dynamically inserted here -->
                    <div class="flex justify-center items-center h-full text-gray-400 text-lg" id="no-chat-selected">
                        á€˜á€šá€ºá€˜á€€á€ºá€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€á€…á€ºá€¦á€¸á€¦á€¸á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ á€…á€á€„á€ºá€•á€¼á€±á€¬á€†á€­á€¯á€•á€«á‹
                    </div>
                </div>

                <!-- Message Input -->
                <div id="message-input-area" class="p-4 border-t bg-gray-50">
                    <form id="reply-form" class="flex" onsubmit="handleReply(event)">
                        <input type="text" id="reply-text" placeholder="Admin á€¡á€”á€±á€–á€¼á€„á€·á€º á€•á€¼á€”á€ºá€œá€Šá€ºá€–á€¼á€±á€€á€¼á€¬á€¸á€›á€”á€º á€…á€¬á€›á€­á€¯á€€á€ºá€•á€«..."
                               class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-200"
                               disabled required>
                        <button type="submit" id="send-button"
                                class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-150"
                                disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- View: Broadcast -->
            <div id="view-broadcast" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Broadcast Message</h1>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
                    <p class="font-bold">á€¡á€á€»á€€á€ºá€¡á€œá€€á€º:</p>
                    <p>á€¤á€”á€±á€›á€¬á€™á€¾ Telegram á€›á€¾á€­ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€¬á€¸á€œá€¯á€¶á€¸á€á€­á€¯á€· á€á€…á€ºá€•á€¼á€­á€¯á€„á€ºá€á€Šá€ºá€¸ á€…á€¬á€™á€»á€¬á€¸ á€•á€­á€¯á€·á€”á€­á€¯á€„á€ºá€›á€”á€º á€…á€®á€…á€‰á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
                <!-- ... Broadcast Form ... -->
                <textarea class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="á€•á€­á€¯á€·á€œá€­á€¯á€á€±á€¬ á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«..."></textarea>
                <button class="mt-4 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition duration-150">Broadcast á€…á€á€„á€ºá€•á€«</button>
            </div>

            <!-- View: Settings -->
            <div id="view-settings" class="view-content p-8 h-full bg-gray-50 overflow-y-auto hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Settings</h1>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <p class="font-bold">á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸:</p>
                    <p>á€¤á€”á€±á€›á€¬á€á€½á€„á€º Admin Account á€…á€€á€¬á€¸á€á€¾á€€á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Bot á á€¡á€á€¼á€±á€á€¶ á€á€»á€­á€”á€ºá€Šá€¾á€­á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€¯á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
                </div>
                <!-- ... Settings Options ... -->
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        const apiBaseUrl = window.location.origin;

        let activeChats = [];
        let currentChatId = null;
        let currentView = 'chat'; // Default view is 'chat'

        const navItems = document.querySelectorAll('.nav-item');
        const viewContents = document.querySelectorAll('.view-content');
        const chatListHeader = document.getElementById('chat-list-header');
        const userListContainer = document.getElementById('user-list-container');
        const chatWindow = document.getElementById('chat-window');
        const chatHeaderTitle = document.getElementById('current-chat-title');
        const chatHeaderSubtitle = document.getElementById('current-chat-subtitle');
        const replyText = document.getElementById('reply-text');
        const sendButton = document.getElementById('send-button');
        const noChatSelected = document.getElementById('no-chat-selected');

        // Helper function to format time
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('my-MM', {
            hour: '2-digit', minute: '2-digit', hour12: true
        });

        // ------------------------------------
        // Menu Navigation Function
        // ------------------------------------

        const switchView = (viewId) => {
            currentView = viewId;

            // áá‹ Navigation Item á€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            navItems.forEach(item => {
                item.classList.remove('active', 'text-white', 'text-gray-300');
                if (item.getAttribute('data-view') === viewId) {
                    item.classList.add('active', 'text-white');
                } else {
                    item.classList.add('text-gray-300');
                }
            });

            // á‚á‹ Content View á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            viewContents.forEach(view => {
                if (view.id === `view-${viewId}`) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });

            // áƒá‹ Chat View á€¡á€á€½á€€á€º Left Panel á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€á€¼á€„á€ºá€¸
            const isChatView = viewId === 'chat';
            chatListHeader.classList.toggle('hidden', !isChatView);
            userListContainer.classList.toggle('hidden', !isChatView);

            // Chat view á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€•á€«á€€ á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ refresh á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            if (isChatView && activeChats.length === 0) {
                fetchChats();
            }
        };

        // Event listener for navigation
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.getAttribute('data-view'));
            });
        });

        // ------------------------------------
        // UI Rendering Functions
        // ------------------------------------

        // áá‹ Chat Message á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderMessage = (message) => {
            const isUser = message.sender === 'user';
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 shadow-md text-sm ${isUser ? 'user-message' : 'admin-message'}`;
            bubble.innerHTML = `
                <p class="whitespace-pre-wrap">${message.text}</p>
                <span class="block text-xs mt-1 opacity-75 text-right">${formatTime(message.timestamp)}</span>
            `;
            messageEl.appendChild(bubble);
            chatWindow.appendChild(messageEl);
        };

        // á‚á‹ Chat List á€€á€­á€¯ Render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
        const renderChatList = () => {
            userListContainer.innerHTML = ''; // á€…á€¬á€›á€„á€ºá€¸á€Ÿá€±á€¬á€„á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
            const fragment = document.createDocumentFragment();

            activeChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.dataset.chatId = chat.telegramId;
                // Chat List item style á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€Šá€¾á€­á€á€¼á€„á€ºá€¸
                chatItem.className = `p-4 border-b border-gray-700 text-white cursor-pointer hover:bg-gray-700 transition duration-150 ${currentChatId === chat.telegramId ? 'bg-blue-600 font-semibold' : 'bg-gray-800'}`;

                // á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ Message á€¡á€á€»á€­á€”á€ºá€€á€­á€¯ á€á€½á€€á€ºá€á€»á€€á€ºá€á€¼á€„á€ºá€¸
                const lastMsgTime = chat.lastMessageTime ? new Date(chat.lastMessageTime) : new Date(chat.createdAt);
                const timeString = lastMsgTime.toLocaleDateString('my-MM', { month: 'short', day: 'numeric' }) + ' ' + lastMsgTime.toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });

                chatItem.innerHTML = `
                    <p class="text-base truncate">${chat.username}</p>
                    <p class="text-xs text-gray-400 mt-1">${timeString}</p>
                `;

                chatItem.onclick = () => selectChat(chat.telegramId);
                fragment.appendChild(chatItem);
            });
            userListContainer.appendChild(fragment);
        };

        // áƒá‹ Chat á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸ History á€€á€­á€¯ á€á€„á€ºá€á€¼á€„á€ºá€¸
        const selectChat = async (chatId) => {
            currentChatId = chatId;
            
            // UI á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
            const user = activeChats.find(c => c.telegramId === chatId);
            chatHeaderTitle.textContent = user.username;
            chatHeaderSubtitle.textContent = `Telegram ID: ${chatId}`;
            noChatSelected.classList.add('hidden');
            replyText.disabled = false;
            sendButton.disabled = false;
            chatWindow.innerHTML = '<div class="text-center text-gray-500">History á€€á€­á€¯ á€›á€šá€°á€”á€±á€á€Šá€º...</div>';
            
            // Active chat á€€á€­á€¯ á€™á€®á€¸á€™á€±á€¬á€„á€ºá€¸á€‘á€­á€¯á€¸á€•á€¼á€›á€”á€º chat list á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€º render á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            renderChatList();

            try {
                // HTTP Basic Auth Credentials á€€á€­á€¯ fetch request á€á€½á€„á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º
                // á€¤á€”á€±á€›á€¬á€á€½á€„á€º Browser á€™á€¾ Auth á€€á€­á€¯ á€™á€¾á€á€ºá€‘á€¬á€¸á€•á€¼á€®á€¸á€–á€¼á€…á€ºá€•á€«á€€ áá€„á€ºá€¸á€€á€­á€¯ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€•á€«á€™á€Šá€ºá‹
                const response = await fetch(`${apiBaseUrl}/api/chats/${chatId}/history`);

                if (response.status === 401) {
                    throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                }
                if (!response.ok) throw new Error('History á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');
                
                const history = await response.json();

                chatWindow.innerHTML = ''; // loading á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
                history.forEach(renderMessage);
                chatWindow.scrollTop = chatWindow.scrollHeight; // á€¡á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€á€¼á€„á€ºá€¸
            } catch (error) {
                chatWindow.innerHTML = `<div class="text-center text-red-500">Chat history á€€á€­á€¯ á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€á€Šá€º: ${error.message}</div>`;
                console.error("Fetch history error:", error);
            }
        };

        // á„á‹ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ API á€™á€¾ á€›á€šá€°á€á€¼á€„á€ºá€¸
        const fetchChats = async () => {
            document.getElementById('loading-chats').classList.remove('hidden');
            try {
                const response = await fetch(`${apiBaseUrl}/api/chats`);
                
                if (response.status === 401) {
                    throw new Error('Authentication á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º (Login á€…á€…á€ºá€†á€±á€¸á€•á€«)');
                }
                if (!response.ok) throw new Error('Chat list á€›á€šá€°á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«');

                activeChats = await response.json();
                renderChatList();
            } catch (error) {
                console.error("Fetch chats error:", error);
                userListContainer.innerHTML = `<div class="p-4 text-center text-red-500">á€…á€¬á€›á€„á€ºá€¸á€›á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á‹ Server á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹ (${error.message})</div>`;
            } finally {
                document.getElementById('loading-chats').classList.add('hidden');
            }
        };

        // ------------------------------------
        // Event Handlers
        // ------------------------------------

        // Admin á€™á€¾ Message á€•á€¼á€”á€ºá€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
        const handleReply = (event) => {
            event.preventDefault();
            const text = replyText.value.trim();

            if (!text || !currentChatId) return;

            // Socket.io á€™á€¾á€á€…á€ºá€†á€„á€·á€º Server á€€á€­á€¯ message á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
            socket.emit('admin_reply', { chatId: currentChatId, text });

            // UI á€á€½á€„á€º á€á€»á€€á€ºá€á€»á€„á€ºá€¸ á€•á€¼á€á€á€¼á€„á€ºá€¸ (Local Echo)
            const tempMessage = {
                chatId: currentChatId,
                sender: 'admin',
                text: text,
                timestamp: new Date().toISOString()
            };
            renderMessage(tempMessage);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            replyText.value = '';
        };

        // ------------------------------------
        // Socket.io Real-time Handling
        // ------------------------------------
        
        // Telegram Bot á€™á€¾ message á€¡á€á€…á€º á€›á€±á€¬á€€á€ºá€œá€¬á€á€±á€¬á€¡á€á€«
        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // áá‹ Chat List á€€á€­á€¯ á€¡á€•á€ºá€’á€­á€á€ºá€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
            const existingIndex = activeChats.findIndex(c => c.telegramId === chatId);
            if (existingIndex > -1) {
                // á€›á€¾á€­á€•á€¼á€®á€¸á€á€¬á€¸ chat á€€á€­á€¯ á€¡á€•á€±á€«á€ºá€†á€¯á€¶á€¸á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€›á€”á€º
                const updatedUser = activeChats.splice(existingIndex, 1)[0];
                updatedUser.lastMessageTime = new Date();
                activeChats.unshift(updatedUser);
            } else {
                // chat á€¡á€á€…á€º á€–á€¼á€…á€ºá€•á€«á€€ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º
                activeChats.unshift(user);
            }
            // Chat view á€á€½á€„á€º á€›á€¾á€­á€”á€±á€™á€¾á€á€¬ render á€œá€¯á€•á€ºá€›á€”á€º
            if (currentView === 'chat') {
                renderChatList();
            }

            // á‚á‹ á€œá€€á€ºá€›á€¾á€­ chat window á€á€½á€„á€º á€›á€¾á€­á€”á€±á€•á€«á€€ message á€€á€­á€¯ á€•á€¼á€á€á€¼á€„á€ºá€¸
            if (chatId === currentChatId) {
                // Server á€€á€”á€± á€•á€¼á€”á€ºá€œá€¬á€á€²á€· admin reply message á€€á€­á€¯ (local echo á€™á€œá€¯á€•á€ºá€‘á€¬á€¸á€›á€„á€º) á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º user message á€€á€­á€¯ á€•á€¼á€á€á€¼á€„á€ºá€¸
                if (message.sender === 'user') {
                    renderMessage(message);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        });

        // Server á€™á€¾ á€¡á€™á€¾á€¬á€¸á€¡á€šá€½á€„á€ºá€¸á€™á€»á€¬á€¸ (á€¥á€•á€™á€¬: Telegram á€•á€­á€¯á€·á€™á€›á€á€¼á€„á€ºá€¸)
        socket.on('error', (err) => {
            console.error("Socket Error:", err);
            // á€šá€¬á€šá€® notification á€•á€¼á€á€á€¼á€„á€ºá€¸
            // NOTE: alert() á€€á€­á€¯ á€™á€á€¯á€¶á€¸á€˜á€² Custom UI á€á€¯á€¶á€¸á€›á€”á€º á€Šá€½á€¾á€”á€ºá€€á€¼á€¬á€¸á€á€»á€€á€ºá€›á€¾á€­á€á€±á€¬á€€á€¼á€±á€¬á€„á€·á€º á€šá€¬á€šá€® console á€á€½á€„á€ºá€á€¬ á€•á€¼á€á€Šá€º
            const header = document.getElementById('chat-header');
            const errorDiv = document.createElement('div');
            errorDiv.className = "bg-red-500 text-white p-2 text-center text-sm sticky top-0 z-50";
            errorDiv.textContent = `ğŸš« Message á€•á€­á€¯á€·á€›á€”á€º á€¡á€†á€„á€ºá€™á€•á€¼á€±á€•á€«á‹ ${err.message}`;
            header.insertAdjacentElement('afterend', errorDiv);
            setTimeout(() => errorDiv.remove(), 5000); 
        });

        // ------------------------------------
        // Initialization
        // ------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // Default á€¡á€”á€±á€–á€¼á€„á€·á€º 'chat' view á€€á€­á€¯ á€…á€á€„á€ºá€•á€¼á€á€•á€¼á€®á€¸ chat list á€€á€­á€¯ á€šá€°á€á€¼á€„á€ºá€¸
            switchView('chat'); 
        });

    </script>
</body>
</html>
