{% extends "base.html" %}
{% block header %}TG Chat{% endblock %}
{% block content %}

<div style="display:flex; max-width:1200px; margin:auto; gap:20px; height:75vh;">

    <!-- User list -->
    <div id="user-list" style="flex:0 0 250px; overflow-y:auto; padding:10px; border-radius:12px; background:rgba(255,255,255,0.05);">
    </div>

    <!-- Conversation window -->
    <div style="flex:1; display:flex; flex-direction:column; gap:10px; border-radius:12px; background:rgba(255,255,255,0.05); overflow:hidden;">
        <div id="chat-container" style="flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px;">
        </div>

        <div style="display:flex; gap:10px; padding:10px; border-top:1px solid var(--glass-border);">
            <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1; padding:10px 14px; border-radius:20px; border:1px solid var(--glass-border); background:var(--bg-main); color:var(--text-main);">
            <input type="file" id="file-input" style="display:none;">
            <button onclick="document.getElementById('file-input').click()" style="padding:10px 14px; border-radius:20px; background:var(--accent); color:#020617; border:none;">ðŸ“Ž</button>
            <button onclick="sendMessage()" style="padding:10px 16px; border-radius:20px; background:var(--accent); color:#020617; border:none;">Send</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = { apiKey:"MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDrfYdMxHqnF7OG\nlfFYMRgbuXYMwB36Wz3iX8U7rFHRVREXgmEveinNgmehyJBZFunGZNkv6qcaRVIP\nsWwf5vBdqGStIOejYsAtwFOrcXus6wnnrBkSV2HO8kQv7wf9+9tlHmudscFOfnKa\nkoyrbYK8Ts5YdRC3oe3G/auPt9BiPOwXodO3MyN9W/tVUcdNnseFTXras3e3cYoC\nnFgXhiYIzRtJXkp2bRHS++EPwu6bXv2meAQkpsyQZDblJc8/05mGGvgUPiuxoGjC\nfC9k3KyhIDx05LtpjgLkzwMLJ7ruM6DgyA11cRy/Jlhm18NskRHNP5rJmo7nLOgs\n33qN5Ml3AgMBAAECggEACFh9iAn0Jgg5mfM/oPy0bWvoNB5G5OcagI0cvbdArkBR\nuvL2I/gA+g7wda2LxN+1nAzzT+oEzz7vrPpNUHm49Dv4ijr+5hDWwLuIYflDa2bO\nn6hCVAHgYU4sS0QxLoSGscTsBj2uq4Wtsa6wT47+mB/bp9gWP8iV8OLVxq66ZhDQ\nDZppfBjDLUz7trc5XYWozcQ9ExQVyBROjVKA3PfrvyeBTGd3VXfxGZ7gBVLNxdII\n5mqmX1KE7c1WbmTNS5+DZVBOE5FvPfiHaAxzbkfxLAAapYM+YvnrWlxFSnMaRG7j\nZjdeSp5SRM70Hy2MemUuZ+HBBrmAJR7Gg0lRArgAMQKBgQD7H314HIL9qzJXZ0OP\nKG4ikqsHnlvfNNG8r4AtWqejIRwLAGjqgN+bTRFfr5qjHr6dCUP1HvQUb0S7NZyB\nGnFey4dTwOfhO1UQgPU9jlBTl6Pe141QKG92jFh8H6a5lpTglKaGHxqI8jBnUbPX\nSZYg4N0SqT4AUvApBijHdqWcHwKBgQDwEFFAlone624FIln0V9KthSh7hwhXCu+q\nOhsQ+267+CcrwxwRwNvEhRTCePRZFeCZ4SCSoSqL1D1PtwcaHmqjPFy7ETEqzlH7\nik+a1j4bXRG3f9Bz+1DF2alr7KxJi1dCD3f/FUi++JV2MYDmH+58aZnI5+RodlT9\n4eNlBzgnqQKBgQCNyIfEqwRiSKhRpOIGD+Ou3XRV5cUlTuMkT0plUQvZFLaKl56k\n2EJnoqmuhq0ecBta+oI+AU35w6DgujI0ykM8LFmptf61shQjD0xnhtRfffxtsvH8\nUfgszKyg2BYALr671fH3Q9RtgaBGlWCeqtNymML46EkzUaB66RlZFOoILQKBgQDO\nyt+TKZoeIuOlHJAswTKEMr5Kmmk+wbbuBhump1AeL4delTWqvV0Sjijx1Mt3qfbN\n1zX92UMTLIRVIK7HewghIIQoyIh3/T511hD4qjDZ1XQe9d0U65oKtJLS2w8WUyeZ\nSkXtv+HoT65AICiPE1aWaUkF3WvN6JESGfGN54gh8QKBgHVpCh4wphmiT6qfU/Ze\ng/eOC1rfipfz7PDPzziNFAtSDmhYj7ljzsM2cmGtydLa6xsCBzBmus2hfdYP9xJI\njxvk3tYI21dCAsoofgRe+ni8SD1fIQlM5++k7Pu2CfLgvjD7nQ7nxT5mXcWQYDyV\nXVGqzIFXzpRr35lHRyFFE6xV", authDomain:"", projectId:"mksadmin-6ffeb", storageBucket:"", messagingSenderId:"", appId:"" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatRef = collection(db, "tg_chat");
const usersRef = collection(db, "tg_users");

let currentUserId = null;

// Load users
onSnapshot(usersRef, snapshot => {
    const list = document.getElementById("user-list");
    list.innerHTML = "";
    snapshot.forEach(doc => {
        const user = doc.data();
        const div = document.createElement("div");
        div.textContent = user.name || user.id;
        div.style.padding = "10px";
        div.style.cursor = "pointer";
        div.onclick = () => loadChat(user.id);
        list.appendChild(div);
    });
});

// Load chat
function loadChat(userId){
    currentUserId = userId;
    const container = document.getElementById("chat-container");
    container.innerHTML = "";
    const q = query(chatRef, orderBy("timestamp"));
    onSnapshot(q, snapshot => {
        container.innerHTML = "";
        snapshot.forEach(doc => {
            const msg = doc.data();
            if(msg.user_id !== currentUserId) return;
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.flexDirection = msg.sender==="Admin" ? "row-reverse":"row";
            div.style.alignItems="center";
            div.style.gap="10px";

            const bubble = document.createElement("div");
            bubble.style.padding="10px 16px";
            bubble.style.borderRadius="20px";
            bubble.style.maxWidth="70%";
            bubble.style.wordWrap="break-word";
            bubble.style.background = msg.sender==="Admin" ? "var(--accent)" : "rgba(255,255,255,0.1)";
            bubble.style.color = msg.sender==="Admin" ? "#020617" : "var(--text-main)";

            if(msg.type==="text") bubble.textContent = msg.message;
            if(msg.type==="photo") bubble.innerHTML = `<img src="https://api.telegram.org/file/bot<YOUR_BOT_TOKEN>/${msg.file_id}" style="max-width:200px;border-radius:12px;">`;
            if(msg.type==="video") bubble.innerHTML = `<video src="https://api.telegram.org/file/bot<YOUR_BOT_TOKEN>/${msg.file_id}" style="max-width:200px;border-radius:12px;" controls></video>`;

            div.appendChild(bubble);
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    });
}

// Send message
function sendMessage(){
    if(!currentUserId) return alert("Select a user first!");
    const input = document.getElementById("msg-input");
    const fileInput = document.getElementById("file-input");

    let content = {};
    if(fileInput.files.length>0){
        const file = fileInput.files[0];
        // For simplicity: we send as text placeholder, backend should handle file upload
        content = {type: "photo", file_id: "FILE_ID_FROM_BACKEND"};
        fileInput.value="";
    }else{
        if(input.value.trim()==="") return;
        content = {type:"text", message:input.value.trim()};
        input.value="";
    }

    // Save admin message
    addDoc(chatRef,{
        sender:"Admin",
        user_id:currentUserId,
        timestamp:serverTimestamp(),
        ...content
    });

    // Backend will read Firestore and send via Bot API
}
</script>
{% endblock %}
