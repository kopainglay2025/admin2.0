{% extends "base.html" %}
{% block header %}TG Chat{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-list" id="chatList"></div>

    <div class="chat-box">
        <div class="chat-messages" id="messages"></div>

        <div class="chat-input">
            <input id="msgInput" placeholder="Type a message...">
            <input type="file" id="fileInput" hidden>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<style>
.chat-wrapper{display:flex;height:80vh}
.chat-list{width:280px;border-right:1px solid var(--glass-border);overflow:auto}
.chat-item{padding:14px;cursor:pointer}
.chat-item:hover{background:var(--glass-border)}
.chat-box{flex:1;display:flex;flex-direction:column}
.chat-messages{flex:1;padding:16px;overflow:auto}
.msg{max-width:60%;margin:8px;padding:10px;border-radius:12px}
.user{background:#1f2937}
.admin{background:#6366f1;margin-left:auto}
.chat-input{display:flex;gap:8px;padding:12px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX",
  projectId: "XXXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let activeUser = null;

// Load chat list
db.collection("tg_chats")
  .orderBy("updated_at","desc")
  .onSnapshot(snap=>{
    chatList.innerHTML="";
    snap.forEach(d=>{
      chatList.innerHTML+=`
        <div class="chat-item" onclick="openChat('${d.id}')">
          ${d.data().username || d.id}
        </div>`;
    });
});

function openChat(uid){
  activeUser = uid;
  db.collection("tg_chats").document(uid)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snap=>{
      messages.innerHTML="";
      snap.forEach(m=>{
        const d=m.data();
        messages.innerHTML+=`
          <div class="msg ${d.from}">
            ${d.text || d.type}
          </div>`;
      });
      messages.scrollTop=messages.scrollHeight;
    });
}

function sendMessage(){
  const text=msgInput.value;
  if(!text||!activeUser) return;

  db.collection("tg_chats").document(activeUser)
    .collection("messages").add({
      from:"admin",
      type:"text",
      text:text,
      timestamp:Date.now()
    });

  fetch("/tg-send",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({user_id:activeUser,text})
  });

  msgInput.value="";
}
</script>
{% endblock %}
