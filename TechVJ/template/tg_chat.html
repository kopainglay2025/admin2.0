{% extends "base.html" %}
{% block header %}Telegram Chat{% endblock %}
{% block content %}

<div class="chat-layout">
    <div class="chat-list" id="chatList"></div>

    <div class="chat-box">
        <div class="chat-messages" id="messages"></div>

        <div class="chat-input">
            <input type="text" id="msgInput" placeholder="Type a messageâ€¦">
            <button onclick="sendMsg()">Send</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "XXX",
  authDomain: "XXX",
  databaseURL: "XXX",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;

// Load chat list
db.ref("tg_chats").on("value", snap => {
    const list = document.getElementById("chatList");
    list.innerHTML = "";
    snap.forEach(user => {
        const u = user.val().user;
        const div = document.createElement("div");
        div.className = "chat-user";
        div.innerText = u.name;
        div.onclick = () => openChat(u.id);
        list.appendChild(div);
    });
});

function openChat(uid){
    currentUser = uid;
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    db.ref(`tg_chats/${uid}/messages`).on("child_added", snap=>{
        const m = snap.val();
        const div = document.createElement("div");
        div.className = "msg " + (m.from === "admin" ? "me":"them");
        div.innerText = m.text || m.type;
        msgBox.appendChild(div);
        msgBox.scrollTop = msgBox.scrollHeight;
    });
}

function sendMsg(){
    const text = msgInput.value;
    fetch("/tg/send",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            user_id: currentUser,
            type:"text",
            text:text
        })
    });
    msgInput.value="";
}
</script>

<style>
.chat-layout{display:flex;height:75vh}
.chat-list{width:260px;border-right:1px solid var(--glass-border);overflow:auto}
.chat-user{padding:14px;cursor:pointer}
.chat-user:hover{background:var(--glass-border)}
.chat-box{flex:1;display:flex;flex-direction:column}
.chat-messages{flex:1;padding:16px;overflow:auto}
.msg{max-width:65%;padding:10px 14px;border-radius:14px;margin-bottom:10px}
.me{background:#6366f1;color:#fff;margin-left:auto}
.them{background:#1f2937}
.chat-input{display:flex;padding:12px;border-top:1px solid var(--glass-border)}
.chat-input input{flex:1;padding:10px;border-radius:10px;border:none}
.chat-input button{margin-left:10px}
</style>

{% endblock %}
