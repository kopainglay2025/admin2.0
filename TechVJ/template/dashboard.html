<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Multi-User Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin:0; padding:0; background:#f0f2f5;
}
.container {
    display: flex;
    height: 100vh;
}
.user-list {
    width: 200px;
    background: #fff;
    border-right: 1px solid #ccc;
    overflow-y: auto;
}
.user-list .user-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.user-list .user-item.active {
    background: #e6f3ff;
    font-weight: bold;
}
.chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
}
#chat-container {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background: #e5ddd5;
}
.message {
    margin-bottom: 10px;
    max-width: 70%;
    display: flex;
    flex-direction: column;
}
.message.user { align-self: flex-start; }
.message.admin { align-self: flex-end; }
.bubble {
    padding: 8px 12px;
    border-radius: 15px;
    word-wrap: break-word;
}
.bubble.user { background: #fff; border:1px solid #ccc; }
.bubble.admin { background: #dcf8c6; }
.timestamp { font-size:11px; color:#555; margin-top:2px; }
#reply-box { display:flex; padding:10px; border-top:1px solid #ccc; }
#reply-text { flex:1; padding:8px; border-radius:5px; border:1px solid #ccc; }
#send-btn { padding:8px 15px; border:none; border-radius:5px; background:#0084ff; color:#fff; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
    <div class="user-list" id="user-list"></div>
    <div class="chat-panel">
        <div id="chat-container"></div>
        <div id="reply-box">
            <input type="text" id="reply-text" placeholder="Type message">
            <button id="send-btn">Send</button>
        </div>
    </div>
</div>

<script>
let ws = new WebSocket("wss://yourdomain.com/ws/chat"); // change to your WS URL
const chatBox = document.getElementById("chat-container");
const userListEl = document.getElementById("user-list");
const replyInput = document.getElementById("reply-text");
const sendBtn = document.getElementById("send-btn");

let selectedUserId = null;
let users = {};

function formatTime(ts){
    const d = new Date(ts*1000);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function renderUsers(){
    userListEl.innerHTML = '';
    Object.values(users).forEach(user=>{
        const div = document.createElement("div");
        div.classList.add("user-item");
        if(user.user_id === selectedUserId) div.classList.add("active");
        div.textContent = user.user_name;
        div.onclick = async () => {
            selectedUserId = user.user_id;
            renderUsers();
            chatBox.innerHTML = '';
            ws.send(JSON.stringify({type:"fetch_chat", user_id:selectedUserId}));
        }
        userListEl.appendChild(div);
    });
}

function addMessage(user_id, sender, text, time){
    if(user_id !== selectedUserId) return; // only show selected user chat
    const div = document.createElement("div");
    div.classList.add("message", sender === "admin" ? "admin" : "user");
    const bubble = document.createElement("div");
    bubble.classList.add("bubble", sender === "admin" ? "admin" : "user");
    bubble.textContent = text;
    div.appendChild(bubble);
    const ts = document.createElement("div");
    ts.classList.add("timestamp");
    ts.textContent = formatTime(time);
    div.appendChild(ts);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

ws.onmessage = function(event){
    const data = JSON.parse(event.data);
    if(data.type === "users_list"){
        data.users.forEach(u=>users[u.user_id]=u);
        renderUsers();
    }
    else if(data.type === "chat_history"){
        data.messages.forEach(m=>addMessage(data.user_id, m.sender, m.text, m.time));
    }
    else if(data.type === "message"){
        if(!users[data.user_id]){
            users[data.user_id] = {user_id:data.user_id, user_name:data.sender==="user"?data.user_name:"Unknown"};
            renderUsers();
        }
        addMessage(data.user_id, data.sender==="user"?data.user_name:"admin", data.text, data.time);
    }
}

sendBtn.onclick = () => {
    if(!selectedUserId){ alert("Select a user first."); return; }
    const text = replyInput.value.trim();
    if(!text) return;
    ws.send(JSON.stringify({type:"reply", user_id:selectedUserId, text}));
    addMessage(selectedUserId,"admin",text,Math.floor(Date.now()/1000));
    replyInput.value = '';
}

replyInput.addEventListener("keypress", e=>{
    if(e.key==="Enter") sendBtn.click();
});
</script>
</body>
</html>
