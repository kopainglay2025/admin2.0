<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - {{ active_chat.user_name if active_chat else "No Chats" }}</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; overflow: hidden; }
.chat-container { height: calc(100vh - 150px); scroll-behavior: smooth; overflow-y: auto; }
.sidebar-height { height: calc(100vh - 75px); overflow-y: auto; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
.msg-bubble { max-width: 75%; padding: 8px 14px; border-radius: 18px; font-size: 0.9375rem; line-height: 1.4; }
.msg-received { background-color: #f0f0f0; color: #050505; border-bottom-left-radius: 4px; }
.msg-sent { background: linear-gradient(135deg, #0084ff 0%, #0078ff 100%); color: white; border-bottom-right-radius: 4px; }
</style>
</head>
<body class="bg-white text-slate-900">

<!-- Top Navigation -->
<nav class="bg-white border-b border-slate-200 h-[75px] flex items-center justify-between px-6 sticky top-0 z-50">
    <div class="flex items-center gap-4">
        <div class="bg-blue-600 p-2.5 rounded-2xl text-white">
            <i class="fas fa-comment-dots text-xl"></i>
        </div>
        <div>
            <h1 class="text-xl font-extrabold text-slate-800">Messages</h1>
            <p id="statusText" class="text-[10px] font-semibold text-amber-500 uppercase tracking-wider">Connecting...</p>
        </div>
    </div>
</nav>

<div class="flex h-[calc(100vh-75px)]">
    <!-- Sidebar -->
    <aside class="w-[360px] bg-white border-r border-slate-100 sidebar-height custom-scrollbar flex flex-col">
        <div id="userList" class="flex flex-col px-2 py-4">
            {% for user in users %}
            <a href="/dashboard?user_id={{ user.user_id }}" 
               id="user-side-{{ user.user_id }}"
               class="user-item flex items-center gap-3 p-3 rounded-xl mb-1 {{ 'bg-blue-50' if active_chat and active_chat.user_id == user.user_id else 'hover:bg-slate-50' }}">
                <div class="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center font-bold">
                    {{ user.user_name[:1] | upper }}
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="flex justify-between items-baseline">
                        <span class="font-bold text-slate-800 truncate">{{ user.user_name }}</span>
                    </div>
                    <p id="last-msg-{{ user.user_id }}" class="text-[13px] text-slate-500 truncate">
                        {% if user.chats %}{{ user.chats[-1].message }}{% else %}No messages{% endif %}
                    </p>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Chat -->
    <main class="flex-1 flex flex-col bg-white">
        {% if active_chat %}
        <div class="h-[75px] px-6 flex items-center border-b border-slate-100">
            <h2 class="font-bold text-slate-800">{{ active_chat.user_name }}</h2>
        </div>

        <div class="flex-1 chat-container p-6" id="chatWindow">
            <div class="flex flex-col" id="messageList">
                {% for msg in active_chat.chats %}
                <div class="flex flex-col {{ 'items-end' if msg.from_admin else 'items-start' }} mb-4">
                    <div class="msg-bubble {{ 'msg-sent' if msg.from_admin else 'msg-received' }}">
                        {{ msg.message }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <form id="replyForm" class="p-4 border-t flex gap-2">
            <input type="text" id="messageInput" placeholder="Aa" class="flex-1 bg-slate-100 rounded-full px-4 py-2 outline-none">
            <button type="submit" class="text-blue-600 px-2"><i class="fas fa-paper-plane"></i></button>
        </form>
        {% else %}
        <div class="flex-1 flex items-center justify-center text-slate-400">စကားပြောရန် User ရွေးချယ်ပါ</div>
        {% endif %}
    </main>
</div>

<script>
    const chatWindow = document.getElementById('chatWindow');
    const messageList = document.getElementById('messageList');
    const messageInput = document.getElementById('messageInput');
    const currentUserId = new URLSearchParams(window.location.search).get('user_id');
    const statusText = document.getElementById('statusText');

    // WebSocket ချိတ်ဆက်ခြင်း
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

    ws.onopen = () => {
        statusText.innerText = "Online";
        statusText.classList.replace('text-amber-500', 'text-green-500');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === "new_message") {
            const msg = data.data;
            const senderId = data.user_id.toString();

            // 1. Sidebar က နောက်ဆုံးစာကို Update လုပ်မယ်
            const lastMsgEl = document.getElementById(`last-msg-${senderId}`);
            if (lastMsgEl) {
                lastMsgEl.innerText = (msg.from_admin ? "You: " : "") + msg.message;
            }

            // 2. လက်ရှိဖွင့်ထားတဲ့ Chat ဖြစ်ရင် စာရင်းထဲချက်ချင်းထည့်မယ်
            if (senderId === currentUserId) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex flex-col ${msg.from_admin ? 'items-end' : 'items-start'} mb-4 animate-fade-in`;
                msgDiv.innerHTML = `<div class="msg-bubble ${msg.from_admin ? 'msg-sent' : 'msg-received'}">${msg.message}</div>`;
                messageList.appendChild(msgDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            } else {
                // တခြား User ဆီကစာဆိုရင် Sidebar မှာ အရောင်ပြောင်းတာမျိုး လုပ်လို့ရတယ်
                const userSideEl = document.getElementById(`user-side-${senderId}`);
                if (userSideEl) userSideEl.classList.add('border-l-4', 'border-blue-500');
            }
        }
    };

    // စာပို့တဲ့အပိုင်း
    if (document.getElementById('replyForm')) {
        document.getElementById('replyForm').onsubmit = async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentUserId) return;

            messageInput.value = '';
            await fetch('/send_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: currentUserId, message: text })
            });
        };
    }

    if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
</script>


</body>
</html>
