<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard & Chat</title>
    <style>
        /* Base styles */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        .container { display: flex; max-width: 1200px; min-height: 100vh; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* Sidebar/Menu */
        .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar h2 { padding: 0 20px; margin-bottom: 30px; border-bottom: 1px solid #3c5269; padding-bottom: 15px; }
        .sidebar a { display: flex; align-items: center; color: white; padding: 12px 20px; text-decoration: none; transition: background 0.3s, padding-left 0.3s; }
        .sidebar a:hover { background: #34495e; padding-left: 25px; }
        .sidebar a i { margin-right: 10px; }
        
        /* Main Content */
        .content { flex-grow: 1; padding: 30px; }
        .content h1 { color: #2c3e50; margin-bottom: 20px; }
        
        /* User List Style (Messenger Style) */
        .user-list { list-style: none; padding: 0; margin: 0; }
        .user-list li { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .user-list li:hover { background: #eef; }
        
        /* User Info */
        .user-info { flex-grow: 1; }
        .user-info b { font-size: 1.1em; color: #3498db; }
        .last-active { font-size: 0.8em; color: #7f8c8d; }
        
        /* Status Dot */
        .active-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 15px; background-color: #e74c3c; /* Default: Inactive */ }
        .user-active .active-dot { background-color: #2ecc71; /* Active */ }
        
        /* Alert/Notification */
        #notification-bar { background-color: #f39c12; color: white; padding: 10px; text-align: center; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Admin Panel</h2>
            <a href="/"><i class="fas fa-home"></i> üè† Dashboard</a>
            <a href="#chat"><i class="fas fa-comment"></i> üí¨ Chat</a>
            <a href="#broadcast"><i class="fas fa-bullhorn"></i> üì£ Broadcast</a>
            <a href="#settings"><i class="fas fa-cog"></i> ‚öôÔ∏è Settings</a>
        </div>

        <div class="content">
            <h1>Active Telegram Users</h1>
            
            <div id="notification-bar"></div>
            
            <ul id="user-list" class="user-list">
                <li>Loading users...</li>
            </ul>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userListElement = document.getElementById('user-list');
        const notificationBar = document.getElementById('notification-bar');

        socket.on('connect', () => {
            console.log('Connected to socket server.');
            socket.emit('request_active_users');
        });

        socket.on('active_users_list', (users) => {
            userListElement.innerHTML = '';
            
            if (users.length === 0) {
                userListElement.innerHTML = '<li><i class="fas fa-info-circle"></i> No active users found.</li>';
                return;
            }

            users.forEach(user => {
                const li = document.createElement('li');
                
                const lastActiveDate = new Date(user.lastActive);
                // Last active 10 minutes ago is considered "active"
                const isActive = (new Date() - lastActiveDate) < (10 * 60 * 1000); 
                
                const timeString = lastActiveDate.toLocaleDateString() + ' ' + lastActiveDate.toLocaleTimeString();

                li.classList.add(isActive ? 'user-active' : 'user-inactive');
                
                li.innerHTML = `
                    <span class="active-dot"></span> 
                    <div class="user-info">
                        <b>${user.username || 'User ' + user.id}</b> 
                        <span class="last-active">(ID: ${user.id})</span>
                        <br>
                        <span class="last-active">Last Active: ${timeString}</span>
                    </div>
                    <i class="fas fa-chevron-right" style="color:#bdc3c7;"></i>
                `;
                
                li.onclick = () => {
                    window.location.href = `/chat/${user.id}`;
                };
                userListElement.appendChild(li);
            });
        });
        
        // Real-time notification for new messages
        socket.on('new_message_from_user', (data) => {
             console.log('New message received:', data);
             
             // Show notification bar
             notificationBar.style.display = 'block';
             notificationBar.innerHTML = `<i class="fas fa-bell"></i> New message from <b>${data.username}</b>: ${data.message.substring(0, 50)}... <a href="/chat/${data.userId}" style="color:white; font-weight: bold; text-decoration: underline;">Reply</a>`;
             
             // Re-request the user list to bring the active user to the top
             socket.emit('request_active_users');
             
             // Optionally hide notification after a few seconds
             setTimeout(() => {
                notificationBar.style.display = 'none';
             }, 10000);
        });
    </script>
</body>
</html>
