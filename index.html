<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Channel Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Load Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-6 text-indigo-400">Admin Login</h2>
            <div class="space-y-4">
                <input type="text" id="auth-username" placeholder="Username" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white">
                <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white">
                <button id="auth-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg">
                    Log In
                </button>
                <p id="auth-error" class="text-red-400 text-sm hidden">Authentication failed. Check credentials.</p>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden flex h-screen">

        <!-- Sidebar Navigation -->
        <nav class="w-64 bg-gray-800 flex flex-col p-4 shadow-lg border-r border-gray-700">
            <div class="text-2xl font-extrabold text-indigo-400 mb-8">
                OmniDesk
            </div>
            <ul class="space-y-2 flex-grow">
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="dashboard">Dashboard</li>
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="tg_chats">TG Chats</li>
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="fb_chats">FB Chats</li>
            </ul>
            <ul class="space-y-2 mt-auto border-t border-gray-700 pt-4">
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="user_list">System Users</li>
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="broadcast">Broadcast (WIP)</li>
                <li class="nav-item cursor-pointer p-3 rounded-lg hover:bg-gray-700 transition duration-150" data-view="settings">Settings (WIP)</li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-auto p-6">
            <h1 id="main-title" class="text-3xl font-bold text-white mb-6">Dashboard</h1>
            
            <div id="content-container" class="bg-gray-800 p-6 rounded-xl shadow-lg h-[calc(100vh-100px)] overflow-auto">
                <!-- Dynamic content will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Templates for dynamic rendering -->
    <template id="chat-view-template">
        <div class="flex h-full -m-6">
            <!-- Chat List Panel -->
            <div class="w-80 border-r border-gray-700 bg-gray-900 p-4 overflow-y-auto rounded-l-xl">
                <div class="sticky top-0 pb-2 bg-gray-900 z-10">
                    <h3 class="text-xl font-semibold mb-3 text-indigo-400">Conversations</h3>
                </div>
                <div id="chat-list-items" class="space-y-2">
                    <!-- Chat items go here -->
                </div>
            </div>
            <!-- Chat Detail Panel -->
            <div class="flex-1 flex flex-col p-4 rounded-r-xl">
                <div id="chat-header" class="border-b border-gray-700 pb-3 mb-4 sticky top-0 bg-gray-800 z-10">
                    <h4 id="chat-username-title" class="text-xl font-semibold">Select a Chat</h4>
                    <p id="chat-platform" class="text-sm text-gray-400"></p>
                </div>
                <div id="chat-history-messages" class="flex-1 overflow-y-auto space-y-4 mb-4 p-2">
                    <!-- Messages go here -->
                </div>
                <div id="reply-box" class="mt-auto pt-4 border-t border-gray-700 flex items-center">
                    <input type="text" id="admin-reply-input" placeholder="Type your reply here..." class="flex-1 p-3 rounded-l-lg bg-gray-700 border-t border-b border-l border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white disabled:opacity-50" disabled>
                    <button id="admin-reply-send" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-r-lg transition duration-200 disabled:opacity-50" disabled>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="user-list-template">
        <div class="space-y-6">
            <h3 class="text-xl font-semibold text-indigo-400">System User Management</h3>

            <!-- Add User Form -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h4 class="text-lg font-medium mb-3">Add New User</h4>
                <div class="flex space-x-4">
                    <input type="text" id="new-user-name" placeholder="Name" class="p-2 rounded-lg bg-gray-800 border border-gray-600 flex-1" required>
                    <select id="new-user-role" class="p-2 rounded-lg bg-gray-800 border border-gray-600">
                        <option value="Viewer">Viewer</option>
                        <option value="Operator">Operator</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <select id="new-user-status" class="p-2 rounded-lg bg-gray-800 border border-gray-600">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                    <button id="add-user-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Add User
                    </button>
                </div>
            </div>

            <!-- User Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700 rounded-lg overflow-hidden">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Role</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- User rows go here -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>
    
<script>
    // --- GLOBAL STATE & CONFIGURATION ---
    let authHeader = '';
    let currentView = 'dashboard';
    let currentPlatformFilter = null;
    let chats = [];
    let currentChatId = null;
    let socket;

    // --- DOM REFERENCES ---
    const authModal = document.getElementById('auth-modal');
    const authSubmit = document.getElementById('auth-submit');
    const authUsernameInput = document.getElementById('auth-username');
    const authPasswordInput = document.getElementById('auth-password');
    const authError = document.getElementById('auth-error');
    const appContainer = document.getElementById('app-container');
    const mainTitle = document.getElementById('main-title');
    const contentContainer = document.getElementById('content-container');
    const navItems = document.querySelectorAll('.nav-item');

    // --- HELPER FUNCTIONS ---
    function setAuthHeader(username, password) {
        const credentials = `${username}:${password}`;
        authHeader = 'Basic ' + btoa(credentials);
    }

    async function fetchAPI(endpoint, options = {}) {
        const headers = {
            'Authorization': authHeader,
            'Content-Type': 'application/json',
            ...options.headers
        };
        const response = await fetch(endpoint, { ...options, headers });
        if (response.status === 401) {
            // If API call fails authentication, show login modal again
            return showAuthError('Authentication failed. Check credentials.');
        }
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API Error ${response.status}: ${errorText}`);
        }
        return response.json();
    }

    function showAuthError(message) {
        authError.textContent = message;
        authError.classList.remove('hidden');
        authModal.classList.remove('hidden');
        appContainer.classList.add('hidden');
        authHeader = ''; // Clear header on failure
    }

    function formatTimestamp(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' +
               date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // --- AUTHENTICATION LOGIC ---

    authSubmit.addEventListener('click', async () => {
        const username = authUsernameInput.value;
        const password = authPasswordInput.value;

        if (!username || !password) {
            return showAuthError('Please enter both username and password.');
        }

        setAuthHeader(username, password);
        
        // Test authentication by fetching a simple endpoint
        try {
            // Note: The /api/chats endpoint requires basicAuthMiddleware
            await fetchAPI('/api/chats', { method: 'GET' });

            authModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initSocketIo();
            renderView(currentView);
        } catch (e) {
            showAuthError('Authentication failed. Check username and password.');
            console.error(e);
        }
    });

    // --- SOCKET.IO & REAL-TIME ---

    function initSocketIo() {
        if (socket) return;
        socket = io();

        socket.on('connect', () => {
            console.log('Connected to Socket.IO');
        });

        // Handler for new user messages (Telegram or FB)
        socket.on('new_message', (data) => {
            console.log('New message received:', data);
            
            // 1. Update the local chats list
            const existingIndex = chats.findIndex(c => c.telegramId === data.chatId);
            const newChat = {
                telegramId: String(data.chatId),
                username: data.user.username,
                lastMessageTime: data.message.timestamp,
                lastMessageText: data.message.text || 'Media received',
                platform: data.platform
            };

            if (existingIndex > -1) {
                // Update existing chat and move to top
                chats.splice(existingIndex, 1);
                chats.unshift(newChat);
            } else {
                // Add new chat to top
                chats.unshift(newChat);
            }
            
            // 2. Re-render the chat list if visible
            if (currentView.endsWith('_chats')) {
                renderChatList();
            }

            // 3. Update the message history if the current chat is active
            if (currentChatId === data.chatId) {
                appendMessageToHistory(data.message, false);
            }
        });

        // Handler for admin messages sent via the dashboard
        socket.on('message_sent', (data) => {
            console.log('Admin message confirmed sent:', data);
            if (currentChatId === data.chatId) {
                // The message has already been saved to Firestore and confirmed
                // We just need to ensure the local display is updated.
                // The saveMessage in server.js updates the chat list, but we update the history here.
                appendMessageToHistory(data.message, true);
            }
        });
    }

    // --- NAVIGATION AND VIEW RENDERING ---

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            const newView = e.target.dataset.view;
            if (newView === 'tg_chats' || newView === 'fb_chats') {
                currentPlatformFilter = newView === 'tg_chats' ? 'telegram' : 'facebook';
                currentView = 'chat_view';
            } else {
                currentPlatformFilter = null;
                currentView = newView;
            }
            renderView(currentView);
        });
    });

    function renderView(view) {
        // Reset scroll position
        contentContainer.scrollTop = 0;
        
        navItems.forEach(item => {
            const dataView = item.dataset.view;
            const isActive = (view === 'chat_view' && dataView.endsWith('_chats')) 
                             ? (currentPlatformFilter === 'telegram' && dataView === 'tg_chats') || (currentPlatformFilter === 'facebook' && dataView === 'fb_chats')
                             : (dataView === view);
            item.classList.toggle('bg-gray-700', isActive);
            item.classList.toggle('text-indigo-400', isActive);
        });
        
        let title = '';
        let content = '';
        currentChatId = null; // Clear selected chat on view change

        switch (view) {
            case 'dashboard':
                title = 'Dashboard';
                content = renderDashboardView();
                break;
            case 'chat_view':
                title = currentPlatformFilter === 'telegram' ? 'Telegram Chats' : 'Facebook Chats';
                content = renderChatView();
                break;
            case 'user_list':
                title = 'System User List';
                content = renderUserListView();
                break;
            case 'broadcast':
                title = 'Broadcast Messages (WIP)';
                content = `<p class="text-gray-400">This feature for broadcasting messages to all users is currently under construction.</p>`;
                break;
            case 'settings':
                title = 'Settings (WIP)';
                content = `<p class="text-gray-400">This area will contain application settings, such as API key management and preferences.</p>`;
                break;
            default:
                title = 'Error';
                content = '<p class="text-red-400">View not found.</p>';
        }

        mainTitle.textContent = title;
        contentContainer.innerHTML = content;

        if (view === 'chat_view') {
            fetchChats(currentPlatformFilter);
        } else if (view === 'user_list') {
            fetchUsers();
            attachUserListListeners();
        }
    }

    function renderDashboardView() {
        return `
            <div class="space-y-6">
                <p class="text-gray-400">Welcome to the Omni-Channel Admin Dashboard. Manage Telegram and Facebook Messenger conversations in real-time.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-indigo-600 p-6 rounded-xl shadow-lg">
                        <p class="text-sm font-medium opacity-80">Total Chats</p>
                        <p class="text-3xl font-bold mt-1">${chats.length || '...'}</p>
                    </div>
                    <div class="bg-blue-600 p-6 rounded-xl shadow-lg">
                        <p class="text-sm font-medium opacity-80">Telegram Users</p>
                        <p class="text-3xl font-bold mt-1">${chats.filter(c => c.platform === 'telegram').length || '...'}</p>
                    </div>
                    <div class="bg-sky-600 p-6 rounded-xl shadow-lg">
                        <p class="text-sm font-medium opacity-80">Facebook Users</p>
                        <p class="text-3xl font-bold mt-1">${chats.filter(c => c.platform === 'facebook').length || '...'}</p>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mt-6 text-indigo-400">Real-time Activity</h3>
                <div class="bg-gray-700 p-4 rounded-lg h-40 overflow-y-auto">
                    <p class="text-gray-400 text-sm">Waiting for real-time messages...</p>
                    <!-- In a full app, you'd log socket events here -->
                </div>
            </div>
        `;
    }

    function renderChatView() {
        const template = document.getElementById('chat-view-template');
        return template.innerHTML;
    }

    function renderUserListView() {
        const template = document.getElementById('user-list-template');
        return template.innerHTML;
    }

    // --- CHAT LOGIC ---

    async function fetchChats(platform) {
        try {
            const endpoint = `/api/chats${platform ? `?platform=${platform}` : ''}`;
            chats = await fetchAPI(endpoint);
            renderChatList();
        } catch (error) {
            console.error('Error fetching chats:', error);
            document.getElementById('chat-list-items').innerHTML = `<p class="text-red-400">Failed to load chats. Check server logs.</p>`;
        }
    }

    function renderChatList() {
        const chatListContainer = document.getElementById('chat-list-items');
        if (!chatListContainer) return;

        chatListContainer.innerHTML = chats
            .filter(chat => !currentPlatformFilter || chat.platform === currentPlatformFilter)
            .map(chat => `
                <div class="chat-list-item p-3 rounded-lg cursor-pointer transition duration-150 ${chat.telegramId === currentChatId ? 'bg-indigo-700 shadow-xl' : 'bg-gray-800 hover:bg-gray-700'}" 
                     data-chat-id="${chat.telegramId}" 
                     data-username="${chat.username}"
                     data-platform="${chat.platform}">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold truncate">${chat.username || chat.telegramId}</span>
                        <span class="text-xs ${chat.platform === 'telegram' ? 'bg-blue-500' : 'bg-sky-500'} text-white px-2 py-0.5 rounded-full">${chat.platform.substring(0, 2).toUpperCase()}</span>
                    </div>
                    <p class="text-sm text-gray-400 truncate mt-1">${chat.lastMessageText}</p>
                    <p class="text-xs text-gray-500 mt-1">${formatTimestamp(chat.lastMessageTime)}</p>
                </div>
            `).join('');

        document.querySelectorAll('.chat-list-item').forEach(item => {
            item.addEventListener('click', () => {
                selectChat(item.dataset.chatId, item.dataset.username, item.dataset.platform);
            });
        });
    }

    async function selectChat(chatId, username, platform) {
        currentChatId = chatId;
        renderChatList(); // Highlight the selected chat

        // Update chat header
        document.getElementById('chat-username-title').textContent = username;
        document.getElementById('chat-platform').textContent = `Platform: ${platform.charAt(0).toUpperCase() + platform.slice(1)} (ID: ${chatId})`;
        
        // Prepare history view
        const historyContainer = document.getElementById('chat-history-messages');
        const replyInput = document.getElementById('admin-reply-input');
        const replyButton = document.getElementById('admin-reply-send');
        
        historyContainer.innerHTML = '<div class="text-center p-4 text-indigo-400">Loading history...</div>';
        replyInput.disabled = false;
        replyButton.disabled = false;

        try {
            const history = await fetchAPI(`/api/chats/${chatId}/history?limit=50`);
            historyContainer.innerHTML = '';
            history.forEach(msg => appendMessageToHistory(msg, false));
            historyContainer.scrollTop = historyContainer.scrollHeight; // Scroll to bottom

            // Attach reply listener
            replyButton.onclick = () => sendAdminReply(chatId);
            replyInput.onkeypress = (e) => {
                if (e.key === 'Enter') sendAdminReply(chatId);
            };

        } catch (error) {
            console.error('Error fetching chat history:', error);
            historyContainer.innerHTML = `<p class="text-red-400 text-center p-4">Failed to load history.</p>`;
            replyInput.disabled = true;
            replyButton.disabled = true;
        }
    }

    function appendMessageToHistory(msg, isRealtime) {
        const historyContainer = document.getElementById('chat-history-messages');
        if (!historyContainer || msg.chatId !== currentChatId) return;

        const isUser = msg.sender === 'user';
        const timestamp = formatTimestamp(msg.timestamp);

        let mediaContent = '';
        if (msg.mediaPath) {
            // For Telegram, mediaPath is file_id. We need a server endpoint to fetch the actual file.
            // Since there's no download endpoint in server.js, we display a placeholder.
            const iconClass = msg.filename ? 'fa-file-alt' : 'fa-image';
            mediaContent = `
                <div class="p-3 bg-gray-600 rounded-lg mt-2 inline-block">
                    <p class="text-sm italic">Media received: ${msg.filename || 'Photo/Document'}</p>
                    <p class="text-xs text-gray-400">File ID: ${msg.mediaPath.substring(0, 15)}...</p>
                </div>
            `;
        }

        const messageHtml = `
            <div class="flex ${isUser ? 'justify-start' : 'justify-end'}">
                <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${isUser ? 'bg-indigo-600 rounded-bl-none' : 'bg-gray-700 rounded-br-none'}">
                    <p class="font-medium">${msg.text}</p>
                    ${mediaContent}
                    <p class="text-right text-xs mt-1 ${isUser ? 'text-indigo-200' : 'text-gray-400'}">${timestamp}</p>
                </div>
            </div>
        `;
        
        historyContainer.insertAdjacentHTML('beforeend', messageHtml);
        
        // Only scroll if the user is already near the bottom
        const shouldScroll = historyContainer.scrollHeight - historyContainer.clientHeight <= historyContainer.scrollTop + 50;
        if (shouldScroll || isRealtime) {
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }
    }

    function sendAdminReply(chatId) {
        const input = document.getElementById('admin-reply-input');
        const text = input.value.trim();

        if (!text || !chatId) return;

        // Optimistic update for the UI
        appendMessageToHistory({
            chatId,
            sender: 'admin',
            text: text,
            timestamp: new Date().toISOString()
        }, true);
        
        // Disable input while sending
        input.value = 'Sending...';
        input.disabled = true;
        document.getElementById('admin-reply-send').disabled = true;

        socket.emit('admin_reply', { chatId, text }, (response) => {
            input.value = '';
            input.disabled = false;
            document.getElementById('admin-reply-send').disabled = false;

            if (response.success) {
                console.log('Reply success:', response.message);
                // The 'message_sent' socket event will provide the final, Firestore-stamped message, 
                // but we already did the optimistic update. The confirmation is for the server side.
            } else {
                console.error('Reply failed:', response.error);
                // Note: In a real app, you might want to show a toast/notification about the failure
            }
        });
    }

    // --- USER LIST LOGIC ---

    async function fetchUsers() {
        try {
            const users = await fetchAPI('/api/users');
            renderUserTable(users);
        } catch (error) {
            console.error('Error fetching users:', error);
            document.getElementById('user-table-body').innerHTML = `<tr><td colspan="4" class="text-red-400 p-4 text-center">Failed to load users.</td></tr>`;
        }
    }

    function renderUserTable(users) {
        const tbody = document.getElementById('user-table-body');
        if (!tbody) return;

        tbody.innerHTML = users.map(user => `
            <tr class="hover:bg-gray-700 transition duration-150">
                <td class="px-4 py-3">${user.name}</td>
                <td class="px-4 py-3">
                    <span class="px-3 py-1 text-xs font-medium rounded-full ${user.role === 'Admin' ? 'bg-red-800' : user.role === 'Operator' ? 'bg-yellow-800' : 'bg-green-800'}">
                        ${user.role}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <span class="px-3 py-1 text-xs font-medium rounded-full ${user.status === 'Active' ? 'bg-green-600' : 'bg-red-600'}">
                        ${user.status}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <button class="delete-user-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded-lg" data-user-id="${user.id}">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function attachUserListListeners() {
        document.getElementById('add-user-btn')?.addEventListener('click', addUser);
        document.getElementById('user-table-body')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.dataset.userId;
                if (userId && window.confirm('Are you sure you want to delete this user?')) {
                    deleteUser(userId);
                }
            }
        });
    }

    async function addUser() {
        const name = document.getElementById('new-user-name').value;
        const role = document.getElementById('new-user-role').value;
        const status = document.getElementById('new-user-status').value;

        if (!name) return alert('User name is required.'); // Using JS alert here for simplicity in an admin tool

        try {
            await fetchAPI('/api/users', {
                method: 'POST',
                body: JSON.stringify({ name, role, status })
            });
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-role').value = 'Viewer';
            document.getElementById('new-user-status').value = 'Active';
            fetchUsers(); // Refresh list
        } catch (error) {
            console.error('Error adding user:', error);
            alert('Failed to add user: ' + error.message);
        }
    }

    async function deleteUser(userId) {
        try {
            await fetchAPI(`/api/users/${userId}`, { method: 'DELETE' });
            fetchUsers(); // Refresh list
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Failed to delete user: ' + error.message);
        }
    }
    
    // --- INITIALIZATION ---
    // Show auth modal on load
    document.addEventListener('DOMContentLoaded', () => {
        // Pre-fill fields for easier testing
        authUsernameInput.value = 'admin';
        authPasswordInput.value = 'password';
    });

</script>
</body>
</html>
