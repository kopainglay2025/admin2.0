<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - Bot Management (Firestore Live)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, setLogLevel, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase and export services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Enable debug logging for Firebase

        // Expose necessary variables globally for the main script block
        window.firebaseServices = { 
            db, 
            auth, 
            appId, 
            initialAuthToken,
            onAuthStateChanged,
            collection, query, orderBy, limit, onSnapshot, 
            addDoc, serverTimestamp, where
        };
    </script>

    <!-- Configure Tailwind to enable dark mode based on the 'dark' class -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* --- BASE STYLES --- */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 150ms ease-in-out;
            color: #6B7280;
            text-decoration: none;
        }

        .nav-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .nav-link.active {
            background-color: #F3F4F6;
            color: #1F2937;
            font-weight: 600;
        }

        .dark .nav-link.active {
            background-color: #374151;
            color: #F9FAFB;
        }

        .dark .nav-link {
            color: #9CA3AF;
        }

        .dark .nav-link:hover {
            background-color: #1F2937;
            color: #F9FAFB;
        }
        
        /* Custom scrollbar for chat */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 8px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6B7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* --- INBOX SPECIFIC STYLES --- */
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            display: inline-block;
            overflow: hidden;
            margin-bottom: 2px;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Light Mode Bubbles */
        .user-message { background-color: #0088cc; color: white; align-self: flex-start; border-radius: 1rem 1rem 1rem 0.25rem; }
        .admin-message { background-color: #34B7F1; color: white; align-self: flex-end; border-radius: 1rem 1rem 0.25rem 1rem; }
        
        /* Dark Mode Bubbles (slightly muted colors) */
        .dark .user-message { background-color: #1E40AF; color: #E5E7EB; } /* Darker blue */
        .dark .admin-message { background-color: #06B6D4; color: #E5E7EB; } /* Darker cyan */

        /* Timestamp Styling */
        .message-timestamp {
            font-size: 0.7rem;
            color: #9CA3AF; /* Light gray */
            margin-top: 1px;
            margin-bottom: 5px;
            padding: 0 0.5rem;
        }
        
        .dark .message-timestamp {
            color: #6B7280; /* Darker gray for dark mode */
        }


        .emoji-picker { display: none; position: absolute; bottom: 60px; right: 10px; background:white; border:1px solid #ddd; border-radius: 10px; padding: 10px; max-width: 300px; max-height: 250px; overflow-y:auto; z-index:50; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .dark .emoji-picker { background: #374151; border-color: #4B5563; }

        .emoji-picker span { cursor:pointer; font-size: 24px; margin:2px; transition: transform 0.1s; display: inline-block; }
        .emoji-picker span:hover { transform: scale(1.2); }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #22C55E; /* Changed to green for a better notification feel */
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .toast.show { opacity:1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans min-h-screen transition-colors duration-300">

    <!-- Mobile Menu Overlay (Click to close menu) -->
    <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

    <div id="app-container" class="flex">
        <!-- Sidebar Navigation (Responsive: Hidden on mobile by default, shown via toggle) -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-xl transition-transform duration-300 p-4 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 flex flex-col z-50">
            
            <!-- Top Section: Logo and Main Nav -->
            <div class="flex-grow">
                <div class="p-4 border-b dark:border-gray-700 mb-6 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Panel</h1>
                    <!-- Close button for mobile -->
                    <button id="close-menu-btn" class="md:hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Navigation Links -->
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#/dashboard" class="nav-link" data-path="/dashboard">
                                <i class="fas fa-home w-5 text-indigo-500"></i><span class="ml-3">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#/inbox" class="nav-link" data-path="/inbox">
                                <i class="fas fa-inbox w-5 text-green-500"></i><span class="ml-3">Inbox</span>
                            </a>
                        </li>
                        <li>
                            <a href="#/broadcast" class="nav-link" data-path="/broadcast">
                                <i class="fas fa-bullhorn w-5 text-yellow-500"></i><span class="ml-3">Broadcast</span>
                            </a>
                        </li>
                        <li>
                            <a href="#/users" class="nav-link" data-path="/users">
                                <i class="fas fa-users w-5 text-red-500"></i><span class="ml-3">Users</span>
                            </a>
                        </li>
                        <li>
                            <a href="#/integrations" class="nav-link" data-path="/integrations">
                                <i class="fas fa-plug w-5 text-purple-500"></i><span class="ml-3">Integrations (APIs)</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <!-- Bottom Section: Logout Link -->
            <div class="mt-4 pt-4 border-t dark:border-gray-700">
                <a href="#/logout" class="nav-link group transition-colors duration-200" data-path="/logout">
                    <i class="fas fa-sign-out-alt w-5 text-gray-500 group-hover:text-red-500 dark:text-gray-400 dark:group-hover:text-red-400"></i>
                    <span class="ml-3 font-semibold text-gray-700 dark:text-gray-300 group-hover:text-red-500 dark:group-hover:text-red-400">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 p-4 md:p-8 min-h-screen">
            <!-- Mobile Menu Toggle, Dark Mode Toggle & Header Simulation -->
            <header class="flex justify-between items-center mb-4 md:mb-8">
                <!-- Mobile Menu Toggle Button (Visible only on mobile) -->
                <button id="menu-toggle-btn" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200 md:hidden" title="Open Menu">
                    <i class="fas fa-bars"></i>
                </button>
                
                <!-- Spacer/Title Placeholder for mobile alignment -->
                <h2 class="text-xl font-bold text-gray-900 dark:text-white md:hidden" id="mobile-page-title"></h2>

                <!-- Dark Mode Toggle -->
                <button id="theme-toggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all duration-200" title="Toggle Dark/Light Mode">
                    <i id="theme-icon" class="fas fa-sun"></i>
                </button>
            </header>

            <!-- Content Container (This will be dynamically populated) -->
            <div id="content-container" class="transition-colors duration-300 max-w-7xl mx-auto">
                <div class="flex items-center justify-center h-64 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-3 text-3xl"></i>
                    Firebase á€á€­á€¯á€· á€á€»á€­á€á€ºá€†á€€á€ºá€”á€±á€•á€«á€á€Šá€º...
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 dark:text-white"></h3>
            <p id="modal-message" class="mb-6 dark:text-gray-300"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">á€–á€»á€€á€ºá€á€­á€™á€ºá€¸</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">á€¡á€á€Šá€ºá€•á€¼á€¯</button>
            </div>
        </div>
    </div>


    <script>
        // --- FIREBASE GLOBALS ---
        let db, auth, appId, initialAuthToken, onAuthStateChanged, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, where;
        let isAuthReady = false;
        let userId = null;
        
        // --- APP STATE ---
        let conversations = [];
        let activeUserId = null;
        let unsubscribeMessages = null; // Listener for active chat messages
        let unsubscribeConversations = null; // Listener for conversation list
        let fileToSend = null; 
        
        // Emojis for the picker
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ˜˜',
            'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜©', 'ğŸ˜­', 'ğŸ¤¯',
            'ğŸ‘‹', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™', 'â¤ï¸', 'ğŸ”¥', 'ğŸ’¯', 'âœ…', 'âŒ',
            'ğŸ', 'ğŸŒ', 'ğŸ•', 'â˜•', 'ğŸš€', 'ğŸ’¡', 'ğŸ’°', 'ğŸ”‘', 'ğŸ ', 'ğŸ’»'
        ];


        // --- GLOBAL DOM ELEMENTS ---
        const htmlElement = document.documentElement;
        const toggleButton = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentContainer = document.getElementById('content-container');
        const toast = document.getElementById('toast');
        const sidebar = document.getElementById('sidebar');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuOverlay = document.getElementById('menu-overlay');
        const mobilePageTitle = document.getElementById('mobile-page-title');


        // --- HELPER FUNCTIONS ---

        function formatTime(timestamp) {
            if (!timestamp) return '...';
            // Firestore timestamp object needs to be converted to Date
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp * 1000); 
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // --- SIDEBAR TOGGLE LOGIC ---
        function toggleSidebar(isOpen) {
            const isMobile = window.innerWidth < 768;
            if (!isMobile) return;

            if (isOpen === undefined) {
                isOpen = sidebar.classList.contains('-translate-x-full');
            }

            if (isOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                menuOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                menuOverlay.classList.add('hidden');
            }
        }
        
        // --- DARK MODE LOGIC ---

        function enableDarkMode() {
            htmlElement.classList.add('dark');
            localStorage.setItem('color-theme', 'dark');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
        }

        function disableDarkMode() {
            htmlElement.classList.remove('dark');
            localStorage.setItem('color-theme', 'light');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }

        function initializeTheme() {
            const preferredTheme = localStorage.getItem('color-theme');
            const systemPreference = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (preferredTheme === 'dark' || (!preferredTheme && systemPreference)) {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }

        // --- TOAST NOTIFICATION ---

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- INBOX MESSAGE DISPLAY LOGIC ---

        function displayTextMessage(msg, sender) {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            const wrapper = document.createElement('div');
            wrapper.classList.add('flex', 'flex-col', sender === 'user' ? 'items-start' : 'items-end');
            
            // 1. Message Bubble
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble', sender === 'user' ? 'user-message' : 'admin-message');
            bubble.textContent = msg.content; 

            // 2. Timestamp Element
            const timeEl = document.createElement('span');
            timeEl.classList.add('message-timestamp', sender === 'user' ? 'ml-0' : 'mr-0'); 
            timeEl.textContent = formatTime(msg.timestamp);

            wrapper.appendChild(bubble);
            wrapper.appendChild(timeEl); 
            container.appendChild(wrapper);

            container.scrollTop = container.scrollHeight;
        }
        
        // Function to display file/media messages
        function displayMediaMessage(msg, sender) {
            const container = document.getElementById('messages-container');
            if (!container) return;

            const wrapper = document.createElement('div');
            wrapper.classList.add('flex', 'flex-col', sender === 'user' ? 'items-start' : 'items-end');

            // Determine Icon and Label
            let iconClass, mediaTypeLabel;
            if (msg.mediaType && msg.mediaType.startsWith('image')) {
                iconClass = 'fa-image';
                mediaTypeLabel = 'á€•á€¯á€¶ / Photo';
            } else if (msg.mediaType && msg.mediaType.startsWith('video')) {
                iconClass = 'fa-video';
                mediaTypeLabel = 'á€—á€®á€’á€®á€šá€­á€¯ / Video';
            } else {
                iconClass = 'fa-file';
                mediaTypeLabel = 'á€–á€­á€¯á€„á€º / File';
            }
            
            // 1. Message Bubble (Container for media content)
            const bubble = document.createElement('div');
            bubble.classList.add(
                'message-bubble', 
                'p-4',
                sender === 'user' ? 'user-message' : 'admin-message', 
                'flex', 'flex-col', 'items-center', 'justify-center', 
                'max-w-[12rem]',
                'bg-opacity-80' 
            );

            // Handle file size display (optional field)
            const fileSizeText = msg.fileSize ? `${(msg.fileSize / 1024 / 1024).toFixed(2)} MB` : 'Unknown size';


            bubble.innerHTML = `
                <i class="fas ${iconClass} text-5xl mb-3"></i>
                <div class="font-bold text-base text-center">${mediaTypeLabel}</div>
                <div class="text-sm italic truncate w-full text-center px-1">${msg.content}</div>
                <div class="text-xs mt-1 font-semibold">${fileSizeText}</div>
                <button class="mt-3 px-3 py-1 text-xs bg-white/20 hover:bg-white/30 rounded-full font-semibold transition">
                    á€–á€½á€„á€·á€ºá€›á€”á€º (Simulated)
                </button>
            `;

            // 2. Timestamp Element
            const timeEl = document.createElement('span');
            timeEl.classList.add('message-timestamp', sender === 'user' ? 'ml-0' : 'mr-0'); 
            timeEl.textContent = formatTime(msg.timestamp);

            wrapper.appendChild(bubble);
            wrapper.appendChild(timeEl);
            container.appendChild(wrapper);

            container.scrollTop = container.scrollHeight;
        }

        // Delegating display function
        function displayMessage(msg, sender) {
            if (msg.type === 'media') {
                displayMediaMessage(msg, sender);
            } else {
                displayTextMessage(msg, sender);
            }
        }
        
        // --- INBOX LOGIC ---
        
        function getConversationsCollectionRef() {
            // Path: /artifacts/{appId}/public/data/conversations
            return collection(db, `artifacts/${appId}/public/data/conversations`);
        }
        
        function getMessagesCollectionRef(conversationId) {
            // Path: /artifacts/{appId}/public/data/conversations/{conversationId}/messages
            return collection(db, `artifacts/${appId}/public/data/conversations/${conversationId}/messages`);
        }
        
        function unsubscribeAll() {
            if (unsubscribeConversations) {
                unsubscribeConversations();
                unsubscribeConversations = null;
            }
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
        }


        function loadConversation(userId, userName, conversationListEl, chatWindowEl) {
            if (!isAuthReady) {
                showToast("á€’á€±á€á€¬á€˜á€±á€·á€…á€ºá€€á€­á€¯ á€á€»á€­á€á€ºá€†á€€á€ºá€”á€±á€†á€²á€–á€¼á€…á€ºá€á€Šá€º...");
                return;
            }
            
            // Unsubscribe from previous chat listener
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            const messagesContainerEl = document.getElementById('messages-container');

            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('conversation-sidebar');
                if(sidebar) sidebar.classList.add('hidden'); 
                if(chatWindowEl) chatWindowEl.classList.remove('hidden');
            }
            
            activeUserId = userId;
            const activeUserIdInput = document.getElementById('active-user-id');
            if (activeUserIdInput) activeUserIdInput.value = userId;

            // Update Headers
            const headerName = userName;
            const headerId = `(#${userId})`;

            document.getElementById('chat-user-name').textContent = headerName;
            document.getElementById('chat-user-id').textContent = headerId;
            document.getElementById('chat-user-name-desktop').textContent = headerName;
            document.getElementById('chat-user-id-desktop').textContent = headerId;

            // Update Active Link Style
            conversationListEl.querySelectorAll('.chat-item').forEach(el => el.classList.remove('bg-gray-100', 'dark:bg-gray-700'));
            const selectedItem = document.querySelector(`.chat-item[data-user-id="${userId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('bg-gray-100', 'dark:bg-gray-700');
            }
            
            // Clear current messages and show loading
            messagesContainerEl.innerHTML = `
                <div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
                    <i class="fas fa-spinner fa-spin mr-3 text-2xl"></i>
                    á€…á€¬á€™á€»á€¬á€¸ á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º...
                </div>
            `;
            
            // Start listening to the messages subcollection
            const messagesQuery = query(
                getMessagesCollectionRef(userId), 
                orderBy('timestamp', 'asc')
            );

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                // Clear the container only on the initial load or full replacement
                if (messagesContainerEl.children.length === 1 && messagesContainerEl.textContent.includes('á€…á€¬á€™á€»á€¬á€¸ á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º')) {
                    messagesContainerEl.innerHTML = '';
                }

                if (snapshot.empty) {
                    messagesContainerEl.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€…á€á€„á€ºá€›á€”á€º</div>';
                    return;
                }

                snapshot.docChanges().forEach((change) => {
                    const msgData = change.doc.data();
                    
                    // Determine sender based on 'fromAdmin' field
                    const sender = msgData.fromAdmin ? 'admin' : 'user';

                    if (change.type === "added") {
                        displayMessage(msgData, sender);
                    }
                    // Ignoring 'modified' and 'removed' for chat UI simplicity
                });
            }, (error) => {
                console.error("Error listening to messages: ", error);
                messagesContainerEl.innerHTML = `<div class="text-red-500 p-4">á€’á€±á€á€¬á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€á€Šá€º: ${error.code}</div>`;
            });
            
            // Clear any pending file attachment when switching conversations
            clearFileAttachment();
        }
        
        function renderConversationList(conversationListEl, chatWindowEl) {
            if (!isAuthReady) return;

            // 1. Initial listener setup
            if (!unsubscribeConversations) {
                const conversationsQuery = query(
                    getConversationsCollectionRef(), 
                    orderBy('lastMessageTimestamp', 'desc')
                );
                
                unsubscribeConversations = onSnapshot(conversationsQuery, (snapshot) => {
                    conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // 2. Clear and render the list
                    conversationListEl.innerHTML = '';

                    if (conversations.length === 0) {
                        conversationListEl.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">á€…á€€á€¬á€¸á€á€­á€¯á€„á€ºá€¸á€™á€»á€¬á€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«</div>';
                        return;
                    }
                    
                    conversations.forEach((conv) => {
                        const newItem = document.createElement('div');
                        const lastMessage = conv.lastMessage || "á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€…á€á€„á€ºá€›á€”á€º";
                        // Note: unreadCount would ideally be managed by a server-side rule,
                        // but for client-side display, we just show a badge if it exists/is > 0
                        const unreadCount = conv.unreadCount || 0; 
                        
                        newItem.className = `relative p-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 chat-item border-b dark:border-gray-700 ${conv.id === activeUserId ? 'bg-gray-100 dark:bg-gray-700' : ''}`;
                        newItem.dataset.userId = conv.id;
                        newItem.dataset.userName = conv.name || conv.id; // Use ID as fallback name
                        
                        const badgeHtml = unreadCount > 0 
                            ? `<span class="unread-count absolute top-4 right-4 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${unreadCount}</span>` 
                            : '';
                        
                        newItem.innerHTML = `
                            <h4 class="font-semibold text-gray-800 dark:text-white">
                                <span class="truncate">${conv.name || 'Unknown User'}</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400 ml-1">(ID: ${conv.id})</span>
                            </h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">${lastMessage}</p>
                            ${badgeHtml}
                        `;
                        
                        conversationListEl.appendChild(newItem);
                        
                        newItem.addEventListener('click', () => {
                            loadConversation(conv.id, conv.name || 'Unknown User', conversationListEl, chatWindowEl);
                        });
                    });
                    
                    // Re-load messages for the currently active user to update the active item's style
                    if (activeUserId) {
                        const activeConv = conversations.find(c => c.id === activeUserId);
                        if (activeConv) {
                             loadConversation(activeConv.id, activeConv.name || 'Unknown User', conversationListEl, chatWindowEl);
                        }
                    }

                }, (error) => {
                    console.error("Error listening to conversations: ", error);
                    conversationListEl.innerHTML = `<div class="text-red-500 p-4">á€…á€¬á€›á€„á€ºá€¸á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€á€Šá€º: ${error.code}</div>`;
                });
            }
        }
        
        // --- NEW: File attachment logic ---
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            const filePreviewArea = document.getElementById('file-preview-area');
            const fileNameDisplay = document.getElementById('file-name-display');

            if (file) {
                fileToSend = file;
                fileNameDisplay.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                filePreviewArea.classList.remove('hidden');
                document.getElementById('message-input').placeholder = "á€–á€­á€¯á€„á€ºá€€á€­á€¯ á€•á€­á€¯á€·á€›á€”á€º á€¡á€†á€„á€ºá€á€„á€·á€ºá€•á€«...";
                document.getElementById('message-input').value = ''; 
                document.getElementById('message-input').disabled = true;
            } else {
                clearFileAttachment();
            }
        }
        
        function clearFileAttachment() {
            fileToSend = null;
            document.getElementById('file-input').value = null;
            document.getElementById('file-preview-area').classList.add('hidden');
            document.getElementById('message-input').placeholder = "á€…á€¬á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«...";
            document.getElementById('message-input').disabled = false;
            document.getElementById('message-input').style.height = 'auto'; 
        }

        // --- Message Sending Logic (Using Firestore) ---
        async function sendMessage(text, currentUserId) {
            if (!currentUserId || !isAuthReady) return;

            let newMessageData;

            if (fileToSend) {
                newMessageData = {
                    type: 'media',
                    content: fileToSend.name,
                    timestamp: serverTimestamp(),
                    fromAdmin: true,
                    mediaType: fileToSend.type || 'application/octet-stream',
                    fileSize: fileToSend.size
                };
                showToast(`á€–á€­á€¯á€„á€º (${fileToSend.name}) á€€á€­á€¯ á€•á€­á€¯á€·á€”á€±á€•á€«á€á€Šá€º...`);
                // Important: Clear file attachment BEFORE trying to send to avoid sending the same file again on error
                clearFileAttachment(); 
            } else if (text) {
                newMessageData = {
                    type: 'text',
                    content: text,
                    timestamp: serverTimestamp(),
                    fromAdmin: true
                };
                showToast("á€…á€¬á€•á€­á€¯á€·á€”á€±á€•á€«á€á€Šá€º...");
            } else {
                return;
            }

            try {
                // 1. Add message to subcollection
                await addDoc(getMessagesCollectionRef(currentUserId), newMessageData);

                // 2. Update the parent conversation document (last message preview)
                // Determine the last message text based on what was sent
                const lastMessageText = newMessageData.type === 'media'
                    ? `Admin: [${newMessageData.mediaType.startsWith('image') ? 'á€•á€¯á€¶' : 'á€—á€®á€’á€®á€šá€­á€¯'}] á€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€á€Šá€º`
                    : `Admin: ${text}`;

                const convRef = doc(getConversationsCollectionRef(), currentUserId);
                // Note: We use merge: true to avoid overwriting the whole document
                await setDoc(convRef, {
                    lastMessage: lastMessageText,
                    lastMessageTimestamp: serverTimestamp(),
                    // Optionally reset unreadCount for the admin on reply
                    // unreadCount: 0 
                }, { merge: true });

                showToast("á€…á€¬á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€º!");

            } catch (error) {
                console.error("Error sending message or updating conversation: ", error);
                showToast(`á€…á€¬á€•á€­á€¯á€·á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€á€Šá€º: ${error.code}`);
            }
        }

        function setupInboxEvents(conversationListEl, chatWindowEl) {
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const searchInput = document.getElementById('conversation-search');
            const backButton = document.getElementById('back-button');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            
            // FILE ELEMENTS
            const fileBtn = document.getElementById('file-btn');
            const fileInput = document.getElementById('file-input');
            const clearFileBtn = document.getElementById('clear-file-btn');

            // File selection event
            fileInput.addEventListener('change', handleFileSelect);
            fileBtn.addEventListener('click', () => fileInput.click());
            clearFileBtn.addEventListener('click', clearFileAttachment);


            messageForm.addEventListener('submit', async e => {
                e.preventDefault();
                const text = messageInput.value.trim();
                const currentUserId = document.getElementById('active-user-id').value;
                
                if (!currentUserId) {
                     showToast("á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€›á€”á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€á€…á€ºá€¦á€¸á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹");
                     return;
                }
                
                // Check if a file is attached OR if the text input has content
                if (fileToSend || text) {
                    await sendMessage(text, currentUserId);
                    if (!fileToSend) { // Only clear text input if it was used for sending text
                        messageInput.value = ''; 
                        messageInput.style.height = 'auto'; // Reset textarea height
                    }
                }
            });

            messageInput.addEventListener('input', () => { 
                // Only allow resizing if no file is attached
                if (!fileToSend) {
                    messageInput.style.height = 'auto'; 
                    messageInput.style.height = messageInput.scrollHeight + 'px';
                }
            });

            // Emoji picker
            emojiBtn.addEventListener('click', () => {
                emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            });
            emojiPicker.querySelectorAll('span').forEach(e => e.addEventListener('click', () => {
                if (!fileToSend) {
                    messageInput.value += e.textContent;
                    messageInput.focus();
                    messageInput.style.height = 'auto'; 
                    messageInput.style.height = messageInput.scrollHeight + 'px';
                }
            }));
            
            // Search (client-side filtering of loaded data)
            searchInput.addEventListener('input', () => {
                const filter = searchInput.value.toLowerCase();
                document.querySelectorAll('.chat-item').forEach(item => {
                    const name = item.dataset.userName.toLowerCase();
                    const id = item.dataset.userId.toLowerCase();
                    item.style.display = (name.includes(filter) || id.includes(filter)) ? '' : 'none';
                });
            });
            
            // Mobile back button
            backButton.addEventListener('click', () => {
                const sidebar = document.getElementById('conversation-sidebar');
                if(sidebar) sidebar.classList.remove('hidden');
                if(chatWindowEl) chatWindowEl.classList.add('hidden');
                activeUserId = null;
                const activeUserIdInput = document.getElementById('active-user-id');
                if (activeUserIdInput) activeUserIdInput.value = null;
                clearFileAttachment();
                // Unsubscribe from messages when going back to list
                if (unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
            });
        }
        
        // --- PAGE RENDERING: Integrations UI (NEW) ---
        function renderIntegrationsUI() {
             unsubscribeAll();
             contentContainer.innerHTML = `
                <div id="main-content-card" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6">Bot & API á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯á€™á€»á€¬á€¸ (Integrations)</h2>
                    
                    <p class="text-gray-700 dark:text-gray-300 mb-6">
                        Telegram Bot á€€á€²á€·á€á€­á€¯á€·á€á€±á€¬ á€•á€¼á€„á€ºá€•á€á€”á€ºá€†á€±á€¬á€„á€ºá€™á€¾á€¯á€™á€»á€¬á€¸ (External Services) á€€á€­á€¯ á€œá€€á€ºá€›á€¾á€­ Inbox á€…á€”á€…á€ºá€”á€²á€· á€”á€¾á€…á€ºá€œá€™á€ºá€¸á€á€½á€¬á€¸ (Two-Way) á€á€»á€­á€á€ºá€†á€€á€ºá€”á€­á€¯á€„á€ºá€–á€­á€¯á€·á€¡á€á€½á€€á€º Server-side logic (Firebase Cloud Functions) á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€šá€ºá‹
                        á€¡á€±á€¬á€€á€ºá€•á€« á€¡á€†á€„á€·á€º (á‚) á€†á€„á€·á€ºá€€ á€¡á€†á€­á€¯á€•á€« á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯á€¡á€á€½á€€á€º á€œá€­á€¯á€¡á€•á€ºá€á€²á€· á€—á€­á€á€¯á€€á€¬ (Architecture) á€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€•á€¼á€‘á€¬á€¸á€•á€«á€á€šá€ºá‹
                    </p>

                    <!-- SECTION 1: Telegram to Firestore -->
                    <div class="mb-8 p-4 border border-blue-200 dark:border-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold text-blue-800 dark:text-blue-200 mb-3">
                            áá‹ Telegram á€™á€¾ Firestore á€á€­á€¯á€· (á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° á€…á€¬á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸)
                        </h3>
                        <p class="text-blue-700 dark:text-blue-300 mb-2">
                            á€¤á€¡á€†á€„á€·á€ºá€á€Šá€º Telegram á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€á€…á€ºá€¦á€¸á€™á€¾ á€…á€¬á€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€á€­á€¯á€„á€ºá€¸ Admin Panel á Inbox á€‘á€²á€á€­á€¯á€· á€¡á€á€»á€­á€”á€ºá€”á€¾á€„á€·á€ºá€á€•á€¼á€±á€¸á€Šá€® á€›á€±á€¬á€€á€ºá€›á€¾á€­á€…á€±á€›á€”á€º á€–á€¼á€…á€ºá€á€Šá€ºá‹
                        </p>
                        <ol class="list-decimal list-inside pl-4 space-y-2 text-blue-700 dark:text-blue-300">
                            <li><strong>Webhook á€á€á€ºá€™á€¾á€á€ºá€á€¼á€„á€ºá€¸:</strong> Telegram Bot API á€á€½á€„á€º á€á€„á€ºá Cloud Function á HTTPS endpoint á€€á€­á€¯ Webhook á€¡á€–á€¼á€…á€º á€á€á€ºá€™á€¾á€á€ºá€•á€«á‹</li>
                            <li><strong>Cloud Function (Listener) á€›á€±á€¸á€á€¬á€¸á€á€¼á€„á€ºá€¸:</strong>
                                <ul class="list-disc list-inside ml-4">
                                    <li>á€á€„á€ºá€œá€¬á€á€±á€¬ Telegram á€™á€€á€ºá€†á€±á€·á€á€»á€ºá€€á€­á€¯ á€œá€€á€ºá€á€¶á€•á€¼á€®á€¸áŠ á€™á€€á€ºá€†á€±á€·á€á€»á€ºá€•á€­á€¯á€·á€á€±á€¬á€á€°á Telegram User ID á€€á€­á€¯ Conversation ID á€¡á€–á€¼á€…á€º á€á€¯á€¶á€¸á€•á€«á‹</li>
                                    <li>Firestore Path: <code>/artifacts/${appId}/public/data/conversations/{Telegram_User_ID}/messages</code> á€á€­á€¯á€· á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€›á€±á€¸á€á€½á€„á€ºá€¸á€•á€«á‹</li>
                                    <li>Data Structure: <code>{ type: 'text', content: '...', timestamp: ServerValue.TIMESTAMP, fromAdmin: false }</code></li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <!-- SECTION 2: Firestore to Telegram -->
                    <div class="p-4 border border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold text-green-800 dark:text-green-200 mb-3">
                            á‚á‹ Firestore á€™á€¾ Telegram á€á€­á€¯á€· (Admin á€™á€¾ á€…á€¬á€•á€¼á€”á€ºá€á€¼á€„á€ºá€¸)
                        </h3>
                        <p class="text-green-700 dark:text-green-300 mb-2">
                            á€¤á€¡á€†á€„á€·á€ºá€á€Šá€º Admin á€™á€¾ Inbox á€á€½á€„á€º á€…á€¬á€•á€¼á€”á€ºá€•á€­á€¯á€·á€œá€­á€¯á€€á€ºá€á€Šá€ºá€”á€¾á€„á€·á€º á€‘á€­á€¯á€…á€¬á€€á€­á€¯ Telegram User á€†á€®á€á€­á€¯á€· á€•á€¼á€”á€ºá€œá€Šá€ºá€•á€­á€¯á€·á€†á€±á€¬á€„á€ºá€•á€±á€¸á€›á€”á€º á€–á€¼á€…á€ºá€á€Šá€ºá‹
                        </p>
                        <ol class="list-decimal list-inside pl-4 space-y-2 text-green-700 dark:text-green-300">
                            <li><strong>Cloud Function (Firestore Trigger) á€›á€±á€¸á€á€¬á€¸á€á€¼á€„á€ºá€¸:</strong>
                                <ul class="list-disc list-inside ml-4">
                                    <li>Firestore á€á€½á€„á€º Message á€¡á€á€…á€ºá€á€…á€ºá€á€¯ á€‘á€•á€ºá€‘á€Šá€·á€ºá€á€­á€¯á€„á€ºá€¸ á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€™á€Šá€·á€º Trigger á€á€…á€ºá€á€¯ á€á€á€ºá€™á€¾á€á€ºá€•á€«á‹ (Path: <code>.../conversations/{conversationId}/messages/{messageId}</code>)</li>
                                    <li><strong>Condition:</strong> á€‘á€­á€¯ message á€á€Šá€º Admin á€™á€¾ á€•á€­á€¯á€·á€á€±á€¬ message (<code>fromAdmin: true</code>) á€–á€¼á€…á€ºá€™á€¾á€á€¬ Bot API á€€á€­á€¯ á€á€±á€«á€ºá€†á€­á€¯á€•á€«á‹</li>
                                    <li><strong>Telegram API Call:</strong> <code>conversationId</code> á€€á€­á€¯ Telegram Chat ID á€¡á€–á€¼á€…á€ºá€á€¯á€¶á€¸á€•á€¼á€®á€¸áŠ Admin á á€…á€¬á€á€¬á€¸á€€á€­á€¯ Bot API (<code>sendMessage</code> method) á€™á€¾á€á€…á€ºá€†á€„á€·á€º á€•á€¼á€”á€ºá€•á€­á€¯á€·á€•á€±á€¸á€•á€«á‹</li>
                                </ul>
                            </li>
                            <li><strong>API Key á€œá€­á€¯á€¡á€•á€ºá€á€¼á€„á€ºá€¸:</strong> á€¤ Function á€á€Šá€º Telegram Bot API Key á€€á€­á€¯ á€œá€¯á€¶á€á€¼á€¯á€¶á€…á€½á€¬ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹</li>
                        </ol>
                    </div>

                    <div class="mt-6 p-3 bg-yellow-100 dark:bg-yellow-800/50 border-l-4 border-yellow-500 rounded-lg text-sm text-yellow-800 dark:text-yellow-200">
                        <i class="fas fa-exclamation-triangle mr-2"></i> á€¤ Integration á€…á€”á€…á€ºá€€á€­á€¯ á€¡á€€á€±á€¬á€„á€ºá€¡á€‘á€Šá€ºá€–á€±á€¬á€ºá€›á€”á€ºá€¡á€á€½á€€á€º **Firebase Cloud Functions** (server-side code) á€™á€»á€¬á€¸á€€á€­á€¯ á€á€®á€¸á€á€¼á€¬á€¸ á€›á€±á€¸á€á€¬á€¸ deploy á€œá€¯á€•á€ºá€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹
                    </div>
                </div>
            `;
        }
        
        function renderInboxUI() {
            // Stop any previous message listener
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            
            contentContainer.innerHTML = `
                <h2 class="hidden md:block text-3xl font-bold text-gray-800 dark:text-white mb-6">Inbox</h2>

                <div class="flex flex-col md:flex-row h-[calc(100vh-140px)] md:h-[calc(100vh-200px)] bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                
                    <!-- Sidebar -->
                    <div id="conversation-sidebar" class="w-full md:w-1/3 flex flex-col border-r border-gray-200 dark:border-gray-700 transition-colors duration-300">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <input type="text" id="conversation-search" placeholder="á€¡á€™á€Šá€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º ID á€–á€¼á€„á€·á€º á€›á€¾á€¬á€–á€½á€±á€•á€«..."
                                class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        </div>
                        <div id="conversation-list" class="flex-1 overflow-y-auto">
                             <div class="p-4 text-center text-gray-500 dark:text-gray-400">á€…á€€á€¬á€¸á€á€­á€¯á€„á€ºá€¸á€™á€»á€¬á€¸ á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º...</div>
                        </div>
                    </div>
                
                    <!-- Chat Window -->
                    <div id="chat-window" class="flex-1 flex flex-col hidden md:flex relative transition-colors duration-300">
                        <!-- Mobile Header -->
                        <div class="md:hidden flex items-center justify-start p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <button id="back-button" class="mr-4 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white focus:outline-none">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h4 class="font-semibold text-gray-800 dark:text-white">
                                    <span id="chat-user-name">Select user</span>
                                    <span id="chat-user-id" class="text-sm text-gray-500 dark:text-gray-400 ml-1"></span>
                                </h4>
                            </div>
                        </div>
                
                        <!-- Desktop Header -->
                        <div class="hidden md:flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                            <h4 class="font-semibold text-gray-800 dark:text-white">
                                <span id="chat-user-name-desktop">Select user</span>
                                <span id="chat-user-id-desktop" class="text-sm text-gray-500 dark:text-gray-400 ml-1"></span>
                            </h4>
                        </div>
                
                        <div class="flex flex-col h-full">
                            <!-- Messages -->
                            <div id="messages-container" class="flex-1 pt-6 px-6 pb-20 overflow-y-auto flex flex-col space-y-4 bg-gray-50 dark:bg-gray-900/50">
                                <div class="flex items-center justify-center h-full text-gray-400 dark:text-gray-500">
                                    á€…á€€á€¬á€¸á€•á€¼á€±á€¬á€›á€”á€º á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€á€…á€ºá€¦á€¸á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«
                                </div>
                            </div>
                
                            <!-- Input with emoji, file button, and preview (fixed at bottom) -->
                            <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 sticky bottom-0 z-10 flex flex-col">
                                <!-- File Preview Area -->
                                <div id="file-preview-area" class="flex items-center justify-between p-2 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                                    <div class="flex items-center overflow-hidden">
                                        <i class="fas fa-paperclip text-lg text-blue-500 mr-2"></i>
                                        <span id="file-name-display" class="text-sm font-medium dark:text-gray-300 truncate max-w-xs md:max-w-md"></span>
                                    </div>
                                    <button id="clear-file-btn" class="text-red-500 hover:text-red-700 p-1 rounded-full transition" title="á€–á€­á€¯á€„á€ºá€•á€šá€ºá€–á€»á€€á€ºá€™á€Šá€º">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-end">
                                    <button id="emoji-btn" class="mr-2 text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-lg transition" title="Emojis">ğŸ˜Š</button>

                                    <!-- File Input/Button -->
                                    <input type="file" id="file-input" class="hidden" accept="image/*,video/*">
                                    <button id="file-btn" class="mr-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 p-2 rounded-lg transition flex-shrink-0" title="á€•á€¯á€¶/á€—á€®á€’á€®á€šá€­á€¯ á€•á€­á€¯á€·á€›á€”á€º">
                                        <i class="fas fa-paperclip text-xl"></i>
                                    </button>

                                    <!-- Emoji Picker -->
                                    <div id="emoji-picker" class="emoji-picker">
                                        ${emojis.map(e => `<span>${e}</span>`).join('')}
                                    </div>

                                    <form id="message-form" class="flex-1 flex items-end space-x-2">
                                        <input type="hidden" id="active-user-id">
                                        <textarea id="message-input" class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 max-h-32 overflow-y-auto dark:bg-gray-700 dark:text-white dark:border-gray-600 resize-none" placeholder="á€…á€¬á€›á€­á€¯á€€á€ºá€‘á€Šá€·á€ºá€•á€«..." rows="1" required></textarea>
                                        <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 flex-shrink-0 flex items-center justify-center">
                                            <i class="fas fa-paper-plane mr-2"></i>á€•á€­á€¯á€·á€›á€”á€º
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                
                </div>
            `;
            
            // Get newly created elements
            const conversationListEl = document.getElementById('conversation-list');
            const chatWindowEl = document.getElementById('chat-window');

            // Set up events and listeners
            setupInboxEvents(conversationListEl, chatWindowEl);
            renderConversationList(conversationListEl, chatWindowEl);

            // Handle initial mobile view state
            if (window.innerWidth < 768) { 
                document.getElementById('conversation-sidebar').classList.remove('hidden'); 
                chatWindowEl.classList.add('hidden');
            } else {
                document.getElementById('conversation-sidebar').classList.remove('hidden'); 
                chatWindowEl.classList.remove('hidden');
            }
        }

        function renderDashboardUI() {
             unsubscribeAll();
             contentContainer.innerHTML = `
                <div id="main-content-card" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">Dashboard</h2>
                    <p class="text-gray-700 dark:text-gray-300">
                        This is the main content area for the <strong>Dashboard</strong> page.
                    </p>
                    <div class="mt-4 p-4 border border-indigo-200 dark:border-indigo-700 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-sm text-indigo-800 dark:text-indigo-200">
                        Firebase User ID (Admin): <code>${userId || 'Not signed in'}</code>
                    </div>
                </div>
            `;
        }

        function renderLogoutUI() {
            unsubscribeAll();
            contentContainer.innerHTML = `
                <div id="main-content-card" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">You have been logged out.</h2>
                    <p class="text-gray-700 dark:text-gray-300">
                        Thank you for using the Admin Panel. Your simulated session has been cleared.
                    </p>
                    <a href="#/dashboard" class="mt-6 inline-block px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150">
                        <i class="fas fa-sign-in-alt mr-2"></i> Log In / Go to Dashboard
                    </a>
                </div>
            `;
            localStorage.removeItem('color-theme');
            disableDarkMode();
        }

        function renderGenericUI(path, title) {
             unsubscribeAll();
             contentContainer.innerHTML = `
                <div id="main-content-card" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-4">${title}</h2>
                    <p class="text-gray-700 dark:text-gray-300">
                        This is the main content area for the <strong>${title}</strong> page.
                    </p>
                    <div class="mt-4 p-4 border border-indigo-200 dark:border-indigo-700 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-sm text-indigo-800 dark:text-indigo-200">
                        Current simulated path: <code>${path}</code>
                    </div>
                </div>
            `;
        }


        // --- MAIN ROUTING LOGIC ---
        function updateActiveLink() {
            const currentHash = window.location.hash.replace('#', '') || '/dashboard';

            // Reset all links
            navLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Find the matching link and set it active
            const activeLink = Array.from(navLinks).find(link => link.dataset.path === currentHash);

            if (activeLink) {
                activeLink.classList.add('active');
                const titleText = activeLink.querySelector('span').textContent;
                
                // Update mobile header title
                mobilePageTitle.textContent = titleText;
                
                // Close sidebar on mobile after navigation
                toggleSidebar(false); 

                // Render content based on the active path
                if (currentHash === '/inbox') {
                    renderInboxUI();
                } else if (currentHash === '/dashboard') {
                    renderDashboardUI();
                } else if (currentHash === '/logout') {
                    renderLogoutUI();
                } else if (currentHash === '/integrations') {
                    renderIntegrationsUI(); // NEW Integration page
                } else {
                    renderGenericUI(currentHash, titleText);
                }
            }
        }
        
        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            // Wait for firebaseServices to be populated by the module script
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (window.firebaseServices) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
            });

            ({ 
                db, auth, appId, initialAuthToken, onAuthStateChanged, 
                collection, query, orderBy, limit, onSnapshot, 
                addDoc, serverTimestamp, where
            } = window.firebaseServices);

            if (!db || !auth) {
                 console.error("Firebase services failed to initialize.");
                 return;
            }

            // Authentication state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Admin signed in as:", userId);
                    showToast(`Admin ID: ${userId} á€–á€¼á€„á€·á€º á€á€»á€­á€á€ºá€†á€€á€ºá€‘á€¬á€¸á€á€Šá€º`);
                } else {
                    console.warn("User signed out or failed to sign in.");
                    isAuthReady = true; // Still ready, just unauthenticated (will use anonymous)
                    userId = null;
                }
                
                // Once auth is checked, load the initial content
                updateActiveLink();
            });

            // Attempt Custom Token Sign-In first
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no token is available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                showToast(`Auth á€¡á€™á€¾á€¬á€¸: ${error.code}`);
                // Proceed, let onAuthStateChanged handle the unauthenticated state
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeFirebase(); // Start Firebase and Auth flow

            toggleButton.addEventListener('click', () => {
                if (htmlElement.classList.contains('dark')) {
                    disableDarkMode();
                } else {
                    enableDarkMode();
                }
            });

            // NEW: Menu Toggle Events
            menuToggleBtn.addEventListener('click', () => toggleSidebar(true));
            closeMenuBtn.addEventListener('click', () => toggleSidebar(false));
            menuOverlay.addEventListener('click', () => toggleSidebar(false));

            // Run when hash changes (user clicks navigation links)
            window.addEventListener('hashchange', updateActiveLink);
            
            // Set initial hash if none exists (defaults to dashboard)
            if (!window.location.hash) {
                window.location.hash = '/dashboard';
            }
        });
    </script>
</body>
</html>
