<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Channel Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        .scrollbar-hidden::-webkit-scrollbar { display: none; }
        .scrollbar-hidden { -ms-overflow-style: none; scrollbar-width: none; }
        .menu-link {
            @apply flex items-center p-3 text-sm font-medium text-gray-700 rounded-lg transition duration-150 ease-in-out hover:bg-indigo-100 hover:text-indigo-700 shadow-sm mb-2;
        }
        .menu-link.active {
            @apply bg-indigo-600 text-white shadow-lg;
        }
        .menu-link.active:hover {
             @apply bg-indigo-700 text-white;
        }
        .user-message {
            @apply bg-gray-100 text-gray-800 p-3 rounded-tr-xl rounded-b-xl max-w-lg shadow-sm self-start;
        }
        .admin-message {
            @apply bg-indigo-600 text-white p-3 rounded-tl-xl rounded-b-xl max-w-lg shadow-md self-end;
        }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden">

    <!-- 1. Sidebar -->
    <aside id="sidebar" class="w-64 flex-shrink-0 bg-white border-r border-gray-200 shadow-xl transition-all duration-300">
        <div class="p-6 h-full flex flex-col">
            <h1 class="text-3xl font-extrabold text-indigo-600 mb-8 border-b pb-4">OmniChat Admin</h1>
            
            <nav id="menu-nav" class="flex-grow">
                <a href="#" class="menu-link" data-page="dashboard" onclick="app.setPage('dashboard')">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-link" data-page="tg_chats" onclick="app.setPage('tg_chats')">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20l9-2-9-2L3 20l9 2zm0-4l9-2-9-2L3 16l9 2zm0-4l9-2-9-2L3 12l9 2z"/></svg>
                    <span>TG Chats</span>
                </a>
                <a href="#" class="menu-link" data-page="fb_chats" onclick="app.setPage('fb_chats')">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>FB Chats</span>
                </a>
                <a href="#" class="menu-link" data-page="user_list" onclick="app.setPage('user_list')">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M20 10.5V8a6 6 0 00-6-6h-2a6 6 0 00-6 6v2.5M6 9h3v3H6V9zm4 0h3v3h-3V9zm4 0h3v3h-3V9z"/></svg>
                    <span>TG User List</span>
                </a>
                <a href="#" class="menu-link" data-page="broadcast" onclick="app.setPage('broadcast')">
                    <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.75 1.75 0 01-3.5 0v-1.118a1.75 1.75 0 00-3.5 0v1.118a1.75 1.75 0 01-3.5 0V5.882a1.75 1.75 0 013.5 0v1.118a1.75 1.75 0 003.5 0V5.882a1.75 1.75 0 013.5 0zM17 13h4m-2-2v4"/></svg>
                    <span>TG User Broadcast</span>
                </a>
            </nav>

            <a href="#" class="menu-link mt-auto" data-page="settings" onclick="app.setPage('settings')">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.945 3.31.84 2.704 2.432a1.724 1.724 0 00.076 2.572c1.337 1.34-1.025 3.65-2.572 2.704a1.724 1.724 0 00-1.066 2.573c.945 1.543-.84 3.31-2.432 2.704a1.724 1.724 0 00-2.572.076c-1.34 1.337-3.65-1.025-2.704-2.572a1.724 1.724 0 00-2.573-1.066c-1.543.945-3.31-.84-2.704-2.432a1.724 1.724 0 00-.076-2.572c-1.337-1.34 1.025-3.65 2.572-2.704a1.724 1.724 0 001.066-2.573c-.945-1.543.84-3.31 2.432-2.704z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>Settings</span>
            </a>
        </div>
    </aside>

    <!-- 2. Main Content Area -->
    <main class="flex-grow overflow-auto p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-6">
                <h2 id="page-title" class="text-3xl font-bold text-gray-900 transition-opacity duration-300"></h2>
            </header>
            
            <!-- Dynamic Content Area -->
            <div id="content-container">
                <!-- Views will be injected here -->
            </div>
        </div>
    </main>

    <!-- 3. Custom Alert/Modal -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-semibold mb-3 text-indigo-600"></h3>
            <p id="modal-body" class="text-gray-700 mb-6"></p>
            <button onclick="app.closeModal()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition duration-150">Close</button>
        </div>
    </div>


    <script>
        const API_URL = ''; // Empty string means relative path
        let socket;

        // Global App State
        const app = {
            currentPage: 'dashboard',
            selectedChatId: null,
            chats: [],
            messages: [],
            users: [],
            platformFilter: null,
            
            // Utility for fetching data (Handles Basic Auth)
            async authFetch(endpoint, options = {}) {
                const username = localStorage.getItem('adminUser') || 'admin';
                const password = localStorage.getItem('adminPass') || 'password';
                
                options.headers = {
                    ...options.headers,
                    'Authorization': 'Basic ' + btoa(username + ":" + password),
                    'Content-Type': 'application/json'
                };

                const response = await fetch(API_URL + endpoint, options);
                
                if (response.status === 401) {
                    // Attempt basic auth challenge if not already set or failed
                    app.showAuthPrompt();
                    throw new Error('Authentication required.');
                }
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ message: 'Server error' }));
                    throw new Error(errorBody.error || errorBody.message || `HTTP error! Status: ${response.status}`);
                }
                
                return response.json();
            },

            // Basic Auth Prompt (simplified for this environment)
            showAuthPrompt() {
                const username = prompt("Admin Username:");
                const password = prompt("Admin Password:");
                if (username && password) {
                    localStorage.setItem('adminUser', username);
                    localStorage.setItem('adminPass', password);
                    app.setPage(app.currentPage); // Try reloading the page/data
                } else {
                    app.showModal('Authentication Failed', 'You must provide credentials to access the dashboard.');
                }
            },

            // UI Helpers
            showModal(title, body) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').textContent = body;
                document.getElementById('modal-container').classList.remove('hidden');
            },

            closeModal() {
                document.getElementById('modal-container').classList.add('hidden');
            },

            // Navigation/Router
            setPage(page, chatId = null) {
                this.currentPage = page;
                this.selectedChatId = chatId;
                this.platformFilter = ['tg_chats', 'fb_chats'].includes(page) ? page.split('_')[0] : null;

                document.querySelectorAll('.menu-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === page) {
                        link.classList.add('active');
                    }
                });

                document.getElementById('page-title').textContent = this.getPageTitle(page);
                this.renderPage();
            },

            getPageTitle(page) {
                const titles = {
                    'dashboard': 'Dashboard Overview',
                    'tg_chats': 'Telegram Live Chats',
                    'fb_chats': 'Facebook Live Chats',
                    'user_list': 'System User Management',
                    'broadcast': 'Telegram Broadcast Message',
                    'settings': 'Settings & Configuration'
                };
                return titles[page] || 'Dashboard';
            },

            // Core Render Function
            renderPage() {
                const container = document.getElementById('content-container');
                container.innerHTML = '';
                
                switch (this.currentPage) {
                    case 'dashboard':
                        this.renderDashboard(container);
                        break;
                    case 'tg_chats':
                    case 'fb_chats':
                        this.renderChats(container);
                        break;
                    case 'user_list':
                        this.renderUserList(container);
                        break;
                    case 'broadcast':
                        this.renderBroadcast(container);
                        break;
                    case 'settings':
                        this.renderSettings(container);
                        break;
                    default:
                        this.renderDashboard(container);
                }
            },
            
            // --- View Renderers ---
            
            renderDashboard(container) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-200">
                            <p class="text-sm font-medium text-gray-500">Total Chats</p>
                            <p class="text-4xl font-bold text-indigo-600 mt-2">${this.chats.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-green-200">
                            <p class="text-sm font-medium text-gray-500">Telegram Chats</p>
                            <p class="text-4xl font-bold text-green-600 mt-2">${this.chats.filter(c => c.platform === 'telegram').length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-200">
                            <p class="text-sm font-medium text-gray-500">Facebook Chats</p>
                            <p class="text-4xl font-bold text-blue-600 mt-2">${this.chats.filter(c => c.platform === 'facebook').length}</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Activity</h3>
                        <p class="text-gray-500">Real-time updates are handled by Socket.io. Click on 'TG Chats' or 'FB Chats' to manage conversations.</p>
                    </div>
                `;
            },

            async renderChats(container) {
                container.innerHTML = `
                    <div class="flex h-[80vh] bg-white rounded-xl shadow-2xl overflow-hidden">
                        <!-- Chat List Panel -->
                        <div id="chat-list-panel" class="w-full md:w-1/3 border-r border-gray-200 overflow-y-auto scrollbar-hidden">
                            <div class="p-4 bg-gray-50 sticky top-0 z-10 border-b">
                                <h3 class="text-lg font-semibold text-gray-800 capitalize">${this.platformFilter} Chats</h3>
                                <p class="text-sm text-gray-500">${this.chats.filter(c => c.platform === this.platformFilter).length} active conversations</p>
                            </div>
                            <div id="chats-list">
                                <!-- Chat items will be injected here -->
                                <p class="p-4 text-center text-gray-400">Loading chats...</p>
                            </div>
                        </div>

                        <!-- Chat History Panel -->
                        <div id="chat-history-panel" class="w-full md:w-2/3 flex flex-col">
                            <div id="chat-header" class="p-4 bg-gray-50 border-b border-gray-200 text-center sticky top-0 z-10">
                                <p class="text-gray-500 font-medium">Select a conversation to view history</p>
                            </div>
                            <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col scrollbar-hidden">
                                <!-- Messages will be injected here -->
                            </div>
                            <div id="reply-box" class="p-4 border-t border-gray-200 hidden">
                                <input type="text" id="reply-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-inner" placeholder="Type your reply here...">
                                <button onclick="app.sendReply()" class="mt-2 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">Send Reply</button>
                            </div>
                        </div>
                    </div>
                `;
                this.fetchChats();
            },

            // Chat List Logic
            async fetchChats() {
                try {
                    const chats = await this.authFetch(`/api/chats?platform=${this.platformFilter}`);
                    this.chats = chats;
                    this.renderChatList();
                    if (this.selectedChatId) {
                        this.fetchHistory(this.selectedChatId);
                    }
                } catch (error) {
                    console.error("Error fetching chats:", error);
                    app.showModal('Error', `Could not load chats: ${error.message}`);
                }
            },

            renderChatList() {
                const list = document.getElementById('chats-list');
                const filteredChats = this.chats.filter(c => c.platform === this.platformFilter);
                
                if (filteredChats.length === 0) {
                    list.innerHTML = `<p class="p-4 text-center text-gray-500">No active chats for ${this.platformFilter}.</p>`;
                    return;
                }

                list.innerHTML = filteredChats.map(chat => `
                    <div onclick="app.fetchHistory('${chat.telegramId}')" 
                         class="p-4 border-b border-gray-100 cursor-pointer transition duration-100 ${this.selectedChatId === chat.telegramId ? 'bg-indigo-50 border-l-4 border-indigo-600' : 'hover:bg-gray-100'}">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-900">${chat.username || chat.telegramId}</p>
                            <span class="text-xs text-gray-500">${this.formatTimestamp(chat.lastMessageTime)}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate mt-1">${chat.lastMessageText || 'Media/Attachment'}</p>
                        <span class="text-xs text-gray-400 capitalize">${chat.platform}</span>
                    </div>
                `).join('');
            },

            // Chat History Logic
            async fetchHistory(chatId) {
                this.selectedChatId = chatId;
                this.renderChatList(); // Update highlight
                
                const messagesContainer = document.getElementById('messages-container');
                const chatHeader = document.getElementById('chat-header');
                const replyBox = document.getElementById('reply-box');
                
                const currentChat = this.chats.find(c => c.telegramId === chatId);
                chatHeader.innerHTML = `
                    <p class="text-xl font-bold text-gray-900">${currentChat.username || currentChat.telegramId}</p>
                    <p class="text-sm text-gray-500 capitalize">Platform: ${currentChat.platform}</p>
                `;
                replyBox.classList.remove('hidden');
                messagesContainer.innerHTML = `<p class="p-4 text-center text-gray-400">Loading history...</p>`;

                try {
                    const history = await this.authFetch(`/api/chats/${chatId}/history`);
                    this.messages = history;
                    this.renderMessages();
                } catch (error) {
                    console.error("Error fetching history:", error);
                    messagesContainer.innerHTML = `<p class="p-4 text-center text-red-500">Error loading history: ${error.message}</p>`;
                }
            },

            renderMessages() {
                const container = document.getElementById('messages-container');
                container.innerHTML = this.messages.map(msg => {
                    const isUser = msg.sender === 'user';
                    const cssClass = isUser ? 'user-message' : 'admin-message';
                    const alignment = isUser ? 'self-start' : 'self-end';
                    
                    let content = '';
                    if (msg.mediaPath) {
                        const mediaName = msg.filename || 'Media File';
                        content += `<p class="text-sm font-semibold">${mediaName}</p>`;
                        // Note: Media download link is not fully functional as the server only stores file_id
                        content += `<p class="text-xs text-gray-400 mt-1">File ID: ${msg.mediaPath.substring(0, 15)}...</p>`;
                    }
                    if (msg.text) {
                        content += `<p class="mt-1">${msg.text}</p>`;
                    }

                    return `
                        <div class="flex flex-col ${alignment} w-full">
                            <div class="${cssClass} text-base max-w-sm md:max-w-md lg:max-w-lg mb-1">
                                ${content}
                            </div>
                            <p class="text-xs text-gray-400 ${alignment === 'self-end' ? 'text-right' : 'text-left'}">${this.formatTimestamp(msg.timestamp)}</p>
                        </div>
                    `;
                }).join('');
                
                container.scrollTop = container.scrollHeight; // Scroll to bottom
            },

            async sendReply() {
                const input = document.getElementById('reply-input');
                const text = input.value.trim();
                const chatId = this.selectedChatId;

                if (!text || !chatId) return;

                input.disabled = true;
                const sendButton = document.querySelector('#reply-box button');
                sendButton.textContent = 'Sending...';

                socket.emit('admin_reply', { chatId, text }, (response) => {
                    input.disabled = false;
                    sendButton.textContent = 'Send Reply';
                    input.value = '';
                    if (response.success) {
                        // Message will be added via Socket.io listener 'message_sent'
                    } else {
                        app.showModal('Error Sending Message', response.error);
                    }
                });
            },

            // User List Logic
            async renderUserList(container) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Add New System User</h3>
                        <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="user-name" class="p-2 border border-gray-300 rounded-lg" placeholder="Name (Required)" required>
                            <select id="user-role" class="p-2 border border-gray-300 rounded-lg">
                                <option>Viewer</option>
                                <option>Editor</option>
                                <option>Admin</option>
                            </select>
                            <select id="user-status" class="p-2 border border-gray-300 rounded-lg">
                                <option>Active</option>
                                <option>Inactive</option>
                            </select>
                            <button type="submit" class="bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150">Add User</button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Existing System Users</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('add-user-form').onsubmit = this.addUser.bind(this);
                this.fetchUsers();
            },

            async fetchUsers() {
                try {
                    const users = await this.authFetch('/api/users');
                    this.users = users;
                    this.renderUserTable();
                } catch (error) {
                    console.error("Error fetching users:", error);
                    app.showModal('Error', `Could not load users: ${error.message}`);
                }
            },

            renderUserTable() {
                const tbody = document.getElementById('user-table-body');
                if (!tbody) return;

                if (this.users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No system users found.</td></tr>`;
                    return;
                }

                tbody.innerHTML = this.users.map(user => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="app.deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 transition duration-150">Delete</button>
                        </td>
                    </tr>
                `).join('');
            },

            async addUser(event) {
                event.preventDefault();
                const name = document.getElementById('user-name').value;
                const role = document.getElementById('user-role').value;
                const status = document.getElementById('user-status').value;

                try {
                    const newUser = await this.authFetch('/api/users', {
                        method: 'POST',
                        body: JSON.stringify({ name, role, status })
                    });
                    this.users.push(newUser);
                    this.renderUserTable();
                    document.getElementById('add-user-form').reset();
                    app.showModal('Success', `${name} added successfully.`);
                } catch (error) {
                    app.showModal('Error', `Failed to add user: ${error.message}`);
                }
            },

            async deleteUser(userId) {
                if (!confirm('Are you sure you want to delete this user?')) return;
                try {
                    await this.authFetch(`/api/users/${userId}`, { method: 'DELETE' });
                    this.users = this.users.filter(u => u.id !== userId);
                    this.renderUserTable();
                    app.showModal('Success', 'User deleted successfully.');
                } catch (error) {
                    app.showModal('Error', `Failed to delete user: ${error.message}`);
                }
            },

            // Broadcast Logic
            renderBroadcast(container) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl mx-auto">
                        <p class="text-gray-600 mb-6 border-b pb-4">Send a broadcast message to ALL users who have previously messaged the Telegram Bot.</p>
                        
                        <form id="broadcast-form">
                            <label for="broadcast-message" class="block text-sm font-medium text-gray-700 mb-2">Message Content</label>
                            <textarea id="broadcast-message" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-inner" placeholder="Enter your message here..." required></textarea>
                            <p id="char-count" class="text-xs text-gray-500 text-right mt-1">0/1024 characters</p>
                            
                            <button type="submit" id="broadcast-btn" class="mt-6 w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-lg">
                                Send Broadcast to Telegram Users
                            </button>
                            <p id="broadcast-status" class="mt-4 text-center font-medium"></p>
                        </form>
                    </div>
                `;

                const form = document.getElementById('broadcast-form');
                const textarea = document.getElementById('broadcast-message');
                const charCount = document.getElementById('char-count');
                
                textarea.oninput = () => {
                    const count = textarea.value.length;
                    charCount.textContent = `${count}/1024 characters`;
                    if (count > 1024) {
                        textarea.value = textarea.value.substring(0, 1024);
                        charCount.classList.add('text-red-500');
                    } else {
                        charCount.classList.remove('text-red-500');
                    }
                };

                form.onsubmit = this.sendBroadcast.bind(this);
            },

            async sendBroadcast(event) {
                event.preventDefault();
                const message = document.getElementById('broadcast-message').value.trim();
                const btn = document.getElementById('broadcast-btn');
                const statusEl = document.getElementById('broadcast-status');

                if (!message) return;

                btn.disabled = true;
                btn.textContent = 'Initiating Broadcast...';
                statusEl.className = 'mt-4 text-center font-medium text-blue-600';
                statusEl.textContent = 'Sending messages in the background. Please wait...';

                try {
                    const result = await this.authFetch('/api/broadcast/telegram', {
                        method: 'POST',
                        body: JSON.stringify({ message })
                    });
                    
                    statusEl.className = 'mt-4 text-center font-medium text-green-600';
                    statusEl.textContent = result.message;
                    document.getElementById('broadcast-message').value = '';
                } catch (error) {
                    statusEl.className = 'mt-4 text-center font-medium text-red-600';
                    statusEl.textContent = `Broadcast Failed: ${error.message}`;
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Send Broadcast to Telegram Users';
                }
            },

            // Settings View
            renderSettings(container) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Admin Credentials</h3>
                        <p class="text-gray-600 mb-4">These credentials are used for Basic HTTP Authentication on all API endpoints.</p>
                        <button onclick="app.showAuthPrompt()" class="bg-indigo-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150">
                            Update Username/Password
                        </button>
                    </div>
                `;
            },
            
            // --- Helper Functions ---
            formatTimestamp(isoString) {
                if (!isoString) return 'N/A';
                const date = new Date(isoString);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ' ' + 
                       date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        };

        // --- Initialization ---

        function initSocket() {
            socket = io();

            // Listener for new messages from Telegram/Facebook
            socket.on('new_message', (data) => {
                console.log('New message received:', data);
                
                // 1. Update the overall chat list
                const existingIndex = app.chats.findIndex(c => c.telegramId === data.chatId);
                const newChat = { 
                    telegramId: data.chatId, 
                    ...data.user, 
                    lastMessageTime: data.message.timestamp 
                };

                if (existingIndex !== -1) {
                    app.chats.splice(existingIndex, 1); // Remove old position
                }
                app.chats.unshift(newChat); // Add to top
                
                // 2. Re-render chat list if on the current page
                if (app.platformFilter === data.platform) {
                    app.renderChatList();
                }

                // 3. Update messages if the chat is currently selected
                if (app.selectedChatId === data.chatId) {
                    app.messages.push(data.message);
                    app.renderMessages();
                }
            });

            // Listener for messages sent by the admin (confirmation)
            socket.on('message_sent', (data) => {
                console.log('Message sent confirmed:', data);
                
                // 1. Update the chat list to reflect latest activity (optional, done by 'new_message' or 'fetchChats')
                
                // 2. Update messages if the chat is currently selected
                if (app.selectedChatId === data.chatId) {
                    app.messages.push(data.message);
                    app.renderMessages();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSocket();
            // Start with the basic auth check/prompt
            if (!localStorage.getItem('adminUser')) {
                app.showAuthPrompt();
            }
            // Load the initial page
            app.setPage('tg_chats'); // Default to Telegram Chats
        });

    </script>

</body>
</html>
