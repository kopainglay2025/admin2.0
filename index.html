<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Chat Integrator</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Heroicons (for SVG icons) -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* small niceties */
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(6px); }
    .menu-item:hover { transform: translateX(6px); }
    .scroll-shadow { box-shadow: inset 0 -10px 10px -10px rgba(0,0,0,0.3); }
  </style>
</head>
<body class="bg-gray-900 text-slate-200 font-sans min-h-screen">
  <div class="flex h-screen">
    <!-- Left Sidebar -->
    <aside class="w-72 bg-gradient-to-b from-slate-800 to-slate-900 p-4 flex flex-col gap-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">A</div>
        <div>
          <div class="text-lg font-semibold">Admin Panel</div>
          <div class="text-sm text-slate-400">Chat Integrator</div>
        </div>
      </div>

      <nav class="flex-1">
        <ul class="space-y-1">
          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4v11H3zM10 3h4v18h-4zM17 7h4v14h-4z"/></svg>
            <span>Dashboard</span>
          </li>

          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="fbchats">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878V24l3.219-1.688C17.019 22.934 19.5 22 22 22V12z"/></svg>
            <span>FB Chats</span>
          </li>

          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="tgchats">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M21.447 4.697L2.927 11.17c-.944.325-.785 1.513.18 1.711l4.292.695 1.717 5.214c.286.88 1.535.821 1.75-.081L17.06 6.94c.316-1.137-1.05-1.962-1.98-1.243z"/></svg>
            <span>TG Chats</span>
          </li>

          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="users">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-4-4h-1M9 20H4v-2a4 4 0 014-4h1m0-4a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span>TG User List</span>
          </li>

          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="broadcast">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A2 2 0 0122 9.618v4.764a2 2 0 01-2.447 1.894L15 14M4 9v6m0 0l4-3m-4 3l4 3"/></svg>
            <span>TG User Broadcast</span>
          </li>

          <li class="menu-item p-2 rounded-md hover:bg-slate-800 transition-all cursor-pointer flex items-center gap-3" data-view="settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-1.164 1.96-1.164 2.259 0a1.724 1.724 0 002.582 1.02c1.088-.63 2.45.42 2.027 1.664a1.724 1.724 0 00.435 1.872c.9.8.374 2.36-.873 2.312a1.724 1.724 0 00-1.46 1.19c-.29 1.088-1.876 1.088-2.166 0a1.724 1.724 0 00-1.459-1.19c-1.247.048-1.773-1.512-.873-2.312a1.724 1.724 0 00.435-1.872c-.423-1.244.939-2.294 2.027-1.664.86.5 1.9-.06 2.582-1.02z"/></svg>
            <span>Settings</span>
          </li>
        </ul>
      </nav>

      <div class="text-xs text-slate-500">Server: <span id="server-status">unknown</span></div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">Admin Dashboard</h1>
        <div class="flex items-center gap-3">
          <div class="text-sm text-slate-400">Logged as <span id="admin-user">-</span></div>
          <button id="logoutBtn" class="px-3 py-1 rounded-md bg-slate-800 hover:bg-slate-700 transition">Logout</button>
        </div>
      </header>

      <section id="view-container" class="h-[calc(100vh-140px)] overflow-auto scroll-shadow p-4 glass rounded-lg">
        <!-- Views are injected here -->

        <div id="view-dashboard" class="view hidden">
          <div class="grid grid-cols-3 gap-4">
            <div class="p-4 rounded-lg bg-slate-800"> <div class="text-sm text-slate-400">Total Chats</div><div id="stat-chats" class="text-2xl mt-2 font-bold">-</div></div>
            <div class="p-4 rounded-lg bg-slate-800"> <div class="text-sm text-slate-400">Users</div><div id="stat-users" class="text-2xl mt-2 font-bold">-</div></div>
            <div class="p-4 rounded-lg bg-slate-800"> <div class="text-sm text-slate-400">Last Activity</div><div id="stat-last" class="text-2xl mt-2 font-bold">-</div></div>
          </div>

          <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">Recent Messages</h3>
            <div id="recent-messages" class="space-y-2"></div>
          </div>
        </div>

        <div id="view-fbchats" class="view hidden">
          <h2 class="text-lg font-semibold mb-3">Facebook Chats</h2>
          <div class="mb-3 flex gap-2">
            <input id="fb-search" placeholder="Search..." class="flex-1 p-2 rounded bg-slate-900" />
            <button id="refresh-fb" class="px-3 py-1 rounded bg-indigo-600">Refresh</button>
          </div>
          <div id="fb-list" class="space-y-2"></div>
        </div>

        <div id="view-tgchats" class="view hidden">
          <h2 class="text-lg font-semibold mb-3">Telegram Chats</h2>
          <div class="mb-3 flex gap-2">
            <input id="tg-search" placeholder="Search..." class="flex-1 p-2 rounded bg-slate-900" />
            <button id="refresh-tg" class="px-3 py-1 rounded bg-indigo-600">Refresh</button>
          </div>
          <div id="tg-list" class="space-y-2"></div>
        </div>

        <div id="view-users" class="view hidden">
          <h2 class="text-lg font-semibold mb-3">System Users</h2>
          <div class="mb-3 flex gap-2">
            <input id="user-name" placeholder="Name" class="p-2 rounded bg-slate-900" />
            <select id="user-role" class="p-2 rounded bg-slate-900">
              <option>Viewer</option><option>Moderator</option><option>Admin</option>
            </select>
            <button id="create-user" class="px-3 py-1 rounded bg-green-600">Create</button>
          </div>
          <div id="user-list" class="space-y-2"></div>
        </div>

        <div id="view-broadcast" class="view hidden">
          <h2 class="text-lg font-semibold mb-3">Broadcast</h2>
          <div class="mb-3">
            <textarea id="broadcast-text" rows="4" class="w-full p-3 rounded bg-slate-900" placeholder="Message to broadcast"></textarea>
            <div class="flex items-center gap-2 mt-2">
              <button id="send-broadcast" class="px-4 py-2 rounded bg-indigo-600">Send to All</button>
              <div class="text-sm text-slate-400">Be careful — this will send a message to every saved user.</div>
            </div>
          </div>
        </div>

        <div id="view-settings" class="view hidden">
          <h2 class="text-lg font-semibold mb-3">Settings</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-slate-400">FB Page Token</label>
              <input id="input-fb-token" class="w-full p-2 rounded bg-slate-900" placeholder="FB_PAGE_ACCESS_TOKEN" />
            </div>
            <div>
              <label class="block text-sm text-slate-400">Telegram Bot Token</label>
              <input id="input-tg-token" class="w-full p-2 rounded bg-slate-900" placeholder="TELEGRAM_BOT_TOKEN" />
            </div>
            <div class="flex gap-2">
              <button id="save-settings" class="px-4 py-2 rounded bg-green-600">Save</button>
              <button id="test-connection" class="px-4 py-2 rounded bg-indigo-600">Test Server</button>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center">
    <div class="w-[420px] bg-slate-800 p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold mb-4">Admin Login</h3>
      <div class="space-y-3">
        <input id="auth-user" placeholder="Username" class="w-full p-2 rounded bg-slate-900" />
        <input id="auth-pass" placeholder="Password" type="password" class="w-full p-2 rounded bg-slate-900" />
        <div class="flex justify-end gap-2">
          <button id="loginBtn" class="px-4 py-2 rounded bg-indigo-600">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Basic front-end admin dashboard logic
    const socket = io();
    let basicAuthHeader = null;

    function showView(name) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      document.getElementById('view-' + name).classList.remove('hidden');
    }

    // Menu clicks
    document.querySelectorAll('[data-view]').forEach(el => {
      el.addEventListener('click', () => {
        const view = el.getAttribute('data-view');
        showView(view);
        if (view === 'tgchats') loadChats('telegram');
        if (view === 'fbchats') loadChats('facebook');
        if (view === 'users') loadUsers();
      });
    });

    // Login
    document.getElementById('loginBtn').addEventListener('click', () => {
      const user = document.getElementById('auth-user').value.trim();
      const pass = document.getElementById('auth-pass').value;
      if (!user || !pass) return alert('Enter credentials');
      basicAuthHeader = 'Basic ' + btoa(user + ':' + pass);
      document.getElementById('admin-user').innerText = user;
      document.getElementById('login-modal').style.display = 'none';
      serverStatus();
      showView('dashboard');
      loadChats();
      loadUsers();
    });

    document.getElementById('logoutBtn').addEventListener('click', () => location.reload());

    // API helpers
    async function apiGet(path, params) {
      const res = await axios.get(path, { params, headers: { Authorization: basicAuthHeader } });
      return res.data;
    }
    async function apiPost(path, data) {
      const res = await axios.post(path, data, { headers: { Authorization: basicAuthHeader } });
      return res.data;
    }

    // Load chats (optionally by platform)
    async function loadChats(platform) {
      try {
        const chats = await apiGet('/api/chats', { platform });
        const listEl = document.getElementById(platform === 'facebook' ? 'fb-list' : 'tg-list');
        listEl.innerHTML = '';
        if (!chats.length) listEl.innerHTML = '<div class="p-3 bg-slate-900 rounded">No chats</div>';
        chats.forEach(c => {
          const item = document.createElement('div');
          item.className = 'p-3 bg-slate-900 rounded flex items-start justify-between gap-3';
          item.innerHTML = `
            <div>
              <div class="font-semibold">${c.username || c.telegramId}</div>
              <div class="text-sm text-slate-400">${c.lastMessageText || ''}</div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <div class="text-xs text-slate-400">${c.lastMessageTime || '-'}</div>
              <div class="flex gap-2">
                <button class="reply-btn px-2 py-1 rounded bg-indigo-600" data-id="${c.telegramId}" data-platform="${c.platform}">Reply</button>
                <button class="history-btn px-2 py-1 rounded bg-slate-700" data-id="${c.telegramId}">History</button>
              </div>
            </div>
          `;
          listEl.appendChild(item);
        });
        attachChatButtons();
      } catch (err) {
        console.error(err); alert('Failed to load chats. Check console.');
      }
    }

    function attachChatButtons() {
      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const chatId = btn.getAttribute('data-id');
          const text = prompt('Message to send:');
          if (!text) return;
          socket.emit('admin_reply', { chatId, text }, (resp) => {
            if (resp.success) alert('Sent'); else alert('Error: '+resp.error);
          });
        });
      });

      document.querySelectorAll('.history-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const chatId = btn.getAttribute('data-id');
          try {
            const history = await apiGet(`/api/chats/${chatId}/history`);
            const html = history.map(h => `<div class="p-2 bg-slate-800 rounded mb-1"><div class="text-xs text-slate-400">${h.sender} • ${h.timestamp}</div><div>${h.text || h.filename || 'Media'}</div></div>`).join('');
            const w = window.open('', '_blank', 'width=600,height=700');
            w.document.write(`<body style="background:#0f1724;color:#e6eef8;font-family:system-ui;padding:12px;"><h3>History for ${chatId}</h3>${html}</body>`);
          } catch (err) { console.error(err); alert('Failed to fetch history'); }
        });
      });
    }

    // Users
    async function loadUsers() {
      try {
        const users = await apiGet('/api/users');
        document.getElementById('user-list').innerHTML = '';
        users.forEach(u => {
          const el = document.createElement('div');
          el.className = 'p-3 bg-slate-900 rounded flex items-center justify-between';
          el.innerHTML = `<div><div class="font-semibold">${u.name}</div><div class="text-xs text-slate-400">${u.role} • ${u.status}</div></div><div class="flex gap-2"><button class='delete-user px-2 py-1 rounded bg-red-600' data-id='${u.id}'>Delete</button></div>`;
          document.getElementById('user-list').appendChild(el);
        });
        document.querySelectorAll('.delete-user').forEach(b => b.addEventListener('click', async () => {
          if (!confirm('Delete user?')) return;
          const id = b.getAttribute('data-id');
          await axios.delete(`/api/users/${id}`, { headers: { Authorization: basicAuthHeader } });
          loadUsers();
        }));
      } catch(err) { console.error(err); }
    }

    document.getElementById('create-user').addEventListener('click', async () => {
      const name = document.getElementById('user-name').value.trim();
      const role = document.getElementById('user-role').value;
      if (!name) return alert('Enter name');
      try {
        await apiPost('/api/users', { name, role });
        document.getElementById('user-name').value = '';
        loadUsers();
      } catch(err){ console.error(err); alert('Failed to create'); }
    });

    // Broadcast (simple: will iterate users and send via admin_reply, but server does not provide broadcast endpoint)
    document.getElementById('send-broadcast').addEventListener('click', async () => {
      const text = document.getElementById('broadcast-text').value.trim();
      if (!text) return alert('Enter message');
      if (!confirm('Send broadcast to all users?')) return;
      try {
        const users = await apiGet('/api/users');
        for (const u of users) {
          socket.emit('admin_reply', { chatId: u.id, text }, (r) => console.log('sent', r));
        }
        alert('Broadcast sent (requests queued)');
      } catch (err) { console.error(err); alert('Failed to broadcast'); }
    });

    // Settings
    document.getElementById('save-settings').addEventListener('click', () => {
      alert('Settings are stored as env on server. Edit .env or use your deployment to change tokens.');
    });

    document.getElementById('test-connection').addEventListener('click', serverStatus);

    async function serverStatus() {
      try {
        const chats = await apiGet('/api/chats');
        document.getElementById('server-status').innerText = 'online';
        document.getElementById('stat-chats').innerText = chats.length;
        document.getElementById('stat-last').innerText = chats[0]?.lastMessageTime || '-';
        const users = await apiGet('/api/users');
        document.getElementById('stat-users').innerText = users.length;

        // recent messages
        const rec = chats.slice(0,5).map(c => `<div class="p-2 bg-slate-800 rounded"><div class="font-medium">${c.username||c.telegramId}</div><div class="text-sm text-slate-400">${c.lastMessageText||''}</div></div>`).join('');
        document.getElementById('recent-messages').innerHTML = rec;
      } catch (err) {
        document.getElementById('server-status').innerText = 'offline';
        console.error(err);
        alert('Server not reachable or auth failed');
      }
    }

    // Socket events
    socket.on('connect', () => console.log('socket connected'));
    socket.on('new_message', (data) => {
      // show a toast briefly
      const t = document.createElement('div');
      t.className = 'fixed right-6 bottom-6 p-3 rounded bg-indigo-600 shadow';
      t.innerHTML = `<div class="font-semibold">New: ${data.user.username||data.chatId}</div><div class="text-xs">${data.message.text||'Media'}</div>`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 6000);
      // update small stats
      const statEl = document.getElementById('stat-chats');
      if (statEl) statEl.innerText = (parseInt(statEl.innerText || '0') + 1).toString();
    });

    // show initial login modal
    document.getElementById('login-modal').style.display = 'flex';

    // small UX: keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.key === '1') showView('dashboard');
      if (e.key === '2') showView('fbchats');
      if (e.key === '3') showView('tgchats');
    });
  </script>
</body>
</html>
