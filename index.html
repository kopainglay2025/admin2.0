<!doctype html>
<html lang="my">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Chats</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#6366f1}
    .scroll-y{overflow-y:auto}
    .msg-admin{background:rgba(99,102,241,0.12)}
    .msg-user{background:rgba(16,185,129,0.06)}
    .msg-meta{font-size:11px;color:#6b7280}
    .kbd{background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:12px}
  </style>
</head>
<body class="min-h-screen font-sans bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <h1 class="text-2xl font-semibold">Admin Dashboard</h1>
        <div class="text-sm text-gray-500 hidden sm:block">ျမန္မာစာ (Burmese) / English</div>
      </div>
      <div class="flex items-center gap-3">
        <label class="flex items-center gap-2 text-sm cursor-pointer">
          <input id="theme-toggle" type="checkbox" class="hidden" />
          <span id="theme-label" class="kbd">Dark</span>
        </label>
        <button id="btn-logout" class="px-3 py-1 rounded bg-red-500 text-white text-sm">Logout</button>
      </div>
    </header>

    <div class="grid grid-cols-12 gap-4">
      <!-- Sidebar menu -->
      <aside class="col-span-12 md:col-span-2 bg-white dark:bg-gray-800 rounded shadow p-3 h-[78vh]">
        <nav class="space-y-2">
          <div class="font-medium mb-2">Menu</div>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="dashboard">Dashboard</button>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="users">User</button>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="tg">TG Chats</button>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="fb">FB Chats</button>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="broadcast">TG Broadcast</button>
          <button class="menu-item w-full text-left p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700" data-view="settings">Settings</button>
        </nav>
      </aside>

      <!-- Main area -->
      <main class="col-span-12 md:col-span-10 bg-white dark:bg-gray-800 rounded shadow p-4">
        <!-- Top controls -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2 w-full">
            <input id="search" placeholder="Search username / id / message" class="flex-1 p-2 border rounded dark:bg-gray-900 dark:border-gray-700" />
            <select id="platform-filter" class="p-2 border rounded text-sm dark:bg-gray-900 dark:border-gray-700">
              <option value="">All</option>
              <option value="telegram">Telegram</option>
              <option value="facebook">Facebook</option>
            </select>
            <button id="btn-refresh" class="px-3 py-1 bg-gray-200 rounded">⟳</button>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-sm text-gray-500">Page size</div>
            <select id="page-size" class="p-2 border rounded dark:bg-gray-900 dark:border-gray-700"><option>10</option><option>20</option><option>50</option></select>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <!-- Chats list + pagination -->
          <section class="col-span-1 bg-gray-50 dark:bg-gray-700 p-2 rounded h-[60vh] flex flex-col">
            <div class="flex-1 overflow-y-auto" id="chats"></div>
            <div class="flex items-center justify-between mt-2">
              <button id="prev-page" class="px-3 py-1 border rounded">Prev</button>
              <div class="text-sm text-gray-500" id="page-info">Page 1</div>
              <button id="next-page" class="px-3 py-1 border rounded">Next</button>
            </div>
          </section>

          <!-- Chat & history -->
          <section class="col-span-2 bg-white dark:bg-gray-800 p-3 rounded shadow h-[60vh] flex flex-col">
            <div id="chat-header" class="border-b pb-2 mb-2">
              <div class="flex items-center justify-between">
                <div>
                  <h2 id="chat-title" class="text-lg font-medium">Select a chat</h2>
                  <div id="chat-sub" class="text-sm text-gray-500">Platform — — Last message</div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="btn-history-more" class="px-2 py-1 text-sm border rounded">Load more</button>
                  <button id="btn-open-users" class="px-2 py-1 text-sm border rounded">Users</button>
                </div>
              </div>
            </div>

            <div id="history" class="flex-1 overflow-y-auto p-2 space-y-3 scroll-y"></div>

            <div class="mt-3 pt-3 border-t">
              <div class="flex gap-2 items-end">
                <div class="flex-1">
                  <textarea id="reply-text" rows="2" placeholder="Type your reply..." class="w-full p-2 border rounded resize-none dark:bg-gray-900 dark:border-gray-700"></textarea>
                  <div class="mt-2 flex items-center gap-2">
                    <input id="file-input" type="file" class="hidden" />
                    <button id="attach-btn" class="px-3 py-1 border rounded text-sm">Attach</button>
                    <div id="attach-preview" class="flex gap-2 items-center"></div>
                  </div>
                </div>
                <div>
                  <button id="btn-send" class="px-4 py-2 bg-accent text-white rounded" style="background:var(--accent)">Send</button>
                </div>
              </div>
              <div class="text-xs text-gray-500 mt-2">Replies will be sent through the correct platform and saved to Firestore. Attachments supported (images & files).</div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Image preview modal -->
    <div id="img-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
      <div class="bg-white dark:bg-gray-900 p-3 rounded shadow max-w-3xl w-full">
        <div class="flex items-center justify-between mb-2"><div id="img-meta"></div><button id="img-close">✕</button></div>
        <img id="img-preview" class="w-full h-auto rounded" alt="preview" />
      </div>
    </div>

    <!-- Users modal -->
    <div id="users-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
      <div class="w-3/4 bg-white dark:bg-gray-800 rounded shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium">System Users</h3>
          <button id="close-users" class="text-gray-600">✕</button>
        </div>
        <div class="mb-3 flex gap-2">
          <input id="new-user-name" placeholder="Name" class="p-2 border rounded flex-1 dark:bg-gray-900 dark:border-gray-700" />
          <input id="new-user-role" placeholder="Role (Viewer/Admin)" class="p-2 border rounded w-40 dark:bg-gray-900 dark:border-gray-700" />
          <button id="add-user" class="px-3 py-1 bg-green-500 text-white rounded">Add</button>
        </div>
        <div id="users-list" class="max-h-64 overflow-y-auto divide-y"></div>
      </div>
    </div>
  </div>

  <!-- Socket.io client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Localization strings (simple)
    const L = {
      send: 'ပို့မည်', attach: 'File တင်ပြီး', select_chat: 'Chat ရွေးပါ', no_chats: 'No chats found.'
    };

    // Tiny helpers
    function el(tag, cls){const e = document.createElement(tag); if(cls) e.className=cls; return e;}
    function fmtTime(iso){ try{return new Date(iso).toLocaleString();}catch(e){return iso;} }

    const state = { auth:null, chats:[], selectedChatId:null, historyLimit:50, page:1, pageSize:10 };

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const themeLabel = document.getElementById('theme-label');
    themeToggle.addEventListener('change', ()=>{
      if(themeToggle.checked){ document.documentElement.classList.add('dark'); themeLabel.textContent='Dark'; }
      else { document.documentElement.classList.remove('dark'); themeLabel.textContent='Light'; }
    });

    // Auth restore (simple placeholder) - in real use, use Basic Auth form like before
    (function(){ const t = sessionStorage.getItem('admin_auth'); if(t){ state.auth='Basic '+t; } else { /* leave unauthenticated but front-end will still function for demo */ } })();

    async function apiGet(path){ const res = await fetch(path, { headers: state.auth ? { 'Authorization': state.auth } : {} }); if(!res.ok) throw new Error(await res.text()); return res.json(); }
    async function apiPost(path, body){ const res = await fetch(path, { method:'POST', headers: Object.assign({ 'Content-Type':'application/json' }, state.auth ? { 'Authorization': state.auth } : {}), body: JSON.stringify(body)}); if(!res.ok) throw new Error(await res.text()); return res.json(); }
    async function apiDelete(path){ const res = await fetch(path, { method:'DELETE', headers: state.auth ? { 'Authorization': state.auth } : {} }); if(!res.ok) throw new Error(await res.text()); return res.json(); }

    // Chats pagination
    const chatsEl = document.getElementById('chats');
    const searchInput = document.getElementById('search');
    const platformFilter = document.getElementById('platform-filter');
    const pageInfo = document.getElementById('page-info');
    document.getElementById('btn-refresh').addEventListener('click', ()=> loadChats());
    document.getElementById('prev-page').addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderChats(); } });
    document.getElementById('next-page').addEventListener('click', ()=>{ state.page++; renderChats(); });
    document.getElementById('page-size').addEventListener('change', (e)=>{ state.pageSize = parseInt(e.target.value); state.page=1; renderChats(); });

    searchInput.addEventListener('input', ()=>{ state.page=1; renderChats(); });
    platformFilter.addEventListener('change', ()=>{ state.page=1; loadChats(); });

    async function loadChats(){ try{ const pf = platformFilter.value; const url = '/api/chats' + (pf ? `?platform=${pf}` : ''); const data = await apiGet(url); state.chats = data; state.page=1; renderChats(); } catch(err){ console.error(err); alert('Failed to load chats: '+err.message); } }

    function renderChats(){ const q = searchInput.value.trim().toLowerCase(); let filtered = state.chats.filter(c=>{ if(q){ return (c.username||'').toLowerCase().includes(q) || (c.telegramId||'').toLowerCase().includes(q) || (c.lastMessageText||'').toLowerCase().includes(q); } return true; });
      const total = filtered.length; const start = (state.page-1)*state.pageSize; const paged = filtered.slice(start, start+state.pageSize);
      chatsEl.innerHTML=''; if(paged.length===0) chatsEl.innerHTML = `<div class='p-3 text-sm text-gray-500'>${L.no_chats}</div>`;
      for(const c of paged){ const wrap = el('div','p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-start gap-3'); wrap.addEventListener('click', ()=> selectChat(c)); const avatar = el('div','w-10 h-10 rounded bg-gray-200 dark:bg-gray-600 flex items-center justify-center'); avatar.textContent = (c.username||'U').slice(0,2).toUpperCase(); const meta = el('div','flex-1'); const title = el('div','flex items-center justify-between'); const name = el('div','font-medium'); name.textContent = c.username || c.telegramId; const when = el('div','text-sm text-gray-500'); when.textContent = c.lastMessageTime || ''; const sub = el('div','text-sm text-gray-600 mt-1'); sub.textContent = c.lastMessageText || ''; title.appendChild(name); title.appendChild(when); meta.appendChild(title); meta.appendChild(sub); const pf = el('div','text-xs text-gray-400'); pf.textContent = (c.platform||'').toUpperCase(); wrap.appendChild(avatar); wrap.appendChild(meta); wrap.appendChild(pf); chatsEl.appendChild(wrap); }
      pageInfo.textContent = `Page ${state.page} • ${start+1}-${Math.min(start+state.pageSize, total)} of ${total}`;
    }

    // Chat selection & history
    const chatTitle = document.getElementById('chat-title');
    const chatSub = document.getElementById('chat-sub');
    const historyEl = document.getElementById('history');
    const btnSend = document.getElementById('btn-send');
    const replyText = document.getElementById('reply-text');
    const btnHistoryMore = document.getElementById('btn-history-more');

    async function selectChat(chat){ state.selectedChatId = chat.telegramId || chat.id; chatTitle.textContent = chat.username || chat.telegramId || chat.id; chatSub.textContent = `${(chat.platform||'').toUpperCase()} — ${chat.lastMessageText || ''}`; await loadHistory(state.selectedChatId, state.historyLimit); }

    async function loadHistory(chatId, limit=50){ try{ historyEl.innerHTML = '<div class="text-sm text-gray-500 p-2">Loading...</div>'; const data = await apiGet(`/api/chats/${encodeURIComponent(chatId)}/history?limit=${limit}`); renderHistory(data); } catch(err){ console.error(err); historyEl.innerHTML = '<div class="text-sm text-red-500 p-2">Failed to load history</div>'; } }

    function renderHistory(items){ historyEl.innerHTML=''; if(!items||items.length===0){ historyEl.innerHTML = '<div class="p-2 text-sm text-gray-500">No messages</div>'; return; } for(const m of items){ const wrap = el('div','p-2 rounded'); wrap.classList.add(m.sender==='admin' ? 'msg-admin' : 'msg-user'); const top = el('div','flex items-center justify-between'); const who = el('div','font-medium text-sm'); who.textContent = m.sender==='admin' ? 'Admin' : (m.username || 'User'); const t = el('div','msg-meta'); t.textContent = m.timestamp ? fmtTime(m.timestamp) : ''; top.appendChild(who); top.appendChild(t); const body = el('div','mt-1 text-sm whitespace-pre-wrap'); body.textContent = m.text || (m.filename ? m.filename : 'Media'); wrap.appendChild(top); wrap.appendChild(body);
          // attachment preview
          if(m.filename || m.mediaPath){ const att = el('div','mt-2'); const link = el('a','text-sm underline cursor-pointer'); link.textContent = m.filename || 'Attachment'; link.href = '#'; link.addEventListener('click',(e)=>{ e.preventDefault(); if(m.mediaPath && (m.filename||'').match(/\.(jpg|jpeg|png|gif)$/i)){ openImage(m.mediaPath, m.filename||'Image'); } else { alert('Attachment: '+(m.filename||m.mediaPath)); } }); att.appendChild(link); wrap.appendChild(att); }
          historyEl.appendChild(wrap);
      }
      historyEl.scrollTop = historyEl.scrollHeight; }

    btnHistoryMore.addEventListener('click', ()=>{ state.historyLimit += 50; if(state.selectedChatId) loadHistory(state.selectedChatId, state.historyLimit); });

    // Socket.io
    function connectSocket(){ if(window.socket) return; const socket = io(); window.socket = socket; socket.on('connect', ()=>console.log('socket connected')); socket.on('disconnect', ()=>console.log('socket disconnected'));
      socket.on('new_message',(data)=>{ const id = String(data.chatId); const exists = state.chats.some(c=>String(c.telegramId)===id || String(c.id)===id); if(!exists){ state.chats.unshift({ telegramId: id, username: data.user.username, lastMessageText: data.message.text, lastMessageTime: data.message.timestamp, platform: data.platform }); renderChats(); } else { for(const c of state.chats){ if(String(c.telegramId)===id || String(c.id)===id){ c.lastMessageText = data.message.text; c.lastMessageTime = data.message.timestamp; } } renderChats(); } if(state.selectedChatId && String(state.selectedChatId)===id) loadHistory(id, state.historyLimit); });
      socket.on('message_sent',(d)=>{ if(state.selectedChatId && String(state.selectedChatId)===String(d.chatId)) loadHistory(d.chatId, state.historyLimit); }); }

    // Reply with optional attachment (sends via socket.admin_reply with attachment metadata only)
    const attachBtn = document.getElementById('attach-btn'); const fileInput = document.getElementById('file-input'); const attachPreview = document.getElementById('attach-preview');
    attachBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{ const f = fileInput.files[0]; if(!f) return; attachPreview.innerHTML=''; const div = el('div','text-sm'); div.textContent = f.name; const img = el('img','hidden'); if(f.type.startsWith('image/')){ const reader = new FileReader(); reader.onload = function(e){ const i = el('img'); i.src = e.target.result; i.style.maxWidth='60px'; i.style.borderRadius='6px'; i.className='cursor-pointer'; i.addEventListener('click', ()=> openImage(e.target.result, f.name)); attachPreview.appendChild(i); } reader.readAsDataURL(f); } attachPreview.appendChild(div); });

    btnSend.addEventListener('click', async ()=>{
      const text = replyText.value.trim(); if(!text && !fileInput.files.length) return alert('Enter message or attach file'); if(!state.selectedChatId) return alert('Select a chat first'); try{ window.socket.emit('admin_reply', { chatId: state.selectedChatId, text, attachment: fileInput.files[0] ? { name: fileInput.files[0].name, type: fileInput.files[0].type } : null }, (res)=>{ if(res && res.success){ replyText.value=''; fileInput.value=''; attachPreview.innerHTML=''; loadHistory(state.selectedChatId, state.historyLimit); } else { alert('Send failed: '+(res.error||JSON.stringify(res))); } }); } catch(err){ console.error(err); alert('Send error: '+err.message); } });

    // Image preview modal
    const imgModal = document.getElementById('img-modal'); const imgPreview = document.getElementById('img-preview'); const imgMeta = document.getElementById('img-meta'); document.getElementById('img-close').addEventListener('click', ()=> imgModal.classList.add('hidden'));
    function openImage(src, name){ imgPreview.src = src; imgMeta.textContent = name; imgModal.classList.remove('hidden'); imgModal.classList.add('flex'); }

    // Users modal
    const usersModal = document.getElementById('users-modal'); document.getElementById('btn-open-users').addEventListener('click', async ()=>{ usersModal.classList.remove('hidden'); usersModal.classList.add('flex'); await loadUsers(); }); document.getElementById('close-users').addEventListener('click', ()=>{ usersModal.classList.add('hidden'); usersModal.classList.remove('flex'); });
    async function loadUsers(){ try{ const users = await apiGet('/api/users'); const list = document.getElementById('users-list'); list.innerHTML=''; for(const u of users){ const row = el('div','p-2 flex items-center justify-between'); row.innerHTML = `<div><div class='font-medium'>${u.name}</div><div class='text-xs text-gray-500'>${u.role} • ${u.status||''}</div></div>`; const btns = el('div','flex gap-2'); const del = el('button','px-2 py-1 text-sm border rounded'); del.textContent='Delete'; del.addEventListener('click', async ()=>{ if(confirm('Delete user?')){ await apiDelete('/api/users/'+u.id); await loadUsers(); } }); btns.appendChild(del); row.appendChild(btns); list.appendChild(row); } } catch(err){ console.error(err); alert('Failed to load users: '+err.message); } }

    document.getElementById('add-user').addEventListener('click', async ()=>{ const name = document.getElementById('new-user-name').value.trim(); const role = document.getElementById('new-user-role').value.trim() || 'Viewer'; if(!name) return alert('Name required'); try{ await apiPost('/api/users', { name, role }); document.getElementById('new-user-name').value=''; await loadUsers(); } catch(err){ console.error(err); alert('Add user failed: '+err.message); } });

    // Menu navigation
    document.querySelectorAll('.menu-item').forEach(btn=> btn.addEventListener('click', (e)=>{ document.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('bg-gray-100')); e.target.classList.add('bg-gray-100'); const view = e.target.dataset.view; if(view==='tg'){ platformFilter.value='telegram'; loadChats(); } else if(view==='fb'){ platformFilter.value='facebook'; loadChats(); } else if(view==='users'){ document.getElementById('btn-open-users').click(); } else { platformFilter.value=''; loadChats(); } }));

    // init
    connectSocket(); loadChats();
  </script>
</body>
</html>
