<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Channel Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .platform-tag {
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
        .telegram { background-color: #2AABEE; color: white; }
        .facebook { background-color: #1877F2; color: white; }
        .admin-msg { background-color: #E0F2FE; }
        .user-msg { background-color: #F3F4F6; }
        .scrollable { max-height: calc(100vh - 18rem); overflow-y: auto; }
        .user-list-scroll { max-height: calc(100vh - 10rem); overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Basic Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-96">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Login</h2>
            <p class="text-sm text-gray-600 mb-4">Enter the Basic Auth credentials defined in your `.env` file (ADMIN_USERNAME & ADMIN_PASSWORD).</p>
            <input type="text" id="auth-username" placeholder="Username (e.g., admin)" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button id="auth-login-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Login</button>
            <p id="auth-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <div id="main-content" class="hidden h-screen flex flex-col">
        <!-- Header/Tabs -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-3xl font-bold text-gray-800">OmniChat Admin</h1>
            <div class="flex space-x-4">
                <button id="tab-chats" class="tab-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition duration-150">Chats</button>
                <button id="tab-users" class="tab-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">System Users</button>
            </div>
        </header>

        <div id="chats-view" class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar: Chat List -->
            <div class="w-1/3 border-r bg-white flex flex-col">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-semibold text-gray-700">Conversations</h2>
                </div>
                <div id="chat-list" class="flex-1 overflow-y-auto divide-y divide-gray-200">
                    <!-- Chat list items will be injected here -->
                </div>
                <div class="p-2 border-t flex space-x-2">
                    <button onclick="fetchChats()" class="flex-1 bg-gray-100 text-gray-600 p-2 rounded-lg text-sm hover:bg-gray-200 transition">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m0 0H15"></path></svg>
                        Refresh Chats
                    </button>
                    <select id="platform-filter" onchange="fetchChats(this.value)" class="p-2 border border-gray-300 rounded-lg text-sm bg-white">
                        <option value="">All Platforms</option>
                        <option value="telegram">Telegram</option>
                        <option value="facebook">Facebook</option>
                    </select>
                </div>
            </div>

            <!-- Right Panel: Chat History & Reply -->
            <div id="chat-panel" class="w-2/3 bg-gray-50 flex flex-col hidden">
                <!-- Header -->
                <div class="p-4 border-b bg-white flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800" id="chat-header-name">Select a Chat</h2>
                    <span id="chat-header-platform" class="platform-tag"></span>
                </div>
                
                <!-- History -->
                <div id="chat-history" class="flex-1 p-4 space-y-4 scrollable bg-gray-50">
                    <p class="text-center text-gray-500 mt-10">Select a conversation from the left to view history.</p>
                    <!-- Messages will be injected here -->
                </div>

                <!-- Reply Input -->
                <div class="p-4 border-t bg-white">
                    <textarea id="reply-input" placeholder="Type your reply here..." rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <button id="send-reply-btn" class="mt-2 w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150" disabled>
                        Send Reply
                    </button>
                    <p id="reply-status" class="text-sm mt-2"></p>
                </div>
            </div>
        </div>

        <!-- System Users View -->
        <div id="users-view" class="p-6 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">System User Management</h2>
            <div class="flex space-x-6">
                <!-- User Creation Form -->
                <div class="w-1/3 bg-white p-6 rounded-xl shadow-lg h-min">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Add New User</h3>
                    <form id="add-user-form" class="space-y-4">
                        <div>
                            <label for="new-user-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="new-user-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-user-role" class="block text-sm font-medium text-gray-700">Role</label>
                            <select id="new-user-role" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="Admin">Admin</option>
                                <option value="Operator" selected>Operator</option>
                                <option value="Viewer">Viewer</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-user-status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="new-user-status" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="Active" selected>Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150">
                            Create User
                        </button>
                        <p id="user-add-status" class="text-sm text-center mt-2"></p>
                    </form>
                </div>

                <!-- User List -->
                <div class="w-2/3 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Existing Users</h3>
                    <div id="user-list-container" class="user-list-scroll">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- User rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="user-list-status" class="text-sm text-center mt-4"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let socket;
        let authHeader = '';
        let currentChat = null;
        let allUsers = []; // Used to manage users locally

        // --- Utility Functions ---

        function getBase64Auth(username, password) {
            return 'Basic ' + btoa(`${username}:${password}`);
        }

        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ' ' + 
                   date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function displayToast(message, isError = false) {
            const statusElement = document.getElementById('reply-status');
            statusElement.textContent = message;
            statusElement.className = `text-sm mt-2 transition-opacity duration-300 ${isError ? 'text-red-500' : 'text-green-600'}`;
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'text-sm mt-2';
            }, 3000);
        }

        // --- Basic Auth Handling ---

        document.getElementById('auth-login-btn').addEventListener('click', async () => {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const errorElement = document.getElementById('auth-error');

            if (!username || !password) {
                errorElement.textContent = 'Please enter both username and password.';
                errorElement.classList.remove('hidden');
                return;
            }

            authHeader = getBase64Auth(username, password);

            // Test the API endpoint with the credentials
            try {
                const response = await fetch('/api/chats', {
                    headers: { 'Authorization': authHeader }
                });
                if (response.ok) {
                    document.getElementById('auth-modal').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    initializeApp();
                } else {
                    throw new Error('Authentication failed. Check credentials.');
                }
            } catch (error) {
                console.error(error);
                errorElement.textContent = 'Login failed: Invalid credentials.';
                errorElement.classList.remove('hidden');
            }
        });

        // --- Core Application Logic ---

        function initializeApp() {
            socket = io();
            fetchChats();
            fetchUsers();
            setupSocketListeners();
            setupTabs();
            setupReplyHandler();
            setupUserFormHandler();
        }
        
        // --- Tab Management ---

        function setupTabs() {
            const chatsView = document.getElementById('chats-view');
            const usersView = document.getElementById('users-view');
            const tabChats = document.getElementById('tab-chats');
            const tabUsers = document.getElementById('tab-users');

            tabChats.addEventListener('click', () => {
                tabChats.classList.replace('bg-gray-200', 'bg-blue-600');
                tabChats.classList.replace('text-gray-700', 'text-white');
                tabUsers.classList.replace('bg-blue-600', 'bg-gray-200');
                tabUsers.classList.replace('text-white', 'text-gray-700');
                chatsView.classList.remove('hidden');
                usersView.classList.add('hidden');
            });

            tabUsers.addEventListener('click', () => {
                tabUsers.classList.replace('bg-gray-200', 'bg-blue-600');
                tabUsers.classList.replace('text-gray-700', 'text-white');
                tabChats.classList.replace('bg-blue-600', 'bg-gray-200');
                tabChats.classList.replace('text-white', 'text-gray-700');
                chatsView.classList.add('hidden');
                usersView.classList.remove('hidden');
                fetchUsers(); // Refresh user list when switching to this tab
            });
        }

        // --- Chat & History Fetching ---

        async function fetchChats(platform = document.getElementById('platform-filter').value) {
            try {
                const response = await axios.get(`/api/chats?platform=${platform}`, {
                    headers: { 'Authorization': authHeader }
                });
                renderChatList(response.data);
            } catch (error) {
                console.error('Error fetching chats:', error);
                document.getElementById('chat-list').innerHTML = '<p class="p-4 text-red-500">Failed to load chats.</p>';
            }
        }

        function renderChatList(chats) {
            const chatListElement = document.getElementById('chat-list');
            chatListElement.innerHTML = '';

            if (chats.length === 0) {
                chatListElement.innerHTML = '<p class="p-4 text-gray-500 text-center">No active chats found.</p>';
                return;
            }

            chats.forEach(chat => {
                const listItem = document.createElement('div');
                listItem.className = `p-3 cursor-pointer hover:bg-gray-100 transition duration-150 flex flex-col ${currentChat && currentChat.chatId === chat.chatId ? 'bg-blue-50 border-l-4 border-blue-600' : ''}`;
                listItem.setAttribute('data-chat-id', chat.chatId);
                listItem.setAttribute('data-platform', chat.platform);
                listItem.onclick = () => selectChat(chat);
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-gray-800 truncate">${chat.username || 'Unknown User'}</span>
                        <span class="platform-tag ${chat.platform}">${chat.platform.toUpperCase()}</span>
                    </div>
                    <p class="text-sm text-gray-500 truncate">${chat.lastMessageText || 'No text'}</p>
                    <span class="text-xs text-gray-400 mt-1 self-end">${formatTimestamp(chat.lastMessageTime)}</span>
                `;
                chatListElement.appendChild(listItem);
            });
        }

        async function selectChat(chat) {
            currentChat = chat;
            
            // UI updates
            document.querySelectorAll('#chat-list > div').forEach(el => {
                el.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-600');
            });
            document.querySelector(`[data-chat-id="${chat.chatId}"]`).classList.add('bg-blue-50', 'border-l-4', 'border-blue-600');
            
            document.getElementById('chat-panel').classList.remove('hidden');
            document.getElementById('chat-header-name').textContent = chat.username || `Chat ID: ${chat.chatId}`;
            document.getElementById('chat-header-platform').textContent = chat.platform.toUpperCase();
            document.getElementById('chat-header-platform').className = `platform-tag ${chat.platform}`;
            document.getElementById('send-reply-btn').disabled = false;
            
            // Fetch history
            await fetchHistory(chat.chatId);
        }

        async function fetchHistory(chatId) {
            const historyElement = document.getElementById('chat-history');
            historyElement.innerHTML = '<p class="text-center text-blue-600">Loading history...</p>';
            try {
                const response = await axios.get(`/api/chats/${chatId}/history`, {
                    headers: { 'Authorization': authHeader }
                });
                renderChatHistory(response.data);
            } catch (error) {
                console.error('Error fetching history:', error);
                historyElement.innerHTML = '<p class="text-center text-red-500">Failed to load chat history.</p>';
            }
        }

        function renderChatHistory(messages) {
            const historyElement = document.getElementById('chat-history');
            historyElement.innerHTML = '';

            messages.forEach(msg => {
                const isUser = msg.sender === 'user';
                const msgEl = document.createElement('div');
                msgEl.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;

                let content = '';
                if (msg.mediaPath) {
                    // Check if it's a Telegram media file we can retrieve
                    if (currentChat.platform === 'telegram') {
                         const mediaUrl = `/api/media/telegram/${msg.mediaPath}`;
                         let fileLink = `<a href="${mediaUrl}" target="_blank" class="text-blue-600 hover:underline">${msg.filename || 'Media File'}</a>`;
                         // Simple check for common image types to display inline
                         if (msg.filename && (msg.filename.match(/(.jpg|.jpeg|.png|.gif|.webp)$/i) || msg.text.includes("photo") || msg.text.includes("image"))) {
                            fileLink = `<img src="${mediaUrl}" alt="Media" class="max-w-xs max-h-48 rounded-lg shadow-md mb-1 object-cover cursor-pointer" onclick="window.open(this.src)">`;
                         } else if (msg.filename && msg.filename.match(/(.mp4|.mov|.webm)$/i)) {
                            fileLink = `<video controls class="max-w-xs max-h-48 rounded-lg shadow-md mb-1"><source src="${mediaUrl}"></video>`;
                         } else if (msg.filename && msg.filename.match(/(.mp3|.ogg|.wav)$/i)) {
                            fileLink = `<audio controls class="w-full max-w-xs mb-1"><source src="${mediaUrl}"></audio>`;
                         }
                         content += fileLink;
                    } else {
                        // For other platforms, just show placeholder
                        content += `<span class="text-yellow-600 italic">${msg.filename || 'Media/Attachment'}</span>`;
                    }
                }
                
                if (msg.text) {
                    content += `<p class="whitespace-pre-wrap">${msg.text}</p>`;
                }

                msgEl.innerHTML = `
                    <div class="max-w-xs lg:max-w-md p-3 rounded-xl shadow-md ${isUser ? 'user-msg' : 'admin-msg'}">
                        ${content}
                        <span class="text-xs text-gray-400 mt-1 block text-right">${formatTimestamp(msg.timestamp)}</span>
                    </div>
                `;
                historyElement.appendChild(msgEl);
            });
            // Scroll to bottom
            historyElement.scrollTop = historyElement.scrollHeight;
        }

        // --- Reply Handler ---

        function setupReplyHandler() {
            const input = document.getElementById('reply-input');
            const sendBtn = document.getElementById('send-reply-btn');

            const sendMessage = () => {
                const text = input.value.trim();
                if (!text || !currentChat) return;

                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';

                socket.emit('admin_reply', {
                    chatId: currentChat.chatId,
                    text: text
                }, (response) => {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Reply';
                    if (response.success) {
                        displayToast('Message sent successfully!');
                        input.value = '';
                        // The 'message_sent' socket listener will handle the UI update
                    } else {
                        displayToast(`Error sending: ${response.error}`, true);
                    }
                });
            };

            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // --- Socket.io Listeners ---

        function setupSocketListeners() {
            socket.on('new_message', (data) => {
                // 1. Refresh chat list to show new message/time update
                fetchChats(); 

                // 2. If the message is for the currently viewed chat, append it to history
                if (currentChat && currentChat.chatId === data.chatId) {
                    const historyElement = document.getElementById('chat-history');
                    // Use a temporary array to include new message and re-render history (simpler than appending element)
                    const tempMessages = [
                        ...Array.from(historyElement.children).map(el => JSON.parse(el.dataset.message || '{}')).filter(m => m.id),
                        data.message
                    ];
                    // Since history is reversed in API, we must rely on fetching again or a complex local update. 
                    // For simplicity and correctness with full model, we re-fetch the whole history.
                    fetchHistory(currentChat.chatId);
                } else if (!currentChat) {
                    // If no chat is selected, show a notification/toast
                    console.log(`New message received from ${data.user.username}`);
                }
            });

            socket.on('message_sent', (data) => {
                // Admin's own message was saved and confirmed.
                if (currentChat && currentChat.chatId === data.chatId) {
                    // Update the history display with the confirmed message
                    fetchHistory(currentChat.chatId);
                }
                // Also refresh chat list to update "last message" timestamp/text
                fetchChats();
            });
        }


        // --- User Management Logic ---

        async function fetchUsers() {
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading users...</td></tr>';
            
            try {
                const response = await axios.get('/api/users', {
                    headers: { 'Authorization': authHeader }
                });
                allUsers = response.data;
                renderUserList(allUsers);
            } catch (error) {
                console.error('Error fetching users:', error);
                document.getElementById('user-list-status').textContent = 'Failed to load user list.';
            }
        }

        function renderUserList(users) {
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';

            if (users.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No system users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 transition duration-150">Delete</button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        function setupUserFormHandler() {
            document.getElementById('add-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-user-name').value;
                const role = document.getElementById('new-user-role').value;
                const status = document.getElementById('new-user-status').value;
                const statusElement = document.getElementById('user-add-status');

                statusElement.textContent = 'Creating user...';
                statusElement.className = 'text-sm text-center mt-2 text-blue-600';

                try {
                    const response = await axios.post('/api/users', { name, role, status }, {
                        headers: { 'Authorization': authHeader }
                    });
                    
                    if (response.status === 200) {
                        statusElement.textContent = `User '${response.data.name}' created successfully!`;
                        statusElement.className = 'text-sm text-center mt-2 text-green-600';
                        document.getElementById('add-user-form').reset();
                        fetchUsers(); // Refresh the list
                    }
                } catch (error) {
                    console.error('Error creating user:', error);
                    statusElement.textContent = `Error: ${error.response?.data?.error || error.message}`;
                    statusElement.className = 'text-sm text-center mt-2 text-red-500';
                }
                setTimeout(() => statusElement.textContent = '', 3000);
            });
        }

        async function deleteUser(userId) {
            if (!confirm("Are you sure you want to delete this user?")) return;
            
            try {
                const response = await axios.delete(`/api/users/${userId}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (response.status === 200) {
                    document.getElementById('user-list-status').textContent = `User ${userId} deleted.`;
                    document.getElementById('user-list-status').className = 'text-sm text-center mt-4 text-green-600';
                    fetchUsers(); // Refresh the list
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                document.getElementById('user-list-status').textContent = `Failed to delete user: ${error.response?.data?.error || error.message}`;
                document.getElementById('user-list-status').className = 'text-sm text-center mt-4 text-red-500';
            }
            setTimeout(() => document.getElementById('user-list-status').textContent = '', 3000);
        }

        // Initialize only after the DOM is fully loaded
        // The auth modal handles the first step of initialization
    </script>

</body>
</html>
