<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminPlan - Unified Chat Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios for HTTP requests and Socket.io for real-time communication -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    
    <script>
        // --- Global Configuration ---
        const API_BASE_URL = window.location.origin;
        let AUTH_HEADER = ''; // Basic Authentication header will be set after login
        let currentChatId = null;
        let socket;

        // Configure Tailwind with Neon/Dark Theme
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'neon-primary': '#00e0ff', 
                        'neon-secondary': '#ff00ff', 
                        'light-bg': '#F3F4F6', 
                        'light-card': '#FFFFFF',
                        'light-border': '#D1D5DB',
                        'dark-bg': '#0D0C1D', 
                        'dark-card': '#1A192B', 
                        'dark-border': '#374151',
                        'darker-sidebar': '#121021',
                        'telegram-icon': '#0088CC',
                        'facebook-icon': '#1877F2',
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles and custom scrollbar */
        body { 
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        
        #chatList, #messageHistory, .main-content {
            scrollbar-width: thin;
            scrollbar-color: #374151 #1A192B; 
        }
        .light #chatList, .light #messageHistory, .light .main-content {
            scrollbar-color: #9CA3AF #F3F4F6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { border-radius: 10px; background-color: var(--scrollbar-thumb); }
        ::-webkit-scrollbar-track { background-color: var(--scrollbar-track); }
        .dark { --scrollbar-thumb: #374151; --scrollbar-track: #1A192B; }
        .light { --scrollbar-thumb: #9CA3AF; --scrollbar-track: #F3F4F6; }
        
        /* Custom Keyframe for Neon Pulse */
        @keyframes neon-pulse {
            0%, 100% { box-shadow: 0 0 5px currentColor, 0 0 10px currentColor; }
            50% { box-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
        }
    </style>
</head>
<body class="light bg-light-bg dark:bg-dark-bg text-gray-800 dark:text-gray-200">

    <!-- Mobile Menu Button (Hamburger Icon) -->
    <button id="menuToggle" class="fixed top-4 left-4 z-50 p-2 rounded-full shadow-lg bg-light-card dark:bg-dark-card hover:ring-2 ring-neon-primary/50 transition-all duration-300 sm:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-neon-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
    </button>
    
    <div id="appContainer" class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" 
            class="w-64 fixed inset-y-0 left-0 transform -translate-x-full 
                   sm:relative sm:translate-x-0 sm:flex-shrink-0 
                   bg-light-card dark:bg-darker-sidebar shadow-2xl z-40 
                   flex flex-col transition-all duration-300">
            
            <!-- Logo/Header -->
            <div class="p-6 border-b border-light-border dark:border-dark-border">
                <h1 class="text-2xl font-extrabold tracking-widest text-neon-primary">AdminPlan</h1>
            </div>

            <!-- User Info (Auth Status) -->
            <div class="p-4 text-xs bg-light-bg dark:bg-dark-card/50 truncate">
                <p class="font-medium text-gray-500 dark:text-gray-400">Admin Status:</p>
                <code id="authStatus" class="break-all font-mono text-neon-secondary">Awaiting Auth...</code>
            </div>

            <!-- Main Navigation -->
            <nav class="p-4 space-y-2">
                <a href="#" data-section="chat" class="nav-item flex items-center p-3 rounded-lg text-sm font-medium hover:bg-light-bg dark:hover:bg-dark-card transition-all duration-200 hover:text-neon-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.693A9.761 9.761 0 0112 4c4.97 0 9 3.582 9 8z" /></svg>
                    Chat Manager
                </a>
                <a href="#" data-section="users" class="nav-item flex items-center p-3 rounded-lg text-sm font-medium hover:bg-light-bg dark:hover:bg-dark-card transition-all duration-200 hover:text-neon-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20H4v-2a3 3 0 015-2.236M9 20v-2a3 3 0 00-5.356-1.857m14.712 0l.474-.298M11 12a4 4 0 10-8 0 4 4 0 008 0zm11 0a4 4 0 10-8 0 4 4 0 008 0z" /></svg>
                    System Users
                </a>
            </nav>
            
            <!-- Dark Mode Toggle -->
            <div class="mt-auto p-4 border-t border-light-border dark:border-dark-border">
                <button onclick="toggleDarkMode()" class="w-full flex items-center justify-between p-3 rounded-xl bg-light-bg dark:bg-dark-card hover:ring-2 ring-neon-secondary/50 transition-all duration-300">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <div id="themeIcon" class="text-xl">‚òÄÔ∏è</div>
                </button>
                <p class="text-xs text-center mt-2 text-gray-500 dark:text-gray-400" id="myanmarTimeDisplay">Loading Time...</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div id="mainContent" class="flex-1 overflow-y-auto pt-16 sm:pt-4 p-4 sm:p-8 transition-all duration-300">

            <!-- Section: Chat Manager -->
            <section id="chat" class="main-content space-y-8">
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white border-b pb-2 border-neon-primary/50">Chat Manager</h2>
                
                <div id="chatListContainer" class="card bg-light-card dark:bg-dark-card p-6 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Chat List</h3>
                    
                    <input type="text" id="chatListSearch" onkeyup="filterChatList(this.value)" placeholder="Search chats..." class="w-full p-3 rounded-lg bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border mb-4 focus:ring-2 focus:ring-neon-primary focus:border-neon-primary transition-all duration-300">

                    <!-- Platform Filters -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterByPlatform('')" id="filterAll" class="platform-filter px-4 py-2 bg-neon-secondary/20 dark:bg-neon-secondary/40 text-gray-900 dark:text-white rounded-lg shadow-md hover:ring-2 ring-neon-secondary/50 transition-all duration-300 font-medium">All</button>
                        <button onclick="filterByPlatform('telegram')" id="filterTelegram" class="platform-filter px-4 py-2 bg-telegram-icon/20 dark:bg-telegram-icon/40 text-gray-900 dark:text-white rounded-lg shadow-md hover:ring-2 ring-telegram-icon/50 transition-all duration-300 font-medium">Telegram</button>
                        <button onclick="filterByPlatform('facebook')" id="filterFacebook" class="platform-filter px-4 py-2 bg-facebook-icon/20 dark:bg-facebook-icon/40 text-gray-900 dark:text-white rounded-lg shadow-md hover:ring-2 ring-facebook-icon/50 transition-all duration-300 font-medium">Facebook</button>
                    </div>

                    <div id="chatList" class="space-y-2 max-h-[60vh] overflow-y-auto">
                        <div class="text-center p-4 text-gray-500 dark:text-gray-400">Loading chats...</div>
                    </div>
                </div>

                <div id="chatHistoryContainer" class="card bg-light-card dark:bg-dark-card p-6 rounded-xl shadow-xl hidden">
                    
                    <!-- Chat Header -->
                    <div class="flex items-center justify-between border-b pb-3 mb-4 border-light-border dark:border-dark-border">
                        <button onclick="goBackToChatList()" class="mr-3 p-2 rounded-full hover:bg-light-bg dark:hover:bg-dark-border/50 transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-neon-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <h3 id="currentChatName" class="text-xl font-semibold text-gray-800 dark:text-white truncate flex-1">Chat Name</h3>
                        <div id="currentChatPlatform" class="ml-4 text-sm font-medium"></div>
                    </div>

                    <input type="text" id="chatHistorySearch" onkeyup="filterChatHistory(this.value)" placeholder="Search messages..." class="w-full p-3 rounded-lg bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border mb-4 focus:ring-2 focus:ring-neon-primary focus:border-neon-primary transition-all duration-300">
                    
                    <!-- Message History -->
                    <div id="messageHistory" class="flex flex-col-reverse space-y-reverse space-y-4 max-h-[50vh] overflow-y-auto p-2">
                        <!-- Messages will be dynamically added here (prepended) -->
                    </div>

                    <!-- Message Input -->
                    <div class="mt-4 pt-4 border-t border-light-border dark:border-dark-border">
                        <form id="messageForm" onsubmit="sendAdminReply(event)">
                            <div class="flex items-center space-x-3">
                                <textarea id="messageInput" rows="1" placeholder="Type your reply to the user..." class="flex-1 p-3 rounded-xl bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border focus:ring-2 focus:ring-neon-primary focus:border-neon-primary transition-all duration-300 resize-none overflow-hidden" oninput="autoExpandTextarea(this)"></textarea>
                                <button type="submit" class="p-3 bg-neon-primary text-gray-900 rounded-xl shadow-lg hover:bg-neon-primary/80 transition-all duration-300 transform hover:scale-105">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </section>

            <!-- Section: System Users -->
            <section id="users" class="main-content hidden space-y-8">
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white border-b pb-2 border-neon-primary/50">System Users</h2>

                <div class="card bg-light-card dark:bg-dark-card p-6 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">User List</h3>
                        <button onclick="showCreateUserModal()" class="px-4 py-2 bg-neon-primary text-gray-900 rounded-lg shadow-md hover:bg-neon-primary/80 transition-all duration-300 font-medium">
                            + Add New User
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-light-border dark:divide-dark-border">
                            <thead>
                                <tr class="bg-light-bg dark:bg-dark-border/50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userListTable" class="bg-light-card dark:bg-dark-card divide-y divide-light-border dark:divide-dark-border">
                                <tr><td colspan="4" class="text-center py-4 text-gray-500">Loading system users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Section: Dashboard (Placeholder for now) -->
            <section id="dashboard" class="main-content hidden space-y-8">
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white border-b pb-2 border-neon-primary/50">Dashboard</h2>
                <div class="card bg-light-card dark:bg-dark-card p-6 rounded-xl shadow-xl">
                    <p class="text-gray-600 dark:text-gray-400">Welcome to the Unified Admin Panel. Navigate to Chat Manager to view conversations or System Users to manage access.</p>
                </div>
            </section>


            <!-- Modal for Alerts/Prompts/Login (Custom modal to replace alert()/prompt()) -->
            <div id="customModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
                <div class="bg-light-card dark:bg-dark-card p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100 ring-4 ring-neon-primary/20">
                    <h4 id="modalTitle" class="text-xl font-bold mb-4 text-gray-900 dark:text-neon-primary">Title</h4>
                    <p id="modalMessage" class="mb-4 text-gray-700 dark:text-gray-300">Message</p>
                    <div id="modalInputs" class="space-y-3">
                        <input type="text" id="modalInput1" placeholder="Username / Name" class="w-full p-2 rounded-lg bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border focus:ring-2 focus:ring-neon-secondary hidden">
                        <input type="password" id="modalInput2" placeholder="Password / Role" class="w-full p-2 rounded-lg bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border focus:ring-2 focus:ring-neon-secondary hidden">
                        <select id="modalSelect" class="w-full p-2 rounded-lg bg-light-bg dark:bg-dark-border/50 border border-light-border dark:border-dark-border focus:ring-2 focus:ring-neon-secondary hidden">
                            <option value="Viewer">Viewer</option>
                            <option value="Editor">Editor</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button id="modalCancelBtn" class="px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg text-sm hover:bg-light-bg dark:hover:bg-dark-border transition-all duration-200 hidden">Cancel</button>
                        <button id="modalOkBtn" class="px-4 py-2 bg-neon-primary text-gray-900 rounded-lg text-sm font-medium hover:bg-neon-primary/80 transition-all duration-200">OK</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Core UI Functions and Utilities ---
        
        // Function to expand textarea height dynamically
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        // Global function to show a specific section
        function showSection(sectionId) {
            document.querySelectorAll('.main-content').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'dark:bg-dark-border', 'shadow-lg', 'text-neon-primary', 'font-extrabold', 'ring-2', 'ring-neon-primary/50');
                item.classList.add('text-gray-800', 'dark:text-gray-200', 'font-medium');
            });

            const activeItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeItem) {
                activeItem.classList.add('bg-blue-100', 'dark:bg-dark-border', 'shadow-lg', 'text-neon-primary', 'font-extrabold', 'ring-2', 'ring-neon-primary/50');
                activeItem.classList.remove('text-gray-800', 'dark:text-gray-200', 'font-medium');
            }
            
            if (window.innerWidth < 640) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }

            // Load data when sections are shown
            if (sectionId === 'chat') {
                if (currentChatId) {
                    document.getElementById('chatHistoryContainer').classList.remove('hidden');
                    document.getElementById('chatListContainer').classList.add('hidden');
                } else {
                    document.getElementById('chatHistoryContainer').classList.add('hidden');
                    document.getElementById('chatListContainer').classList.remove('hidden');
                    fetchChats(); 
                }
            } else if (sectionId === 'users') {
                fetchUsers();
            }
        }
        
        // --- Dark Mode Toggling ---
        function toggleDarkMode() {
            const htmlElement = document.documentElement;
            const isDark = htmlElement.classList.toggle('dark');
            htmlElement.classList.toggle('light', !isDark);
            
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        }

        function loadDarkModePreference() {
            const preference = localStorage.getItem('darkMode');
            const htmlElement = document.documentElement;
            
            if (preference === 'dark' || (!preference && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                htmlElement.classList.add('dark');
                htmlElement.classList.remove('light');
                document.getElementById('themeIcon').textContent = 'üåô';
            } else {
                htmlElement.classList.add('light');
                htmlElement.classList.remove('dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }
        
        // --- Myanmar Time Update ---
        function updateMyanmarTime() {
            const now = new Date();
            const options = {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true,
                day: '2-digit', month: 'short', year: 'numeric',
                timeZone: 'Asia/Yangon'
            };
            const myanmarTime = now.toLocaleString('en-US', options);
            document.getElementById('myanmarTimeDisplay').textContent = myanmarTime;
        }

        // --- Custom Modal Functions (Replaces alert/prompt) ---
        function modal({ title, message, okText = 'OK', cancelText = 'Cancel', inputs = [], selectOptions = null }) {
            return new Promise(resolve => {
                const modalEl = document.getElementById('customModal');
                const titleEl = document.getElementById('modalTitle');
                const messageEl = document.getElementById('modalMessage');
                const input1El = document.getElementById('modalInput1');
                const input2El = document.getElementById('modalInput2');
                const selectEl = document.getElementById('modalSelect');
                const okBtn = document.getElementById('modalOkBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                okBtn.textContent = okText;

                // Hide all inputs/selects initially
                input1El.classList.add('hidden');
                input2El.classList.add('hidden');
                selectEl.classList.add('hidden');
                cancelBtn.classList.add('hidden');

                // Configure inputs
                if (inputs.length > 0) {
                    input1El.type = inputs[0].type || 'text';
                    input1El.placeholder = inputs[0].placeholder;
                    input1El.value = inputs[0].defaultValue || '';
                    input1El.classList.remove('hidden');
                }
                if (inputs.length > 1) {
                    input2El.type = inputs[1].type || 'text';
                    input2El.placeholder = inputs[1].placeholder;
                    input2El.value = inputs[1].defaultValue || '';
                    input2El.classList.remove('hidden');
                }
                
                // Configure select
                if (selectOptions) {
                    selectEl.innerHTML = selectOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');
                    selectEl.classList.remove('hidden');
                }

                // Show cancel button if required
                if (cancelText) {
                    cancelBtn.textContent = cancelText;
                    cancelBtn.classList.remove('hidden');
                    cancelBtn.onclick = () => {
                        modalEl.classList.add('hidden');
                        resolve(null);
                    };
                }

                // OK button handler
                okBtn.onclick = () => {
                    modalEl.classList.add('hidden');
                    const results = [];
                    if (inputs.length > 0) results.push(input1El.value);
                    if (inputs.length > 1) results.push(input2El.value);
                    if (selectOptions) results.push(selectEl.value);
                    resolve(results.length === 1 ? results[0] : (results.length > 1 ? results : true));
                };
                
                modalEl.classList.remove('hidden');
                if (inputs.length > 0) input1El.focus();
            });
        }


        // --- Basic Auth / Login ---
        async function adminLogin() {
            const credentials = await modal({
                title: 'Admin Login Required',
                message: 'Enter your Admin Username and Password (as set in server.js).',
                okText: 'Login',
                cancelText: null,
                inputs: [
                    { placeholder: 'Username', type: 'text' },
                    { placeholder: 'Password', type: 'password' }
                ]
            });

            if (!credentials || credentials.length !== 2) {
                document.getElementById('authStatus').textContent = 'Login Failed';
                return;
            }

            const [username, password] = credentials;
            
            // Encode credentials for Basic Auth header
            const token = btoa(`${username}:${password}`);
            AUTH_HEADER = `Basic ${token}`;
            
            // Verify by attempting to fetch chats
            try {
                const response = await axios.get(`${API_BASE_URL}/api/chats?limit=1`, {
                    headers: { 'Authorization': AUTH_HEADER }
                });

                if (response.status === 200) {
                    document.getElementById('authStatus').textContent = `Authenticated as: ${username}`;
                    initializeApp();
                } else {
                    throw new Error('Authentication failed.');
                }
            } catch (error) {
                console.error("Login verification failed:", error);
                await modal({ title: 'Error', message: 'Invalid credentials. Please try again.', okText: 'Retry' });
                adminLogin(); // Loop until success or cancellation
            }
        }
        
        // --- Socket.io and Axios Setup ---
        function setupSocketListeners() {
            try {
                // Connect to the same server URL
                socket = io.connect(API_BASE_URL);

                socket.on('connect', () => {
                    console.log("Socket connected.");
                });

                // Listen for new user messages (Telegram or FB)
                socket.on('new_message', (data) => {
                    const { chatId, message, user } = data;
                    handleNewMessage(chatId, message, user);
                });
                
                // Listen for admin replies confirmation
                socket.on('message_sent', (data) => {
                    const { chatId, message } = data;
                    if (chatId === currentChatId) {
                        // Display admin message immediately (if not already added by client code)
                        const historyContainer = document.getElementById('messageHistory');
                        const existing = document.querySelector(`#messageHistory [data-message-id="${message.id}"]`);
                        if (!existing) {
                            historyContainer.prepend(createMessageBubble(message));
                            historyContainer.scrollTop = 0;
                        }
                    }
                });

                socket.on('disconnect', () => {
                    console.warn("Socket disconnected. Reconnecting...");
                });

            } catch (error) {
                console.error("Socket.io connection failed:", error);
            }
        }

        // --- Chat Management Functions ---
        let currentChatPlatform = null;
        let chatCache = {}; // Cache chats for quick platform lookup

        async function fetchChats(platformFilter = '') {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">Loading chats...</div>';
            
            document.querySelectorAll('.platform-filter').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-neon-primary/50');
            });
            document.getElementById(`filter${platformFilter || 'All'}`).classList.add('ring-2', 'ring-neon-primary/50');

            try {
                const response = await axios.get(`${API_BASE_URL}/api/chats${platformFilter ? `?platform=${platformFilter}` : ''}`, {
                    headers: { 'Authorization': AUTH_HEADER }
                });
                
                chatCache = {};
                chatList.innerHTML = '';
                
                if (response.data.length === 0) {
                    chatList.innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">No chats found for this filter.</div>';
                    return;
                }

                response.data.forEach(chat => {
                    chatCache[chat.telegramId] = chat; // Note: using telegramId as universal ID
                    addOrUpdateChat(chat);
                });
                
                filterChatList(document.getElementById('chatListSearch').value);

            } catch (error) {
                console.error("Error fetching chats:", error);
                chatList.innerHTML = `<div class="text-center p-4 text-red-500">Failed to load chats. Error: ${error.response?.statusText || error.message}</div>`;
            }
        }

        function filterByPlatform(platform) {
            fetchChats(platform);
        }

        function addOrUpdateChat(chat) {
            const chatList = document.getElementById('chatList');
            const chatId = chat.telegramId; 
            let chatElement = document.getElementById(`chat-item-${chatId}`);
            
            const isNew = !chatElement;
            const chatName = chat.username || `User ${chatId.substring(0, 8)}`;

            if (isNew) {
                chatElement = document.createElement('div');
                chatElement.id = `chat-item-${chatId}`;
                chatElement.onclick = () => openChat(chatId, chatName, chat.platform);
                chatList.appendChild(chatElement);
            }
            
            const activeClass = (currentChatId === chatId) ? 'bg-blue-100 dark:bg-dark-border shadow-lg ring-2 ring-neon-primary/50' : 'bg-transparent';
            
            chatElement.className = `chat-item group p-3 rounded-xl cursor-pointer transition-all duration-300 ${activeClass} hover:bg-light-border/50 dark:hover:bg-dark-border/50`;
            chatElement.dataset.name = chatName.toLowerCase();
            chatElement.dataset.platform = chat.platform;
            
            const platformIcon = chat.platform === 'telegram' ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-telegram-icon mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.4c-.4-.4-1-.6-1.7-.6s-1.3.2-1.7.6l-8 8c-.4.4-.6 1-.6 1.7s.2 1.3.6 1.7.9.7 1.7.7 1.3-.2 1.7-.6l8-8c.4-.4.6-1 .6-1.7s-.2-1.3-.6-1.7z"/></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-facebook-icon mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M22.675 0h-21.35C.58 0 0 .58 0 1.286v21.428C0 23.42 0.58 24 1.325 24h11.411v-9.289H9.453v-3.562h3.283V8.455c0-3.238 1.957-5.004 4.887-5.004 1.394 0 2.607.104 2.955.15v3.396h-2.01c-1.582 0-1.892.753-1.892 1.86v2.467h3.766l-.606 3.562h-3.16V24h6.05C23.42 24 24 23.42 24 22.714V1.286C24 .58 23.42 0 22.675 0z"/></svg>`;


            chatElement.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        ${platformIcon}
                        <span class="text-sm truncate text-gray-800 dark:text-gray-100 group-hover:text-neon-primary">
                            ${chatName}
                        </span>
                    </div>
                    <span class="text-xs text-gray-400">${chat.lastMessageTime ? new Date(chat.lastMessageTime).toLocaleTimeString() : 'N/A'}</span>
                </div>
                <p class="text-xs mt-1 text-gray-500 dark:text-gray-400 truncate">${chat.lastMessageText || 'No messages yet'}</p>
            `;

            // Note: The server already returns chats sorted by lastMessageTime.
        }

        async function openChat(chatId, chatName, platform) {
            currentChatId = chatId;
            currentChatPlatform = platform;
            
            document.getElementById('currentChatName').textContent = chatName;
            document.getElementById('currentChatPlatform').innerHTML = platform === 'telegram' ? 
                `<span class="text-xs font-bold bg-telegram-icon text-white px-2 py-1 rounded-full shadow-md">Telegram</span>` :
                `<span class="text-xs font-bold bg-facebook-icon text-white px-2 py-1 rounded-full shadow-md">Facebook</span>`;
                
            document.getElementById('messageHistory').innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">Loading messages...</div>';
            
            showSection('chat'); // Ensure Chat section is visible
            document.getElementById('chatHistoryContainer').classList.remove('hidden');
            document.getElementById('chatListContainer').classList.add('hidden');

            // Reset active chat styling
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('bg-blue-100', 'dark:bg-dark-border', 'shadow-lg', 'ring-2', 'ring-neon-primary/50');
            });
            document.getElementById(`chat-item-${chatId}`).classList.add('bg-blue-100', 'dark:bg-dark-border', 'shadow-lg', 'ring-2', 'ring-neon-primary/50');
            
            try {
                const response = await axios.get(`${API_BASE_URL}/api/chats/${chatId}/history?limit=50`, {
                    headers: { 'Authorization': AUTH_HEADER }
                });
                
                const messages = response.data;
                const historyContainer = document.getElementById('messageHistory');
                historyContainer.innerHTML = ''; // Clear loading text
                
                messages.forEach(message => {
                    historyContainer.prepend(createMessageBubble(message));
                });
                
                filterChatHistory(document.getElementById('chatHistorySearch').value);

            } catch (error) {
                console.error("Error loading chat history:", error);
                await modal({ title: 'Error', message: `Failed to load messages. ${error.response?.statusText || error.message}` });
                goBackToChatList();
            }
        }

        // Handle real-time incoming messages
        function handleNewMessage(chatId, message, user) {
            // Update chat list item first
            addOrUpdateChat(user); 

            if (currentChatId === chatId) {
                const historyContainer = document.getElementById('messageHistory');
                // Check if message already exists (prevent duplicates from socket/history fetch overlap)
                if (!document.querySelector(`#messageHistory [data-message-id="${message.id}"]`)) {
                    historyContainer.prepend(createMessageBubble(message));
                    historyContainer.scrollTop = 0; 
                    filterChatHistory(document.getElementById('chatHistorySearch').value); 
                }
            } else {
                // Flash animation for new message in list
                const chatElement = document.getElementById(`chat-item-${chatId}`);
                if (chatElement) {
                    chatElement.classList.add('ring-4', 'ring-neon-secondary/50', 'animate-pulse');
                    setTimeout(() => chatElement.classList.remove('ring-4', 'ring-neon-secondary/50', 'animate-pulse'), 1500);
                }
            }
        }

        // Send Admin Reply via Socket.io
        function sendAdminReply(e) {
            e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText || !currentChatId) return;
            
            // Add client-side bubble immediately for quick feedback
            const tempMessage = {
                id: `temp-${Date.now()}`,
                sender: 'admin',
                text: messageText,
                timestamp: new Date().toISOString()
            };
            document.getElementById('messageHistory').prepend(createMessageBubble(tempMessage));
            document.getElementById('messageHistory').scrollTop = 0;
            messageInput.value = '';
            autoExpandTextarea(messageInput);


            socket.emit('admin_reply', { chatId: currentChatId, text: messageText }, (response) => {
                if (response.success) {
                    console.log("Reply successfully sent:", response.message);
                } else {
                    console.error("Reply failed:", response.error);
                    // Remove temporary bubble on failure
                    const tempEl = document.querySelector(`[data-message-id="${tempMessage.id}"]`);
                    if (tempEl) tempEl.remove();
                    modal({ title: 'Error', message: `Failed to send reply to ${currentChatPlatform}: ${response.error}` });
                }
            });
        }
        
        // --- UI Rendering Helpers ---

        function createMessageBubble(message) {
            const isUser = message.sender === 'user';
            const bubble = document.createElement('div');
            
            // Use message ID for tracking (for socket updates)
            bubble.setAttribute('data-message-id', message.id);

            const alignment = isUser ? 'items-start' : 'items-end';
            const bgColor = isUser ? 'bg-light-card dark:bg-dark-card text-gray-800 dark:text-gray-200 shadow-md' : 'bg-neon-primary dark:bg-neon-primary/70 text-gray-900';
            const ml = isUser ? 'mr-auto' : 'ml-auto';
            const timeAlignment = isUser ? 'text-left' : 'text-right';
            
            // Format timestamp
            let timestampString;
            try {
                const date = new Date(message.timestamp);
                timestampString = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            } catch (e) {
                timestampString = '...';
            }
            
            let contentHTML = `<p class="text-sm break-words whitespace-pre-wrap">${message.text}</p>`;

            if (message.mediaPath) {
                // If it has media, show a link to the file. We cannot display the file directly
                // as the admin dashboard doesn't have the logic to proxy Telegram's getFile API.
                contentHTML += `
                    <div class="mt-2 p-2 bg-gray-100 dark:bg-dark-border rounded-lg border border-neon-secondary/50">
                        <p class="font-bold">Media Received</p>
                        <p class="text-xs italic">${message.filename || 'File'}</p>
                        <p class="text-xs text-red-500">Admin must manually retrieve file ID: ${message.mediaPath}</p>
                    </div>`;
            }

            bubble.className = `flex w-full ${alignment} mb-4`;
            
            bubble.innerHTML = `
                <div data-text="${message.text.toLowerCase()}" class="max-w-xs md:max-w-md lg:max-w-xl ${ml} p-3 rounded-2xl ${bgColor} transition-all duration-300 transform hover:scale-[1.01]">
                    ${contentHTML}
                    <span class="text-xs mt-1 block ${isUser ? 'text-gray-500' : 'text-gray-700'} ${timeAlignment}">${timestampString}</span>
                </div>
            `;
            return bubble;
        }

        // Filtering
        function filterChatList(searchText) {
            const filter = searchText.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const name = item.dataset.name;
                item.style.display = name.includes(filter) ? '' : 'none';
            });
        }

        function filterChatHistory(searchText) {
            const filter = searchText.toLowerCase();
            document.querySelectorAll('#messageHistory > div > div').forEach(bubble => {
                const text = bubble.dataset.text;
                bubble.closest('.flex').style.display = text.includes(filter) ? 'flex' : 'none';
            });
        }
        
        function goBackToChatList() {
            currentChatId = null;
            document.getElementById('chatHistoryContainer').classList.add('hidden');
            document.getElementById('chatListContainer').classList.remove('hidden');
            fetchChats(document.querySelector('.platform-filter.ring-2')?.id.replace('filter', '').toLowerCase() || '');
        }

        // --- User Management Functions ---
        async function fetchUsers() {
            const userListTable = document.getElementById('userListTable');
            userListTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500 dark:text-gray-400">Loading system users...</td></tr>';
            try {
                const response = await axios.get(`${API_BASE_URL}/api/users`, {
                    headers: { 'Authorization': AUTH_HEADER }
                });

                userListTable.innerHTML = '';
                response.data.forEach(user => {
                    userListTable.appendChild(createUserRow(user));
                });
                
                if (response.data.length === 0) {
                    userListTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500 dark:text-gray-400">No system users found.</td></tr>';
                }

            } catch (error) {
                console.error("Error fetching users:", error);
                userListTable.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Failed to load users. Error: ${error.response?.statusText || error.message}</td></tr>`;
            }
        }

        function createUserRow(user) {
            const row = document.createElement('tr');
            row.id = `user-row-${user.id}`;
            row.className = 'hover:bg-light-bg dark:hover:bg-dark-border/50 transition-colors duration-200';
            
            const statusClass = user.status === 'Active' ? 'text-green-500 bg-green-100 dark:bg-green-900/50' : 'text-red-500 bg-red-100 dark:bg-red-900/50';

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${user.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${user.role}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${user.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="deleteSystemUser('${user.id}', '${user.name}')" class="text-red-600 hover:text-red-900 dark:hover:text-red-400 transition-colors">
                        Delete
                    </button>
                </td>
            `;
            return row;
        }

        async function showCreateUserModal() {
            const results = await modal({
                title: 'Add New System User',
                message: 'Enter the new user details.',
                okText: 'Create User',
                cancelText: 'Cancel',
                inputs: [
                    { placeholder: 'User Name', type: 'text' },
                    { placeholder: 'Status (Active/Inactive)', type: 'text', defaultValue: 'Active' }
                ],
                selectOptions: [
                    { value: 'Viewer', text: 'Viewer' },
                    { value: 'Editor', text: 'Editor' },
                    { value: 'Admin', text: 'Admin' }
                ]
            });

            if (results) {
                const [name, status, role] = results;
                if (!name.trim()) {
                    await modal({ title: 'Error', message: 'Name cannot be empty.' });
                    return;
                }
                
                try {
                    await axios.post(`${API_BASE_URL}/api/users`, { name, role, status }, {
                        headers: { 'Authorization': AUTH_HEADER, 'Content-Type': 'application/json' }
                    });
                    await modal({ title: 'Success', message: `User "${name}" created successfully.` });
                    fetchUsers(); // Refresh the list
                } catch (error) {
                    console.error("Error creating user:", error);
                    await modal({ title: 'Error', message: `Failed to create user. ${error.response?.data?.error || error.message}` });
                }
            }
        }

        async function deleteSystemUser(userId, userName) {
            const confirm = await modal({
                title: 'Confirm Deletion',
                message: `Are you sure you want to delete user "${userName}"? This cannot be undone.`,
                okText: 'Delete',
                cancelText: 'Cancel'
            });

            if (confirm) {
                try {
                    await axios.delete(`${API_BASE_URL}/api/users/${userId}`, {
                        headers: { 'Authorization': AUTH_HEADER }
                    });
                    await modal({ title: 'Success', message: `User "${userName}" deleted.` });
                    document.getElementById(`user-row-${userId}`).remove();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    await modal({ title: 'Error', message: `Failed to delete user. ${error.response?.data?.error || error.message}` });
                }
            }
        }

        // --- Initialization ---
        function initializeApp() {
            setupSocketListeners();
            showSection('chat'); // Start with the chat manager
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDarkModePreference(); 
            setInterval(updateMyanmarTime, 1000);
            updateMyanmarTime();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(item.getAttribute('data-section'));
                });
            });
            
            // Start the Basic Auth process immediately
            adminLogin();
        });
    </script>
</body>
</html>
