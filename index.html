<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Platform Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Socket.io Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --secondary: #10b981;
            --bg-dark: #1f2937;
            --bg-light: #f9fafb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: #1f2937;
        }
        .sidebar {
            background-color: var(--bg-dark);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        .nav-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            background-color: var(--primary-light);
        }
        .nav-item.active {
            background-color: var(--primary);
            border-left: 4px solid var(--secondary);
        }
        .chat-list-item {
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .chat-list-item:hover {
            background-color: #f3f4f6;
        }
        .chat-list-item.active {
            background-color: #e5e7eb;
        }
        .message-bubble {
            max-width: 80%;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        }
        .user-message {
            background-color: var(--primary-light);
            color: white;
        }
        .admin-message {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        /* Scrollbar styling for better look */
        .chat-history::-webkit-scrollbar,
        .chat-list::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-thumb,
        .chat-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Basic Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Login</h2>
            <p class="text-sm text-gray-600 mb-6">Enter your administrator credentials to access the dashboard.</p>
            <form id="auth-form">
                <input type="text" id="auth-username" placeholder="Username" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <input type="password" id="auth-password" placeholder="Password" required class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <button type="submit" class="w-full bg-primary hover:bg-primary-light text-white font-bold py-3 rounded-xl transition duration-200 shadow-md">Authenticate</button>
            </form>
            <p id="auth-error" class="text-red-500 text-center mt-4 hidden">Invalid credentials. Please try again.</p>
        </div>
    </div>


    <!-- Sidebar (Left Menu Bar) -->
    <aside id="sidebar" class="sidebar w-64 flex-shrink-0 text-white flex flex-col hidden">
        <div class="p-6 text-2xl font-extrabold border-b border-gray-700">
            Chat Admin <span class="text-secondary">PRO</span>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <!-- Menu Items -->
            <div id="Dashboard" class="nav-item active p-3 rounded-xl flex items-center space-x-3" data-page="dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </div>

            <div class="text-xs font-semibold uppercase text-gray-400 pt-4 pb-2 px-3">Chats</div>
            <div id="TGChats" class="nav-item p-3 rounded-xl flex items-center space-x-3" data-page="tg_chats">
                <i data-lucide="send" class="w-5 h-5"></i>
                <span>TG Chats</span>
            </div>
            <div id="FBChats" class="nav-item p-3 rounded-xl flex items-center space-x-3" data-page="fb_chats">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span>FB Chats</span>
            </div>

            <div class="text-xs font-semibold uppercase text-gray-400 pt-4 pb-2 px-3">User Management</div>
            <div id="TGUserList" class="nav-item p-3 rounded-xl flex items-center space-x-3" data-page="user_list">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span>System User List</span>
            </div>
            <div id="TGUserBroadcast" class="nav-item p-3 rounded-xl flex items-center space-x-3" data-page="broadcast">
                <i data-lucide="megaphone" class="w-5 h-5"></i>
                <span>TG User Broadcast</span>
            </div>

            <div class="text-xs font-semibold uppercase text-gray-400 pt-4 pb-2 px-3">System</div>
            <div id="Settings" class="nav-item p-3 rounded-xl flex items-center space-x-3" data-page="settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>Settings</span>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-700 text-sm text-gray-400">
            <p>Logged in as: <span id="auth-info" class="font-medium text-white"></span></p>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow p-6 overflow-auto">
        <h1 id="page-title" class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
        <div id="page-content" class="h-full">
            <!-- Content will be injected here -->
        </div>
    </main>

<script>
    // Global state
    let authToken = '';
    let socket;
    let currentPage = 'dashboard';
    let currentChatId = null;
    let currentChatPlatform = null;
    let chatsData = []; // Cache for chat list

    const AUTH_USERNAME_KEY = 'adminUsername';
    const AUTH_PASSWORD_KEY = 'adminPassword';
    const API_URL = ''; // Uses current host

    // --- Utility Functions ---

    function getAuthHeader(username, password) {
        const credentials = `${username}:${password}`;
        // Base64 encoding must be done securely
        const base64Credentials = btoa(credentials);
        return `Basic ${base64Credentials}`;
    }

    // Custom fetch wrapper to include Basic Auth headers
    async function authorizedFetch(url, options = {}) {
        if (!authToken) {
            console.error("Authentication token not set.");
            throw new Error("Unauthorized");
        }
        
        options.headers = {
            ...options.headers,
            'Authorization': authToken,
            'Content-Type': options.method === 'POST' || options.method === 'DELETE' || options.method === 'PUT' ? 'application/json' : undefined
        };

        const response = await fetch(url, options);

        if (response.status === 401) {
            localStorage.removeItem(AUTH_USERNAME_KEY);
            localStorage.removeItem(AUTH_PASSWORD_KEY);
            alert("Authentication failed. Please re-enter credentials.");
            window.location.reload();
            throw new Error("Unauthorized");
        }
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorText}`);
        }
        return response.json();
    }

    function formatTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function platformIcon(platform) {
        const icons = {
            'telegram': 'send',
            'facebook': 'message-square'
        };
        return `<i data-lucide="${icons[platform] || 'globe'}" class="w-4 h-4 mr-2 text-gray-500"></i>`;
    }

    // --- Core UI & State Management ---

    function renderPage(pageId) {
        currentPage = pageId;
        const mainContent = document.getElementById('page-content');
        const title = document.getElementById('page-title');

        // Update sidebar active state
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-page') === pageId) {
                item.classList.add('active');
            }
        });

        // Set title and inject content
        title.textContent = pageId.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        mainContent.innerHTML = '';
        currentChatId = null; // Clear active chat when changing pages

        switch (pageId) {
            case 'dashboard':
                renderDashboard(mainContent);
                break;
            case 'tg_chats':
            case 'fb_chats':
                renderChatView(mainContent, pageId === 'tg_chats' ? 'telegram' : 'facebook');
                break;
            case 'user_list':
                renderUserList(mainContent);
                break;
            case 'broadcast':
                renderBroadcastView(mainContent);
                break;
            case 'settings':
                renderSettings(mainContent);
                break;
        }
        lucide.createIcons();
    }

    // --- Page Render Functions ---

    function renderDashboard(container) {
        container.classList.add('p-8', 'bg-white', 'rounded-xl', 'shadow-lg');
        container.innerHTML = `
            <h2 class="text-2xl font-semibold mb-4 text-primary">Welcome Back!</h2>
            <p class="text-gray-600 mb-6">This is your centralized dashboard. Select a chat platform from the left menu to start replying to users.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-indigo-50 p-6 rounded-xl shadow-md border-l-4 border-primary">
                    <div class="text-sm font-medium text-primary">Telegram Chats</div>
                    <div id="stat-tg" class="text-3xl font-bold text-gray-800 mt-1">0</div>
                </div>
                <div class="bg-green-50 p-6 rounded-xl shadow-md border-l-4 border-secondary">
                    <div class="text-sm font-medium text-secondary">Facebook Chats</div>
                    <div id="stat-fb" class="text-3xl font-bold text-gray-800 mt-1">0</div>
                </div>
                <div class="bg-gray-100 p-6 rounded-xl shadow-md border-l-4 border-gray-400">
                    <div class="text-sm font-medium text-gray-600">Total Users in List</div>
                    <div id="stat-users" class="text-3xl font-bold text-gray-800 mt-1">...</div>
                </div>
            </div>
            <p class="text-sm text-gray-400 mt-8">Real-time updates are active via Socket.io.</p>
        `;
        fetchStats();
    }

    async function fetchStats() {
        try {
            const chats = await authorizedFetch(`${API_URL}/api/chats`);
            const users = await authorizedFetch(`${API_URL}/api/users`);
            
            document.getElementById('stat-tg').textContent = chats.filter(c => c.platform === 'telegram').length;
            document.getElementById('stat-fb').textContent = chats.filter(c => c.platform === 'facebook').length;
            document.getElementById('stat-users').textContent = users.length;
        } catch (error) {
            console.error("Failed to fetch dashboard stats:", error);
            document.getElementById('stat-tg').textContent = 'Error';
            document.getElementById('stat-fb').textContent = 'Error';
            document.getElementById('stat-users').textContent = 'Error';
        }
    }


    function renderChatView(container, platform) {
        container.classList.add('flex', 'h-[90vh]', 'bg-white', 'rounded-xl', 'shadow-lg', 'overflow-hidden');
        container.innerHTML = `
            <!-- Chat List Sidebar -->
            <div class="w-1/3 border-r border-gray-200 flex flex-col">
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">${platform === 'telegram' ? 'Telegram' : 'Facebook'} Conversations</h3>
                    <p class="text-sm text-gray-500">Total chats: <span id="chat-count">0</span></p>
                </div>
                <div id="chat-list" class="chat-list flex-grow overflow-y-auto">
                    <!-- Chat items injected here -->
                    <div class="p-4 text-center text-gray-400">Loading chats...</div>
                </div>
            </div>

            <!-- Chat History and Reply Area -->
            <div id="chat-window" class="w-2/3 flex flex-col bg-gray-50">
                <div id="chat-header" class="p-4 border-b border-gray-200 bg-white">
                    <h4 class="text-lg font-bold text-gray-700">Select a Chat to Start</h4>
                </div>
                <div id="chat-history" class="chat-history flex-grow overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-gray-400 mt-20">No conversation selected.</div>
                </div>
                <div id="reply-area" class="p-4 border-t border-gray-200 bg-white hidden">
                    <form id="reply-form" class="flex items-center space-x-2">
                        <input type="text" id="reply-input" placeholder="Type your reply..." required
                               class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-primary focus:border-primary">
                        <button type="submit" class="bg-primary hover:bg-primary-light text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-200">
                            Send
                        </button>
                    </form>
                    <p id="reply-status" class="text-sm mt-2 hidden"></p>
                </div>
            </div>
        `;

        fetchChats(platform);

        // Event listener for reply form
        document.getElementById('reply-form').addEventListener('submit', handleAdminReply);
    }

    async function fetchChats(platform) {
        try {
            const chats = await authorizedFetch(`${API_URL}/api/chats?platform=${platform}`);
            chatsData = chats; // Cache the full list
            document.getElementById('chat-count').textContent = chats.length;
            renderChatList(chats);
        } catch (error) {
            document.getElementById('chat-list').innerHTML = `<div class="p-4 text-red-500">Error loading chats: ${error.message}</div>`;
            console.error(error);
        }
    }

    function renderChatList(chats) {
        const chatListContainer = document.getElementById('chat-list');
        chatListContainer.innerHTML = '';

        if (chats.length === 0) {
            chatListContainer.innerHTML = `<div class="p-4 text-center text-gray-500">No chats found for this platform.</div>`;
            return;
        }

        chats.forEach(chat => {
            const lastMsgTime = chat.lastMessageTime ? formatTime(chat.lastMessageTime) : '';
            const platform = chat.platform || 'telegram';
            
            const chatItem = document.createElement('div');
            chatItem.className = `chat-list-item p-4 border-b border-gray-100 flex items-center justify-between ${chat.telegramId === currentChatId ? 'active' : ''}`;
            chatItem.setAttribute('data-chat-id', chat.telegramId);
            chatItem.setAttribute('data-platform', platform);
            chatItem.innerHTML = `
                <div class="flex-grow overflow-hidden">
                    <div class="flex items-center font-semibold text-gray-800 truncate">
                         ${platformIcon(platform)}
                        ${chat.username || chat.telegramId}
                    </div>
                    <p class="text-sm text-gray-500 truncate">${chat.lastMessageText || 'No message'}</p>
                </div>
                <div class="flex-shrink-0 text-xs text-gray-400 ml-2">${lastMsgTime}</div>
            `;
            chatItem.addEventListener('click', () => loadChatHistory(chat.telegramId, platform, chat.username || chat.telegramId));
            chatListContainer.appendChild(chatItem);
        });
        lucide.createIcons();
    }

    async function loadChatHistory(chatId, platform, username) {
        if (currentChatId === chatId) return;

        // Update active state in list
        document.querySelectorAll('.chat-list-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-chat-id') === chatId) {
                item.classList.add('active');
            }
        });

        currentChatId = chatId;
        currentChatPlatform = platform;

        const chatHeader = document.getElementById('chat-header');
        const chatHistoryContainer = document.getElementById('chat-history');
        const replyArea = document.getElementById('reply-area');

        chatHeader.innerHTML = `
            <h4 class="text-lg font-bold text-gray-800 flex items-center">
                ${platformIcon(platform)} Chat with: ${username}
            </h4>
            <p class="text-sm text-gray-500">ID: ${chatId} | Platform: ${platform.charAt(0).toUpperCase() + platform.slice(1)}</p>
        `;
        chatHistoryContainer.innerHTML = `<div class="text-center text-gray-400 mt-20">Loading history...</div>`;
        replyArea.classList.add('hidden');

        try {
            const history = await authorizedFetch(`${API_URL}/api/chats/${chatId}/history`);
            renderMessages(history, chatHistoryContainer);
            replyArea.classList.remove('hidden');
        } catch (error) {
            chatHistoryContainer.innerHTML = `<div class="text-center text-red-500 mt-20">Error loading history: ${error.message}</div>`;
            replyArea.classList.add('hidden');
        }
    }

    function renderMessages(messages, container) {
        container.innerHTML = '';
        if (messages.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500 mt-20">No messages in this conversation.</div>`;
            return;
        }

        messages.forEach(msg => {
            const isUser = msg.sender === 'user';
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;
            
            let content = '';
            if (msg.mediaPath) {
                // For media, we only display a placeholder since we can't download the file without extra server logic
                const fileName = msg.filename || 'Media file';
                content = `<div class="p-2 border border-dashed rounded-lg bg-white shadow-sm">
                    <i data-lucide="file" class="w-4 h-4 inline-block mr-1"></i>
                    <span class="font-medium">${fileName}</span>
                    <p class="text-xs italic text-gray-500">${msg.text || 'No caption'}</p>
                </div>`;
            } else {
                content = msg.text;
            }

            messageDiv.innerHTML = `
                <div class="message-bubble ${isUser ? 'user-message' : 'admin-message'} ${isUser ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-md">
                    <p>${content}</p>
                    <span class="block text-xs mt-1 ${isUser ? 'text-indigo-200' : 'text-gray-500'} text-right">${formatTime(msg.timestamp)}</span>
                </div>
            `;
            container.appendChild(messageDiv);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
        lucide.createIcons();
    }

    function handleAdminReply(e) {
        e.preventDefault();
        const input = document.getElementById('reply-input');
        const text = input.value.trim();
        const statusEl = document.getElementById('reply-status');

        if (!text || !currentChatId || !socket) return;

        statusEl.textContent = 'Sending...';
        statusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
        statusEl.classList.add('text-gray-500');

        socket.emit('admin_reply', { chatId: currentChatId, text }, (response) => {
            if (response.success) {
                input.value = '';
                statusEl.textContent = 'Sent!';
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-green-500');
            } else {
                statusEl.textContent = `Error sending: ${response.error}`;
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-red-500');
                console.error("Reply failed:", response.error);
            }
            setTimeout(() => statusEl.classList.add('hidden'), 3000);
        });
    }

    // --- User Management ---

    function renderUserList(container) {
        container.classList.add('p-8', 'bg-white', 'rounded-xl', 'shadow-lg');
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-semibold text-gray-800">System Users</h2>
                <button id="add-user-btn" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-xl shadow-md flex items-center space-x-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Add New User</span>
                </button>
            </div>
            
            <!-- Add User Form (Hidden by default) -->
            <div id="add-user-form-container" class="bg-gray-50 p-6 rounded-xl mb-6 shadow hidden">
                <h3 class="text-lg font-medium mb-4">Add User Details</h3>
                <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="user-name" placeholder="Name" required class="p-2 border rounded-lg col-span-2">
                    <select id="user-role" class="p-2 border rounded-lg">
                        <option value="Viewer">Viewer</option>
                        <option value="Admin">Admin</option>
                        <option value="Editor">Editor</option>
                    </select>
                    <select id="user-status" class="p-2 border rounded-lg">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                    <div class="col-span-4 flex justify-end space-x-2">
                        <button type="button" id="cancel-user-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition duration-150">Cancel</button>
                        <button type="submit" class="bg-primary hover:bg-primary-light text-white font-bold py-2 px-4 rounded-xl transition duration-150">Create User</button>
                    </div>
                </form>
            </div>

            <div id="user-list-table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="p-4 text-center text-gray-400">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('add-user-form-container').classList.remove('hidden');
            document.getElementById('add-user-btn').classList.add('hidden');
        });
        document.getElementById('cancel-user-btn').addEventListener('click', () => {
            document.getElementById('add-user-form-container').classList.add('hidden');
            document.getElementById('add-user-btn').classList.remove('hidden');
        });

        document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
        fetchUsers();
    }

    async function fetchUsers() {
        const body = document.getElementById('user-list-body');
        body.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Loading users...</td></tr>`;

        try {
            const users = await authorizedFetch(`${API_URL}/api/users`);
            body.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.createdAt ? formatDate(user.createdAt.toDate().toISOString()) : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-user-id="${user.id}" class="delete-user-btn text-red-600 hover:text-red-900 ml-2" title="Delete User">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });

            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', handleDeleteUser);
            });
            lucide.createIcons();

        } catch (error) {
            body.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading users: ${error.message}</td></tr>`;
            console.error(error);
        }
    }

    async function handleAddUser(e) {
        e.preventDefault();
        const name = document.getElementById('user-name').value;
        const role = document.getElementById('user-role').value;
        const status = document.getElementById('user-status').value;

        try {
            await authorizedFetch(`${API_URL}/api/users`, {
                method: 'POST',
                body: JSON.stringify({ name, role, status })
            });

            document.getElementById('add-user-form').reset();
            document.getElementById('add-user-form-container').classList.add('hidden');
            document.getElementById('add-user-btn').classList.remove('hidden');
            fetchUsers(); // Refresh list

        } catch (error) {
            alert(`Failed to add user: ${error.message}`);
        }
    }

    async function handleDeleteUser(e) {
        const userId = e.currentTarget.getAttribute('data-user-id');

        // Simple custom confirmation (replaces window.confirm)
        if (confirm(`Are you sure you want to delete user ID: ${userId}?`)) {
            try {
                await authorizedFetch(`${API_URL}/api/users/${userId}`, { method: 'DELETE' });
                fetchUsers(); // Refresh list
            } catch (error) {
                alert(`Failed to delete user: ${error.message}`);
            }
        }
    }

    // --- Broadcast & Settings Placeholders ---

    function renderBroadcastView(container) {
        container.classList.add('p-8', 'bg-white', 'rounded-xl', 'shadow-lg');
        container.innerHTML = `
            <h2 class="text-2xl font-semibold mb-4 text-primary">Telegram User Broadcast</h2>
            <p class="text-gray-600 mb-6">Send a message to all active Telegram users who have started a chat with the bot.</p>
            <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-lg">
                <strong>Note:</strong> Sending broadcast messages requires a dedicated server endpoint (e.g., <code>/api/broadcast</code>) to iterate over all chat IDs and call the <code>bot.sendMessage()</code> function for each. This client-side UI is a placeholder until that server route is implemented.
            </div>
            
            <form id="broadcast-form" class="space-y-4">
                <div>
                    <label for="broadcast-message" class="block text-sm font-medium text-gray-700 mb-2">Message Content</label>
                    <textarea id="broadcast-message" rows="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Enter your broadcast message here..."></textarea>
                </div>
                <button type="submit" id="broadcast-btn" class="bg-primary hover:bg-primary-light text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-200" disabled>
                    Send Broadcast (Disabled)
                </button>
            </form>
            <p id="broadcast-status" class="mt-4 text-sm"></p>
        `;
    }

    function renderSettings(container) {
        container.classList.add('p-8', 'bg-white', 'rounded-xl', 'shadow-lg');
        container.innerHTML = `
            <h2 class="text-2xl font-semibold mb-4 text-primary">Settings</h2>
            <div class="space-y-4">
                <p class="text-gray-600">This section is reserved for configuration options, API key management, and other system settings.</p>
                <div class="p-4 bg-gray-100 rounded-xl">
                    <h3 class="font-medium text-gray-700">Current Login Details</h3>
                    <p class="text-sm text-gray-500">Username: <span class="font-mono text-gray-800">${localStorage.getItem(AUTH_USERNAME_KEY)}</span></p>
                    <button id="logout-btn" class="mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl text-sm transition duration-150">
                        Logout / Reset Credentials
                    </button>
                </div>
            </div>
        `;
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm("Are you sure you want to log out? You will need to re-enter credentials.")) {
                localStorage.removeItem(AUTH_USERNAME_KEY);
                localStorage.removeItem(AUTH_PASSWORD_KEY);
                window.location.reload();
            }
        });
    }

    // --- Socket.io Handlers ---

    function setupSocket() {
        // Assume socket server is on the same host/port
        socket = io({ path: '/socket.io' }); 

        socket.on('connect', () => {
            console.log('Socket.io connected');
        });

        // Handler for a new message from a user (Telegram/Facebook)
        socket.on('new_message', (data) => {
            console.log('New incoming message:', data);
            
            // Update the chat list cache
            const existingIndex = chatsData.findIndex(c => c.telegramId === data.chatId);
            const chatUpdate = { 
                telegramId: data.chatId, 
                username: data.user.username, 
                lastMessageText: data.message.text, 
                lastMessageTime: data.message.timestamp,
                platform: data.platform
            };

            if (existingIndex > -1) {
                // Remove old, add new to top
                chatsData.splice(existingIndex, 1);
                chatsData.unshift(chatUpdate);
            } else {
                chatsData.unshift(chatUpdate);
            }

            // If the user is currently viewing the relevant chat list page, re-render it
            const requiredPage = `${data.platform}_chats`;
            if (currentPage === requiredPage.replace('facebook', 'fb')) {
                renderChatList(chatsData.filter(c => c.platform === data.platform));
            }


            // If the user is currently viewing this chat, append the message
            if (data.chatId === currentChatId) {
                const chatHistoryContainer = document.getElementById('chat-history');
                const tempMsg = { ...data.message, timestamp: new Date().toISOString() };
                renderMessages([tempMsg], chatHistoryContainer);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            }
        });

        // Handler for a message sent by the admin
        socket.on('message_sent', (data) => {
            console.log('Admin message confirmed:', data);
            // If the user is currently viewing this chat, append the message
            if (data.chatId === currentChatId) {
                const chatHistoryContainer = document.getElementById('chat-history');
                renderMessages([data.message], chatHistoryContainer);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            }
            // Update the chat list for last message text/time
            // Since we don't know the current platform, we update the whole list in cache and re-render if visible
            const platform = data.message.sender === 'admin' ? currentChatPlatform : 'telegram'; // Guess platform from current view or default
            const requiredPage = `${platform}_chats`;
            if (currentPage === requiredPage.replace('facebook', 'fb')) {
                // Force a full chat list re-fetch/re-render to update the 'last message' field
                fetchChats(platform);
            }

        });
    }

    // --- Initialization ---

    async function init() {
        const authOverlay = document.getElementById('auth-overlay');
        const sidebar = document.getElementById('sidebar');

        let username = localStorage.getItem(AUTH_USERNAME_KEY);
        let password = localStorage.getItem(AUTH_PASSWORD_KEY);

        // 1. Basic Auth Check/Prompt
        if (!username || !password) {
            authOverlay.classList.remove('hidden');
            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const u = document.getElementById('auth-username').value;
                const p = document.getElementById('auth-password').value;
                
                // Temporary check for auth
                const tempAuthToken = getAuthHeader(u, p);
                try {
                    // Try to fetch a protected resource
                    await fetch(`${API_URL}/api/chats`, { headers: { 'Authorization': tempAuthToken } });
                    
                    // Auth success
                    localStorage.setItem(AUTH_USERNAME_KEY, u);
                    localStorage.setItem(AUTH_PASSWORD_KEY, p);
                    init(); // Re-initialize
                } catch (error) {
                    console.error("Auth attempt failed:", error);
                    document.getElementById('auth-error').classList.remove('hidden');
                }
            });
            return; // Stop initialization until authenticated
        }

        // 2. Auth Success - Set Globals and UI
        authToken = getAuthHeader(username, password);
        authOverlay.classList.add('hidden');
        sidebar.classList.remove('hidden');
        document.getElementById('auth-info').textContent = username;

        // 3. Setup Socket.io
        setupSocket();

        // 4. Setup Navigation Listeners
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const page = e.currentTarget.getAttribute('data-page');
                renderPage(page);
            });
        });

        // 5. Initial Page Load
        renderPage('dashboard');
    }

    // Run the initialization sequence
    window.onload = init;
</script>

</body>
</html>
