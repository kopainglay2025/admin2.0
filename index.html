<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Admin Dashboard - Real-time Support</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Menu -->
        <div class="w-16 md:w-64 bg-gray-800 text-white flex flex-col p-2 md:p-4 transition-all duration-300">
            <div class="text-xl font-bold mb-8 hidden md:block">Admin Panel</div>
            <nav class="flex flex-col space-y-2">
                <!-- Menu Items -->
                <a href="#" class="nav-item active" data-view="chats">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <span class="hidden md:inline">Chats</span>
                </a>
                <a href="#" class="nav-item" data-view="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line></svg>
                    <span class="hidden md:inline">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-view="users">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span class="hidden md:inline">Users</span>
                </a>
                <a href="#" class="nav-item" data-view="broadcast">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 12H3"></path><path d="M10 19l-7-7 7-7"></path></svg>
                    <span class="hidden md:inline">Broadcast</span>
                </a>
                <a href="#" class="nav-item" data-view="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.82.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path></svg>
                    <span class="hidden md:inline">Settings</span>
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header/Platform Filter -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                <h1 class="text-2xl font-semibold text-gray-800" id="current-view-title">Chats</h1>
                <div class="flex space-x-2">
                    <button id="filter-all" class="platform-filter-btn bg-indigo-600 text-white hover:bg-indigo-700">All Chats</button>
                    <button id="filter-telegram" class="platform-filter-btn bg-blue-500 text-white hover:bg-blue-600">TG Chats</button>
                    <button id="filter-facebook" class="platform-filter-btn bg-sky-600 text-white hover:bg-sky-700">FB Chats</button>
                </div>
            </header>

            <!-- Chat Application Layout -->
            <div id="chats-view" class="flex-1 flex overflow-hidden">
                <!-- Chat List (Left Column) -->
                <div class="w-full md:w-1/3 border-r bg-white overflow-y-auto">
                    <ul id="chat-list">
                        <!-- Chat items will be dynamically inserted here -->
                        <li class="p-4 text-center text-gray-500">Loading chats...</li>
                    </ul>
                </div>

                <!-- Chat Conversation (Right Column) -->
                <div class="hidden md:flex flex-col flex-1 bg-gray-50">
                    <!-- Chat Header -->
                    <div id="chat-detail-header" class="p-4 border-b bg-white flex items-center shadow-sm">
                        <span id="chat-detail-name" class="text-lg font-semibold text-gray-800">Select a Chat</span>
                        <span id="chat-detail-platform" class="ml-3 px-3 py-1 text-xs font-medium rounded-full text-white bg-gray-400"></span>
                    </div>

                    <!-- Chat History Area -->
                    <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col-reverse">
                        <!-- Messages will be dynamically inserted here (in reverse order for bottom-up scrolling) -->
                        <div id="no-chat-selected" class="text-center text-gray-500 my-auto">
                            Select a chat from the left to view the conversation and reply.
                        </div>
                    </div>

                    <!-- Message Input Area -->
                    <div id="chat-input-area" class="p-4 bg-white border-t hidden">
                        <form id="reply-form" class="flex items-center space-x-3">
                            <input type="text" id="reply-input" placeholder="Type your reply message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                            <button type="submit" id="send-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                <span class="ml-2 hidden sm:inline">Send</span>
                            </button>
                        </form>
                        <div id="send-status" class="text-sm mt-1 text-center hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Placeholder views for other menu items -->
            <div id="dashboard-view" class="p-8 hidden">
                <h2 class="text-3xl font-bold">Dashboard</h2>
                <p class="text-gray-600 mt-4">Welcome to the Admin Dashboard. Current chat activity will be displayed here.</p>
            </div>
            <div id="users-view" class="p-8 hidden">
                <h2 class="text-3xl font-bold">User Management</h2>
                <p class="text-gray-600 mt-4">Manage system and platform users here. (Uses the `/api/users` endpoints)</p>
            </div>
            <div id="broadcast-view" class="p-8 hidden">
                <h2 class="text-3xl font-bold">Telegram Broadcast</h2>
                <p class="text-gray-600 mt-4">Feature to send bulk messages to all Telegram users.</p>
            </div>
            <div id="settings-view" class="p-8 hidden">
                <h2 class="text-3xl font-bold">Settings</h2>
                <p class="text-gray-600 mt-4">Configure environment variables and system settings.</p>
            </div>
        </div>
    </div>

    <!-- Socket.io Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- Global State ---
        let chats = [];
        let currentChatId = null;
        let currentPlatform = 'all'; // 'all', 'telegram', or 'facebook'

        // --- DOM Elements ---
        const chatListEl = document.getElementById('chat-list');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatDetailNameEl = document.getElementById('chat-detail-name');
        const chatDetailPlatformEl = document.getElementById('chat-detail-platform');
        const chatInputAreaEl = document.getElementById('chat-input-area');
        const replyInputEl = document.getElementById('reply-input');
        const sendStatusEl = document.getElementById('send-status');
        const noChatSelectedEl = document.getElementById('no-chat-selected');

        // --- Socket.io Setup ---
        const socket = io();

        // The server is protected by Basic Auth.
        // We assume the user has already entered credentials or they are cached.
        // If API calls fail (401), the browser will typically prompt the user again.
        // For simplicity, we use the cached credentials for fetch.
        const authHeader = 'Basic ' + btoa('admin:password'); // Replace with logic to get credentials if needed

        // --- Utility Functions ---

        // Helper to format timestamp
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        // Helper to generate unique identifier for a chat
        function getChatId(chat) {
            return chat.telegramId; // Using the document ID (which is the PSID/Telegram ID)
        }

        // --- Rendering Functions ---

        function renderChatList(filter = 'all') {
            chatListEl.innerHTML = '';
            const filteredChats = chats.filter(chat => {
                if (filter === 'all') return true;
                return chat.platform === filter;
            });

            if (filteredChats.length === 0) {
                chatListEl.innerHTML = `<li class="p-4 text-center text-gray-500">No ${filter} chats found.</li>`;
                return;
            }

            filteredChats.forEach(chat => {
                const chatId = getChatId(chat);
                const listItem = document.createElement('li');
                listItem.className = `p-4 border-b cursor-pointer hover:bg-indigo-50 transition duration-100 ${chatId === currentChatId ? 'bg-indigo-100' : 'bg-white'}`;
                listItem.setAttribute('data-chat-id', chatId);
                listItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="font-semibold truncate text-gray-800">${chat.username || chat.telegramId}</div>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white ${chat.platform === 'telegram' ? 'bg-blue-500' : 'bg-sky-600'}">
                            ${chat.platform === 'telegram' ? 'TG' : 'FB'}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 truncate mt-1">${chat.lastMessageText || 'Media message'}</div>
                    <div class="text-xs text-gray-400 mt-1">${formatTime(chat.lastMessageTime)}</div>
                `;
                listItem.addEventListener('click', () => loadChatHistory(chat));
                chatListEl.appendChild(listItem);
            });
        }

        function renderMessage(message) {
            const isUser = message.sender === 'user';
            const bubbleClass = isUser
                ? 'bg-white self-start text-gray-800 rounded-br-none shadow-md'
                : 'bg-indigo-600 self-end text-white rounded-bl-none shadow-md';
            
            const messageEl = document.createElement('div');
            messageEl.className = `max-w-xs md:max-w-md p-3 rounded-xl ${bubbleClass}`;
            
            let content = `<p class="whitespace-pre-wrap">${message.text}</p>`;

            if (message.mediaPath) {
                // Since mediaPath is a file_id (Telegram) or might be an attachment ID (FB),
                // we cannot directly display the media in the Admin UI without another backend endpoint
                // to fetch the file (e.g., using bot.getFileLink and proxying).
                // For this MVP, we show a link/placeholder.
                const filename = message.filename ? `(${message.filename})` : '';
                content += `<p class="text-xs italic mt-1 ${isUser ? 'text-gray-500' : 'text-indigo-200'}">
                    Media file received ${filename}: ${message.mediaPath}
                </p>`;
            }

            messageEl.innerHTML = content + 
                `<p class="text-right text-xs mt-1 ${isUser ? 'text-gray-400' : 'text-indigo-200'}">${formatTime(message.timestamp)}</p>`;
            
            // Note: Since we use flex-col-reverse on the parent, we append to show at the top of the reversed list
            chatHistoryEl.prepend(messageEl); 
        }

        // --- Data Fetching & Handling ---

        async function fetchChats(filter = 'all') {
            try {
                // Construct query URL
                const platformQuery = filter !== 'all' ? `?platform=${filter}` : '';
                const response = await fetch(`/api/chats${platformQuery}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (response.status === 401) {
                    throw new Error("Authentication failed. Please check your admin credentials.");
                }

                chats = await response.json();
                chats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
                currentPlatform = filter;
                renderChatList(currentPlatform);

            } catch (error) {
                console.error("Error fetching chats:", error);
                chatListEl.innerHTML = `<li class="p-4 text-center text-red-500">Error: ${error.message}</li>`;
            }
        }

        async function loadChatHistory(chat) {
            currentChatId = getChatId(chat);

            // Update UI
            chatHistoryEl.innerHTML = '';
            chatDetailNameEl.textContent = chat.username || chat.telegramId;
            chatDetailPlatformEl.textContent = chat.platform === 'telegram' ? 'TELEGRAM' : 'FACEBOOK';
            chatDetailPlatformEl.className = `ml-3 px-3 py-1 text-xs font-medium rounded-full text-white ${chat.platform === 'telegram' ? 'bg-blue-500' : 'bg-sky-600'}`;
            chatInputAreaEl.classList.remove('hidden');
            noChatSelectedEl.classList.add('hidden');

            // Set current chat item as active in the list
            document.querySelectorAll('#chat-list li').forEach(li => {
                li.classList.remove('bg-indigo-100');
                li.classList.add('bg-white');
            });
            const activeLi = document.querySelector(`[data-chat-id="${currentChatId}"]`);
            if (activeLi) {
                activeLi.classList.add('bg-indigo-100');
            }
            
            // Fetch history
            try {
                const response = await fetch(`/api/chats/${currentChatId}/history`, {
                    headers: { 'Authorization': authHeader }
                });
                const history = await response.json();

                history.forEach(renderMessage);

                // Scroll to bottom (since we are using flex-col-reverse)
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight; 

            } catch (error) {
                console.error("Error loading chat history:", error);
                chatHistoryEl.innerHTML = `<div class="text-center text-red-500 mt-4">Error loading history.</div>`;
            }
        }

        // --- Socket.io Event Handlers ---

        socket.on('connect', () => {
            console.log('Connected to Socket.io server.');
        });

        // Handler for new user message from Telegram or Facebook
        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // 1. Update/Add chat in the local 'chats' array
            const existingChatIndex = chats.findIndex(c => getChatId(c) === chatId);
            
            const chatUpdate = {
                telegramId: String(chatId),
                username: user.username,
                lastMessageTime: message.timestamp,
                lastMessageText: message.text || 'Media message',
                platform: data.platform
            };

            if (existingChatIndex !== -1) {
                // Update existing chat
                chats[existingChatIndex] = { ...chats[existingChatIndex], ...chatUpdate };
            } else {
                // Add new chat
                chats.unshift(chatUpdate);
            }

            // 2. Sort and re-render the chat list (keeping the current filter)
            chats.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            renderChatList(currentPlatform);

            // 3. If the message is for the currently selected chat, render it instantly
            if (chatId === currentChatId) {
                renderMessage(message);
                chatHistoryEl.scrollTop = 0; // Keep at bottom (top of reversed list)
            }
        });

        // Handler for admin message confirmation
        socket.on('message_sent', (data) => {
            const { chatId, message } = data;
            if (chatId === currentChatId) {
                // Render the message immediately
                renderMessage(message);
                chatHistoryEl.scrollTop = 0;
            }
        });


        // --- UI Event Listeners ---

        document.getElementById('reply-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const text = replyInputEl.value.trim();
            if (!text || !currentChatId) return;

            sendStatusEl.textContent = 'Sending...';
            sendStatusEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            sendStatusEl.classList.add('text-gray-600');
            
            // Send reply via Socket.io
            socket.emit('admin_reply', { chatId: currentChatId, text }, (response) => {
                if (response.success) {
                    replyInputEl.value = ''; // Clear input on success
                    sendStatusEl.textContent = 'Sent successfully.';
                    sendStatusEl.classList.remove('text-gray-600', 'text-red-600');
                    sendStatusEl.classList.add('text-green-600');
                    // Message will be rendered by the 'message_sent' socket listener
                } else {
                    sendStatusEl.textContent = `Error sending: ${response.error}`;
                    sendStatusEl.classList.remove('text-gray-600', 'text-green-600');
                    sendStatusEl.classList.add('text-red-600');
                }
                setTimeout(() => sendStatusEl.classList.add('hidden'), 3000);
            });
        });

        // Platform Filter Handlers
        document.getElementById('filter-all').addEventListener('click', () => fetchChats('all'));
        document.getElementById('filter-telegram').addEventListener('click', () => fetchChats('telegram'));
        document.getElementById('filter-facebook').addEventListener('click', () => fetchChats('facebook'));

        document.querySelectorAll('.platform-filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.platform-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'bg-blue-500', 'bg-sky-600');
                    btn.classList.add('bg-gray-400');
                });
                this.classList.remove('bg-gray-400');
                // Reapply the specific color based on ID
                if (this.id === 'filter-all') this.classList.add('bg-indigo-600');
                if (this.id === 'filter-telegram') this.classList.add('bg-blue-500');
                if (this.id === 'filter-facebook') this.classList.add('bg-sky-600');
            });
        });
        document.getElementById('filter-all').click(); // Default filter

        // Sidebar Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                const view = item.getAttribute('data-view');
                document.querySelectorAll('div[id$="-view"]').forEach(v => v.classList.add('hidden'));

                const targetView = document.getElementById(view + '-view');
                if (targetView) {
                    targetView.classList.remove('hidden');
                    document.getElementById('current-view-title').textContent = item.querySelector('span') ? item.querySelector('span').textContent : view.charAt(0).toUpperCase() + view.slice(1);
                    
                    // Specific logic for chats view
                    const isChatsView = view === 'chats';
                    document.getElementById('chats-view').classList.toggle('hidden', !isChatsView);
                    document.querySelector('header').classList.toggle('hidden', !isChatsView);
                }
            });
        });

        // Style for active navigation item
        const style = document.createElement('style');
        style.textContent = `
            .nav-item {
                display: flex;
                align-items: center;
                padding: 10px;
                border-radius: 8px;
                transition: background-color 0.2s;
            }
            .nav-item:hover {
                background-color: #374151;
            }
            .nav-item.active {
                background-color: #4f46e5; /* Indigo-600 */
            }
            /* Ensure chats view is visible initially */
            #chats-view {
                display: flex;
            }
        `;
        document.head.appendChild(style);

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            fetchChats('all');
            // Ensure only the chats view is visible initially and all others are hidden
            document.querySelectorAll('div[id$="-view"]').forEach(v => v.classList.add('hidden'));
            document.getElementById('chats-view').classList.remove('hidden');
        });

    </script>
</body>
</html>
