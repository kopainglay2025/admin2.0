<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Channel Chat Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Load Moment.js for time formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar for aesthetics */
        .chat-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        /* Ensure the main content uses full height */
        #main-content {
            height: calc(100vh - 64px); /* Full screen height minus header height (h-16) */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased h-screen flex flex-col">

    <!-- Basic Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Admin Login Required</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button onclick="authenticate()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Login</button>
            <p id="auth-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="flex flex-col h-screen hidden">
        
        <!-- Header / Menu Bar -->
        <header class="bg-white shadow-lg border-b border-gray-200 h-16 flex items-center justify-between px-4 sm:px-6 z-10">
            <h1 class="text-2xl font-extrabold text-blue-600 flex items-center">
                <i class="fas fa-headset mr-3"></i>
                OmniDesk
            </h1>
            
            <!-- Navigation Menu -->
            <nav class="flex space-x-2 sm:space-x-4 overflow-x-auto whitespace-nowrap">
                <button data-view="dashboard" onclick="switchView('dashboard')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150 active-menu"><i class="fas fa-home mr-1"></i> Dashboard</button>
                <button data-view="users" onclick="switchView('users')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150"><i class="fas fa-users-cog mr-1"></i> User</button>
                <button data-view="tg-chats" onclick="switchView('tg-chats')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150"><i class="fab fa-telegram-plane mr-1"></i> TG Chats</button>
                <button data-view="fb-chats" onclick="switchView('fb-chats')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150"><i class="fab fa-facebook-messenger mr-1"></i> FB Chats</button>
                <button data-view="broadcast" onclick="switchView('broadcast')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150"><i class="fas fa-bullhorn mr-1"></i> TG Broadcast</button>
                <button data-view="settings" onclick="switchView('settings')" class="menu-item py-2 px-3 text-gray-600 hover:text-blue-600 hover:bg-gray-100 rounded-lg font-medium transition duration-150"><i class="fas fa-cog mr-1"></i> Settings</button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex flex-1 overflow-hidden bg-gray-100">

            <!-- 1. Dashboard View (Placeholder) -->
            <div id="dashboard-view" class="view-content p-8 w-full">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Dashboard Overview</h2>
                    <p class="text-gray-600">This section would display key metrics like active chats, average response time, and user statistics. (Feature under development).</p>
                    <!-- Example Metric Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-blue-50 p-4 rounded-lg shadow-md">
                            <p class="text-sm text-blue-600 font-medium">Active Chats</p>
                            <p class="text-2xl font-bold text-blue-800">12</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg shadow-md">
                            <p class="text-sm text-green-600 font-medium">Avg. Response Time</p>
                            <p class="text-2xl font-bold text-green-800">45s</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg shadow-md">
                            <p class="text-sm text-yellow-600 font-medium">New Users Today</p>
                            <p class="text-2xl font-bold text-yellow-800">8</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Chats View (The existing core logic) -->
            <div id="chats-view" class="view-content w-full h-full flex hidden">
                
                <!-- Left Sidebar: Chat List -->
                <div class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white border-r border-gray-200 shadow-lg flex-shrink-0">
                    
                    <!-- Header -->
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h1 class="text-xl font-extrabold text-gray-900">Live Conversations</h1>
                        <button onclick="fetchChats()" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150 rounded-full" title="Refresh Chats">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <!-- Platform Filter (Now redundant but kept for flexibility) -->
                    <div class="p-3 bg-gray-50 border-b border-gray-200 flex space-x-2 justify-center hidden">
                        <button id="filter-all" onclick="setPlatformFilter(null)" class="filter-btn bg-blue-500 text-white text-sm font-medium py-1 px-3 rounded-full shadow-md transition duration-150">All</button>
                        <button id="filter-telegram" onclick="setPlatformFilter('telegram')" class="filter-btn bg-white text-gray-700 text-sm font-medium py-1 px-3 rounded-full border border-gray-300 hover:bg-blue-50 transition duration-150">Telegram</button>
                        <button id="filter-facebook" onclick="setPlatformFilter('facebook')" class="filter-btn bg-white text-gray-700 text-sm font-medium py-1 px-3 rounded-full border border-gray-300 hover:bg-blue-50 transition duration-150">Facebook</button>
                    </div>

                    <!-- Chat List -->
                    <div id="chat-list" class="flex-1 overflow-y-auto chat-scroll">
                        <div class="p-4 text-center text-gray-500 italic">Loading chats...</div>
                    </div>
                </div>

                <!-- Right Panel: Chat History & Reply -->
                <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col">
                    
                    <!-- Chat Header -->
                    <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-sm flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i id="header-platform-icon" class="hidden mr-2"></i>
                            <span id="header-username">Select a Chat</span>
                        </h2>
                        <div id="header-chat-id" class="text-sm text-gray-500 hidden md:block"></div>
                    </div>

                    <!-- Message History -->
                    <div id="message-history" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 bg-gray-100 chat-scroll flex flex-col-reverse">
                        <div id="initial-message" class="text-center text-gray-500 italic mt-auto">Please select a conversation from the left panel.</div>
                    </div>

                    <!-- Reply Box -->
                    <div id="reply-box" class="p-4 border-t border-gray-200 bg-white hidden">
                        <div class="flex space-x-3">
                            <textarea id="reply-text" rows="2" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Type your reply..."></textarea>
                            <button onclick="handleReply()" class="w-24 bg-green-600 text-white rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50" id="send-btn">
                                <i class="fas fa-paper-plane mr-2"></i> Send
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- 3. User Management View -->
            <div id="users-view" class="view-content p-8 w-full hidden overflow-y-auto">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-full lg:max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">System User Management</h2>
                    
                    <!-- New User Form -->
                    <div class="mb-6 p-4 border border-blue-100 bg-blue-50 rounded-xl shadow-inner">
                        <h3 class="text-xl font-semibold text-blue-800 mb-3">Add New User</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div class="col-span-1 md:col-span-2">
                                <label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-1">Name (Used for internal tracking only)</label>
                                <input type="text" id="new-user-name" placeholder="Name" class="p-2 w-full border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="new-user-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                <select id="new-user-role" class="p-2 w-full border rounded-lg">
                                    <option value="Viewer">Viewer</option>
                                    <option value="Agent">Agent</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div>
                                <label for="new-user-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="new-user-status" class="p-2 w-full border rounded-lg">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="createUser()" class="mt-4 bg-blue-600 text-white p-2.5 rounded-lg hover:bg-blue-700 transition font-semibold w-full md:w-auto">
                            <i class="fas fa-plus-circle mr-2"></i> Add System User
                        </button>
                    </div>

                    <!-- User Table -->
                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- User rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. TG Broadcast View (Placeholder) -->
            <div id="broadcast-view" class="view-content p-8 w-full hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Telegram Broadcast Manager</h2>
                    <p class="text-gray-600">Use this area to send a message to multiple Telegram users simultaneously. (Feature under development).</p>
                    <textarea class="mt-4 w-full p-3 border border-gray-300 rounded-lg resize-y" rows="5" placeholder="Enter broadcast message here..."></textarea>
                    <button class="mt-3 bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition">Send Broadcast</button>
                </div>
            </div>
            
            <!-- 5. Settings View (Placeholder) -->
            <div id="settings-view" class="view-content p-8 w-full hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">System Settings</h2>
                    <p class="text-gray-600">Configure API keys, webhooks, and default administrative parameters here. (Feature under development).</p>
                    <div class="mt-6 space-y-4">
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Telegram Bot Token (Read Only)">
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Facebook Page Token (Read Only)">
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Message Box (No alerts) -->
    <div id="message-box-container" class="fixed top-0 left-0 right-0 p-4 z-50 pointer-events-none">
        <!-- Messages appear here -->
    </div>


    <script>
        // Global State and Configuration
        const socket = io();
        let currentChatId = null;
        let chats = {}; // Store chat objects for quick lookup
        let platformFilter = null;
        let authHeader = null;
        let currentView = 'dashboard'; // Default view

        // --- Utility Functions ---

        function setAuthHeader(username, password) {
            authHeader = 'Basic ' + btoa(username + ':' + password);
        }

        function createMessage(type, content) {
            const container = document.getElementById('message-box-container');
            const box = document.createElement('div');
            box.className = `p-4 rounded-lg shadow-xl text-white font-medium mb-3 transition-opacity duration-300 ease-out max-w-sm mx-auto ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            box.innerHTML = content;
            container.appendChild(box);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.remove(), 300);
            }, 3000);
        }

        // --- Authentication ---

        function authenticate() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('auth-error');

            setAuthHeader(username, password);

            // Test authentication by fetching chats
            fetchChats(false) // Don't re-render list yet
                .then(() => {
                    document.getElementById('auth-modal').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    createMessage('success', 'Authentication successful. Welcome!');
                    // Set default view after login
                    switchView('tg-chats'); // Default to TG Chats view as it's the primary function
                })
                .catch(error => {
                    setAuthHeader(null, null); // Clear header on failure
                    errorElement.textContent = 'Login failed. Check username and password.';
                    errorElement.classList.remove('hidden');
                    console.error('Authentication error:', error);
                });
        }

        // --- View Switching ---

        function switchView(viewName) {
            currentView = viewName;
            
            // Hide all view containers
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
                view.classList.remove('flex'); // Remove flex from others
            });

            // Show the selected view
            const selectedView = document.getElementById(`${viewName}-view`);
            if (selectedView) {
                if (viewName === 'chats-view' || viewName === 'tg-chats' || viewName === 'fb-chats') {
                    // Chats view requires flex layout
                    selectedView.classList.add('flex');
                    // Special logic for TG/FB chats menu items
                    if (viewName === 'tg-chats') setPlatformFilter('telegram');
                    if (viewName === 'fb-chats') setPlatformFilter('facebook');
                    
                    document.getElementById('chats-view').classList.remove('hidden');
                    
                } else if (viewName === 'users') {
                    // Users view should be full width (default block/p-8 container)
                    selectedView.classList.remove('hidden');
                    fetchUsers(); // Auto-fetch users when switching to user view
                } else {
                     // Dashboard, Broadcast, Settings (Default block display)
                    selectedView.classList.remove('hidden');
                }
            } else {
                 // Fallback to chats if a view is specified but not found
                 document.getElementById('chats-view').classList.add('flex');
            }

            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('text-blue-600', 'bg-gray-100', 'active-menu');
                item.classList.add('text-gray-600');
            });
            const activeMenuItem = document.querySelector(`.menu-item[data-view="${viewName}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('text-blue-600', 'bg-gray-100', 'active-menu');
                activeMenuItem.classList.remove('text-gray-600');
            }
        }
        
        // This function is now only called internally by switchView('tg-chats') or switchView('fb-chats')
        function setPlatformFilter(platform) {
            platformFilter = platform;
            fetchChats(true);
        }

        // --- API & Rendering (Mostly unchanged) ---

        async function apiFetch(url, options = {}) {
            if (!authHeader) throw new Error("Not authenticated.");

            const headers = {
                'Authorization': authHeader,
                'Content-Type': 'application/json',
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                if (response.status === 401) {
                    createMessage('error', 'Authentication failed or expired.');
                    document.getElementById('auth-modal').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                }
                throw new Error(`API Error: ${response.statusText}`);
            }
            return response.json();
        }

        async function fetchChats(shouldRender = true) {
            try {
                // Use the platformFilter set by the menu system
                const url = platformFilter ? `/api/chats?platform=${platformFilter}` : '/api/chats';
                const chatList = await apiFetch(url);
                
                chats = {};
                chatList.forEach(chat => {
                    chats[chat.telegramId] = chat;
                });

                if (shouldRender) {
                    renderChatList(chatList);
                }
                return chatList;

            } catch (error) {
                console.error("Error fetching chats:", error);
            }
        }

        function renderChatList(chatList) {
            const listElement = document.getElementById('chat-list');
            listElement.innerHTML = '';

            if (chatList.length === 0) {
                listElement.innerHTML = `<div class="p-4 text-center text-gray-500 italic">No active ${platformFilter || ''} chats found.</div>`;
                return;
            }

            chatList.forEach(chat => {
                const iconClass = chat.platform === 'facebook' ? 'fab fa-facebook-messenger text-blue-600' : 'fab fa-telegram-plane text-cyan-500';
                const item = document.createElement('div');
                item.className = `p-3 flex items-center space-x-3 cursor-pointer border-b hover:bg-gray-100 transition duration-150 ${currentChatId === chat.telegramId ? 'bg-blue-100 border-l-4 border-blue-500' : ''}`;
                item.onclick = () => selectChat(chat.telegramId);

                item.innerHTML = `
                    <div class="flex-shrink-0 text-2xl">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-semibold text-gray-800 truncate">${chat.username || chat.telegramId}</div>
                        <div class="text-xs text-gray-500 truncate">${chat.lastMessageText || 'Media message'}</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="text-xs text-gray-400">${moment(chat.lastMessageTime).fromNow()}</div>
                        <span class="text-xs font-medium px-2 py-0.5 mt-1 rounded-full text-white ${chat.platform === 'facebook' ? 'bg-blue-500' : 'bg-cyan-500'}">${chat.platform}</span>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        async function selectChat(chatId) {
            // Logic to clear previous selection and highlight new one
            document.querySelectorAll('#chat-list > div').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
            });
            const selectedItem = document.querySelector(`#chat-list > div[onclick*="${chatId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500');
            }

            currentChatId = chatId;
            const chat = chats[chatId];
            
            // Update header
            const iconClass = chat.platform === 'facebook' ? 'fab fa-facebook-messenger text-blue-600' : 'fab fa-telegram-plane text-cyan-500';
            document.getElementById('header-platform-icon').className = iconClass + ' mr-2';
            document.getElementById('header-username').textContent = chat.username || chat.telegramId;
            document.getElementById('header-chat-id').textContent = `ID: ${chatId}`;
            document.getElementById('header-platform-icon').classList.remove('hidden');
            
            // Show reply box
            document.getElementById('reply-box').classList.remove('hidden');
            document.getElementById('initial-message').classList.add('hidden');
            
            await loadHistory(chatId);
        }

        async function loadHistory(chatId) {
            const historyElement = document.getElementById('message-history');
            historyElement.innerHTML = `
                <div class="w-full text-center py-4">
                    <i class="fas fa-circle-notch fa-spin text-blue-500 text-xl"></i> Loading history...
                </div>
            `;
            
            try {
                const history = await apiFetch(`/api/chats/${chatId}/history`);
                renderHistory(history);
            } catch (error) {
                console.error("Error loading history:", error);
                historyElement.innerHTML = `<div class="p-4 text-center text-red-500 italic">Error loading chat history.</div>`;
            }
        }

        function renderHistory(messages) {
            const historyElement = document.getElementById('message-history');
            historyElement.innerHTML = '';
            
            // We reverse the array to render it correctly using flex-col-reverse
            messages.reverse().forEach(message => {
                const isUser = message.sender === 'user';
                const messageDiv = document.createElement('div');
                
                const timeStr = moment(message.timestamp).format('HH:mm');

                messageDiv.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;
                
                let content = '';

                if (message.mediaPath) {
                    // For Telegram, mediaPath is file_id. We can't display it directly here without the Telegram Bot API.
                    content = `<p class="italic text-gray-600">Media: ${message.filename || message.mediaPath}</p>`;
                }

                if (message.text) {
                    content += `<p>${message.text}</p>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow-md ${isUser ? 'bg-white text-gray-800' : 'bg-green-100 text-gray-800'}">
                        ${content}
                        <div class="text-right text-xs mt-1 ${isUser ? 'text-gray-400' : 'text-green-500'}">${timeStr}</div>
                    </div>
                `;
                
                historyElement.appendChild(messageDiv);
            });
            
            // Scroll to bottom (since we are using flex-col-reverse, this simulates scroll to bottom)
            historyElement.scrollTop = 0;
        }

        // --- Reply Handling ---

        async function handleReply() {
            const replyTextElement = document.getElementById('reply-text');
            const sendBtn = document.getElementById('send-btn');
            const text = replyTextElement.value.trim();

            if (!text || !currentChatId) return;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';

            socket.emit('admin_reply', { chatId: currentChatId, text }, (response) => {
                if (response.success) {
                    replyTextElement.value = '';
                    createMessage('success', 'Reply sent successfully!');
                } else {
                    createMessage('error', `Failed to send reply: ${response.error}`);
                    console.error("Reply failed:", response.error);
                }
                
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send';
            });
        }

        // --- Socket.io Handlers ---

        socket.on('connect', () => {
            console.log('Connected to Socket.io server.');
        });

        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // 1. Update/Add chat in local state and re-render chat list
            chats[chatId] = user;
            fetchChats(true); // Re-fetch to get correct ordering

            // 2. If it's the currently viewed chat AND the platform matches the filter, append the message
            if (chatId === currentChatId && (!platformFilter || platformFilter === user.platform)) {
                loadHistory(chatId); 
            }
            createMessage('info', `New message from ${user.username} (${user.platform})!`);
        });

        socket.on('message_sent', (data) => {
            const { chatId, message } = data;
            
            // 1. Update chat list (to update last message text/time)
            if (chats[chatId]) {
                chats[chatId].lastMessageText = message.text;
                fetchChats(true); 
            }

            // 2. If it's the currently viewed chat, update history
            if (chatId === currentChatId) {
                loadHistory(chatId); 
            }
        });


        // --- User Management Logic ---

        async function fetchUsers() {
            // Only fetch if we are in the users view
            if (currentView !== 'users') return;
            
            const listBody = document.getElementById('user-list-body');
            listBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-blue-500 italic"><i class="fas fa-spinner fa-spin mr-2"></i> Loading users...</td></tr>`;

            try {
                const users = await apiFetch('/api/users');
                renderUserList(users);
            } catch (error) {
                console.error("Error fetching users:", error);
                listBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500 italic">Failed to load users.</td></tr>`;
                createMessage('error', 'Could not fetch system users.');
            }
        }

        function renderUserList(users) {
            const listBody = document.getElementById('user-list-body');
            listBody.innerHTML = '';

            if (users.length === 0) {
                listBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No system users defined.</td></tr>`;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 transition duration-150" title="Delete User">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                listBody.appendChild(row);
            });
        }

        async function createUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const role = document.getElementById('new-user-role').value;
            const status = document.getElementById('new-user-status').value;

            if (!name) {
                createMessage('error', 'User name is required.');
                return;
            }

            try {
                await apiFetch('/api/users', {
                    method: 'POST',
                    body: JSON.stringify({ name, role, status })
                });
                document.getElementById('new-user-name').value = '';
                createMessage('success', 'User added successfully!');
                fetchUsers();
            } catch (error) {
                console.error("Error creating user:", error);
                createMessage('error', 'Failed to create user.');
            }
        }

        async function deleteUser(id) {
            // Using a basic window.confirm wrapped in a conditional to adhere to instructions.
            const response = window.confirm(`Are you sure you want to delete user ID: ${id}? (This action is permanent)`);
            if (!response) return;

            try {
                await apiFetch(`/api/users/${id}`, { method: 'DELETE' });
                createMessage('success', 'User deleted successfully.');
                fetchUsers();
            } catch (error) {
                console.error("Error deleting user:", error);
                createMessage('error', 'Failed to delete user.');
            }
        }
        
        // --- Initialization ---
        window.onload = () => {
            // Show auth modal on load
            document.getElementById('auth-modal').classList.remove('hidden');
        };
    </script>
</body>
</html>
