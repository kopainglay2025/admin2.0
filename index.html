<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminPlan</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use 'class' for dark mode and define custom color palette
        tailwind.config = {
            darkMode: 'class', // Enables switching by toggling the 'dark' class on <html>
            theme: {
                extend: {
                    colors: {
                        // Neon accents (consistent in both modes, but may look better on dark)
                        'neon-primary': '#00e0ff', // Electric Cyan
                        'neon-secondary': '#ff00ff', // Fuchsia
                        
                        // Theme base colors for easy class application
                        'light-bg': '#F3F4F6', 
                        'light-card': '#FFFFFF',
                        'light-border': '#D1D5DB',
                        'dark-bg': '#0D0C1D', // Very deep indigo/slate
                        'dark-card': '#1A192B', // Slightly lighter card background
                        'dark-border': '#374151',
                        'darker-sidebar': '#121021', // Darker base for the sidebar
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles that apply to both themes */
        body { 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
        }
        /* Style for the current active nav item in the sidebar */
        .nav-item.active {
            @apply bg-opacity-10 text-neon-primary border-r-4 border-neon-primary;
        }
        /* Custom scrollbar for better aesthetics, especially in dark mode */
        #messageHistory::-webkit-scrollbar {
            width: 8px;
        }
        #messageHistory::-webkit-scrollbar-track {
            background: theme('colors.light-bg');
            border-radius: 4px;
        }
        .dark #messageHistory::-webkit-scrollbar-track {
            background: theme('colors.dark-card');
        }
        #messageHistory::-webkit-scrollbar-thumb {
            background: theme('colors.gray.400');
            border-radius: 4px;
        }
        .dark #messageHistory::-webkit-scrollbar-thumb {
            background: theme('colors.gray.600');
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg transition-colors duration-300">
    <div id="app" class="h-screen flex">
        <!-- Sidebar - Left Panel (Chat List/Navigation) -->
        <aside id="sidebar" class="w-20 md:w-64 bg-white dark:bg-darker-sidebar border-r dark:border-dark-border flex flex-col transition-all duration-300">
            <div class="p-4 text-center border-b dark:border-dark-border">
                <h1 class="text-xl font-bold text-gray-800 dark:text-neon-primary md:block hidden">AdminPlan</h1>
                <h1 class="text-xl font-bold text-gray-800 dark:text-neon-primary md:hidden block">AP</h1>
            </div>
            
            <!-- Navigation -->
            <nav class="flex flex-col flex-grow p-2">
                <a href="#" class="nav-item flex items-center p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-light-bg dark:hover:bg-dark-card transition-colors duration-200 active" data-section="dashboard">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 4h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="md:inline hidden">Chat Dashboard</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-light-bg dark:hover:bg-dark-card transition-colors duration-200" data-section="settings">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="md:inline hidden">Settings</span>
                </a>
            </nav>

            <!-- Dark Mode Toggle and Time -->
            <div class="p-4 border-t dark:border-dark-border text-center">
                <p id="myanmarTime" class="text-sm text-gray-500 dark:text-gray-400 mb-2 md:block hidden">--:--:--</p>
                <button id="darkModeToggle" class="w-full p-2 rounded-full bg-light-bg dark:bg-dark-card hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                    <svg id="sunIcon" class="w-6 h-6 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6 mx-auto text-purple-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 overflow-hidden">
            <div id="dashboard" class="h-full flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-4">
                
                <!-- Chat List Panel -->
                <section id="chatListPanel" class="w-full lg:w-2/5 xl:w-1/3 h-full flex flex-col bg-light-card dark:bg-dark-card rounded-lg shadow-lg overflow-hidden">
                    <div class="p-4 border-b dark:border-dark-border">
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">လက်ခံရရှိထားသော စာများ (Chats)</h2>
                        <input type="text" id="chatListSearch" placeholder="ရှာဖွေရန်..." class="w-full p-2 border rounded-lg bg-light-bg dark:bg-darker-sidebar dark:border-dark-border text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-neon-primary focus:border-neon-primary outline-none" oninput="filterChatList(this.value)">
                    </div>
                    <div id="chatList" class="flex-grow overflow-y-auto divide-y dark:divide-dark-border">
                        <!-- Chat items will be dynamically loaded here -->
                        <p class="text-center text-gray-500 dark:text-gray-400 mt-20">Loading chats...</p>
                    </div>
                </section>

                <!-- Chat Section (Message History & Reply) -->
                <section id="chatSection" class="hidden w-full lg:w-3/5 xl:w-2/3 h-full flex flex-col bg-light-card dark:bg-dark-card rounded-lg shadow-lg">
                    
                    <!-- Chat Header (User Info) -->
                    <div id="chatHeader" class="p-4 border-b dark:border-dark-border flex items-center justify-between">
                        <div class="flex items-center">
                            <span id="chatAvatar" class="w-10 h-10 rounded-full bg-neon-primary flex items-center justify-center text-white font-bold mr-3">U</span>
                            <div>
                                <h3 id="chatUserName" class="text-lg font-semibold text-gray-800 dark:text-white">User Name</h3>
                                <p id="chatPlatform" class="text-sm text-gray-500 dark:text-gray-400">Platform</p>
                            </div>
                        </div>
                        <button id="closeChatButton" class="lg:hidden p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400 transition-colors duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <!-- Search History -->
                    <div class="p-4 border-b dark:border-dark-border">
                        <input type="text" id="chatHistorySearch" placeholder="စာကြောင်းရှာဖွေရန်..." class="w-full p-2 border rounded-lg bg-light-bg dark:bg-darker-sidebar dark:border-dark-border text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-neon-primary focus:border-neon-primary outline-none" oninput="filterChatHistory(this.value)">
                    </div>

                    <!-- Message History Container (ပြင်ဆင်ထားသော Scroll Bar ပါဝင်သည်) -->
                    <div id="messageHistory" class="flex-grow p-4 space-y-3 overflow-y-auto">
                        <!-- Messages go here -->
                        <p class="text-center text-gray-500 dark:text-gray-400 mt-20">Chat စတင်ရန် စာတစ်စောင် ရွေးချယ်ပါ။</p>
                    </div>

                    <!-- Reply Box (အောက်ခြေတွင် ပုံသေထားရှိသည်) -->
                    <div id="replyBox" class="p-4 border-t dark:border-dark-border">
                        <div class="flex items-end space-x-2">
                            <textarea id="replyInput" class="flex-grow resize-none p-3 border rounded-lg bg-light-bg dark:bg-darker-sidebar dark:border-dark-border text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-neon-primary focus:border-neon-primary outline-none max-h-32" rows="1" placeholder="စာပြန်ရန်..."></textarea>
                            <button id="sendReplyButton" class="p-3 rounded-lg bg-neon-primary text-dark-bg hover:bg-neon-primary/80 transition-colors duration-200 shadow-lg shadow-neon-primary/50 disabled:opacity-50" disabled>
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- Placeholder for initial view -->
                <section id="chatPlaceholder" class="w-full lg:w-3/5 xl:w-2/3 h-full flex items-center justify-center bg-light-card dark:bg-dark-card rounded-lg shadow-lg">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        <h2 class="text-xl font-semibold">Chat ရွေးချယ်ရန်</h2>
                        <p>ဘယ်ဘက်ရှိ စာရင်းမှ Chat တစ်ခုကို ရွေးချယ်ပါ</p>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings" class="hidden w-full h-full bg-light-card dark:bg-dark-card rounded-lg shadow-lg p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">ချိန်ညှိချက်များ (Settings)</h2>
                    <div class="space-y-6">
                        <!-- Dark Mode Setting -->
                        <div class="p-4 border rounded-lg dark:border-dark-border dark:bg-darker-sidebar">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">အပြင်အဆင် (Theme)</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-3">အလင်းရောင် (Light) သို့မဟုတ် အမှောင်ရောင် (Dark) ပုံစံကို ရွေးချယ်ပါ။</p>
                            <button id="settingsDarkModeToggle" class="px-4 py-2 rounded-lg text-white font-medium transition-colors duration-200 bg-gray-500 hover:bg-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600">
                                <span>Theme ကိုပြောင်းရန်</span>
                            </button>
                        </div>
                        
                        <!-- Notifications Setting -->
                        <div class="p-4 border rounded-lg dark:border-dark-border dark:bg-darker-sidebar">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">အသံမြည်ခြင်း (Notifications)</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-3">စာအသစ်ဝင်ရောက်ပါက အသံမြည်စေရန် ဖွင့်/ပိတ်ပါ။</p>
                            <label for="notificationToggle" class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" id="notificationToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-neon-primary dark:peer-focus:ring-neon-secondary dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-neon-primary"></div>
                                <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">အသံမြည်ခြင်းကို ဖွင့်ထားသည်</span>
                            </label>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Canvas Provided) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const LLM_API_KEY = typeof __llm_api_key !== 'undefined' ? __llm_api_key : '';
        const MESSAGES_COLLECTION_NAME = 'messages';
        const CHATS_COLLECTION_NAME = 'chats';

        // --- Firebase Initialization ---
        setLogLevel('Debug');
        let app, db, auth, userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('chatList').innerHTML = `<p class="text-center text-red-500 mt-20">Firebase စတင်ရန် မအောင်မြင်ပါ။</p>`;
            }
        } else {
            console.error("Firebase config is missing or empty.");
        }


        // --- State Management ---
        let currentChatId = null;
        let chatListUnsubscribe = null;
        let chatHistoryUnsubscribe = null;

        // --- Utility Functions ---

        // Function to handle exponential backoff for fetch requests
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed for ${url}:`, error);
                    if (i === maxRetries - 1) throw error; // Re-throw if last attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000; // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // Function to create a message bubble
        function createMessageBubble(message) {
            const isSentByAdmin = message.sender === 'admin';
            const bubble = document.createElement('div');
            bubble.classList.add('flex', isSentByAdmin ? 'justify-end' : 'justify-start');

            const content = document.createElement('div');
            content.classList.add(
                'max-w-xs', 'md:max-w-md', 'lg:max-w-lg', 'p-3', 'rounded-xl', 'shadow-md',
                isSentByAdmin
                    ? 'bg-neon-primary text-dark-bg rounded-br-none'
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-tl-none'
            );
            content.innerHTML = `<p>${message.text}</p>`;
            
            // Add timestamp
            const timestamp = document.createElement('p');
            timestamp.classList.add(
                'text-xs', 'mt-1', 
                isSentByAdmin 
                    ? 'text-dark-bg/70 text-right' 
                    : 'text-gray-500 dark:text-gray-400 text-left'
            );
            const date = message.timestamp ? new Date(message.timestamp) : new Date();
            timestamp.textContent = date.toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit', hour12: true });

            content.appendChild(timestamp);
            bubble.appendChild(content);
            return bubble;
        }

        // Function to create a chat list item
        function createChatListItem(chat) {
            const isUnread = chat.unreadCount > 0;
            const item = document.createElement('a');
            item.href = "#";
            item.id = `chat-${chat.id}`;
            item.classList.add(
                'flex', 'items-center', 'p-4', 'hover:bg-light-bg', 'dark:hover:bg-dark-card', 'transition-colors', 'duration-200',
                'cursor-pointer', 'chat-item',
                chat.id === currentChatId ? 'bg-light-bg dark:bg-dark-card' : ''
            );
            item.setAttribute('data-chat-id', chat.id);
            item.setAttribute('data-user-name', chat.userName);
            item.setAttribute('data-platform', chat.platform || 'Unknown');

            const avatar = document.createElement('div');
            avatar.classList.add(
                'w-12', 'h-12', 'rounded-full', 'flex', 'items-center', 'justify-center', 'font-bold', 'text-white', 'mr-4', 'shadow',
                chat.platform === 'facebook' ? 'bg-blue-600' : 'bg-cyan-500' // Different color for platforms
            );
            avatar.textContent = chat.userName ? chat.userName[0].toUpperCase() : 'U';
            item.appendChild(avatar);

            const info = document.createElement('div');
            info.classList.add('flex-grow', 'overflow-hidden');
            
            const header = document.createElement('div');
            header.classList.add('flex', 'justify-between', 'items-center', 'mb-1');
            
            const name = document.createElement('h3');
            name.classList.add('text-md', 'font-semibold', 'text-gray-900', 'dark:text-white', 'truncate');
            name.textContent = chat.userName || 'Unknown User';
            header.appendChild(name);

            if (chat.lastMessageTimestamp) {
                const time = document.createElement('p');
                time.classList.add('text-xs', 'text-gray-500', 'dark:text-gray-400', 'flex-shrink-0');
                const date = new Date(chat.lastMessageTimestamp);
                time.textContent = date.toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' });
                header.appendChild(time);
            }

            const messageText = document.createElement('p');
            messageText.classList.add('text-sm', 'text-gray-600', 'dark:text-gray-400', 'truncate');
            messageText.textContent = chat.lastMessageText || 'No messages yet.';

            info.appendChild(header);
            info.appendChild(messageText);
            item.appendChild(info);

            if (isUnread) {
                const unreadBadge = document.createElement('span');
                unreadBadge.classList.add('ml-3', 'px-2', 'py-0.5', 'text-xs', 'font-bold', 'bg-red-500', 'text-white', 'rounded-full', 'flex-shrink-0');
                unreadBadge.textContent = chat.unreadCount;
                item.appendChild(unreadBadge);
            }

            item.onclick = (e) => {
                e.preventDefault();
                openChat(chat.id, chat.userName, chat.platform);
            };

            return item;
        }

        // --- Authentication & Setup ---

        function handleAuthSuccess(user) {
            userId = user.uid;
            isAuthReady = true;
            console.log("Authentication successful, User ID:", userId);
            // Once auth is ready, start listening to chats
            startChatListListener();
        }

        async function initAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                document.getElementById('chatList').innerHTML = `<p class="text-center text-red-500 mt-20">Authentication မအောင်မြင်ပါ။</p>`;
            }
        }

        // Use onAuthStateChanged to ensure we are fully authenticated before running listeners
        onAuthStateChanged(auth, (user) => {
            if (user) {
                handleAuthSuccess(user);
            } else {
                console.log("No user signed in. Attempting sign-in...");
                initAuth(); // Attempt to sign in if no user is found
            }
        });

        // --- Chat Listeners ---

        function getChatRef(chatId) {
            // Public path for chat data
            return doc(db, `artifacts/${appId}/public/data/${CHATS_COLLECTION_NAME}`, chatId);
        }

        function getMessagesCollectionRef(chatId) {
            // Public path for message data
            return collection(db, `artifacts/${appId}/public/data/${CHATS_COLLECTION_NAME}/${chatId}/${MESSAGES_COLLECTION_NAME}`);
        }

        function startChatListListener() {
            if (!isAuthReady) return;

            if (chatListUnsubscribe) chatListUnsubscribe();

            const chatListContainer = document.getElementById('chatList');
            const collectionRef = collection(db, `artifacts/${appId}/public/data/${CHATS_COLLECTION_NAME}`);
            
            // Note: Not using orderBy to avoid requiring composite indexes in security rules
            const q = query(collectionRef); 

            chatListContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-20">Chat စာရင်းကို စစ်ဆေးနေပါသည်။...</p>`;

            chatListUnsubscribe = onSnapshot(q, (snapshot) => {
                const chats = [];
                snapshot.forEach(doc => {
                    const chatData = doc.data();
                    // Deserialize lastMessageTimestamp if it was serialized as a string (if needed)
                    chats.push({
                        id: doc.id,
                        ...chatData,
                        lastMessageTimestamp: chatData.lastMessageTimestamp // Assuming Firestore Timestamp or simple number
                    });
                });
                
                // Sort the chats by last message timestamp (descending) in memory
                chats.sort((a, b) => (b.lastMessageTimestamp || 0) - (a.lastMessageTimestamp || 0));

                renderChatList(chats);
                filterChatList(document.getElementById('chatListSearch').value);
            }, (error) => {
                console.error("Error listening to chat list:", error);
                chatListContainer.innerHTML = `<p class="text-center text-red-500 mt-20">Chat စာရင်းကို ယူဆောင်ရာတွင် အမှားပေါ်ပေါက်ခဲ့သည်။</p>`;
            });
        }

        function renderChatList(chats) {
            const chatListContainer = document.getElementById('chatList');
            chatListContainer.innerHTML = '';
            if (chats.length === 0) {
                chatListContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-20">လက်ခံရရှိထားသော Chat မရှိသေးပါ။</p>`;
                return;
            }
            chats.forEach(chat => {
                chatListContainer.appendChild(createChatListItem(chat));
            });
        }

        function filterChatList(query) {
            const items = document.querySelectorAll('.chat-item');
            const lowerCaseQuery = query.toLowerCase();
            items.forEach(item => {
                const userName = item.getAttribute('data-user-name').toLowerCase();
                const platform = item.getAttribute('data-platform').toLowerCase();
                if (userName.includes(lowerCaseQuery) || platform.includes(lowerCaseQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // --- Chat History Management ---

        function startChatHistoryListener(chatId) {
            if (!isAuthReady || !chatId) return;

            if (chatHistoryUnsubscribe) chatHistoryUnsubscribe();

            const historyContainer = document.getElementById('messageHistory');
            const messagesRef = getMessagesCollectionRef(chatId);
            
            // Query to fetch messages, limited for performance, ordered by timestamp
            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(50));

            historyContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-20">Loading messages...</p>`;

            chatHistoryUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp // Assuming Firestore Timestamp or simple number
                    });
                });
                
                // Reverse the array to display chronologically (oldest at top)
                messages.reverse();
                renderChatHistory(messages);

                // Scroll to the bottom only on the initial load or a new message from the user
                if (currentChatId === chatId) {
                    historyContainer.scrollTop = historyContainer.scrollHeight;
                }
            }, (error) => {
                console.error("Error listening to chat history:", error);
                historyContainer.innerHTML = `<p class="text-center text-red-500 mt-20">Message များကို ယူဆောင်ရာတွင် အမှားပေါ်ပေါက်ခဲ့သည်။</p>`;
            });
        }

        function renderChatHistory(messages) {
            const historyContainer = document.getElementById('messageHistory');
            historyContainer.innerHTML = '';
            if (messages.length === 0) {
                historyContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-20">ဤ Chat တွင် စာများ မရှိသေးပါ။</p>`;
                return;
            }
            messages.forEach(message => {
                historyContainer.appendChild(createMessageBubble(message));
            });
            // Ensure the scroll bar is at the bottom after rendering new messages
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        function filterChatHistory(query) {
            const historyContainer = document.getElementById('messageHistory');
            const bubbles = historyContainer.querySelectorAll('.flex'); // Select all message bubbles
            const lowerCaseQuery = query.toLowerCase();
            let found = false;

            bubbles.forEach(bubble => {
                const textContent = bubble.querySelector('p:not(.text-xs)').textContent.toLowerCase();
                if (textContent.includes(lowerCaseQuery) || lowerCaseQuery === '') {
                    bubble.style.display = 'flex';
                    found = true;
                } else {
                    bubble.style.display = 'none';
                }
            });
            
            // Show a "No Results" message if nothing is found and the query is not empty
            let noResultsMessage = historyContainer.querySelector('.no-results-message');
            if (!noResultsMessage) {
                noResultsMessage = document.createElement('p');
                noResultsMessage.classList.add('text-center', 'text-gray-500', 'dark:text-gray-400', 'mt-20', 'no-results-message', 'hidden');
                noResultsMessage.textContent = 'ရှာဖွေမှုရလဒ် မရှိပါ။';
                historyContainer.appendChild(noResultsMessage);
            }
            
            if (!found && lowerCaseQuery !== '') {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
            }
        }
        
        // --- Chat Actions ---

        function openChat(chatId, userName, platform) {
            if (currentChatId) {
                const prevItem = document.getElementById(`chat-${currentChatId}`);
                if (prevItem) {
                    prevItem.classList.remove('bg-light-bg', 'dark:bg-dark-card');
                }
            }

            currentChatId = chatId;

            // Highlight new chat item
            const newItem = document.getElementById(`chat-${currentChatId}`);
            if (newItem) {
                newItem.classList.add('bg-light-bg', 'dark:bg-dark-card');
            }

            // Update chat header
            document.getElementById('chatUserName').textContent = userName;
            document.getElementById('chatPlatform').textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
            document.getElementById('chatAvatar').textContent = userName ? userName[0].toUpperCase() : 'U';
            document.getElementById('chatAvatar').classList.remove('bg-blue-600', 'bg-cyan-500');
            document.getElementById('chatAvatar').classList.add(platform === 'facebook' ? 'bg-blue-600' : 'bg-cyan-500');
            
            // Show chat section
            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('chatSection').classList.remove('hidden');

            // Reset reply input and enable send button
            const replyInput = document.getElementById('replyInput');
            const sendButton = document.getElementById('sendReplyButton');
            replyInput.value = '';
            sendButton.disabled = true;

            // Start message listener
            startChatHistoryListener(chatId);
            
            // Mark as read and update the server (which will update the unread count in Firestore)
            markChatAsRead(chatId);
            // Re-render chat list to update the unread badge immediately (if needed, though onSnapshot handles it)
        }

        // Auto-adjust reply input height
        document.getElementById('replyInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            document.getElementById('sendReplyButton').disabled = this.value.trim() === '';
        });
        
        // Handle send reply
        document.getElementById('sendReplyButton').addEventListener('click', async () => {
            const input = document.getElementById('replyInput');
            const text = input.value.trim();

            if (text && currentChatId) {
                const sendButton = document.getElementById('sendReplyButton');
                sendButton.disabled = true;
                
                // Optimistically add message to history
                const message = {
                    sender: 'admin',
                    text: text,
                    timestamp: Date.now()
                };
                document.getElementById('messageHistory').appendChild(createMessageBubble(message));
                document.getElementById('messageHistory').scrollTop = document.getElementById('messageHistory').scrollHeight;

                input.value = '';
                input.style.height = 'auto'; // Reset height

                try {
                    // 1. Save the message to Firestore
                    const messagesRef = getMessagesCollectionRef(currentChatId);
                    await addDoc(messagesRef, {
                        text: text,
                        sender: 'admin',
                        timestamp: Date.now()
                    });

                    // 2. Update the chat document (last message info)
                    const chatRef = getChatRef(currentChatId);
                    await updateDoc(chatRef, {
                        lastMessageText: text,
                        lastMessageTimestamp: Date.now(),
                        // Don't change unread count, as admin sent it
                    });

                    // 3. Send the message to the external service via server.js (using a custom fetch call to mimic a socket/server action)
                    const serverUrl = '/api/reply'; // Assuming server.js exposes a reply API
                    const response = await fetchWithRetry(serverUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Basic Auth header for server.js
                            'Authorization': 'Basic ' + btoa('admin:password')
                        },
                        body: JSON.stringify({ chatId: currentChatId, text: text })
                    });
                    
                    if (!response.ok) {
                         throw new Error(`Server failed to send message: ${response.statusText}`);
                    }
                    console.log("Message successfully sent to external platform.");


                } catch (error) {
                    console.error("Error sending message or updating database:", error);
                    // Add an error indicator to the message bubble if needed
                    const historyContainer = document.getElementById('messageHistory');
                    const errorMessage = document.createElement('div');
                    errorMessage.classList.add('text-center', 'text-sm', 'text-red-500');
                    errorMessage.textContent = `Error: စာပို့ရာတွင် အမှားပေါ်ပေါက်ခဲ့သည်။`;
                    historyContainer.appendChild(errorMessage);
                } finally {
                    sendButton.disabled = false;
                }
            }
        });
        
        // --- Utility to Mark Chat as Read ---
        async function markChatAsRead(chatId) {
            if (!isAuthReady || !chatId) return;
            try {
                const chatRef = getChatRef(chatId);
                const chatDoc = await getDoc(chatRef);
                if (chatDoc.exists() && chatDoc.data().unreadCount > 0) {
                    await updateDoc(chatRef, { unreadCount: 0 });
                    console.log(`Chat ${chatId} marked as read.`);
                    // Manually update the badge in the UI if onSnapshot is too slow
                    const item = document.getElementById(`chat-${chatId}`);
                    if (item) {
                        const badge = item.querySelector('.bg-red-500');
                        if (badge) badge.remove();
                    }
                }
            } catch (error) {
                console.error("Error marking chat as read:", error);
            }
        }
        
        // --- UI Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('#dashboard section, #app main section').forEach(section => {
                section.classList.add('hidden');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-opacity-10', 'text-neon-primary', 'border-r-4', 'border-neon-primary');
            });
            
            document.querySelector(`.nav-item[data-section="${sectionId}"]`).classList.add('active', 'bg-opacity-10', 'text-neon-primary', 'border-r-4', 'border-neon-primary');
            
            if (sectionId === 'dashboard') {
                document.getElementById('dashboard').classList.remove('hidden');
                // Ensure chat sections are initially correct
                if (currentChatId) {
                    document.getElementById('chatSection').classList.remove('hidden');
                    document.getElementById('chatPlaceholder').classList.add('hidden');
                } else {
                    document.getElementById('chatSection').classList.add('hidden');
                    document.getElementById('chatPlaceholder').classList.remove('hidden');
                }
                document.getElementById('chatListPanel').classList.remove('hidden');
            } else {
                document.getElementById(sectionId).classList.remove('hidden');
            }
        }
        
        // Dark Mode Logic
        function loadDarkModePreference() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
                document.getElementById('moonIcon').classList.remove('hidden');
                document.getElementById('sunIcon').classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('moonIcon').classList.toggle('hidden', !isDark);
            document.getElementById('sunIcon').classList.toggle('hidden', isDark);
        }

        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        document.getElementById('settingsDarkModeToggle').addEventListener('click', toggleDarkMode);

        // Myanmar Time Update
        function updateMyanmarTime() {
            const timeElement = document.getElementById('myanmarTime');
            if (timeElement) {
                const now = new Date();
                const myanmarTime = now.toLocaleTimeString('my-MM', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true,
                    timeZone: 'Asia/Yangon'
                });
                timeElement.textContent = myanmarTime;
            }
        }
        
        // Close Chat Button for Mobile View
        document.getElementById('closeChatButton').addEventListener('click', () => {
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('chatPlaceholder').classList.remove('hidden');
            currentChatId = null; // Deselect chat
            if (chatHistoryUnsubscribe) {
                chatHistoryUnsubscribe();
                chatHistoryUnsubscribe = null;
            }
            // Clear current chat highlight
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('bg-light-bg', 'dark:bg-dark-card');
            });
        });
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDarkModePreference(); 
            updateMyanmarTime(); 
            setInterval(updateMyanmarTime, 1000); // Update time every second
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(item.getAttribute('data-section'));
                });
            });
            showSection('dashboard');
        });
    </script>
</body>
</html>
