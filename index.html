<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Chat Dashboard</title>
  <!-- CDN libs -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- socket.io client will be served from your server at /socket.io/socket.io.js -->
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--white:#e6eef8}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:linear-gradient(180deg,#071029 0%, #071b2b 100%);color:var(--white);height:100vh;display:flex;align-items:stretch}
    .container{display:grid;grid-template-columns:320px 1fr;gap:18px;padding:18px;width:100%}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .left{display:flex;flex-direction:column;height:calc(100vh - 36px);}
    .search{margin-bottom:8px}
    .chat-list{overflow:auto;flex:1;padding-right:6px}
    .chat-item{padding:10px;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:10px;border:1px solid rgba(255,255,255,0.03)}
    .chat-item:hover{background:rgba(255,255,255,0.02)}
    .chat-item.active{background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(59,130,246,0.06));border-color:rgba(96,165,250,0.14)}
    .chat-meta{flex:1}
    .chat-name{font-weight:600}
    .chat-last{font-size:13px;color:var(--muted)}

    .right{display:flex;flex-direction:column;height:calc(100vh - 36px)}
    .header{display:flex;align-items:center;justify-content:space-between;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .messages{flex:1;overflow:auto;padding:12px}
    .msg{max-width:70%;padding:10px;border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,0.02)}
    .msg.admin{margin-left:auto;background:linear-gradient(90deg, rgba(96,165,250,0.14), rgba(59,130,246,0.06));}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;gap:8px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.03)}
    textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);min-height:56px;resize:vertical}
    button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#002833;font-weight:600;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:999px;font-size:12px}
    .topbar{display:flex;gap:8px;align-items:center}
    .platform{font-size:12px;padding:6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="panel left">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div>
          <div style="font-size:18px;font-weight:700">Admin Chats</div>
          <div class="small">Connected to server at <span id="server-url"></span></div>
        </div>
        <div style="text-align:right">
          <div id="auth-status" class="badge">Not authenticated</div>
        </div>
      </div>

      <div class="search">
        <input id="filter-input" placeholder="Filter by name or platform" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)" />
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="platform-filter" style="padding:8px;border-radius:8px;background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.04)">
          <option value="">All platforms</option>
          <option value="telegram">Telegram</option>
          <option value="facebook">Facebook</option>
        </select>
        <button id="refresh-btn">Refresh</button>
      </div>

      <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="panel right">
      <div class="header">
        <div>
          <div id="selected-name" style="font-size:16px;font-weight:700">Select a chat</div>
          <div class="small" id="selected-info">No chat selected</div>
        </div>
        <div class="topbar">
          <div class="small">Server time: <span id="server-time">--</span></div>
          <div style="width:12px"></div>
          <div id="connection-status" class="badge">Disconnected</div>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <textarea id="reply-text" placeholder="Type your reply here..."></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="send-btn">Send</button>
          <button id="clear-btn" style="background:rgba(255,255,255,0.04);color:var(--white);font-weight:600">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Basic configuration
    const SERVER_ORIGIN = location.origin; // adjust if using a different origin
    document.getElementById('server-url').textContent = SERVER_ORIGIN;

    // --- Simple Basic Auth prompt (will be reused for fetch/axios) ---
    let AUTH = null; // { username, password, header }
    function askForCredentials() {
      const u = prompt('Admin username', 'admin');
      if (u === null) return false;
      const p = prompt('Admin password', 'password');
      if (p === null) return false;
      AUTH = { username: u, password: p, header: 'Basic ' + btoa(u + ':' + p) };
      document.getElementById('auth-status').textContent = `Auth: ${u}`;
      return true;
    }

    // Try to get credentials on load
    if (!askForCredentials()) {
      alert('You must provide admin credentials to use the dashboard.');
    }

    // Axios defaults
    axios.defaults.baseURL = SERVER_ORIGIN;
    axios.interceptors.request.use(cfg => {
      if (AUTH) cfg.headers['Authorization'] = AUTH.header;
      return cfg;
    });

    // Socket.io connection
    const socket = io();

    const chatListEl = document.getElementById('chat-list');
    const messagesEl = document.getElementById('messages');
    const selectedNameEl = document.getElementById('selected-name');
    const selectedInfoEl = document.getElementById('selected-info');
    const serverTimeEl = document.getElementById('server-time');
    const connectionStatusEl = document.getElementById('connection-status');

    let CHATS = [];
    let SELECTED_CHAT = null;

    // Update connection status
    socket.on('connect', () => {
      connectionStatusEl.textContent = 'Connected';
      connectionStatusEl.style.background = 'rgba(255,255,255,0.04)';
    });
    socket.on('disconnect', () => {
      connectionStatusEl.textContent = 'Disconnected';
    });

    // Incoming real-time messages
    socket.on('new_message', (data) => {
      // If the chat exists in our list, update lastMessage; otherwise push
      const idx = CHATS.findIndex(c => String(c.telegramId) === String(data.chatId));
      const chatItem = {
        telegramId: String(data.chatId),
        username: data.user.username || (`User ${String(data.chatId).slice(0,6)}`),
        lastMessageText: data.message.text || 'Media',
        lastMessageTime: data.message.timestamp || new Date().toISOString(),
        platform: data.platform || 'telegram'
      };

      if (idx >= 0) {
        CHATS[idx] = { ...CHATS[idx], ...chatItem };
      } else {
        CHATS.unshift(chatItem);
      }
      renderChatList();

      // If currently selected chat, push the message to message view
      if (SELECTED_CHAT && String(SELECTED_CHAT.telegramId) === String(data.chatId)) {
        appendMessageToView(data.message, 'user');
      }
    });

    socket.on('message_sent', (data) => {
      // When server confirms message saved
      if (SELECTED_CHAT && String(SELECTED_CHAT.telegramId) === String(data.chatId)) {
        appendMessageToView(data.message, 'admin');
      }
      // Update chat list last message
      const idx = CHATS.findIndex(c => String(c.telegramId) === String(data.chatId));
      if (idx >= 0) {
        CHATS[idx].lastMessageText = data.message.text || 'Media';
        CHATS[idx].lastMessageTime = data.message.timestamp || new Date().toISOString();
        renderChatList();
      }
    });

    // Helper: render chat list
    function renderChatList() {
      const filter = document.getElementById('filter-input').value.toLowerCase();
      const platformFilter = document.getElementById('platform-filter').value;
      chatListEl.innerHTML = '';
      CHATS.forEach(c => {
        if (platformFilter && c.platform !== platformFilter) return;
        if (filter && !(c.username || '').toLowerCase().includes(filter) && !(c.lastMessageText||'').toLowerCase().includes(filter)) return;
        const el = document.createElement('div');
        el.className = 'chat-item' + (SELECTED_CHAT && String(SELECTED_CHAT.telegramId) === String(c.telegramId) ? ' active' : '');
        el.innerHTML = `
          <div style="flex:1">
            <div class="chat-name">${escapeHtml(c.username || c.telegramId)}</div>
            <div class="chat-last">${escapeHtml(c.lastMessageText || '')}</div>
          </div>
          <div style="text-align:right">
            <div class="small">${new Date(c.lastMessageTime||Date.now()).toLocaleString()}</div>
            <div class="small">${escapeHtml(c.platform)}</div>
          </div>
        `;
        el.onclick = () => selectChat(c);
        chatListEl.appendChild(el);
      });
    }

    // Helpers
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];}); }

    // Load chats from server
    async function loadChats() {
      try {
        const platform = document.getElementById('platform-filter').value;
        const url = platform ? `/api/chats?platform=${encodeURIComponent(platform)}` : '/api/chats';
        const res = await axios.get(url);
        CHATS = (res.data || []).map(c => ({ ...c, telegramId: c.telegramId || c.id }));
        renderChatList();
      } catch (err) {
        console.error('Failed to load chats', err);
        alert('Failed to load chats: ' + (err.response?.data?.error || err.message));
      }
    }

    // Select a chat
    async function selectChat(chat) {
      SELECTED_CHAT = chat;
      selectedNameEl.textContent = chat.username || chat.telegramId;
      selectedInfoEl.textContent = `${chat.platform || 'telegram'} • ${chat.lastMessageText || ''}`;
      renderChatList();
      await loadHistory(String(chat.telegramId));
    }

    // Load history
    async function loadHistory(chatId) {
      messagesEl.innerHTML = '';
      try {
        const res = await axios.get(`/api/chats/${encodeURIComponent(chatId)}/history?limit=200`);
        const msgs = res.data || [];
        msgs.forEach(m => appendMessageToView(m, m.sender));
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (err) {
        console.error('Failed to load history', err);
        alert('Failed to load history: ' + (err.response?.data?.error || err.message));
      }
    }

    // Append single message
    function appendMessageToView(msg, senderOverride) {
      const s = senderOverride || msg.sender || 'user';
      const div = document.createElement('div');
      div.className = 'msg ' + (s === 'admin' ? 'admin' : 'user');
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${s === 'admin' ? 'Admin' : 'User'} • ${new Date(msg.timestamp || Date.now()).toLocaleString()}`;
      const body = document.createElement('div');
      body.innerHTML = msg.text ? escapeHtml(msg.text).replace(/\n/g,'<br/>') : (msg.filename ? `<i>${escapeHtml(msg.filename)}</i>` : '<i>Media</i>');
      div.appendChild(meta);
      div.appendChild(body);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Send reply using socket.io admin_reply event
    document.getElementById('send-btn').addEventListener('click', sendReply);
    document.getElementById('clear-btn').addEventListener('click', () => { document.getElementById('reply-text').value = ''; });

    async function sendReply() {
      if (!SELECTED_CHAT) return alert('Select a chat first');
      const text = document.getElementById('reply-text').value.trim();
      if (!text) return alert('Type a message');

      const payload = { chatId: String(SELECTED_CHAT.telegramId), text };
      socket.emit('admin_reply', payload, (res) => {
        if (res && res.success) {
          // appended on message_sent event
          document.getElementById('reply-text').value = '';
        } else {
          alert('Failed to send: ' + (res?.error || 'unknown'));
        }
      });
    }

    // UI actions
    document.getElementById('refresh-btn').addEventListener('click', loadChats);
    document.getElementById('platform-filter').addEventListener('change', loadChats);
    document.getElementById('filter-input').addEventListener('input', renderChatList);

    // Periodic server time updater (calls an endpoint to get server time if you have one)
    setInterval(() => {
      serverTimeEl.textContent = new Date().toLocaleString();
    }, 1000);

    // Initial load
    (async () => {
      await loadChats();
    })();

    // Basic keyboard shortcut: Enter to send when textarea focused + Ctrl/Cmd+Enter to newline
    document.getElementById('reply-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendReply();
      }
    });
  </script>
</body>
</html>
