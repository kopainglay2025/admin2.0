<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Platform Chat Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Lucide Icons -->
    <script type="module">
        import { createIcons, MessageSquare, Users, Send, Trash2, Facebook, MessageSquareText, Radio, LayoutDashboard, Settings, SendToBack, XCircle } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        createIcons({ icons: { MessageSquare, Users, Send, Trash2, Facebook, MessageSquareText, Radio, LayoutDashboard, Settings, SendToBack, XCircle } });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .platform-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: 600;
        }
        .telegram { background-color: #0088cc1a; color: #0088cc; }
        .facebook { background-color: #1877f21a; color: #1877f2; }
        .message-container { max-height: calc(100vh - 200px); overflow-y: auto; scroll-behavior: smooth; }
        .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; }
        .user-message { background-color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; }
        .admin-message { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .active-menu { background-color: #4338ca !important; color: white !important; }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Authentication Modal (Custom Prompt replacement) -->
    <div id="auth-modal" class="modal-backdrop">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Login Required</h2>
            <p class="text-gray-600 mb-6">Please enter the administrator credentials to access the dashboard.</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="modal-username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="modal-username" name="username" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="modal-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="modal-password" name="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">
                    Access Dashboard
                </button>
                <p id="modal-error-message" class="text-sm text-red-600 mt-2 hidden flex items-center">
                    <i data-lucide="x-circle" class="w-4 h-4 mr-1"></i>
                    <span>Authentication failed.</span>
                </p>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="flex h-screen overflow-hidden hidden">
        
        <!-- Sidebar Navigation (Left Panel) -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col transition-all duration-300 flex-shrink-0">
            <!-- Logo/Title -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-indigo-400">Admin Panel</h2>
            </div>
            
            <!-- Menu Items -->
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <a href="#" data-view="dashboard" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150 active-menu">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </a>
                <a href="#" data-view="user" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> User
                </a>
                
                <div class="pt-4 border-t border-gray-700 mt-4">
                    <p class="text-xs uppercase tracking-wider text-gray-500 mb-2 px-3">Chats</p>
                    <a href="#" data-view="tg-chats" data-platform="telegram" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150">
                        <i data-lucide="message-square" class="w-5 h-5 mr-3"></i> TG Chats
                    </a>
                    <a href="#" data-view="fb-chats" data-platform="facebook" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150">
                        <i data-lucide="facebook" class="w-5 h-5 mr-3"></i> FB Chats
                    </a>
                </div>
                
                <a href="#" data-view="tg-broadcast" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150">
                    <i data-lucide="send-to-back" class="w-5 h-5 mr-3"></i> TG Broadcast
                </a>
                <a href="#" data-view="settings" class="nav-item p-3 flex items-center rounded-lg hover:bg-gray-700 transition duration-150">
                    <i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings
                </a>
            </nav>
            
            <!-- Footer Status -->
            <div class="p-4 border-t border-gray-700 text-xs text-gray-400 flex flex-col space-y-1">
                <span class="flex items-center">
                    <i data-lucide="radio" class="w-4 h-4 mr-1 text-green-500 animate-pulse"></i>
                    <span id="socket-status">Connecting...</span>
                </span>
                <span id="auth-info" class="truncate"></span>
            </div>
        </aside>

        <!-- Main Content Area (Right Panel) -->
        <main class="flex-grow flex flex-col bg-gray-50 overflow-hidden">
            <header class="bg-white shadow p-4 flex items-center justify-between z-10 flex-shrink-0 h-[64px]">
                <h1 id="main-title" class="text-2xl font-bold text-gray-800">
                    Dashboard
                </h1>
            </header>
            
            <!-- View Content Container -->
            <div id="view-content-container" class="flex-grow overflow-hidden">
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="p-8 h-full overflow-y-auto">
                    <div class="p-6 bg-white rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Dashboard Overview</h2>
                        <p class="text-gray-600">Welcome to the Multi-Platform Admin Dashboard! Use the menu on the left to navigate chats and system settings.</p>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="p-4 bg-indigo-100 rounded-lg shadow-md">
                                <p class="text-sm text-indigo-600">Total Chats</p>
                                <p class="text-3xl font-bold text-indigo-800" id="stat-total-chats">...</p>
                            </div>
                            <div class="p-4 bg-blue-100 rounded-lg shadow-md">
                                <p class="text-sm text-blue-600">TG Chats</p>
                                <p class="text-3xl font-bold text-blue-800" id="stat-tg-chats">...</p>
                            </div>
                            <div class="p-4 bg-pink-100 rounded-lg shadow-md">
                                <p class="text-sm text-pink-600">FB Chats</p>
                                <p class="text-3xl font-bold text-pink-800" id="stat-fb-chats">...</p>
                            </div>
                            <div class="p-4 bg-green-100 rounded-lg shadow-md">
                                <p class="text-sm text-green-600">System Users</p>
                                <p class="text-3xl font-bold text-green-800" id="stat-system-users">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User View (System Users Management) -->
                <div id="view-user" class="p-6 hidden h-full overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <!-- User Creation Form -->
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Add New System User</h2>
                            <form id="add-user-form" class="space-y-4 sm:flex sm:space-y-0 sm:space-x-4">
                                <input type="text" id="new-user-name" required placeholder="User Name" class="p-3 border border-gray-300 rounded-lg w-full sm:w-1/3">
                                <select id="new-user-role" class="p-3 border border-gray-300 rounded-lg w-full sm:w-1/3">
                                    <option>Viewer</option>
                                    <option>Agent</option>
                                    <option>Admin</option>
                                </select>
                                <select id="new-user-status" class="p-3 border border-gray-300 rounded-lg w-full sm:w-1/4">
                                    <option>Active</option>
                                    <option>Inactive</option>
                                </select>
                                <button type="submit" class="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition duration-150 w-full sm:w-auto flex-shrink-0">
                                    Add User
                                </button>
                            </form>
                            <p id="user-form-message" class="mt-3 text-sm hidden"></p>
                        </div>

                        <!-- User List Table -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current System Users</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat View (Used for both TG and FB chats) -->
                <div id="view-chats" class="h-full flex flex-row hidden">
                    <!-- Chat List (Left Panel - Dynamic for TG/FB) -->
                    <div id="chat-list-panel" class="w-full sm:w-1/3 border-r border-gray-200 bg-white flex flex-col flex-shrink-0">
                        <div id="chat-list" class="flex-grow overflow-y-auto">
                            <!-- Chat items will be injected here -->
                            <div class="p-4 text-center text-gray-500">Loading chats...</div>
                        </div>
                    </div>

                    <!-- Chat Window (Right Panel - Shared) -->
                    <div id="chat-window" class="flex-grow bg-gray-50 flex flex-col hidden sm:flex">
                        <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-sm flex items-center justify-between flex-shrink-0 h-[64px]">
                            <span class="text-lg font-semibold text-gray-700">Select a chat to start responding</span>
                        </div>

                        <!-- Messages Display -->
                        <div id="messages-display" class="message-container flex-grow p-4 flex flex-col space-y-2">
                            <!-- Messages will be injected here -->
                        </div>

                        <!-- Reply Input -->
                        <div id="reply-form-container" class="p-4 border-t border-gray-200 bg-white flex-shrink-0 hidden">
                            <form id="reply-form" class="flex items-center space-x-3">
                                <input type="text" id="reply-input" class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Type your reply...">
                                <button type="submit" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg flex items-center">
                                    <i data-lucide="send" class="w-5 h-5 text-white"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- TG Broadcast View -->
                <div id="view-tg-broadcast" class="p-8 hidden h-full overflow-y-auto">
                    <div class="max-w-xl mx-auto p-6 bg-white rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Telegram Broadcast Message</h2>
                        <p class="text-gray-600 mb-4">Send a message to all connected Telegram users.</p>
                        <form id="broadcast-form" class="space-y-4">
                            <textarea id="broadcast-input" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Type your broadcast message here..."></textarea>
                            <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 w-full flex items-center justify-center">
                                <i data-lucide="send" class="w-5 h-5 mr-2"></i> Send Broadcast
                            </button>
                        </form>
                        <p id="broadcast-message" class="mt-3 text-sm hidden"></p>
                        <p class="mt-6 text-sm text-yellow-600 p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                            Note: The broadcast feature requires a dedicated endpoint on the Node.js server to fetch all user IDs and send messages, which is currently not implemented in the backend code provided. This form is a client-side placeholder.
                        </p>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="p-8 hidden h-full overflow-y-auto">
                    <div class="p-6 bg-white rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Application Settings</h2>
                        <p class="text-gray-600">Configuration options like API keys, notification preferences, or logging levels will go here.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Initialization and Logic -->
    <script>
        // --- Global State ---
        let ADMIN_CREDENTIALS = null;
        let AUTH_HEADER = null;
        let SELECTED_CHAT = null;
        let CHAT_LIST = [];
        let USER_LIST = [];
        let CURRENT_VIEW = 'dashboard';
        let CHAT_PLATFORM_FILTER = null;
        const SOCKET = io(); // Connect to the server's Socket.io endpoint

        // --- Configuration ---
        const API_BASE = window.location.origin;

        // --- Utility Functions ---

        /**
         * Sets the basic auth header globally.
         */
        function setBasicAuth(username, password) {
            const token = btoa(`${username}:${password}`);
            AUTH_HEADER = `Basic ${token}`;
            ADMIN_CREDENTIALS = { username, password };
        }

        /**
         * Custom Alert replacement for iframe compatibility.
         * Shows a message and hides the app container (simulating failure).
         */
        function customAlert(message) {
            document.getElementById('modal-error-message').querySelector('span').textContent = message;
            document.getElementById('modal-error-message').classList.remove('hidden');
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        /**
         * Fetches data with basic auth headers and error handling.
         */
        async function fetchData(url, options = {}) {
            if (!AUTH_HEADER) {
                // Should not happen if init() ran, but safe check
                customAlert("Authentication headers missing. Please log in.");
                throw new Error("Authentication failed or headers missing.");
            }

            const defaultOptions = {
                headers: {
                    'Authorization': AUTH_HEADER,
                    'Content-Type': 'application/json'
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                customAlert('Authentication failed. Please refresh and re-authenticate.');
                return;
            }
            if (!response.ok) {
                let errorText = await response.text();
                // Try to parse JSON if the server returned it
                try {
                    const errorJson = JSON.parse(errorText);
                    // Use the 'error' field if available, otherwise the whole JSON string
                    errorText = errorJson.error || JSON.stringify(errorJson); 
                } catch (e) {
                    // Not JSON, use plain text
                }
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }
            if (response.status === 204) return null;
            return response.json();
        }

        /**
         * Scrolls the messages display to the bottom.
         */
        function scrollToBottom() {
            const display = document.getElementById('messages-display');
            display.scrollTop = display.scrollHeight;
        }
        
        // --- View Switching ---

        /**
         * Switches the main content view.
         * @param {string} viewName - The ID suffix of the view (e.g., 'dashboard', 'user', 'tg-chats').
         * @param {string|null} platformFilter - 'telegram', 'facebook', or null.
         */
        function switchView(viewName, platformFilter = null) {
            CURRENT_VIEW = viewName;
            CHAT_PLATFORM_FILTER = platformFilter;
            
            // 1. Update Active Menu Item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-menu');
            });
            const activeItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeItem) {
                activeItem.classList.add('active-menu');
            }

            // 2. Update Main Title
            const titleMap = {
                'dashboard': 'Dashboard',
                'user': 'System Users',
                'tg-chats': 'Telegram Chats',
                'fb-chats': 'Facebook Chats',
                'tg-broadcast': 'TG Broadcast',
                'settings': 'Settings',
            };
            document.getElementById('main-title').textContent = titleMap[viewName] || 'Admin Dashboard';

            // 3. Hide all views and show the relevant one(s)
            document.querySelectorAll('#view-content-container > div').forEach(view => {
                view.classList.add('hidden');
            });

            if (viewName === 'tg-chats' || viewName === 'fb-chats') {
                document.getElementById('view-chats').classList.remove('hidden');
                SELECTED_CHAT = null;
                document.getElementById('chat-window').classList.add('hidden');
                document.getElementById('reply-form-container').classList.add('hidden');
                fetchAndRenderChatList(CHAT_PLATFORM_FILTER);
            } else if (viewName === 'user') {
                document.getElementById('view-user').classList.remove('hidden');
                fetchAndRenderUserList();
            } else {
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
            }
        }

        // --- Core Functions: Chats ---

        /**
         * Fetches and renders the list of chats, optionally filtered by platform.
         * Includes improved error handling for the Firestore index issue.
         * @param {string} platform - 'telegram', 'facebook', or '' for all.
         */
        async function fetchAndRenderChatList(platform) {
            const listElement = document.getElementById('chat-list');
            listElement.innerHTML = '<div class="p-4 text-center text-indigo-500">Loading chats...</div>';
            
            try {
                const url = `${API_BASE}/api/chats${platform ? `?platform=${platform}` : ''}`;
                const chats = await fetchData(url);
                CHAT_LIST = chats || [];
                renderChatList();
            } catch (error) {
                console.error("Failed to fetch chat list:", error);
                
                let displayMessage = error.message;

                // Check for the specific Firestore Index Error
                if (displayMessage.includes('FAILED_PRECONDITION') && displayMessage.includes('requires an index')) {
                    displayMessage = `
                        <p class="font-bold mb-1">Firestore Index Missing</p>
                        <p class="text-sm">The server's database query failed because a composite index is missing.</p>
                        <p class="text-sm mt-1">
                            Please check your Node.js console log for the index creation link and create it in your Firebase Console.
                        </p>
                    `;
                } else if (displayMessage.includes('API Error: 500')) {
                    displayMessage = "Server Error (500). Please check the server logs for the full error details.";
                }

                listElement.innerHTML = `
                    <div class="p-4 text-center text-red-700 font-semibold border border-red-300 bg-red-100 rounded-lg shadow-inner">
                        <p class="text-lg mb-2">&#9888; Database Query Failed &#9888;</p>
                        ${displayMessage}
                    </div>
                `;
            }
        }

        /**
         * Renders the chat list UI.
         */
        function renderChatList() {
            const listElement = document.getElementById('chat-list');
            listElement.innerHTML = ''; // Clear previous list

            if (CHAT_LIST.length === 0) {
                listElement.innerHTML = `<div class="p-4 text-center text-gray-500">No active ${CHAT_PLATFORM_FILTER || ''} chats found.</div>`;
                return;
            }

            CHAT_LIST.forEach(chat => {
                const isActive = SELECTED_CHAT && SELECTED_CHAT.telegramId === chat.telegramId;
                const platformClass = chat.platform || 'telegram';
                const icon = platformClass === 'facebook' ? 'facebook' : 'message-square';
                const element = document.createElement('div');
                element.className = `p-3 border-b cursor-pointer transition duration-150 ${isActive ? 'bg-indigo-100 border-indigo-300' : 'hover:bg-gray-50'}`;
                element.setAttribute('data-chat-id', chat.telegramId);

                const timeStr = chat.lastMessageTime ? new Date(chat.lastMessageTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';

                element.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i data-lucide="${icon}" class="w-5 h-5 mr-3 text-gray-500"></i>
                            <span class="font-semibold text-gray-800 truncate">${chat.username || chat.telegramId}</span>
                        </div>
                        <span class="platform-tag ${platformClass}">${platformClass.toUpperCase()}</span>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <p class="text-sm text-gray-600 truncate mr-4">${chat.lastMessageText || 'No text'}</p>
                        <small class="text-xs text-gray-400 flex-shrink-0">${timeStr}</small>
                    </div>
                `;

                // Add event listener to select the chat
                element.addEventListener('click', () => selectChat(chat));
                listElement.appendChild(element);
            });
            
            // Re-render Lucide icons for the newly created chat list elements
            if(typeof createIcons !== 'undefined') {
                 createIcons({ 
                    icons: { MessageSquare, Users, Send, Trash2, Facebook, MessageSquareText, Radio, LayoutDashboard, Settings, SendToBack }, 
                    container: listElement 
                });
            }
        }
        
        /**
         * Selects a chat, updates the UI, and fetches history.
         * @param {object} chat
         */
        async function selectChat(chat) {
            SELECTED_CHAT = chat;
            
            // 1. Update UI for selection
            document.querySelectorAll('#chat-list > div').forEach(el => {
                el.classList.remove('bg-indigo-100', 'border-indigo-300');
            });
            const selectedElement = document.querySelector(`[data-chat-id="${chat.telegramId}"]`);
            if (selectedElement) {
                selectedElement.classList.add('bg-indigo-100', 'border-indigo-300');
            }

            // 2. Update Chat Window header
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-header').innerHTML = `
                <span class="text-xl font-bold text-gray-800">${chat.username || chat.telegramId}</span>
                <span class="platform-tag ${chat.platform}">${chat.platform.toUpperCase()}</span>
            `;
            document.getElementById('reply-form-container').classList.remove('hidden');
            
            // 3. Fetch History
            await fetchAndRenderChatHistory(chat.telegramId);
        }

        /**
         * Fetches and renders the chat message history.
         * @param {string} chatId
         */
        async function fetchAndRenderChatHistory(chatId) {
            const display = document.getElementById('messages-display');
            display.innerHTML = '<div class="p-4 text-center text-indigo-500">Loading history...</div>';
            try {
                const history = await fetchData(`${API_BASE}/api/chats/${chatId}/history`);
                renderMessages(history);
            } catch (error) {
                console.error("Failed to fetch chat history:", error);
                display.innerHTML = `<div class="p-4 text-center text-red-500">Error loading history: ${error.message}</div>`;
            }
        }

        /**
         * Renders an array of messages into the display.
         * @param {Array<object>} messages
         */
        function renderMessages(messages) {
            const display = document.getElementById('messages-display');
            display.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                display.innerHTML = '<div class="p-4 text-center text-gray-500">Start a conversation.</div>';
                return;
            }

            messages.forEach(msg => {
                const isUser = msg.sender === 'user';
                const dateObj = new Date(msg.timestamp);
                const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;

                let content = '';

                if (msg.mediaPath) {
                    // For media, just show the filename and an indicator
                    content = `
                        <div class="message-bubble ${isUser ? 'user-message' : 'admin-message'} flex flex-col items-start">
                            <span class="text-sm font-semibold">${msg.filename || 'Media file'}</span>
                            <span class="text-xs italic ${isUser ? 'text-gray-600' : 'text-white/80'}">${msg.text || 'No caption'} (File ID: ${msg.mediaPath.substring(0, 10)}...)</span>
                            <small class="text-xs mt-1 self-end ${isUser ? 'text-gray-500' : 'text-white/70'}">${timeStr}</small>
                        </div>
                    `;
                } else if (msg.text) {
                    content = `
                        <div class="message-bubble ${isUser ? 'user-message' : 'admin-message'}">
                            <p class="text-sm break-words">${msg.text}</p>
                            <small class="text-xs mt-1 block text-right ${isUser ? 'text-gray-500' : 'text-white/70'}">${timeStr}</small>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = content;
                display.appendChild(messageDiv);
            });

            scrollToBottom();
        }

        // --- Core Functions: Users ---

        /**
         * Fetches and renders the list of system users.
         */
        async function fetchAndRenderUserList() {
            try {
                const users = await fetchData(`${API_BASE}/api/users`);
                USER_LIST = users || [];
                renderUserList();
            } catch (error) {
                console.error("Failed to fetch user list:", error);
                document.getElementById('user-list-body').innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading users: ${error.message}</td></tr>`;
            }
        }
        
        /**
         * Renders the system user list table.
         */
        function renderUserList() {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = '';

            if (USER_LIST.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No system users found.</td></tr>`;
                return;
            }

            USER_LIST.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs">${user.id || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 transition duration-150" data-user-id="${user.id}">
                            <i data-lucide="trash-2" class="w-5 h-5 inline-block"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                // Add delete listener
                const deleteButton = row.querySelector(`[data-user-id="${user.id}"]`);
                if (deleteButton) {
                    deleteButton.addEventListener('click', () => {
                        // Custom confirmation logic
                        // Using window.confirm() here as a temporary measure since custom modal logic is complex
                        if (window.confirm(`Are you sure you want to delete user: ${user.name}?`)) {
                            deleteUser(user.id, user.name);
                        }
                    });
                }
            });
            
            // Re-render Lucide icons
            if(typeof createIcons !== 'undefined') {
                createIcons({ 
                    icons: { Trash2 }, 
                    container: tbody
                });
            }
        }
        
        /**
         * Handles the deletion of a system user.
         */
        async function deleteUser(userId, userName) {
            try {
                await fetchData(`${API_BASE}/api/users/${userId}`, { method: 'DELETE' });
                // Custom Alert/Toast replacement
                console.log(`User ${userName} deleted successfully.`);
                fetchAndRenderUserList();
            } catch (error) {
                console.error("Failed to delete user:", error);
                // Custom Alert/Toast replacement
                customAlert(`Failed to delete user: ${error.message}`);
            }
        }
        
        /**
         * Fetches stats for the dashboard.
         */
        async function fetchDashboardStats() {
            try {
                const allChats = await fetchData(`${API_BASE}/api/chats`);
                const allUsers = await fetchData(`${API_BASE}/api/users`);

                document.getElementById('stat-total-chats').textContent = allChats.length;
                document.getElementById('stat-tg-chats').textContent = allChats.filter(c => c.platform === 'telegram').length;
                document.getElementById('stat-fb-chats').textContent = allChats.filter(c => c.platform === 'facebook').length;
                document.getElementById('stat-system-users').textContent = allUsers.length;
            } catch (error) {
                console.error("Failed to fetch dashboard stats:", error);
                document.getElementById('stat-total-chats').textContent = 'N/A';
                document.getElementById('stat-tg-chats').textContent = 'N/A';
                document.getElementById('stat-fb-chats').textContent = 'N/A';
                document.getElementById('stat-system-users').textContent = 'N/A';
            }
        }


        // --- Event Listeners & Handlers ---
        
        // Navigation Click Handler (for the new sidebar)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const viewName = item.getAttribute('data-view');
                const platform = item.getAttribute('data-platform');
                switchView(viewName, platform);
            });
        });

        // Admin Reply Submission
        document.getElementById('reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!SELECTED_CHAT) return;
            
            const input = document.getElementById('reply-input');
            const text = input.value.trim();
            if (!text) return;

            const chatId = SELECTED_CHAT.telegramId;
            input.disabled = true;
            input.placeholder = "Sending...";

            SOCKET.emit('admin_reply', { chatId, text }, (response) => {
                input.disabled = false;
                input.placeholder = "Type your reply...";
                
                if (response.success) {
                    input.value = ''; // Clear input only on success
                } else {
                    console.error("Reply failed:", response.error);
                    customAlert(`Failed to send reply: ${response.error}`);
                }
            });
        });
        
        // Add User Submission
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const role = document.getElementById('new-user-role').value;
            const status = document.getElementById('new-user-status').value;
            const formMsg = document.getElementById('user-form-message');
            
            formMsg.classList.add('hidden');

            try {
                await fetchData(`${API_BASE}/api/users`, {
                    method: 'POST',
                    body: JSON.stringify({ name, role, status })
                });
                
                formMsg.classList.remove('hidden', 'text-red-500');
                formMsg.classList.add('text-green-500');
                formMsg.textContent = `User "${name}" added successfully!`;
                
                document.getElementById('add-user-form').reset();
                fetchAndRenderUserList();
            } catch (error) {
                console.error("Failed to add user:", error);
                formMsg.classList.remove('hidden', 'text-green-500');
                formMsg.classList.add('text-red-500');
                formMsg.textContent = `Failed to add user: ${error.message}`;
            }
        });
        
        // TG Broadcast Submission (Placeholder)
        document.getElementById('broadcast-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('broadcast-input');
            const message = document.getElementById('broadcast-message');
            
            message.classList.remove('hidden', 'text-red-500', 'text-green-500');
            message.classList.add('text-red-500');
            message.textContent = "Broadcast feature is not yet implemented on the server-side. Message NOT SENT.";
            input.disabled = true;
            setTimeout(() => {
                input.disabled = false;
                message.classList.add('hidden');
            }, 3000);
        });
        
        // Custom Auth Form Submission
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('modal-username').value;
            const password = document.getElementById('modal-password').value;
            const errorMsg = document.getElementById('modal-error-message');
            
            errorMsg.classList.add('hidden');

            if (!username || !password) {
                errorMsg.querySelector('span').textContent = "Username and Password are required.";
                errorMsg.classList.remove('hidden');
                return;
            }

            // Attempt to set auth header and proceed (The actual validation happens on the first API call)
            setBasicAuth(username, password);
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('auth-info').textContent = `User: ${username}`;

            // Load initial data
            fetchDashboardStats();
            
            // Check authentication with a dummy request immediately after login attempt
            checkAuthAndInit();
        });


        // --- Socket.io Handlers ---

        SOCKET.on('connect', () => {
            console.log('Socket.io connected.');
            document.getElementById('socket-status').textContent = 'Connected';
            document.getElementById('socket-status').classList.remove('text-red-500');
            document.getElementById('socket-status').classList.add('text-green-500');
        });

        SOCKET.on('disconnect', () => {
            console.log('Socket.io disconnected.');
            document.getElementById('socket-status').textContent = 'Disconnected';
            document.getElementById('socket-status').classList.remove('text-green-500');
            document.getElementById('socket-status').classList.add('text-red-500');
        });

        /**
         * Handles incoming messages from Telegram/Facebook (user to admin).
         */
        SOCKET.on('new_message', (data) => {
            console.log('New incoming message:', data);
            
            // 1. Update/Add chat in the CHAT_LIST state
            const existingIndex = CHAT_LIST.findIndex(c => c.telegramId === data.chatId);
            const newMessageData = {
                telegramId: data.chatId,
                username: data.user.username,
                lastMessageTime: data.message.timestamp,
                lastMessageText: data.message.text || data.message.filename,
                platform: data.platform
            };

            if (existingIndex !== -1) {
                CHAT_LIST[existingIndex] = { ...CHAT_LIST[existingIndex], ...newMessageData };
            } else {
                CHAT_LIST.unshift(newMessageData);
            }
            
            // Sort by time (descending) before rendering
            CHAT_LIST.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            
            // 2. Refresh the stats for the dashboard if it's the current view
            if (CURRENT_VIEW === 'dashboard') {
                fetchDashboardStats();
            }

            // 3. Re-render chat list ONLY if the current view matches the platform filter
            if (data.platform === CHAT_PLATFORM_FILTER) {
                renderChatList();
            }

            // 4. If the chat is currently open, refetch history to append the new message
            if (SELECTED_CHAT && SELECTED_CHAT.telegramId === data.chatId) {
                fetchAndRenderChatHistory(data.chatId);
            }
        });
        
        /**
         * Handles admin messages successfully sent (admin to user)
         */
        SOCKET.on('message_sent', (data) => {
            console.log('Admin message confirmed:', data);
            
            // 1. Update Chat List's last message
            const chatIndex = CHAT_LIST.findIndex(c => c.telegramId === data.chatId);
            if (chatIndex !== -1) {
                CHAT_LIST[chatIndex].lastMessageText = data.message.text;
                CHAT_LIST[chatIndex].lastMessageTime = data.message.timestamp;
                CHAT_LIST.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
                renderChatList();
            }

            // 2. If the chat is open, update the history display
            if (SELECTED_CHAT && SELECTED_CHAT.telegramId === data.chatId) {
                fetchAndRenderChatHistory(data.chatId);
            }
        });

        /**
         * Checks if the Basic Auth is valid by making a simple request.
         */
        async function checkAuthAndInit() {
            try {
                await fetchData(`${API_BASE}/api/chats`, { method: 'GET' });
                // If successful, the app is visible and data is loaded.
            } catch (error) {
                if (error.message.includes('401')) {
                    // This error is already handled by customAlert inside fetchData
                    // Re-show modal for user to retry
                    document.getElementById('modal-error-message').querySelector('span').textContent = "Authentication failed. Please check your credentials.";
                    document.getElementById('modal-error-message').classList.remove('hidden');
                    document.getElementById('auth-modal').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                } else {
                    console.error("Initialization failed:", error);
                    customAlert(`Failed to connect to server: ${error.message}`);
                }
            }
        }

        // --- Initialization ---

        /**
         * Main initialization function
         */
        function init() {
            // Show the custom authentication modal instead of using prompt()
            document.getElementById('auth-modal').classList.remove('hidden');
            
            // Initial render of Lucide icons for the modal
            if(typeof createIcons !== 'undefined') {
                 createIcons({ 
                    icons: { XCircle }, 
                    container: document.getElementById('auth-modal')
                });
            }
        }

        window.onload = init;
    </script>

</body>
</html>
