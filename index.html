<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Channel Chat Admin Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Load Moment.js for time formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar for aesthetics */
        .chat-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        /* Style for the typing indicator dots */
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        .typing-dot {
            animation: blink 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased h-screen flex flex-col">

    <!-- Basic Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Admin Login Required</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button onclick="authenticate()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Login</button>
            <p id="auth-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="flex flex-1 hidden">

        <!-- 1. Fixed Menu Bar -->
        <div id="menu-bar" class="w-16 md:w-20 fixed left-0 top-0 bottom-0 bg-gray-800 shadow-xl flex flex-col items-center py-4 z-20">
            
            <!-- Logo/Title Placeholder -->
            <div class="mb-6 text-2xl font-bold text-white">
                <i class="fas fa-headset"></i>
            </div>
            
            <!-- Navigation Items -->
            <div class="space-y-4 w-full">
                <!-- Dashboard (All Chats) -->
                <button id="nav-dashboard" onclick="setNavigationView('chats', null, 'nav-dashboard')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 bg-gray-700 text-blue-400">
                    <i class="fas fa-tachometer-alt text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">Dash</span>
                </button>
                
                <!-- FB Chats -->
                <button id="nav-fb" onclick="setNavigationView('chats', 'facebook', 'nav-fb')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 text-gray-400">
                    <i class="fab fa-facebook-messenger text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">FB</span>
                </button>

                <!-- TG Chats -->
                <button id="nav-tg" onclick="setNavigationView('chats', 'telegram', 'nav-tg')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 text-gray-400">
                    <i class="fab fa-telegram-plane text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">TG</span>
                </button>

                <!-- Divider -->
                <div class="border-t border-gray-700 mx-4"></div>

                <!-- TG User List (User Management) -->
                <button id="nav-users" onclick="setNavigationView('users', null, 'nav-users')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 text-gray-400">
                    <i class="fas fa-user-shield text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">Users</span>
                </button>
                
                <!-- TG User Broadcast (Placeholder) -->
                <button id="nav-broadcast" onclick="setNavigationView('broadcast', null, 'nav-broadcast')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 text-gray-400">
                    <i class="fas fa-bullhorn text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">Broad</span>
                </button>

                <!-- Settings (Placeholder) -->
                <button id="nav-settings" onclick="setNavigationView('settings', null, 'nav-settings')" class="nav-item group flex flex-col items-center p-2 mx-auto rounded-xl hover:bg-gray-700 transition duration-150 text-gray-400">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1 text-white group-hover:text-blue-300">Set</span>
                </button>

            </div>
        </div>

        <!-- 2. Main Content Area (Shifted to the right by the menu bar width) -->
        <div id="main-content-wrapper" class="flex flex-1 ml-16 md:ml-20">
            
            <!-- Chat Interface (Dashboard, FB Chats, TG Chats) -->
            <div id="chat-interface" class="flex w-full">
                
                <!-- Left Sidebar: Chat List -->
                <div class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white border-r border-gray-200 shadow-lg">
                    
                    <!-- Header -->
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h1 id="chat-list-title" class="text-xl font-extrabold text-gray-900">All Live Chats</h1>
                        <button onclick="fetchChats()" class="p-2 text-gray-600 hover:text-blue-600 transition duration-150 rounded-full" title="Refresh Chats">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <!-- Chat List -->
                    <div id="chat-list" class="flex-1 overflow-y-auto chat-scroll">
                        <!-- Chat items will be injected here -->
                        <div class="p-4 text-center text-gray-500 italic">No active chats found.</div>
                    </div>
                </div>

                <!-- Right Panel: Chat History & Reply -->
                <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col">
                    
                    <!-- Chat Header -->
                    <div id="chat-header" class="p-4 border-b border-gray-200 bg-white shadow-sm flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i id="header-platform-icon" class="hidden mr-2"></i>
                            <span id="header-username">Select a Chat</span>
                        </h2>
                        <div id="header-chat-id" class="text-sm text-gray-500 hidden md:block"></div>
                    </div>

                    <!-- Message History -->
                    <div id="message-history" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 bg-gray-100 chat-scroll flex flex-col-reverse">
                        <div id="initial-message" class="text-center text-gray-500 italic mt-auto">Please select a conversation from the left panel to view the history.</div>
                    </div>

                    <!-- Reply Box -->
                    <div id="reply-box" class="p-4 border-t border-gray-200 bg-white hidden">
                        <div class="flex space-x-3">
                            <textarea id="reply-text" rows="2" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Type your reply..."></textarea>
                            <button onclick="handleReply()" class="w-24 bg-green-600 text-white rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50" id="send-btn">
                                <i class="fas fa-paper-plane mr-2"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Standalone Panels (TG User List, Broadcast, Settings) -->

            <!-- TG User List (Moved from modal to full panel) -->
            <div id="users-panel" class="hidden w-full p-6">
                 <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-full flex flex-col h-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">TG System User List</h2>
                    
                    <div class="flex-1 overflow-y-auto">
                        <!-- New User Form -->
                        <div class="mb-6 p-4 border border-blue-100 bg-blue-50 rounded-lg">
                            <h3 class="text-lg font-semibold text-blue-800 mb-3">Add New User (Authentication is basic auth on server.js)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="new-user-name" placeholder="Name" class="p-2 border rounded-lg">
                                <select id="new-user-role" class="p-2 border rounded-lg">
                                    <option value="Viewer">Viewer</option>
                                    <option value="Agent">Agent</option>
                                    <option value="Admin">Admin</option>
                                </select>
                                <select id="new-user-status" class="p-2 border rounded-lg">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                                <button onclick="createUser()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition">Add User</button>
                            </div>
                        </div>

                        <!-- User Table -->
                        <div class="overflow-x-auto shadow-md rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                                    <!-- User rows injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TG User Broadcast Placeholder Panel -->
            <div id="broadcast-panel" class="hidden w-full p-6">
                <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-4xl mx-auto text-center">
                    <i class="fas fa-bullhorn text-6xl text-gray-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">TG User Broadcast</h2>
                    <p class="text-gray-600">This panel is reserved for mass broadcasting messages to all Telegram users. (Feature not implemented yet)</p>
                </div>
            </div>

            <!-- Settings Placeholder Panel -->
            <div id="settings-panel" class="hidden w-full p-6">
                <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-4xl mx-auto text-center">
                    <i class="fas fa-cog text-6xl text-gray-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Settings</h2>
                    <p class="text-gray-600">This panel is reserved for managing application settings, API keys, and configurations. (Feature not implemented yet)</p>
                </div>
            </div>

        </div>

    </div>

    <!-- Message Box (No alerts) -->
    <div id="message-box-container" class="fixed top-0 left-0 right-0 p-4 z-50 pointer-events-none">
        <!-- Messages appear here -->
    </div>


    <script>
        // Global State and Configuration
        const socket = io();
        let currentChatId = null;
        let chats = {}; // Store chat objects for quick lookup
        let platformFilter = null;
        let authHeader = null;
        let currentView = 'chats'; // Tracks the current active view/panel

        // DOM Element references for convenience
        const chatInterface = document.getElementById('chat-interface');
        const usersPanel = document.getElementById('users-panel');
        const broadcastPanel = document.getElementById('broadcast-panel');
        const settingsPanel = document.getElementById('settings-panel');
        const chatListTitle = document.getElementById('chat-list-title');

        // --- Utility Functions ---

        function setAuthHeader(username, password) {
            authHeader = 'Basic ' + btoa(username + ':' + password);
        }

        function createMessage(type, content) {
            const container = document.getElementById('message-box-container');
            const box = document.createElement('div');
            box.className = `p-4 rounded-lg shadow-xl text-white font-medium mb-3 transition-opacity duration-300 ease-out max-w-sm mx-auto ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            box.innerHTML = content;
            container.appendChild(box);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.remove(), 300);
            }, 3000);
        }

        // --- Authentication ---

        function authenticate() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('auth-error');

            setAuthHeader(username, password);

            // Test authentication by fetching chats
            fetchChats()
                .then(() => {
                    document.getElementById('auth-modal').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    createMessage('success', 'Authentication successful. Welcome!');
                })
                .catch(error => {
                    setAuthHeader(null, null); // Clear header on failure
                    errorElement.textContent = 'Login failed. Check username and password.';
                    errorElement.classList.remove('hidden');
                    console.error('Authentication error:', error);
                });
        }

        // --- Navigation Logic ---
        
        function setNavigationView(viewName, platform, navItemId) {
            currentView = viewName;
            platformFilter = platform;
            currentChatId = null;
            
            // Hide all main panels
            chatInterface.classList.add('hidden');
            usersPanel.classList.add('hidden');
            broadcastPanel.classList.add('hidden');
            settingsPanel.classList.add('hidden');
            
            // Deactivate all navigation buttons
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-gray-700', 'text-blue-400');
                btn.classList.add('text-gray-400');
            });

            // Activate current navigation button
            const activeBtn = document.getElementById(navItemId);
            if (activeBtn) {
                activeBtn.classList.add('bg-gray-700', 'text-blue-400');
                activeBtn.classList.remove('text-gray-400');
            }

            // Show the selected panel
            if (viewName === 'chats') {
                chatInterface.classList.remove('hidden');
                let title = 'All Live Chats';
                if (platform === 'facebook') title = 'Facebook Chats';
                if (platform === 'telegram') title = 'Telegram Chats';
                chatListTitle.textContent = title;
                fetchChats();
            } else if (viewName === 'users') {
                usersPanel.classList.remove('hidden');
                fetchUsers();
            } else if (viewName === 'broadcast') {
                broadcastPanel.classList.remove('hidden');
            } else if (viewName === 'settings') {
                settingsPanel.classList.remove('hidden');
            }
        }

        // --- API & Rendering ---

        async function apiFetch(url, options = {}) {
            if (!authHeader) throw new Error("Not authenticated.");

            const headers = {
                'Authorization': authHeader,
                'Content-Type': 'application/json',
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                if (response.status === 401) {
                    createMessage('error', 'Authentication failed or expired. Please re-login.');
                    document.getElementById('auth-modal').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                }
                throw new Error(`API Error: ${response.statusText}`);
            }
            return response.json();
        }

        async function fetchChats() {
            if (currentView !== 'chats') return; // Only fetch if we are in a chat view

            try {
                const url = platformFilter ? `/api/chats?platform=${platformFilter}` : '/api/chats';
                const chatList = await apiFetch(url);
                
                chats = {};
                chatList.forEach(chat => {
                    chats[chat.telegramId] = chat;
                });

                renderChatList(chatList);
            } catch (error) {
                console.error("Error fetching chats:", error);
            }
        }

        function renderChatList(chatList) {
            const listElement = document.getElementById('chat-list');
            listElement.innerHTML = '';

            if (chatList.length === 0) {
                listElement.innerHTML = '<div class="p-4 text-center text-gray-500 italic">No active chats found.</div>';
                return;
            }

            chatList.forEach(chat => {
                const iconClass = chat.platform === 'facebook' ? 'fab fa-facebook-messenger text-blue-600' : 'fab fa-telegram-plane text-cyan-500';
                const item = document.createElement('div');
                item.className = `p-3 flex items-center space-x-3 cursor-pointer border-b hover:bg-gray-100 transition duration-150 ${currentChatId === chat.telegramId ? 'bg-blue-100 border-l-4 border-blue-500' : ''}`;
                item.onclick = () => selectChat(chat.telegramId);

                item.innerHTML = `
                    <div class="flex-shrink-0 text-2xl">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-semibold text-gray-800 truncate">${chat.username || chat.telegramId}</div>
                        <div class="text-xs text-gray-500 truncate">${chat.lastMessageText || 'Media message'}</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="text-xs text-gray-400">${moment(chat.lastMessageTime).fromNow()}</div>
                        <span class="text-xs font-medium px-2 py-0.5 mt-1 rounded-full text-white ${chat.platform === 'facebook' ? 'bg-blue-500' : 'bg-cyan-500'}">${chat.platform}</span>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        async function selectChat(chatId) {
            if (currentChatId) {
                // Deselect previous chat visual
                document.querySelectorAll('#chat-list > div').forEach(item => {
                    item.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
                });
            }

            currentChatId = chatId;
            const chat = chats[chatId];
            
            // Highlight selected chat
            const selectedItem = document.querySelector(`#chat-list > div[onclick*="${chatId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500');
            }

            // Update header
            const iconClass = chat.platform === 'facebook' ? 'fab fa-facebook-messenger text-blue-600' : 'fab fa-telegram-plane text-cyan-500';
            document.getElementById('header-platform-icon').className = iconClass + ' mr-2';
            document.getElementById('header-username').textContent = chat.username || chat.telegramId;
            document.getElementById('header-chat-id').textContent = `ID: ${chatId}`;
            document.getElementById('header-platform-icon').classList.remove('hidden');
            
            // Show reply box
            document.getElementById('reply-box').classList.remove('hidden');
            
            await loadHistory(chatId);
        }

        async function loadHistory(chatId) {
            const historyElement = document.getElementById('message-history');
            historyElement.innerHTML = `
                <div class="w-full text-center py-4">
                    <i class="fas fa-circle-notch fa-spin text-blue-500 text-xl"></i> Loading history...
                </div>
            `;
            
            try {
                const history = await apiFetch(`/api/chats/${chatId}/history`);
                renderHistory(history);
            } catch (error) {
                console.error("Error loading history:", error);
                historyElement.innerHTML = `<div class="p-4 text-center text-red-500 italic">Error loading chat history.</div>`;
            }
        }

        function renderHistory(messages) {
            const historyElement = document.getElementById('message-history');
            historyElement.innerHTML = '';
            
            // We reverse the array to render it correctly using flex-col-reverse
            messages.reverse().forEach(message => {
                const isUser = message.sender === 'user';
                const messageDiv = document.createElement('div');
                
                const timeStr = moment(message.timestamp).format('HH:mm');

                messageDiv.className = `flex ${isUser ? 'justify-start' : 'justify-end'}`;
                
                let content = '';

                if (message.mediaPath) {
                    // For Telegram, mediaPath is file_id. We can't display it directly here without the Telegram Bot API.
                    // Placeholder for media:
                    content = `<p class="italic text-gray-600">Media: ${message.filename || message.mediaPath}</p>`;
                }

                if (message.text) {
                    content += `<p>${message.text}</p>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow-md ${isUser ? 'bg-white text-gray-800' : 'bg-green-100 text-gray-800'}">
                        ${content}
                        <div class="text-right text-xs mt-1 ${isUser ? 'text-gray-400' : 'text-green-500'}">${timeStr}</div>
                    </div>
                `;
                
                historyElement.appendChild(messageDiv);
            });
            
            // Scroll to bottom (since we are using flex-col-reverse, this simulates scroll to bottom)
            historyElement.scrollTop = 0;
        }

        // --- Reply Handling ---

        async function handleReply() {
            const replyTextElement = document.getElementById('reply-text');
            const sendBtn = document.getElementById('send-btn');
            const text = replyTextElement.value.trim();

            if (!text || !currentChatId) return;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';

            socket.emit('admin_reply', { chatId: currentChatId, text }, (response) => {
                if (response.success) {
                    replyTextElement.value = '';
                    createMessage('success', 'Reply sent successfully!');
                } else {
                    createMessage('error', `Failed to send reply: ${response.error}`);
                    console.error("Reply failed:", response.error);
                }
                
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send';
            });
        }

        // --- Socket.io Handlers ---

        socket.on('connect', () => {
            console.log('Connected to Socket.io server. Ready for real-time updates.');
        });

        socket.on('new_message', (data) => {
            const { chatId, message, user } = data;
            
            // 1. Update/Add chat in local state and re-render chat list
            chats[chatId] = user;
            if (currentView === 'chats') {
                fetchChats(); // Re-fetch to get correct ordering and platform filtering
            }

            // 2. If it's the currently viewed chat, append the message
            if (chatId === currentChatId) {
                loadHistory(chatId); 
            }
            createMessage('info', `New message from ${user.username} (${user.platform})!`);
        });

        socket.on('message_sent', (data) => {
            const { chatId, message } = data;
            
            // 1. Update chat list (to update last message text/time)
            if (chats[chatId]) {
                chats[chatId].lastMessageText = message.text;
                if (currentView === 'chats') {
                    fetchChats(); 
                }
            }

            // 2. If it's the currently viewed chat, update history
            if (chatId === currentChatId) {
                loadHistory(chatId); 
            }
        });


        // --- User Management Logic ---

        async function fetchUsers() {
            try {
                const users = await apiFetch('/api/users');
                renderUserList(users);
            } catch (error) {
                console.error("Error fetching users:", error);
                createMessage('error', 'Could not fetch system users.');
            }
        }

        function renderUserList(users) {
            const listBody = document.getElementById('user-list-body');
            listBody.innerHTML = '';

            if (users.length === 0) {
                listBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No system users defined.</td></tr>`;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = user.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900 transition duration-150" title="Delete User">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                listBody.appendChild(row);
            });
        }

        async function createUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const role = document.getElementById('new-user-role').value;
            const status = document.getElementById('new-user-status').value;

            if (!name) {
                createMessage('error', 'User name is required.');
                return;
            }

            try {
                await apiFetch('/api/users', {
                    method: 'POST',
                    body: JSON.stringify({ name, role, status })
                });
                document.getElementById('new-user-name').value = '';
                createMessage('success', 'User added successfully!');
                fetchUsers();
            } catch (error) {
                console.error("Error creating user:", error);
                createMessage('error', 'Failed to create user.');
            }
        }

        async function deleteUser(id) {
             const response = window.confirm(`Are you sure you want to delete user ID: ${id}? (NOTE: Server basic auth credentials are set in server.js)`);
             if (!response) return;

            try {
                await apiFetch(`/api/users/${id}`, { method: 'DELETE' });
                createMessage('success', 'User deleted successfully.');
                fetchUsers();
            } catch (error) {
                console.error("Error deleting user:", error);
                createMessage('error', 'Failed to delete user.');
            }
        }
        
        // --- Initialization ---
        window.onload = () => {
            // Show auth modal on load
            document.getElementById('auth-modal').classList.remove('hidden');
        };

        // Initialize the view after successful auth
        // setNavigationView('chats', null, 'nav-dashboard'); // This is called inside authenticate() success
    </script>
</body>
</html>
