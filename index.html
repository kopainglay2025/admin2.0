<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel â€” Unified Messenger</title>

  <!-- Simple reset + Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724; --panel:#0b1220; --muted:#94a3b8; --accent:#2b6ef6; --glass: rgba(255,255,255,0.03);
      --inner-radius:12px; --card-padding:14px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,-apple-system,Helvetica,Arial,sans-serif}
    html,body,#app{height:100%;margin:0;background:linear-gradient(180deg,#071029 0%, #081126 100%);color:#e6eef8}
    a{color:inherit}

    /* Layout */
    .app{display:flex;height:100vh;gap:18px;padding:18px}
    .sidebar{width:300px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;background:linear-gradient(135deg,var(--accent),#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .menu{margin-top:6px;display:flex;flex-direction:column;gap:8px}
    .menu button{background:transparent;border:none;color:var(--muted);text-align:left;padding:10px;border-radius:10px;display:flex;align-items:center;gap:10px;cursor:pointer}
    .menu button.active{background:var(--glass);color:#dff0ff}
    .menu .count{margin-left:auto;background:rgba(43,110,246,0.12);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--accent)}

    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    .topbar{height:64px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:12px;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
    .search{display:flex;align-items:center;gap:8px}
    .search input{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);min-width:360px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .chip{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:999px}

    .content{display:grid;grid-template-columns:360px 1fr;gap:12px;height:calc(100% - 128px)}

    /* Left list of chats */
    .chats{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:12px;padding:12px;overflow:auto}
    .chat-item{display:flex;gap:12px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .chat-item:hover{background:rgba(255,255,255,0.02)}
    .avatar{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#334155,#0ea5a4);display:flex;align-items:center;justify-content:center;font-weight:700}
    .meta{flex:1}
    .meta .title{font-weight:600}
    .meta .sub{font-size:13px;color:var(--muted)}
    .badge{font-size:12px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px}

    /* Chat panel */
    .chat-panel{display:flex;flex-direction:column;border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
    .chat-header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;gap:12px}
    .chat-body{flex:1;padding:20px;overflow:auto;background-image:linear-gradient(180deg, rgba(255,255,255,0.002), transparent)}
    .msg{max-width:70%;padding:10px 12px;border-radius:12px;margin-bottom:10px;display:inline-block}
    .msg.user{background:rgba(255,255,255,0.03);align-self:flex-start;border-top-left-radius:6px}
    .msg.admin{background:linear-gradient(90deg,var(--accent),#7c3aed);color:white;align-self:flex-end;border-top-right-radius:6px}
    .msg small{display:block;color:var(--muted);margin-top:6px;font-size:12px}

    .chat-input{padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center}
    .chat-input textarea{flex:1;min-height:44px;max-height:160px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .btn{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:white;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04)}

    /* small screens */
    @media (max-width:900px){.sidebar{display:none}.content{grid-template-columns:1fr}}

    /* login modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center}
    .card{background:#071226;padding:20px;border-radius:12px;min-width:360px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .muted{color:var(--muted)}

    /* typing indicator */
    .typing{display:flex;gap:4px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.4);animation:blink 1s infinite}
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}
  </style>
</head>
<body>
  <div id="app" class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">MS</div>
        <div>
          <h1>AdminPlan</h1>
          <div class="muted" style="font-size:12px">Unified Messenger â€¢ Multi-Channel</div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button data-channel="all" class="active"><span>All Chats</span><span class="count">12</span></button>
        <button data-channel="telegram">Telegram <span class="count">3</span></button>
        <button data-channel="facebook">Facebook <span class="count">2</span></button>
        <button data-channel="viber">Viber <span class="count">1</span></button>
        <button data-channel="whatsapp">WhatsApp <span class="count">6</span></button>
        <div style="height:1px;background:rgba(255,255,255,0.02);margin:8px 0;border-radius:4px"></div>
        <button data-channel="users">Users</button>
        <button data-channel="settings">Settings</button>
      </div>

      <div style="margin-top:auto;display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <div class="muted" style="font-size:12px">Logged as</div>
          <div style="font-weight:700">Admin</div>
        </div>
        <button class="btn secondary" id="logoutBtn">Logout</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="globalSearch" placeholder="Search messages, users, ids..." />
        </div>
        <div class="top-actions">
          <div class="chip">Dark</div>
          <div class="chip">New: <strong id="unreadCount">12</strong></div>
        </div>
      </div>

      <div class="content">
        <!-- Chats list -->
        <div class="chats">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Conversations</div>
            <div class="muted">Sort: Recent</div>
          </div>

          <div id="chatList">
            <!-- populated by JS -->
          </div>
        </div>

        <!-- Chat panel -->
        <section class="chat-panel">
          <div class="chat-header">
            <div style="display:flex;gap:12px;align-items:center">
              <div class="avatar" id="chatAvatar">U</div>
              <div>
                <div id="chatTitle" style="font-weight:700">Select a conversation</div>
                <div id="chatSubtitle" class="muted" style="font-size:13px">Channel â€¢ last seen</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div id="typingIndicator" style="display:none" class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
              <button class="btn secondary" id="btnFiles">Attach</button>
            </div>
          </div>

          <div class="chat-body" id="chatBody">
            <div style="text-align:center;color:var(--muted);margin-top:40px">No chat selected â€” pick one from the left</div>
          </div>

          <div class="chat-input">
            <input type="file" id="fileInput" style="display:none" />
            <textarea id="msgInput" placeholder="Type a message..."></textarea>
            <button class="btn" id="sendBtn">Send</button>
          </div>
        </section>
      </div>
    </main>

  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal">
    <div class="card">
      <h3>Admin Login</h3>
      <div class="field">
        <label class="muted">Username</label>
        <input id="loginUser" placeholder="admin" />
      </div>
      <div class="field">
        <label class="muted">Password</label>
        <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn secondary" id="demoBtn">Demo</button>
        <button class="btn" id="loginBtn">Login</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ======= CONFIG ========
    const API_BASE = '';// same origin

    // ======= STATE ========
    let socket, logged=false; let currentConv = null;
    const CHAT_STORE = {};

    // ======= MOCK: initial chat list (replace with fetched data) ========
    const initialChats = [
      {id:'tg_12345', name:'Alice', channel:'telegram', last:'Hey, do you have stock?', unread:2},
      {id:'wa_9988', name:'Khin', channel:'whatsapp', last:'Thank you!', unread:0},
      {id:'fb_5566', name:'Company Page', channel:'facebook', last:'Hi, I need help', unread:1},
      {id:'vb_900', name:'Viber User', channel:'viber', last:'Where is my order?', unread:0}
    ];

    // ======= DOM refs ========
    const chatListEl = document.getElementById('chatList');
    const chatBody = document.getElementById('chatBody');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');
    const chatAvatar = document.getElementById('chatAvatar');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const btnFiles = document.getElementById('btnFiles');
    const fileInput = document.getElementById('fileInput');
    const loginModal = document.getElementById('loginModal');
    const loginBtn = document.getElementById('loginBtn');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginMsg = document.getElementById('loginMsg');
    const demoBtn = document.getElementById('demoBtn');

    // ======= Setup menu handlers ========
    document.querySelectorAll('#menu button').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('#menu button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        // filter chat list by data-channel
        const ch = b.getAttribute('data-channel');
        renderChatList(ch);
      })
    });

    // ======= Render chat list ========
    function renderChatList(filter='all'){
      chatListEl.innerHTML='';
      const list = initialChats.filter(c=> filter==='all' || filter==='users' || c.channel===filter);
      list.forEach(c=>{
        const div = document.createElement('div');
        div.className='chat-item';
        div.innerHTML = `<div class="avatar">${(c.name||'U').slice(0,1)}</div>
                         <div class="meta"><div class="title">${c.name}</div><div class="sub">${c.channel} â€¢ ${c.last}</div></div>
                         <div class="badge">${c.unread||''}</div>`;
        div.addEventListener('click', ()=>openConversation(c));
        chatListEl.appendChild(div);
      });
    }

    function openConversation(conv){
      currentConv = conv;
      chatTitle.textContent = conv.name + ' '; 
      chatSubtitle.textContent = conv.channel + ' â€¢ ' + (new Date()).toLocaleString();
      chatAvatar.textContent = (conv.name||'U').slice(0,1);
      chatBody.innerHTML = '';

      // load history (from CHAT_STORE or mock)
      const history = CHAT_STORE[conv.id] || [
        {from:'user',text:conv.last,time:Date.now()-1000*60*30}
      ];
      CHAT_STORE[conv.id] = history;
      history.forEach(m=>appendMsg(m));
    }

    function appendMsg(m){
      const el = document.createElement('div');
      el.className = 'msg '+(m.from==='admin'?'admin':'user');
      el.innerHTML = `<div>${escapeHtml(m.text||'')}</div><small>${new Date(m.time||Date.now()).toLocaleString()}</small>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ======= Send message ========
    sendBtn.addEventListener('click', async ()=>{
      const text = msgInput.value.trim(); if(!text || !currentConv) return;
      const payload = { channel: currentConv.channel, user_id: currentConv.id, message: text };

      // append locally
      const msg = {from:'admin',text, time:Date.now()};
      CHAT_STORE[currentConv.id].push(msg);
      appendMsg(msg);
      msgInput.value='';

      // emit over socket
      if(socket && socket.connected){
        socket.emit('reply_message', payload);
      } else {
        // fallback: post to server endpoint
        try{ await fetch('/api/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}) }catch(e){console.warn(e)}
      }
    });

    // file attach
    btnFiles.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]; if(!f) return; if(!currentConv) return alert('Select conversation first');
      const msg = {from:'admin',text:`ðŸ“Ž ${f.name}`, time:Date.now()};
      CHAT_STORE[currentConv.id].push(msg); appendMsg(msg);
      // TODO: upload file via fetch to server and then notify channel
    });

    // ======= Login ========
    loginBtn.addEventListener('click', async ()=>{
      const user = loginUser.value.trim(); const pass = loginPass.value.trim();
      loginMsg.textContent='';
      try{
        const r = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pass})});
        const j = await r.json();
        if(j.success){ logged=true; loginModal.style.display='none'; initSocket(); renderChatList('all'); }
        else loginMsg.textContent = j.message || 'Login failed';
      }catch(e){ loginMsg.textContent = 'Server error'; }
    });
    demoBtn.addEventListener('click', ()=>{ loginUser.value='admin'; loginPass.value='Paing@123'; loginBtn.click(); });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{ logged=false; loginModal.style.display='flex'; });

    // ======= Escape html utility ========
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]; }); }

    // ======= Socket.io connection ========
    function initSocket(){
      // dynamic load socket.io client
      const s = document.createElement('script'); s.src='/socket.io/socket.io.js'; s.onload = ()=>{
        socket = io();
        socket.on('connect', ()=>console.log('socket connected'));
        socket.on('new_message', (data)=>{
          // When a new message arrives from server, add to store and show notification
          if(!CHAT_STORE[data.user_id]) CHAT_STORE[data.user_id]=[];
          CHAT_STORE[data.user_id].push({from:'user',text:data.message,time:Date.now()});
          // if current conv open, append
          if(currentConv && currentConv.id===data.user_id){ appendMsg({from:'user',text:data.message,time:Date.now()}); }
          // update unread count (simple)
          const cur = parseInt(document.getElementById('unreadCount').textContent||'0'); document.getElementById('unreadCount').textContent = cur+1;
        });
      };
      document.head.appendChild(s);
    }

    // ======= Initialize ========
    (function(){ renderChatList('all'); })();
  </script>
</body>
</html>
