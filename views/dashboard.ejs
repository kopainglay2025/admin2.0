<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Multi-Channel Messenger</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* General Layout */
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* 1. Left Sidebar (Menu) */
        .sidebar { 
            width: 250px; 
            background-color: #2c3e50; 
            color: white; 
            padding-top: 20px; 
            flex-shrink: 0; 
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        .sidebar h3, .sidebar p { padding: 0 20px; margin-bottom: 20px; }
        .sidebar-menu a { 
            display: flex;
            align-items: center;
            padding: 12px 20px; 
            text-decoration: none; 
            color: #ecf0f1; 
            transition: background-color 0.3s, color 0.3s; 
            font-weight: 500;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active { 
            background-color: #34495e; 
            color: #3498db; 
        }
        .sidebar-menu a i { margin-right: 10px; font-size: 1.2em; }
        .sidebar-menu hr { border-color: #34495e; margin: 10px 0; }

        /* Main Content Area */
        .chat-container { flex-grow: 1; display: flex; background-color: white; }

        /* 2. Chat List Panel (Conversations) */
        .chat-list-panel { 
            width: 350px; /* Wider for better chat previews */
            border-right: 1px solid #ddd; 
            overflow-y: auto; 
            flex-shrink: 0; 
            background-color: white;
        }
        .chat-list-header {
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        .chat-item { 
            padding: 15px 20px; 
            border-bottom: 1px solid #f0f2f5; 
            cursor: pointer; 
            transition: background-color 0.1s; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .chat-item:hover { background-color: #f0f8ff; }
        .chat-item.active { background-color: #e6f7ff; border-left: 3px solid #0084ff; }
        
        .chat-info { flex-grow: 1; min-width: 0; }
        .name { font-weight: bold; font-size: 1em; color: #1c1e21; }
        .chat-platform { font-size: 0.75em; color: #0084ff; font-weight: 600; margin-left: 5px; }
        .chat-last-message { 
            font-size: 0.9em; 
            color: #606770; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            max-width: 100%; 
        }
        .unread-count { 
            background: #fa383e; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 0.75em; 
            font-weight: bold;
            margin-left: 10px; 
        }

        /* 3. Chat Window (Message Area) */
        .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { 
            padding: 20px; 
            border-bottom: 1px solid #ddd; 
            font-size: 1.2em; 
            font-weight: 600; 
            background-color: white;
            color: #1c1e21;
        }
        .message-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg"><circle cx="5" cy="5" r="0.5" fill="%23e7e9eb" /></svg>');
            background-size: 40px 40px; 
            display: flex;
            flex-direction: column;
        }
        
        /* Message Bubbles */
        .message { 
            margin-bottom: 10px; 
            max-width: 65%; 
            padding: 10px 15px; 
            border-radius: 18px; 
            line-height: 1.4; 
            word-wrap: break-word; 
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }
        .user-message { 
            background-color: #ffffff; 
            align-self: flex-start; 
            margin-right: auto;
            color: #1c1e21;
        }
        .admin-message { 
            background-color: #0084ff; 
            color: white; 
            align-self: flex-end; 
            margin-left: auto; 
        }
        .message-time { 
            font-size: 0.7em; 
            opacity: 0.7; 
            margin-top: 5px; 
            display: block;
            text-align: right;
            color: inherit; /* Inherit color for contrast */
        }
        .user-message .message-time { color: #606770; }
        .admin-message .message-time { color: rgba(255, 255, 255, 0.8); }


        /* 4. Input Area */
        .chat-input { 
            display: flex; 
            padding: 15px; 
            border-top: 1px solid #ddd; 
            background-color: #f0f2f5; 
        }
        #messageInput { 
            flex-grow: 1; 
            padding: 12px 18px; 
            border: none; 
            border-radius: 24px; 
            margin-right: 10px; 
            font-size: 1em; 
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.1);
        }
        #sendButton { 
            background-color: #0084ff; 
            color: white; 
            border: none; 
            border-radius: 50%; /* Circle button */
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; 
            font-size: 1.2em;
            transition: background-color 0.2s;
        }
        #sendButton:hover { background-color: #006ddb; }
        
        /* Icons (If using Font Awesome or a similar library) */
        /* For this example, we'll use simple text/emoji or assume a CDN is loaded */
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Admin Panel</h3>
        <p>Welcome, **<%= adminUser.username %>**</p>
        <div class="sidebar-menu">
            <a href="#" id="menu-all" class="active" data-platform="">
                <i class="fas fa-comments"></i> Chats (All)
            </a>
            <hr>
            <a href="#" id="menu-telegram" data-platform="telegram">
                <i class="fab fa-telegram-plane"></i> Telegram
            </a>
            <a href="#" id="menu-facebook" data-platform="facebook">
                <i class="fab fa-facebook-messenger"></i> Facebook
            </a>
            <a href="#" id="menu-viber" data-platform="viber">
                <i class="fab fa-viber"></i> Viber
            </a>
            <a href="#" id="menu-whatsapp" data-platform="whatsapp">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
            <hr>
            <a href="/telegram-users">
                <i class="fas fa-users"></i> Telegram Users List
            </a>
            <a href="/logout" style="color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-list-panel" id="chatListPanel">
            <div class="chat-list-header">Conversations</div>
            <% chats.forEach(chat => { %>
                <div class="chat-item" 
                    data-chat-id="<%= chat.chatId %>" 
                    data-platform="<%= chat.platform %>" 
                    data-sender-id="<%= chat.senderId %>">
                    <div class="chat-info">
                        <div class="name">
                            <%= chat.senderName %> 
                            <span class="chat-platform">(<%= chat.platform.toUpperCase() %>)</span>
                        </div>
                        <div class="chat-last-message"><%= chat.lastMessageText %></div>
                    </div>
                    <% if (chat.unreadCount > 0) { %>
                        <span class="unread-count" data-chat-id-count="<%= chat.chatId %>"><%= chat.unreadCount %></span>
                    <% } %>
                </div>
            <% }); %>
        </div>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header" id="chatHeader">
                ✨ Please select a chat from the left panel to begin.
            </div>
            <div class="message-area" id="messageArea">
                </div>
            <div class="chat-input" id="chatInput" style="display: none;">
                <input type="text" id="messageInput" placeholder="Write a reply...">
                <button id="sendButton">➤</button>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script>
        const socket = io();
        const chatListPanel = document.getElementById('chatListPanel');
        const chatHeader = document.getElementById('chatHeader');
        const messageArea = document.getElementById('messageArea');
        const chatInput = document.getElementById('chatInput');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const sidebarMenu = document.querySelector('.sidebar-menu');

        let currentChatId = null;
        let currentPlatform = null;
        let currentSenderId = null;

        // --- Core Functions ---

        /** Fetches and displays the chat list based on the selected platform. */
        async function loadChatList(platform = '') {
            try {
                const response = await fetch(`/api/chats?platform=${platform}`);
                const chats = await response.json();
                
                // Keep the header, clear the rest
                const existingHeader = document.querySelector('.chat-list-header');
                chatListPanel.innerHTML = ''; 
                if (existingHeader) chatListPanel.appendChild(existingHeader);

                chats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    // Check if chat is currently active
                    chatItem.className = 'chat-item' + (chat.chatId === currentChatId ? ' active' : '');
                    chatItem.dataset.chatId = chat.chatId;
                    chatItem.dataset.platform = chat.platform;
                    chatItem.dataset.senderId = chat.senderId;
                    
                    const unreadSpan = chat.unreadCount > 0 ? `<span class="unread-count" data-chat-id-count="${chat.chatId}">${chat.unreadCount}</span>` : '';
                    
                    chatItem.innerHTML = `
                        <div class="chat-info">
                            <div class="name">
                                ${chat.senderName} 
                                <span class="chat-platform">(${chat.platform.toUpperCase()})</span>
                            </div>
                            <div class="chat-last-message">${chat.lastMessageText}</div>
                        </div>
                        ${unreadSpan}
                    `;
                    chatListPanel.appendChild(chatItem);
                });
            } catch (error) {
                console.error('Error loading chat list:', error);
            }
        }

        /** Fetches and displays messages for a specific chatId. */
        async function loadMessages(chatId, senderName, platform, senderId) {
            currentChatId = chatId;
            currentPlatform = platform;
            currentSenderId = senderId;

            chatHeader.innerHTML = `<i class="fas fa-user-circle"></i> ${senderName} <span class="chat-platform">(${platform.toUpperCase()})</span>`;
            messageArea.innerHTML = '';
            chatInput.style.display = 'flex';

            // Set active class on the selected chat item
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeChat = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (activeChat) activeChat.classList.add('active');

            try {
                const response = await fetch(`/api/chats/${chatId}/messages`);
                const messages = await response.json();

                messages.forEach(msg => appendMessage(msg));

                // Scroll to bottom after loading
                messageArea.scrollTop = messageArea.scrollHeight;

                // Remove unread badge
                const unreadBadge = document.querySelector(`.unread-count[data-chat-id-count="${chatId}"]`);
                if (unreadBadge) unreadBadge.remove();

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        /** Appends a single message to the chat window. */
        function appendMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message ' + (msg.isFromAdmin ? 'admin-message' : 'user-message');
            
            // Format timestamp 
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="message-text">${msg.text}</div>
                <div class="message-time">${time}</div>
            `;
            messageArea.appendChild(div);
            // Auto-scroll on new message
            messageArea.scrollTop = messageArea.scrollHeight; 
        }

        /** Sends the admin reply. */
        function sendAdminReply() {
            const message = messageInput.value.trim();
            if (!message || !currentChatId) return;

            const adminUsername = '<%= adminUser.username %>';

            // 1. Emit to server for sending to the platform and DB
            socket.emit('admin_reply', {
                chatId: currentChatId,
                senderId: currentSenderId,
                platform: currentPlatform,
                message: message,
                adminUsername: adminUsername
            });
            
            // 2. Clear input
            messageInput.value = '';
        }

        // --- Event Listeners ---

        // 1. Chat Item Click
        chatListPanel.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                const chatId = chatItem.dataset.chatId;
                const platform = chatItem.dataset.platform;
                const senderId = chatItem.dataset.senderId;
                // Get the displayed sender name and strip the platform tag for cleaner display
                const senderNameElement = chatItem.querySelector('.name');
                if (senderNameElement) {
                     const senderName = senderNameElement.textContent.split('(')[0].trim();
                     loadMessages(chatId, senderName, platform, senderId);
                }
            }
        });

        // 2. Send Button/Enter Key
        sendButton.addEventListener('click', sendAdminReply);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent newline in input
                sendAdminReply();
            }
        });

        // 3. Sidebar Menu Click
        sidebarMenu.addEventListener('click', (e) => {
            const menuItem = e.target.closest('a');
            if (menuItem && menuItem.dataset.platform !== undefined) {
                if (menuItem.getAttribute('href') && menuItem.getAttribute('href') !== '#') {
                    // Let links like /telegram-users or /logout proceed normally
                    return;
                }
                e.preventDefault();
                
                // Update active class
                sidebarMenu.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                menuItem.classList.add('active');

                // Load chats for the selected platform
                loadChatList(menuItem.dataset.platform);
            }
        });


        // --- Socket.io Listeners (Real-time updates) ---

        // Listener for a new incoming message from any platform
        socket.on('new_message', (msg) => {
            
            // 1. If the chat is currently open, append the message
            if (msg.chatId === currentChatId) {
                appendMessage(msg);
                // Since the admin is viewing it, the backend should be marking it as read implicitly/explicitly
            } else {
                // 2. If chat is not open, increment unread count and reload list to move to top
                
                // Find existing badge
                let unreadBadge = document.querySelector(`.unread-count[data-chat-id-count="${msg.chatId}"]`);
                if (unreadBadge) {
                    unreadBadge.textContent = parseInt(unreadBadge.textContent) + 1;
                } else {
                    // New message/chat, force reload list to show unread badge and move to top
                    loadChatList(document.querySelector('.sidebar-menu a.active').dataset.platform);
                }
            }
             // Always reload chat list to ensure the conversation with the new message moves to the top
            loadChatList(document.querySelector('.sidebar-menu a.active').dataset.platform);
        });

        // Listener for admin's own reply
        socket.on('new_message_for_chat', (msg) => {
            if (msg.chatId === currentChatId) {
                // Append the admin's message immediately
                appendMessage(msg);
            }
            // Always reload chat list to move the conversation to the top
            loadChatList(document.querySelector('.sidebar-menu a.active').dataset.platform);
        });

        // Listener for when a chat is marked as read (to update UI on other admin screens)
        socket.on('chat_read', (data) => {
             const unreadBadge = document.querySelector(`.unread-count[data-chat-id-count="${data.chatId}"]`);
             if (unreadBadge) unreadBadge.remove();
        });

        // Initial load of all chats when the dashboard loads
        loadChatList('');
    </script>
</body>
</html>
